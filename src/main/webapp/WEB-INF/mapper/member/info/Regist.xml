<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    Regist.xml
    회원관리
    ======================================================
    No  ||  수정자 ||  수정일자    ||  수정내역
    ======================================================
    1       정용길     2018.05.01     최초작성
    2       김지은     2018.11.08     회원정보관리 수정
-->
<mapper namespace="kr.co.solbipos.membr.info.regist.service.impl.RegistMapper">

    <!-- 등록매장 조회 -->
    <!--
        TABLE    : TB_HQ_OFFICE, TB_HQ_BRAND, TB_MS_STORE
        COMMENTS : 회원정보 등록시 등록매장 콤보박스 내용 조회
    -->
    <select id="getRegistStore"  parameterType="hqManageVO" resultType="DefaultMap">
        /* RegistMapper.getRegistStore */
        SELECT tms.STORE_CD AS VALUE,
               tms.STORE_NM AS NAME
          FROM TB_MS_STORE tms
         WHERE tms.HQ_OFFICE_CD = #{hqOfficeCd}
    </select>

    <!-- 회원등급 리스트 조회-->
    <!--
        TABLE    : TB_HQ_OFFICE, TB_HQ_BRAND, TB_MS_STORE
        COMMENTS : 회원정보 등록시 등록매장 콤보박스 내용 조회
    -->
    <select id="getMemberClassList"  parameterType="membrClassVO" resultType="DefaultMap">
        /* RegistMapper.getMemberClassList */
        SELECT MEMBR_CLASS_CD AS VALUE,
               MEMBR_CLASS_NM AS NAME
          FROM TB_MB_MEMBER_CLASS
         WHERE USE_YN = 'Y'
           AND MEMBR_ORGN_CD = #{membrOrgnCd}
         ORDER BY DEFLT_YN DESC
    </select>


    <!-- 회원정보 조회 -->
    <!--
        TABLE    : TB_MB_MEMBER
        COMMENTS : 회원정보 리스트 조회
    -->
    <select id="getMemberList" parameterType="registVO" resultType="DefaultMap">
        /* RegistMapper.getMemberList */
        <include refid="CmmSQL.PagingTemplateHeader"/>
        SELECT tmm.MEMBR_NO,
               tmm.MEMBR_NM,
               tmm.MEMBR_CLASS_CD,
               tmmc.MEMBR_CLASS_NM,
               tmm.MEMBR_CARD_NO,
               tmm.SHORT_NO,
               tmm.MEMBR_ORGN_CD,
               tmm.REG_STORE_CD,
               tms.STORE_NM AS REG_STORE_NM,
               tmm.POST_NO,
               tmm.ADDR,
               tmm.ADDR_DTL,
               tmm.TEL_NO,
               tmm.EMAIL_ADDR,
               tmm.EMAIL_RECV_YN,
               tmm.BIRTHDAY,
               tmm.GENDR_FG,
               tmm.SMS_RECV_YN,
               tmm.WEDDING_YN,
               tmm.WEDDINGDAY,
               tmm.LUNAR_YN,
               tmm.USE_YN,
               tmm.MEMBR_NICKNM,
               tmm.MEMBER_ENG_NM,
               tmm.REMARK,
               '후불적용매장등록' AS CREDIT_STORE
        <include refid="CmmSQL.PagingTemplateCount"/>
          FROM TB_MB_MEMBER tmm,
               TB_MB_MEMBER_CLASS tmmc,
               TB_MS_STORE tms
         WHERE tmm.MEMBR_ORGN_CD = #{hqOfficeCd}
        <if test='orgnFg != null and orgnFg.toString() == "HQ"'>
           AND tmmc.MEMBR_ORGN_CD (+)= #{hqOfficeCd}
        </if>
        <if test='orgnFg != null and orgnFg.toString() == "STORE"'>
           AND tmmc.MEMBR_ORGN_CD (+)= #{storeCd}
        </if>
           AND tmmc.MEMBR_CLASS_CD (+)= tmm.MEMBR_CLASS_CD
           AND tms.HQ_OFFICE_CD = #{hqOfficeCd}
           AND tms.STORE_CD = tmm.REG_STORE_CD
           AND tmm.USE_YN = 'Y'
        <if test='storeCd != null and storeCd.toString() != ""'>
           AND tmm.REG_STORE_CD = #{storeCd}
        </if>
        <if test='membrCardNo != null and membrCardNo.toString() != ""'>
           AND tmm.MEMBR_CARD_NO = #{membrCardNo}
        </if>
        <if test='membrNo != null and membrNo.toString() != ""'>
           AND tmm.MEMBR_NO = #{membrNo}
        </if>
        <if test='membrNm != null and membrNm.toString() != ""'>
           AND tmm.MEMBR_NM = #{membrNm}
        </if>
        <if test='telNo != null and telNo.toString() != ""'>
           AND tmm.TEL_NO = #{telNo}
        </if>
        <if test='emailAddr != null and emailAddr.toString() != ""'>
           AND tmm.EMAIL_ADDR = #{emailAddr}
        </if>
        <if test='regStoreCd != null and regStoreCd.toString() != ""'>
           AND tmm.REG_STORE_CD IN
          <foreach collection="regStoreCds" item="item" open="("  separator="," close=")" >
            #{item}
          </foreach>
        </if>
        <if test='membrClassCd != null and membrClassCd.toString() != ""'>
           AND tmm.MEMBR_CLASS_CD = #{membrClassCd}
        </if>
        <if test='gendrFg != null and gendrFg.toString() != ""'>
           AND tmm.GENDR_FG = #{gendrFg}
        </if>
        <if test='emailRecvYn != null and emailRecvYn.toString() != ""'>
           AND tmm.EMAIL_RECV_YN = #{emailRecvYn}
        </if>
        <if test='smsRecvYn != null and smsRecvYn.toString() != ""'>
           AND tmm.SMS_RECV_YN = #{smsRecvYn}
        </if>
        <if test='periodType != null and periodType.toString() != ""'>
            <if test='periodType.getCode() == "reg"'>
           AND tmm.REG_DT BETWEEN #{periodStartDate}||'000000' AND #{periodEndDate}||'999999'
            </if>
            <if test='periodType.getCode() == "last"'>
            </if>
        </if>
        <if test='anvType != null and anvType.toString() != ""'>
            <if test='anvType.getCode() == "1"'>
          AND tmm.BIRTHDAY BETWEEN #{anvStartDate} AND #{anvEndDate}
            </if>
        </if>
         ORDER BY tmm.REG_DT DESC
        <include refid="CmmSQL.PagingTemplateBottom"/>
    </select>

    <!-- 회원정보 조회 -->
    <!--
        TABLE    : TB_MB_MEMBER
        COMMENTS : 회원정보 조회
    -->
    <select id="getMemberInfo" parameterType="registVO" resultType="DefaultMap">
        /* RegistMapper.getMemberInfo */
        SELECT tmm.MEMBR_ORGN_CD,
               tmm.MEMBR_NO,
               tmm.MEMBR_NM,
               tmm.MEMBR_NICKNM,
               tmm.MEMBR_CLASS_CD,
               tmm.MEMBR_CARD_NO,
               tmm.REG_STORE_CD,
               tmm.POST_NO,
               tmm.ADDR,
               tmm.ADDR_DTL,
               tmm.LUNAR_YN,
               tmm.BIRTHDAY,
               tmm.GENDR_FG,
               tmm.TEL_NO,
               tmm.SHORT_NO,
               tmm.WEDDING_YN,
               tmm.WEDDINGDAY,
               tmm.EMAIL_ADDR,
               tmm.EMAIL_RECV_YN,
               tmm.SMS_RECV_YN,
               tmm.REMARK,
               tmm.USE_YN,
               tmm.REG_DT,
               tmm.REG_ID,
               tmm.MOD_DT,
               tmm.MOD_ID
          FROM TB_MB_MEMBER tmm
         WHERE tmm.MEMBR_NO = #{membrNo}
           AND tmm.MEMBR_ORGN_CD = #{membrOrgnCd}
    </select>

    <!-- 회원정보 등록 -->
    <!--
        TABLE    : TB_MB_MEMBER
        COMMENTS : 회원정보 등록
    -->
    <insert id="registMemberInfo" parameterType="registVO">
        /* RegistMapper.registMemberInfo */
        <![CDATA[
        INSERT INTO TB_MB_MEMBER tmm (
            tmm.MEMBR_ORGN_CD,
            tmm.MEMBR_NO,
            tmm.MEMBR_NM,
            tmm.MEMBR_NICKNM,
            tmm.MEMBR_CLASS_CD,
            tmm.MEMBR_CARD_NO,
            tmm.REG_STORE_CD,
            tmm.POST_NO,
            tmm.ADDR,
            tmm.ADDR_DTL,
            tmm.BIRTHDAY,
            tmm.LUNAR_YN,
            tmm.GENDR_FG,
            tmm.EMAIL_ADDR,
            tmm.SHORT_NO,
            tmm.TEL_NO,
            tmm.WEDDING_YN,
            tmm.WEDDINGDAY,
            tmm.EMAIL_RECV_YN,
            tmm.SMS_RECV_YN,
            tmm.USE_YN,
            tmm.REMARK,
            tmm.REG_DT,
            tmm.REG_ID,
            tmm.MOD_DT,
            tmm.MOD_ID
        ) VALUES (
            #{membrOrgnCd},
            (SELECT LPAD( NVL(MAX(MEMBR_NO), 0) + 1, 10, '0') FROM TB_MB_MEMBER WHERE MEMBR_ORGN_CD = #{membrOrgnCd}),
            #{membrNm},
            #{membrNicknm},
            #{membrClassCd},
            #{membrCardNo},
            #{regStoreCd},
            #{postNo},
            #{addr},
            #{addrDtl},
            #{birthday},
            #{lunarYn},
            #{gendrFg},
            #{emailAddr},
            #{shortNo},
            #{telNo},
            #{weddingYn},
            #{weddingday},
            #{emailRecvYn},
            #{smsRecvYn},
            #{useYn},
            #{remark},
            #{regDt},
            #{regId},
            #{modDt},
            #{modId}
        )
        ]]>
    </insert>

    <!-- 회원정보 수정 -->
    <!--
        TABLE    : TB_MB_MEMBER
        COMMENTS : 회원정보 수정
    -->
    <update id="updateMemberInfo" parameterType="registVO">
        /* RegistMapper.updateMemberInfo */
        UPDATE TB_MB_MEMBER tmm
           SET tmm.MEMBR_NM = #{membrNm},
               tmm.MEMBR_NICKNM = #{membrNicknm},
               tmm.MEMBR_CLASS_CD = #{membrClassCd},
               tmm.MEMBR_CARD_NO = #{membrCardNo},
               tmm.REG_STORE_CD = #{regStoreCd},
               tmm.POST_NO = #{postNo},
               tmm.ADDR = #{addr},
               tmm.ADDR_DTL = #{addrDtl},
               tmm.BIRTHDAY = #{birthday},
               tmm.LUNAR_YN = #{lunarYn},
               tmm.GENDR_FG = #{gendrFg},
               tmm.EMAIL_ADDR = #{emailAddr},
               tmm.SHORT_NO = #{shortNo},
               tmm.TEL_NO = #{telNo},
               tmm.WEDDING_YN = #{weddingYn},
               tmm.WEDDINGDAY = #{weddingday},
               tmm.EMAIL_RECV_YN = #{emailRecvYn},
               tmm.SMS_RECV_YN = #{smsRecvYn},
               tmm.USE_YN = #{useYn},
               tmm.REMARK = #{remark},
               tmm.MOD_ID = #{modId},
               tmm.MOD_DT = #{modDt}
         WHERE tmm.MEMBR_NO = #{membrNo}
           AND tmm.MEMBR_ORGN_CD = #{membrOrgnCd}
    </update>

    <!-- 회원정보 삭제 -->
    <!--
        TABLE    : TB_MB_MEMBER
        COMMENTS : 회원정보 삭제 버튼 처리 USE_YN : N 으로 업데이트 처리
    -->
    <delete id="deleteMemberInfo" parameterType="registVO">
      /* RegistMapper.deleteMemberInfo */
      UPDATE TB_MB_MEMBER tmm
         SET tmm.USE_YN = 'N',
             tmm.MOD_ID = #{modId},
             tmm.MOD_DT = #{modDt}
       WHERE tmm.MEMBR_ORGN_CD = #{membrOrgnCd}
         AND tmm.MEMBR_NO = #{membrNo}
    </delete>

    <!-- 회원카드정보 추가 -->
    <!--
        TABLE    : TB_MB_MEMBER_CARD
        COMMENTS : 회원정보등록시 카드정보도 등록
    -->
    <insert id="insertMembrCard" parameterType="registVO">
        /* RegistMapper.insertMembrCard */
        INSERT INTO TB_MB_MEMBER_CARD tmmc (
            tmmc.MEMBR_CARD_NO,
            tmmc.MEMBR_ORGN_CD,
            tmmc.MEMBR_NO,
            tmmc.REG_ID,
            tmmc.REG_DT,
            tmmc.MOD_ID,
            tmmc.MOD_DT)
        VALUES (
            #{membrCardNo},
            #{membrOrgnCd},
            #{membrNo},
            #{regId},
            #{regDt},
            #{modId},
            #{modDt})
    </insert>

    <!-- 회원카드정보 수정 -->
    <!--
        TABLE    : TB_MB_MEMBER_CARD
        COMMENTS : 회원정보 수정시에 회원 카드번호 수정
    -->
    <update id="updateMembrCard" parameterType="registVO">
        /* RegistMapper.updateMembrCard */
        UPDATE TB_MB_MEMBER_CARD tmmc
           SET tmmc.MEMBR_CARD_NO = #{membrCardNo},
               tmmc.MOD_ID = #{modId},
               tmmc.MOD_DT = #{modDt}
         WHERE tmmc.MEMBR_ORGN_CD = #{membrOrgnCd}
           AND tmmc.MEMBR_NO = #{membrNo}
    </update>

    <!-- 후불회원 등록매장 조회 -->
    <!--
        TABLE    : TB_MB_MEMBER_CREDIT_STORE
        COMMENTS : 후불회원 적용매장 조회
    -->
    <select id="getRegStoreList" parameterType="creditStoreVO" resultType="DefaultMap">
        /* RegistMapper.getRegStoreList */
        SELECT tmbcs.HQ_OFFICE_CD,
               tmbcs.MEMBER_NO,
               tmbcs.CREDIT_STORE_CD,
               (SELECT STORE_NM FROM TB_MS_STORE WHERE STORE_CD = tmbcs.CREDIT_STORE_CD) CREDIT_STORE_NM
          FROM TB_MB_MEMBER_CREDIT_STORE tmbcs
         WHERE tmbcs.HQ_OFFICE_CD = #{hqOfficeCd}
           AND tmbcs.MEMBER_NO = #{memberNo}
        <if test='defaultStoreCd != null and defaultStoreCd.toString() != ""'>
           AND tmbcs.CREDIT_STORE_CD != #{defaultStoreCd}
        </if>
    </select>

    <!-- 후불회원 미등록매장 조회 -->
    <!--
        TABLE    : TB_MB_MEMBER_CREDIT_STORE
        COMMENTS : 후불회원 적용매장 조회
    -->
    <select id="getNoRegStoreList" parameterType="creditStoreVO" resultType="DefaultMap">
        /* RegistMapper.getNoRegStoreList */
        SELECT HQ_OFFICE_CD,
               STORE_CD AS CREDIT_STORE_CD,
               STORE_NM AS CREDIT_STORE_NM
          FROM TB_MS_STORE
         WHERE HQ_OFFICE_CD = #{hqOfficeCd}
           AND STORE_CD NOT IN (SELECT CREDIT_STORE_CD
                                  FROM TB_MB_MEMBER_CREDIT_STORE
                                 WHERE HQ_OFFICE_CD = #{hqOfficeCd}
                                   AND MEMBER_NO =  #{memberNo})
        <if test='defaultStoreCd != null and defaultStoreCd.toString() != ""'>
           AND STORE_CD != #{defaultStoreCd}
        </if>
    </select>

    <!-- 후불회원 적용매장 삭제 -->
    <!--
        TABLE    : TB_MB_MEMBER_CREDIT_STORE
        COMMENTS : 후불회원 적용매장 삭제
    -->
    <delete id="deleteCreditStore" parameterType="creditStoreVO">
        /* RegistMapper.deleteCreditStore */
        DELETE TB_MB_MEMBER_CREDIT_STORE
         WHERE HQ_OFFICE_CD = #{hqOfficeCd}
           AND MEMBER_NO = #{memberNo}
           AND CREDIT_STORE_CD = #{creditStoreCd}
    </delete>

    <!-- 후불회원 적용매장 등록 및 수정 -->
    <!--
        TABLE    : TB_MB_MEMBER_CREDIT_STORE
        COMMENTS : 후불회원 적용매장 등록 및 수정
    -->
    <insert id="registCreditStore" parameterType="creditStoreVO">
        /* RegistMapper.registCreditStore */
        INSERT INTO TB_MB_MEMBER_CREDIT_STORE(
            HQ_OFFICE_CD,
            MEMBER_NO,
            CREDIT_STORE_CD,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID
        ) VALUES (
            #{hqOfficeCd},
            #{memberNo},
            #{creditStoreCd},
            #{regDt},
            #{regId},
            #{modDt},
            #{modId}
        )
    </insert>
</mapper>
