<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    StoreView.xml
    매장정보조회
    ======================================================
    No  ||  수정자 ||  수정일자    ||  수정내역
    ======================================================
    1       김영근     2018.08.07     최초작성
-->

<mapper namespace="kr.co.solbipos.store.manage.storeview.service.impl.StoreViewMapper">

  <!-- 매장정보조회  -->
  <!--        
      TABLE    : TB_MS_STORE
      COMMENTS : 매장정보조회한다.
  -->
  <select id="getStoreViewList" parameterType="StoreViewVO" resultType="DefaultMap">
    /* USE : StoreViewMapper.getStoreViewList */
    <include refid="CmmSQL.PagingTemplateHeader"/>
    
    SELECT X.*
          <include refid="CmmSQL.PagingTemplateCount"/>
      FROM
      (
        SELECT TMS.HQ_OFFICE_CD,
               THO.HQ_OFFICE_NM,
               TMS.STORE_CD,
               TMS.STORE_NM,
               TMS.BIZ_NO,
               TMS.OWNER_NM,
               TMS.TEL_NO,
               TMS.SYS_STAT_FG,
               (SELECT TCN.NMCODE_NM FROM TB_CM_NMCODE TCN  WHERE TCN.NMCODE_GRP_CD='009' AND TCN.NMCODE_CD = TMS.SYS_STAT_FG) AS SYS_STAT_FG_NM,
               TMS.CLS_FG,
               (SELECT TCN.NMCODE_NM FROM TB_CM_NMCODE TCN  WHERE TCN.NMCODE_GRP_CD='003' AND TCN.NMCODE_CD = TMS.CLS_FG) AS CLS_FG_NM,
               (SELECT COUNT(TMP.STORE_CD) FROM TB_MS_POS TMP WHERE TMP.STORE_CD = TMS.STORE_CD AND TMP.USE_YN = 'Y') AS POS_CNT,
                TMS.AGENCY_CD,
               (SELECT TCA.AGENCY_NM FROM TB_CM_AGENCY TCA  WHERE TCA.AGENCY_CD = TMS.AGENCY_CD) AS AGENCY_NM,
               TMS.VAN_CD,
               (SELECT TCVC.VAN_NM FROM TB_CM_VAN_CMPNY TCVC  WHERE TCVC.VAN_CD = TMS.VAN_CD) AS VAN_NM,
               (SELECT TCED.ENVST_VAL_NM
                 FROM TB_CM_ENVST_DTL TCED
                WHERE TCED.ENVST_CD = '114'
                  AND TCED.ENVST_VAL_CD = NVL((SELECT TMSE.ENVST_VAL FROM TB_MS_STORE_ENVST TMSE WHERE TMSE.STORE_CD   = TMS.STORE_CD AND TMSE.ENVST_CD = '114' ), 0 )
               ) CORNER_USE_YN_NM,
               (SELECT MAX(TMPLL.LOGIN_DATE) FROM TB_MS_POS_LOGIN_LOG TMPLL WHERE TMPLL.STORE_CD = TMS.STORE_CD) AS POS_LAST_LOGIN_DT,
                TMS.SYS_OPEN_DATE,
                TMS.SYS_CLOSURE_DATE,
               TMS.REG_DT
          FROM TB_MS_STORE TMS, TB_HQ_OFFICE tho
         WHERE TMS.HQ_OFFICE_CD = THO.HQ_OFFICE_CD
        <if test='hqOfficeCd != null and hqOfficeCd != ""'>
           AND TMS.HQ_OFFICE_CD = #{hqOfficeCd}
        </if>
        <if test='hqOfficeNm != null and hqOfficeNm != ""'>
           AND THO.HQ_OFFICE_NM  LIKE '%'||#{hqOfficeNm}||'%'
        </if>
        <if test='storeCd != null and storeCd != ""'>
           AND TMS.STORE_CD = #{storeCd}
        </if>
        <if test='storeNm != null and storeNm != ""'>
           AND TMS.STORE_NM  LIKE '%'||#{storeNm}||'%'
        </if>
        <if test='bizNo != null and bizNo != ""'>
            AND TMS.BIZ_NO = #{bizNo}
        </if>
        <if test='sysStatFg != null and sysStatFg != ""'>
           AND TMS.SYS_STAT_FG = #{sysStatFg}
        </if>
        <if test='agencyCd != null and agencyCd != ""'>
           AND TMS.AGENCY_CD = #{agencyCd}
        </if>
        <if test='vanCd != null and vanCd != ""'>
           AND TMS.VAN_CD = #{vanCd}
        </if>
        <if test='dateType != null and dateType != ""'>
          <if test='dateType == "2"'>
           AND TMS.SYS_OPEN_DATE BETWEEN #{startDt} AND #{endDt}
          </if>
          <if test='dateType == "3"'>
           AND TMS.SYS_CLOSURE_DATE BETWEEN #{startDt} AND #{endDt}
          </if>
        </if>
      ) X
     <where>
       <if test='dateType != null and dateType != ""'>
          <if test='dateType == "1"'>
          AND X.POS_LAST_LOGIN_DT BETWEEN #{startDt} AND #{endDt}   
          </if>
       </if>
     </where>
     ORDER BY X.REG_DT DESC
     <include refid="CmmSQL.PagingTemplateBottom"/>
  </select>
</mapper>