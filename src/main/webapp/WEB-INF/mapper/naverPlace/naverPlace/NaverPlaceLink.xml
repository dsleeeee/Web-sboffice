<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    NaverPlaceLink.xml
    [네이버플레이스] - [네이버플레이스] - [네이버플레이스 연동] sql
    ======================================================
    No  ||  수정자 ||  수정일자    ||  수정내역
    ======================================================
    1       이다솜     2026.01.27
-->
<mapper namespace="kr.co.solbipos.naverPlace.naverPlace.naverPlaceLink.service.impl.NaverPlaceLinkMapper">

    <!-- 네이버 로그인 state 값 저장 -->
    <!--
        TABLE    : TB_TMP_NAVER_STATE
        PARAM    : naverPlaceLinkVO
        COMMENTS : 네이버 로그인 state 값을 저장한다.
    -->
    <insert id="saveNaverState" parameterType="naverPlaceLinkVO">
        /* NaverPlaceLinkMapper.saveNaverState */
        INSERT INTO TB_TMP_NAVER_STATE
        (
            HQ_OFFICE_CD
        ,   STORE_CD
        ,   USER_ID
        ,   STATE
        ,   REG_DT
        ,   REG_ID
        )
        VALUES
        (
            #{hqOfficeCd}
        ,   #{storeCd}
        ,   #{userId}
        ,   #{state}
        ,   #{regDt}
        ,   #{regId}
        )
    </insert>

    <!-- 네이버 로그인 state 값으로 기존 세션정보 조회 -->
    <!--
        TABLE    : TB_TMP_NAVER_STATE
        PARAM    : naverPlaceApiVO
        COMMENTS : 네이버 로그인 state 값으로 기존 세션정보를 조회한다.
    -->
    <select id="getNaverState" parameterType="naverPlaceApiVO" resultType="DefaultMap">
        /* NaverPlaceLinkMapper.getNaverState */
        SELECT  HQ_OFFICE_CD
        ,       STORE_CD
        ,       USER_ID
        ,       STATE
        FROM    TB_TMP_NAVER_STATE
        WHERE   STATE = #{state}
    </select>

    <!-- 네.아.로 Unique ID 저장 -->
    <!--
        TABLE    : TB_CM_NAVER_LINK
        PARAM    : naverPlaceLinkVO
        COMMENTS : 네.아.로 Unique ID를 저장한다.
    -->
    <update id="saveNaverUniqueId" parameterType="naverPlaceLinkVO">
        /* NaverPlaceLinkMapper.saveNaverUniqueId */
        MERGE INTO TB_CM_NAVER_LINK A
        USING DUAL
        ON (
                A.HQ_OFFICE_CD = #{hqOfficeCd}
            AND A.STORE_CD     = #{storeCd}
        )
        WHEN MATCHED THEN
        UPDATE
           SET A.UNIQUE_ID = #{uniqueId},
               A.LAST_RESPONSE_DT = #{lastResponseDt},
               A.MP_NO = #{mpNo},
               A.ETC01 = #{etc01},
               A.ETC02 = #{etc02},
               A.ETC03 = #{etc03},
               A.ETC04 = #{etc04},
               A.ETC05 = #{etc05},
               A.ETC06 = #{etc06},
               A.ETC07 = #{etc07},
               A.ETC08 = #{etc08},
               A.ETC09 = #{etc09},
               A.ETC10 = #{etc10},
               A.MOD_DT = #{modDt},
               A.MOD_ID = #{modId}
        WHEN NOT MATCHED THEN
        INSERT (
            A.HQ_OFFICE_CD,
            A.STORE_CD,
            A.UNIQUE_ID,
            A.LAST_RESPONSE_DT,
            A.MP_NO,
            A.ETC01,
            A.ETC02,
            A.ETC03,
            A.ETC04,
            A.ETC05,
            A.ETC06,
            A.ETC07,
            A.ETC08,
            A.ETC09,
            A.ETC10,
            A.REG_DT,
            A.REG_ID,
            A.MOD_DT,
            A.MOD_ID
        )
        VALUES (
            #{hqOfficeCd},
            #{storeCd},
            #{uniqueId},
            #{lastResponseDt},
            #{mpNo},
            #{etc01},
            #{etc02},
            #{etc03},
            #{etc04},
            #{etc05},
            #{etc06},
            #{etc07},
            #{etc08},
            #{etc09},
            #{etc10},
            #{regDt},
            #{regId},
            #{modDt},
            #{modId}
        )
    </update>

    <!-- 네.아.로 Unique ID 조회 -->
    <!--
        TABLE    : TB_CM_NAVER_LINK
        PARAM    : naverPlaceLinkVO
        COMMENTS : 네.아.로 Unique ID를 저장한다.
    -->
    <select id="getNaverUniqueId" parameterType="naverPlaceLinkVO" resultType="String">
         /* NaverPlaceLinkMapper.getNaverUniqueId */
        SELECT  UNIQUE_ID
        FROM    TB_CM_NAVER_LINK
        WHERE   HQ_OFFICE_CD = #{hqOfficeCd}
        AND     STORE_CD = #{storeCd}
    </select>

    <!-- 네이버 동의여부 저장 -->
    <!--
        TABLE    : TB_CM_NAVER_LINK_AGREEMENT
        PARAM    : naverPlaceLinkVO
        COMMENTS : 네이버 동의여부를 저장한다.
    -->
    <update id="saveNaverAgreement" parameterType="naverPlaceLinkVO">
        /* NaverPlaceLinkMapper.saveNaverAgreement */
        MERGE INTO TB_CM_NAVER_LINK_AGREEMENT A
        USING DUAL
        ON (
                A.HQ_OFFICE_CD = #{hqOfficeCd}
            AND A.STORE_CD = #{storeCd}
        )
        WHEN MATCHED THEN
        UPDATE
           SET A.UNIQUE_ID = #{uniqueId},
               A.LAST_RESPONSE_DT = #{lastResponseDt},
               A.AGREEMENT_TYPE = #{agreementType},
               A.MOD_DT = #{modDt},
               A.MOD_ID = #{modId}
        WHEN NOT MATCHED THEN
        INSERT (
            A.HQ_OFFICE_CD,
            A.STORE_CD,
            A.UNIQUE_ID,
            A.LAST_RESPONSE_DT,
            A.AGREEMENT_TYPE,
            A.REG_DT,
            A.REG_ID,
            A.MOD_DT,
            A.MOD_ID
        )
        VALUES (
            #{hqOfficeCd},
            #{storeCd},
            #{uniqueId},
            #{lastResponseDt},
            #{agreementType},
            #{regDt},
            #{regId},
            #{modDt},
            #{modId}
        )
    </update>

</mapper>
