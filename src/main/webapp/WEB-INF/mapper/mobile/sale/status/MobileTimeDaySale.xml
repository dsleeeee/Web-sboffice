<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    MobileTimeDaySale.xml
    (모바일) 매출현황 > 시간대별(일자별)매출현황
    ======================================================
    No  ||  수정자 ||  수정일자    ||  수정내역
    ======================================================
    1       김설아     2021.06.07     최초작성
-->
<mapper namespace="kr.co.solbipos.mobile.sale.status.timeDaySale.service.impl.MobileTimeDaySaleMapper">

    <!-- 일자-시간대별 - 조회 -->
    <!--
        TABLE    : TB_SL_DAILY_TIME
        COMMENTS : [매출]일별_시간대별
    -->
    <select id="getMobileTimeDaySaleDateTimeList" parameterType="MobileTimeDaySaleVO" resultType="DefaultMap">
        /* MobileTimeDaySaleMapper.getMobileTimeDaySaleDateTimeList */
        SELECT
        TO_CHAR(TO_DATE(SALE_DATE, 'YYYYMMDD'), 'YYYY-MM-DD') AS SALE_DATE
        ${sQuery2}
        FROM
        (
            SELECT
            tsdt.SALE_DATE
            ${sQuery1}
            FROM TB_SL_DAILY_TIME tsdt
            WHERE 1=1
            AND tsdt.HQ_OFFICE_CD = #{hqOfficeCd}
            <!-- 매장 -->
            <if test='orgnFg != null and orgnFg != "" and orgnFg == "S"'>
                AND tsdt.STORE_CD IN
                <foreach collection="arrStoreCd" item="item" open="("  separator="," close=")">
                    #{item}
                </foreach>
            </if>
            AND tsdt.SALE_DATE BETWEEN #{startDate} AND #{endDate}
            AND tsdt.SALE_HOUR BETWEEN #{startTime} AND #{endTime}
            GROUP BY tsdt.SALE_DATE, tsdt.SALE_HOUR
            ORDER BY tsdt.SALE_DATE, tsdt.SALE_HOUR
        )
        GROUP BY SALE_DATE
        ORDER BY SALE_DATE
    </select>

    <!-- 시간대별 - 조회 -->
    <!--
        TABLE    : TB_SL_DAILY_TIME
        COMMENTS : [매출]일별_시간대별
    -->
    <select id="getMobileTimeDaySaleTimeList" parameterType="MobileTimeDaySaleVO" resultType="DefaultMap">
        /* MobileTimeDaySaleMapper.getMobileTimeDaySaleTimeList */
        SELECT
        A.SALE_TIME,
        A.AMT_CNT,
        A.REAL_SALE_AMT,
        NVL(ROUND(A.REAL_SALE_AMT / DECODE(B.TOT_REAL_SALE_AMT, 0, null, B.TOT_REAL_SALE_AMT) * 100, 2), 0) AS AMT_RATE
        FROM
        (
            SELECT
            tsdt.SALE_HOUR AS SALE_TIME,
            NVL(SUM(tsdt.SALE_CNT), 0) AS AMT_CNT,
            NVL(SUM(tsdt.REAL_SALE_AMT), 0) AS REAL_SALE_AMT
            FROM TB_SL_DAILY_TIME tsdt
            WHERE 1=1
            AND tsdt.HQ_OFFICE_CD = #{hqOfficeCd}
            <!-- 매장 -->
            <if test='orgnFg != null and orgnFg != "" and orgnFg == "S"'>
                AND tsdt.STORE_CD IN
                <foreach collection="arrStoreCd" item="item" open="("  separator="," close=")">
                    #{item}
                </foreach>
            </if>
            AND tsdt.SALE_DATE BETWEEN #{startDate} AND #{endDate}
            AND tsdt.SALE_HOUR BETWEEN #{startTime} AND #{endTime}
            GROUP BY tsdt.SALE_HOUR
        ) A,
        (
            SELECT
            NVL(SUM(tsdt.REAL_SALE_AMT), 0) AS TOT_REAL_SALE_AMT
            FROM TB_SL_DAILY_TIME tsdt
            WHERE 1=1
            AND tsdt.HQ_OFFICE_CD = #{hqOfficeCd}
            <!-- 매장 -->
            <if test='orgnFg != null and orgnFg != "" and orgnFg == "S"'>
                AND tsdt.STORE_CD IN
                <foreach collection="arrStoreCd" item="item" open="("  separator="," close=")">
                    #{item}
                </foreach>
            </if>
            AND tsdt.SALE_DATE BETWEEN #{startDate} AND #{endDate}
        ) B
        ORDER BY A.SALE_TIME
    </select>

    <!-- 시간대별 - 차트 조회 -->
    <!--
        TABLE    : TB_SL_DAILY_TIME
        COMMENTS : [매출]일별_시간대별
    -->
    <select id="getMobileTimeDaySaleTimeChartList" parameterType="MobileTimeDaySaleVO" resultType="DefaultMap">
        /* MobileTimeDaySaleMapper.getMobileTimeDaySaleTimeChartList */
        SELECT
        (tsdt.SALE_HOUR || '시') AS SALE_TIME,
        NVL(SUM(tsdt.REAL_SALE_AMT), 0) AS REAL_SALE_AMT
        FROM TB_SL_DAILY_TIME tsdt
        WHERE 1=1
        AND tsdt.HQ_OFFICE_CD = #{hqOfficeCd}
        <!-- 매장 -->
        <if test='orgnFg != null and orgnFg != "" and orgnFg == "S"'>
            AND tsdt.STORE_CD IN
            <foreach collection="arrStoreCd" item="item" open="("  separator="," close=")">
                #{item}
            </foreach>
        </if>
        AND tsdt.SALE_DATE BETWEEN #{startDate} AND #{endDate}
        AND tsdt.SALE_HOUR BETWEEN #{startTime} AND #{endTime}
        GROUP BY tsdt.SALE_HOUR
        ORDER BY tsdt.SALE_HOUR
    </select>

</mapper>