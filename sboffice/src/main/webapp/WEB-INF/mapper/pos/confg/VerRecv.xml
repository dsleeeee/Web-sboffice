<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.solbipos.pos.persistence.confg.verrecv.VerRecvMapper">

  <select id="selectVerList" parameterType="verRecvVO" resultType="DefaultMap">
    /* VerRecvMapper.selectVerList */
    <![CDATA[
    SELECT *
      FROM (
      SELECT
             COUNT(1) OVER (PARTITION BY 1 ORDER BY 1) TOT_CNT,
             ROW_NUMBER() OVER(PARTITION BY 1 ORDER BY 1) RNUM,
             A.VER_SER_NO,
             A.VER_SER_NM,
             A.USE_YN,
             TO_CHAR(TO_DATE(A.REG_DT, 'YYYYMMDDHH24MISS'), 'YYYY.MM.DD HH24:MI:SS') REG_DT,
             A.REG_ID,
             TO_CHAR(TO_DATE(A.MOD_DT, 'YYYYMMDDHH24MISS'), 'YYYY.MM.DD HH24:MI:SS') MOD_DT,
             A.MOD_ID,
             B.REG_CNT,
             B.RECV_CNT
        FROM TB_CM_POS_VERSN A,
            (
       SELECT VER_SER_NO, 
              SUM(DECODE(VER_RECV_FG , '1' , 1, 0)) REG_CNT,
              SUM(DECODE(VER_RECV_FG , '2' , 1, 0)) RECV_CNT
         FROM TB_CM_POS_VERSN_STORE
        GROUP BY VER_SER_NO
             ) B
       WHERE B.VER_SER_NO = A.VER_SER_NO
      ]]>
        <if test='verSerNo != null and verSerNo != ""'>
         AND A.VER_SER_NO = #{verSerNo}
        </if>
        <if test='verSerNm != null and verSerNm != ""'>
         AND A.VER_SER_NM = #{verSerNm}
        </if>
       ORDER BY REG_DT DESC
           )
    <![CDATA[
     WHERE RNUM >= #{prev}
       AND RNUM <= #{next}
    ]]>
  </select>
  
  <select id="selectStoreList" parameterType="verRecvVO" resultType="DefaultMap">
    /* VerRecvMapper.selectStoreList */
    <![CDATA[
    SELECT *
      FROM (
      SELECT COUNT(1) OVER (PARTITION BY 1 ORDER BY 1) TOT_CNT,
             ROW_NUMBER() OVER(PARTITION BY 1 ORDER BY 1) RNUM,
             A.VER_SER_NO,
             A.STORE_CD,
             B.STORE_NM,
             A.VER_RECV_FG,
             TO_CHAR(TO_DATE(A.VER_RECV_DT, 'YYYYMMDDHH24MISS'), 'YYYY.MM.DD HH24:MI:SS') VER_RECV_DT,
             A.POS_IP,
             TO_CHAR(TO_DATE(A.REG_DT, 'YYYYMMDDHH24MISS'), 'YYYY.MM.DD HH24:MI:SS') REG_DT,
             A.REG_ID,
             TO_CHAR(TO_DATE(A.MOD_DT, 'YYYYMMDDHH24MISS'), 'YYYY.MM.DD HH24:MI:SS') MOD_DT,
             A.MOD_ID,
             A.POS_NO
        FROM TB_CM_POS_VERSN_STORE A,
             TB_MS_STORE B
      ]]>
       WHERE A.VER_SER_NO = #{verSerNo}
         AND B.STORE_CD = A.STORE_CD
       ORDER BY STORE_CD
           )
     <![CDATA[
     WHERE RNUM >= #{prev}
       AND RNUM <= #{next}
      ]]>
  </select>
  
  <select id="selectStoreRecvList" parameterType="verRecvVO" resultType="DefaultMap">
    /* VerRecvMapper.selectStoreRecvList */
    <![CDATA[
    SELECT A.HQ_OFFICE_CD,
           A.HQ_OFFICE_NM,
           B.STORE_CD,
           B.STORE_NM,
           C.POS_NO,
           C.POS_NM,
           C.POS_VER_NO LAST_VER,
           TO_CHAR(TO_DATE(D.LOGIN_DT, 'YYYYMMDDHH24MISS'), 'YYYY.MM.DD HH24:MI:SS') LAST_LOGIN_DT,
           D.LOGIN_IP LAST_LOGIN_IP,
           E.ENVST_VAL MAIN_YN,
           F.ENVST_VAL POS_FG,
           G.ENVST_VAL PAY_FG
      FROM TB_HQ_OFFICE A,
           TB_MS_STORE B,
           TB_MS_POS C,
           (
      SELECT ROW_NUMBER() OVER(PARTITION BY STORE_CD, POS_NO, POS_VER_NO ORDER BY LOGIN_DT DESC) AS SRNUM,
             STORE_CD,
             POS_NO,
             LOGIN_DT,
             LOGIN_IP
        FROM TB_MS_POS_LOGIN_LOG A
           ) D,
           TB_MS_POS_ENVST E,
           TB_MS_POS_ENVST F,
           TB_MS_POS_ENVST G
     WHERE B.HQ_OFFICE_CD = A.HQ_OFFICE_CD
       AND C.STORE_CD = B.STORE_CD
       AND D.SRNUM = 1
       AND D.STORE_CD = B.STORE_CD
       AND D.POS_NO = C.POS_NO
       AND E.STORE_CD = B.STORE_CD
       AND E.POS_NO = C.POS_NO
       AND E.ENVST_CD = '205'
       AND E.USE_YN = 'Y'
       AND F.STORE_CD = B.STORE_CD
       AND F.POS_NO = C.POS_NO
       AND F.ENVST_CD = '101'
       AND F.USE_YN = 'Y'
       AND G.STORE_CD = B.STORE_CD
       AND G.POS_NO = C.POS_NO
       AND G.ENVST_CD = '204'
       AND G.USE_YN = 'Y'
    ]]>
    <if test='hqOfficeCd != null and hqOfficeCd != ""'>
       AND A.HQ_OFFICE_CD = #{hqOfficeCd}
    </if>
    <if test='hqOfficeNm != null and hqOfficeNm != ""'>
       AND A.HQ_OFFICE_NM = #{hqOfficeNm}
    </if>
    <if test='storeCd != null and storeCd != ""'>
       AND B.STORE_CD = #{storeCd}
    </if>
    <if test='storeNm != null and storeNm != ""'>
       AND B.STORE_NM = #{storeNm}
    </if>
    <if test='lastVer != null and lastVer != ""'>
       AND C.POS_VER_NO = #{lastVer}
    </if>
     ORDER BY A.HQ_OFFICE_CD, B.STORE_CD 
  </select>
  
  <select id="selectStoreDtl" parameterType="verRecvVO" resultType="DefaultMap">
    /* VerRecvMapper.selectStoreDtl */
    <![CDATA[
    SELECT A.VER_SER_NO, 
         B.VER_SER_NM,
         B.PROG_FG,
         A.VER_RECV_FG,
         B.FILE_NM, 
         TO_CHAR(TO_DATE(B.REG_DT, 'YYYYMMDDHH24MISS'), 'YYYY.MM.DD HH24:MI:SS') REG_DT,
         TO_CHAR(TO_DATE(A.VER_RECV_DT, 'YYYYMMDDHH24MISS'), 'YYYY.MM.DD HH24:MI:SS') VER_RECV_DT
    FROM TB_CM_POS_VERSN_STORE A,
         TB_CM_POS_VERSN B
   WHERE A.STORE_CD = #{storeCd}
     AND B.VER_SER_NO = A.VER_SER_NO
     ]]>
  </select>
  
  <select id="selectVerStoreList" parameterType="verRecvVO" resultType="DefaultMap">
    /* VerRecvMapper.selectVerStoreList */
    <![CDATA[
    SELECT *
      FROM (
      SELECT COUNT(1) OVER (PARTITION BY 1 ORDER BY 1) TOT_CNT,
             ROW_NUMBER() OVER(PARTITION BY 1 ORDER BY 1) RNUM,
             A.VER_SER_NO,
             A.VER_SER_NM,
             A.PROG_FG,
             B.POS_CNT
        FROM TB_CM_POS_VERSN A,
             (
        SELECT VER_SER_NO, COUNT(POS_NO) POS_CNT
          FROM TB_CM_POS_VERSN_STORE
         GROUP BY VER_SER_NO     
              ) B
        WHERE B.VER_SER_NO = A.VER_SER_NO
    ]]>
      <if test='verSerNo != null and verSerNo != ""'>
          AND A.VER_SER_NO = #{verSerNo}
      </if>
      <if test='verSerNm != null and verSerNm != ""'>
          AND A.VER_SER_NM = #{verSerNm}
      </if>
        ORDER BY A.VER_SER_NO DESC
            )
    <![CDATA[
     WHERE RNUM >= #{prev}
       AND RNUM <= #{next}
    ]]>
  </select>
  
   
  <select id="selectVerStoreDtlList" parameterType="verRecvVO" resultType="DefaultMap">
    /* VerRecvMapper.selectVerStoreDtlList */
    <![CDATA[
    SELECT *
      FROM (
      SELECT COUNT(1) OVER (PARTITION BY 1 ORDER BY 1) TOT_CNT,
             ROW_NUMBER() OVER(PARTITION BY 1 ORDER BY 1) RNUM,
             A.VER_SER_NO,
             A.STORE_CD,
             B.STORE_NM,
             A.POS_NO,
             TO_CHAR(TO_DATE(A.VER_RECV_DT, 'YYYYMMDDHH24MISS'), 'YYYY.MM.DD HH24:MI:SS') VER_RECV_DT,
             A.POS_IP
        FROM TB_CM_POS_VERSN_STORE A,
             TB_MS_STORE B
       WHERE A.VER_SER_NO = #{verSerNo}
         AND B.STORE_CD = A.STORE_CD
          )
     WHERE RNUM >= #{prev}
       AND RNUM <= #{next}
  ]]>
  </select>
</mapper>