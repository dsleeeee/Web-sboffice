<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.solbipos.sale.status.table.service.impl.TableSaleMapper">

    <select id="getTableDayList" parameterType="tableSaleVO" resultType="DefaultMap">
        /* TableSaleMapper.getTableDayList */
        <include refid="CmmSQL.PagingTemplateHeader"/>
        SELECT STORE_CD
        , TO_CHAR(TO_DATE(SALE_DATE, 'yyyymmdd'), 'yyyy-mm-dd') AS SALE_DATE
        , TO_CHAR(TO_DATE(SALE_DATE, 'YYYYMMDD'), 'DY') SALE_DAY
        , NVL(SUM(REAL_SALE_AMT), 0) TOT_REAL_SALE_AMT
        , NVL(SUM(SALE_CNT), 0) TOT_SALE_CNT
        , NVL(SUM(TOT_GUEST_CNT), 0) TOT_GUEST_CNT
        ${sQuery1}
        <include refid="CmmSQL.PagingTemplateCount"/>
        FROM TB_SL_DAILY_TABLE TSDT
        WHERE 1 = 1
        AND HQ_OFFICE_CD = #{hqOfficeCd}
        <if test='arrTableCd != null and arrTableCd.length >= 0'>
            AND STORE_CD||'||'||TBL_CD IN
            <foreach collection="arrTableCd" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test='startDate != null and startDate != ""'>
            AND TSDT.SALE_DATE <![CDATA[>= ]]> #{startDate}
        </if>
        <if test='endDate != null and endDate != ""'>
            AND TSDT.SALE_DATE <![CDATA[<= ]]> #{endDate}
        </if>
        GROUP
        BY 	  STORE_CD, SALE_DATE
        ORDER
        BY    SALE_DATE DESC
        <include refid="CmmSQL.PagingTemplateBottom"/>
    </select>

    <select id="getTableDayExcelList" parameterType="tableSaleVO" resultType="DefaultMap">
        /* TableSaleMapper.getTableDayExcelList */
        SELECT TSDT.STORE_CD
        , TO_CHAR(TO_DATE(SALE_DATE, 'yyyymmdd'), 'yyyy-mm-dd') AS SALE_DATE
        , TO_CHAR(TO_DATE(SALE_DATE, 'YYYYMMDD'), 'DY') SALE_DAY
        , NVL(SUM(REAL_SALE_AMT), 0) TOT_REAL_SALE_AMT
        , NVL(SUM(SALE_CNT), 0) TOT_SALE_CNT
        , NVL(SUM(TOT_GUEST_CNT), 0) TOT_GUEST_CNT
        ${sQuery1}
        FROM TB_SL_DAILY_TABLE TSDT
        WHERE 1 = 1
        AND HQ_OFFICE_CD = #{hqOfficeCd}
        <if test='arrTableCd != null and arrTableCd.length >= 0'>
            AND STORE_CD||'||'||TBL_CD IN
            <foreach collection="arrTableCd" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test='startDate != null and startDate != ""'>
            AND TSDT.SALE_DATE <![CDATA[>= ]]> #{startDate}
        </if>
        <if test='endDate != null and endDate != ""'>
            AND TSDT.SALE_DATE <![CDATA[<= ]]> #{endDate}
        </if>
        GROUP
        BY    TSDT.STORE_CD, SALE_DATE
        ORDER
        BY    SALE_DATE DESC
    </select>

    <select id="getStoreTableList" parameterType="tableSaleVO" resultType="DefaultMap">
        /* TableSaleMapper.getStoreTableList */
        SELECT	TMP.STORE_CD||'||'||TMP.TBL_CD AS TABLE_CD
        , TMP.TBL_NM AS TABLE_NM
        , (SELECT STORE_NM FROM TB_MS_STORE WHERE STORE_CD = TMP.STORE_CD) AS STORE_NM
        , TMP.TBL_GRP_CD
        , TMP.TBL_CD	AS	TABLE_CD_ORG
        FROM    TB_MS_TABLE_V01 TMP
        WHERE	1=1
        AND EXISTS (SELECT * FROM TB_MS_STORE Z WHERE Z.STORE_CD = TMP.STORE_CD AND Z.HQ_OFFICE_CD = #{hqOfficeCd})
        <if test='arrStoreCd != null and arrStoreCd.length >= 0'>
            AND
            <foreach collection="arrStoreCd" item="item" open="(" close=")" separator="OR">
                TMP.STORE_CD = #{item}
            </foreach>
        </if>
        <if test='arrTableCd != null and arrTableCd.length >= 0'>
            AND TMP.STORE_CD||'||'||TMP.TBL_CD IN
            <foreach collection="arrTableCd" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        ORDER BY TMP.STORE_CD||'||'||TMP.TBL_CD
    </select>

    <select id="getTableDayOfWeekList" parameterType="tableSaleVO" resultType="DefaultMap">
        /* TableSaleMapper.getTableDayOfWeekList */
        SELECT 	TSDT.STORE_CD
        , TO_CHAR(TO_DATE(TSDT.SALE_DATE, 'YYYY-MM-DD'),'DY','NLS_DATE_LANGUAGE=korean') AS SALE_DAY
        , CASE TO_CHAR(TO_DATE(TSDT.SALE_DATE, 'YYYY-MM-DD'),'DY','NLS_DATE_LANGUAGE=korean')
        WHEN '일' THEN 1
        WHEN '월' THEN 2
        WHEN '화' THEN 3
        WHEN '수' THEN 4
        WHEN '목' THEN 5
        WHEN '금' THEN 6
        ELSE 7
        END AS DAY_ORDER
        , NVL(SUM(REAL_SALE_AMT), 0) TOT_REAL_SALE_AMT
        , NVL(SUM(SALE_CNT), 0) TOT_SALE_CNT
        , NVL(SUM(TOT_GUEST_CNT), 0) TOT_GUEST_CNT
        ${sQuery1}
        FROM TB_SL_DAILY_TABLE TSDT
        WHERE 1 = 1
        AND HQ_OFFICE_CD = #{hqOfficeCd}
        <if test='arrTableCd != null and arrTableCd != ""'>
            AND STORE_CD||'||'||TBL_CD IN
            <foreach collection="arrTableCd" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test='startDate != null and startDate != ""'>
            AND TSDT.SALE_DATE <![CDATA[>= ]]> #{startDate}
        </if>
        <if test='endDate != null and endDate != ""'>
            AND TSDT.SALE_DATE <![CDATA[<= ]]> #{endDate}
        </if>
        GROUP BY TSDT.STORE_CD, TO_CHAR(TO_DATE(TSDT.SALE_DATE, 'YYYY-MM-DD'),'DY','NLS_DATE_LANGUAGE=korean')
        ORDER BY DAY_ORDER
    </select>

    <select id="getTableMonthList" parameterType="tableSaleVO" resultType="DefaultMap">
        /* TableSaleMapper.getTableMonthList */
        <include refid="CmmSQL.PagingTemplateHeader"/>
        SELECT STORE_CD
        , TO_CHAR(TO_DATE(SALE_YM, 'YYYYMM'), 'YYYY-MM') AS SALE_YM
        , NVL(SUM(REAL_SALE_AMT), 0) TOT_REAL_SALE_AMT
        , NVL(SUM(SALE_CNT), 0) TOT_SALE_CNT
        , NVL(SUM(TOT_GUEST_CNT), 0) TOT_GUEST_CNT
        ${sQuery1}
        <include refid="CmmSQL.PagingTemplateCount"/>
        FROM TB_SL_MONTHLY_TABLE TSDT
        WHERE 1 = 1
        AND HQ_OFFICE_CD = #{hqOfficeCd}
        <if test='arrTableCd != null and arrTableCd.length >= 0'>
            AND STORE_CD||'||'||TBL_CD IN
            <foreach collection="arrTableCd" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test='startDate != null and startDate != ""'>
            AND TSDT.SALE_YM <![CDATA[>= ]]> #{startDate}
        </if>
        <if test='endDate != null and endDate != ""'>
            AND TSDT.SALE_YM <![CDATA[<= ]]> #{endDate}
        </if>
        GROUP
        BY 	  STORE_CD, SALE_YM
        ORDER
        BY    SALE_YM DESC
        <include refid="CmmSQL.PagingTemplateBottom"/>
    </select>

    <select id="getTableMonthExcelList" parameterType="tableSaleVO" resultType="DefaultMap">
        /* TableSaleMapper.getTableMonthExcelList */
        SELECT STORE_CD
        , TO_CHAR(TO_DATE(SALE_YM, 'YYYYMM'), 'YYYY-MM') AS SALE_YM
        , NVL(SUM(REAL_SALE_AMT), 0) TOT_REAL_SALE_AMT
        , NVL(SUM(SALE_CNT), 0) TOT_SALE_CNT
        , NVL(SUM(TOT_GUEST_CNT), 0) TOT_GUEST_CNT
        ${sQuery1}
        FROM TB_SL_MONTHLY_TABLE TSDT
        WHERE 1 = 1
        AND HQ_OFFICE_CD = #{hqOfficeCd}
        <if test='arrTableCd != null and arrTableCd.length >= 0'>
            AND STORE_CD||'||'||TBL_CD IN
            <foreach collection="arrTableCd" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        <if test='startDate != null and startDate != ""'>
            AND TSDT.SALE_YM <![CDATA[>= ]]> #{startDate}
        </if>
        <if test='endDate != null and endDate != ""'>
            AND TSDT.SALE_YM <![CDATA[<= ]]> #{endDate}
        </if>
        GROUP
        BY    STORE_CD, SALE_YM
        ORDER
        BY    SALE_YM DESC
    </select>

    <select id="getTableDayPeriodList" parameterType="tableSaleVO" resultType="DefaultMap">
        /* TableSaleMapper.getTableDayPeriodList */
        <include refid="CmmSQL.PagingTemplateHeader"/>
        SELECT TO_CHAR(TO_DATE(TSDT.SALE_DATE, 'yyyymmdd'), 'yyyy-mm-dd') AS SALE_DATE,
        TMTG.STORE_CD,
        TMS.STORE_NM,
        TMT.TBL_CD,
        TMT.TBL_NM,
        <!-- TMTG.TBL_GRP_NM, -->
        NVL(SUM(TSDT.SALE_CNT), 0) AS SALE_CNT,
        NVL(SUM((TSDT.TOT_GUEST_CNT)), 0) AS GUEST_CNT,
        NVL(SUM(TSDT.TOT_SALE_AMT), 0) AS TOT_SALE_AMT,
        NVL(SUM(TSDT.TOT_DC_AMT), 0) AS TOT_DC_AMT,
        NVL(SUM(TSDT.TOT_TIP_AMT), 0) AS TOT_TIP_AMT,
        NVL(SUM(TSDT.REAL_SALE_AMT), 0) AS REAL_SALE_AMT
        <include refid="CmmSQL.PagingTemplateCount"/>
        FROM TB_MS_TABLE_GROUP TMTG
        , TB_MS_TABLE_V01 TMT
        , TB_SL_DAILY_TABLE TSDT
        , TB_MS_STORE TMS
        WHERE TMS.HQ_OFFICE_CD = #{hqOfficeCd}
        AND TMTG.TBL_GRP_CD = TMT.TBL_GRP_CD
        AND TMT.TBL_CD = TSDT.TBL_CD
        AND TMT.STORE_CD = TSDT.STORE_CD
        AND TMTG.STORE_CD = TSDT.STORE_CD
        AND TMT.STORE_CD = TMS.STORE_CD
        <if test='storeCdQuery != null and storeCdQuery != ""'>
            AND TMTG.STORE_CD IN (${storeCdQuery})
        </if>
        <if test='orgnFg != null and orgnFg == "H"'>
            AND (
            'N' = (SELECT NVL(MAX(ENVST_VAL), 'N') FROM TB_HQ_ENVST WHERE HQ_OFFICE_CD = #{hqOfficeCd} AND ENVST_CD = '0001')
            OR	TMTG.STORE_CD IN (SELECT STORE_CD  FROM TB_HQ_EMPLOYEE_STORE_V08 WHERE HQ_OFFICE_CD = #{hqOfficeCd} AND EMP_NO = #{empNo})
            )
        </if>
        <if test='startDate != null and startDate != "" and endDate != null and endDate != ""'>
            <![CDATA[
   			  AND TSDT.SALE_DATE >= #{startDate}
   			  AND TSDT.SALE_DATE <= #{endDate}
   			  ]]>
        </if>
        GROUP BY TMTG.STORE_CD, TMS.STORE_NM, TSDT.SALE_DATE, TMT.TBL_CD, TMT.TBL_NM
        ORDER BY TSDT.SALE_DATE DESC, TMT.TBL_CD, TMT.TBL_NM
        <include refid="CmmSQL.PagingTemplateBottom"/>
    </select>

    <select id="getTableDayPeriodExcelList" parameterType="tableSaleVO" resultType="DefaultMap">
        /* TableSaleMapper.getTableDayPeriodExcelList */
        SELECT TO_CHAR(TO_DATE(TSDT.SALE_DATE, 'yyyymmdd'), 'yyyy-mm-dd') AS SALE_DATE,
        TMTG.STORE_CD,
        TMS.STORE_NM,
        TMT.TBL_CD,
        TMT.TBL_NM,
        <!-- TMTG.TBL_GRP_NM, -->
        NVL(SUM(TSDT.SALE_CNT), 0) AS SALE_CNT,
        NVL(SUM((TSDT.TOT_GUEST_CNT)), 0) AS GUEST_CNT,
        NVL(SUM(TSDT.TOT_SALE_AMT), 0) AS TOT_SALE_AMT,
        NVL(SUM(TSDT.TOT_DC_AMT), 0) AS TOT_DC_AMT,
        NVL(SUM(TSDT.TOT_TIP_AMT), 0) AS TOT_TIP_AMT,
        NVL(SUM(TSDT.REAL_SALE_AMT), 0) AS REAL_SALE_AMT
        FROM TB_MS_TABLE_GROUP TMTG
        , TB_MS_TABLE_V01 TMT
        , TB_SL_DAILY_TABLE TSDT
        , TB_MS_STORE TMS
        WHERE TMS.HQ_OFFICE_CD = #{hqOfficeCd}
        AND TMTG.TBL_GRP_CD = TMT.TBL_GRP_CD
        AND TMT.TBL_CD = TSDT.TBL_CD
        AND TMT.STORE_CD = TSDT.STORE_CD
        AND TMTG.STORE_CD = TSDT.STORE_CD
        AND TMT.STORE_CD = TMS.STORE_CD
        <if test='storeCdQuery != null and storeCdQuery != ""'>
            AND TMTG.STORE_CD IN (${storeCdQuery})
        </if>
        <if test='orgnFg != null and orgnFg == "H"'>
            AND (
            'N' = (SELECT NVL(MAX(ENVST_VAL), 'N') FROM TB_HQ_ENVST WHERE HQ_OFFICE_CD = #{hqOfficeCd} AND ENVST_CD = '0001')
            OR	TMTG.STORE_CD IN (SELECT STORE_CD  FROM TB_HQ_EMPLOYEE_STORE_V08 WHERE HQ_OFFICE_CD = #{hqOfficeCd} AND EMP_NO = #{empNo})
            )
        </if>
        <if test='startDate != null and startDate != "" and endDate != null and endDate != ""'>
            <![CDATA[
              AND TSDT.SALE_DATE >= #{startDate}
              AND TSDT.SALE_DATE <= #{endDate}
              ]]>
        </if>
        GROUP BY TMTG.STORE_CD, TMS.STORE_NM, TSDT.SALE_DATE, TMT.TBL_CD, TMT.TBL_NM
        ORDER BY TSDT.SALE_DATE DESC, TMT.TBL_CD, TMT.TBL_NM
    </select>


</mapper>