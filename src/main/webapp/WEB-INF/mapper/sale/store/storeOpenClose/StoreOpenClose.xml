<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.solbipos.sale.store.storeOpenClose.service.impl.StoreOpenCloseMapper">

    <!-- 매맘스터치 > 점포매출 > 매장 오픈/마감 현황 - 일별 탭 조회 -->
    <!--
        TABLE    : TB_SL_DAILY_TOTAL_ORDAPP
        PARAM    : storeOpenCloseVO
        COMMENTS : 매장 오픈/마감 현황 - 일별 데이터를 조회한다.
    -->
    <select id="getStoreOpenCloseDayList" parameterType="storeOpenCloseVO" resultType="DefaultMap">
        /* USE : StoreOpenCloseMapper.getStoreOpenCloseDayList */
            SELECT	A.TIME
            ,       A.MIN
            ,       A.MAX
            ,       #{saleDate} AS SALE_DATE
            ,		(	SELECT	COUNT(DISTINCT tpe.STORE_CD)
                        FROM	TB_PS_EXACTCALC tpe
                        ,       TB_MS_STORE tms
                        ,       TB_MS_STORE_INFO tmsi
                        WHERE   tpe.HQ_OFFICE_CD = tms.HQ_OFFICE_CD
                        AND     tpe.STORE_CD = tms.STORE_CD
                        AND     tpe.STORE_CD = tmsi.STORE_CD (+)
                        AND     tpe.HQ_OFFICE_CD = #{hqOfficeCd}
                        AND		tpe.SALE_DATE = #{saleDate}
                        AND     TPE.REG_SEQ = '00'
                        <if test='storeCds != null and storeCds != ""'>
                            AND
                            <foreach collection="storeCdList" item="item" open="(" close=")" separator="OR">
                                tpe.STORE_CD = #{item}
                            </foreach>
                        </if>
                        <if test='storeHqBrandCd != null and storeHqBrandCd != ""'>
                            AND tms.HQ_BRAND_CD = #{storeHqBrandCd} -- 매장브랜드 선택일때
                        </if>
                        <if test='storeHqBrandCd == null or storeHqBrandCd == ""'>
                            <if test='userBrands != null and userBrands != ""'>
                                -- 매장브랜드 전체일때
                                AND tms.HQ_BRAND_CD IN
                                <foreach collection="userBrandList" item="item" open=" (" separator="," close=")" >
                                    #{item}
                                </foreach>
                            </if>
                        </if>
                        <if test='momsTeam != null and momsTeam != ""'>
                            AND tmsi.MOMS_TEAM = #{momsTeam}
                        </if>
                        <if test='momsAcShop != null and momsAcShop != ""'>
                            AND tmsi.MOMS_AC_SHOP = #{momsAcShop}
                        </if>
                        <if test='momsAreaFg != null and momsAreaFg != ""'>
                            AND tmsi.MOMS_AREA_FG = #{momsAreaFg}
                        </if>
                        <if test='momsCommercial != null and momsCommercial != ""'>
                            AND tmsi.MOMS_COMMERCIAL = #{momsCommercial}
                        </if>
                        <if test='momsShopType != null and momsShopType != ""'>
                            AND tmsi.MOMS_SHOP_TYPE = #{momsShopType}
                        </if>
                        <if test='momsStoreManageType != null and momsStoreManageType != ""'>
                            AND tmsi.MOMS_STORE_MANAGE_TYPE = #{momsStoreManageType}
                        </if>
                        <if test='branchCd != null and branchCd != ""'>
                            AND tms.BRANCH_CD = #{branchCd}
                        </if>
                        AND		EXTRACT(HOUR FROM TO_TIMESTAMP(tpe.OPEN_DT, 'YYYYMMDDHH24MISS')) BETWEEN A.MIN AND A.MAX) AS OPEN_CNT
            ,		(	SELECT	COUNT(DISTINCT tpe.STORE_CD)
                        FROM	TB_PS_EXACTCALC tpe
                        ,       TB_MS_STORE tms
                        ,       TB_MS_STORE_INFO tmsi
                        WHERE   tpe.HQ_OFFICE_CD = tms.HQ_OFFICE_CD
                        AND     tpe.STORE_CD = tms.STORE_CD
                        AND     tpe.STORE_CD = tmsi.STORE_CD (+)
                        AND     tpe.HQ_OFFICE_CD = #{hqOfficeCd}
                        AND		tpe.SALE_DATE = #{saleDate}
                        AND     TPE.REG_SEQ = '00'
                        AND     tpe.CLOSE_FG    =   '2'
                        <if test='storeCds != null and storeCds != ""'>
                            AND
                            <foreach collection="storeCdList" item="item" open="(" close=")" separator="OR">
                                tpe.STORE_CD = #{item}
                            </foreach>
                        </if>
                        <if test='storeHqBrandCd != null and storeHqBrandCd != ""'>
                            AND tms.HQ_BRAND_CD = #{storeHqBrandCd} -- 매장브랜드 선택일때
                        </if>
                        <if test='storeHqBrandCd == null or storeHqBrandCd == ""'>
                            <if test='userBrands != null and userBrands != ""'>
                                -- 매장브랜드 전체일때
                                AND tms.HQ_BRAND_CD IN
                                <foreach collection="userBrandList" item="item" open=" (" separator="," close=")" >
                                    #{item}
                                </foreach>
                            </if>
                        </if>
                        <if test='momsTeam != null and momsTeam != ""'>
                            AND tmsi.MOMS_TEAM = #{momsTeam}
                        </if>
                        <if test='momsAcShop != null and momsAcShop != ""'>
                            AND tmsi.MOMS_AC_SHOP = #{momsAcShop}
                        </if>
                        <if test='momsAreaFg != null and momsAreaFg != ""'>
                            AND tmsi.MOMS_AREA_FG = #{momsAreaFg}
                        </if>
                        <if test='momsCommercial != null and momsCommercial != ""'>
                            AND tmsi.MOMS_COMMERCIAL = #{momsCommercial}
                        </if>
                        <if test='momsShopType != null and momsShopType != ""'>
                            AND tmsi.MOMS_SHOP_TYPE = #{momsShopType}
                        </if>
                        <if test='momsStoreManageType != null and momsStoreManageType != ""'>
                            AND tmsi.MOMS_STORE_MANAGE_TYPE = #{momsStoreManageType}
                        </if>
                        <if test='branchCd != null and branchCd != ""'>
                            AND tms.BRANCH_CD = #{branchCd}
                        </if>
                        AND		EXTRACT(HOUR FROM TO_TIMESTAMP(tpe.CLOSE_DT, 'YYYYMMDDHH24MISS')) BETWEEN A.MIN AND A.MAX) AS CLOSE_CNT
            FROM 	(
                <if test='optionFg != null and optionFg == "timeSlot"'>
                    SELECT  thn.NMCODE_NM || '(' ||  MIN(thn.NMCODE_CD) KEEP(DENSE_RANK FIRST ORDER BY thn.NMCODE_ITEM_1) || '~' ||LPAD(MAX(thn.NMCODE_CD) KEEP(DENSE_RANK LAST ORDER BY thn.NMCODE_ITEM_1) + 1, 2, '0') || ')' AS TIME
                    ,		MIN(thn.NMCODE_CD) KEEP(DENSE_RANK FIRST ORDER BY thn.NMCODE_ITEM_1) AS MIN
                    ,		LPAD(MAX(thn.NMCODE_CD) KEEP(DENSE_RANK LAST ORDER BY thn.NMCODE_ITEM_1), 2, '0') AS MAX
                    FROM 	TB_HQ_NMCODE thn
                    WHERE 	thn.HQ_OFFICE_CD = #{hqOfficeCd}
                    AND 	thn.NMCODE_GRP_CD = '001'
                    GROUP
                    BY      NMCODE_NM
                </if>
                <if test='optionFg != null and optionFg == "time"'>
                    SELECT 	LPAD(LEVEL-1, 2, '0') AS TIME
                    ,		LPAD(LEVEL-1, 2, '0') AS MIN
                    ,		LPAD(LEVEL-1, 2, '0') AS MAX
                    FROM	DUAL
                    CONNECT BY LEVEL <![CDATA[ <= ]]> 24
                </if>
        ) A
            ORDER BY A.MIN
    </select>

    <!-- 맘스터치 > 점포매출 > 매장 오픈/마감 현황 - 일별 상세 조회 -->
    <!--
        TABLE    : TB_SL_DAILY_TOTAL_ORDAPP
        PARAM    : storeOpenCloseVO
        COMMENTS : 매장 오픈/마감 현황 - 일별 상세 데이터를 조회한다.
    -->
    <select id="getStoreOpenCloseDayDtlList" parameterType="storeOpenCloseVO" resultType="DefaultMap">
        /* USE : StoreOpenCloseMapper.getStoreOpenCloseDayDtlList */
        SELECT  #{saleDate} AS SALE_DATE
        ,     	TPE.HQ_OFFICE_CD
        ,		TPE.STORE_CD
        ,       (SELECT STORE_NM FROM TB_MS_STORE WHERE STORE_CD = TPE.STORE_CD) AS STORE_NM
        ,		TPE.HQ_BRAND_CD AS BRAND
        ,		TPE.MOMS_TEAM
        ,		TPE.MOMS_AC_SHOP
        ,       TO_CHAR(TO_DATE(TPE.SALE_DATE, 'yyyymmdd'), 'yyyy-mm-dd') AS SALE_DATE
        ,       TO_CHAR(TO_DATE(TPE.OPEN_DT, 'YYYYMMDDHH24MISS'), 'HH24:MI:SS') AS OPEN_TIME
        ,       TO_CHAR(TO_DATE(TPE.CLOSE_DT, 'YYYYMMDDHH24MISS'), 'HH24:MI:SS') AS CLOSE_TIME
        ,       TPE.RUN_TIME
        ,       TPE.POS_NO
        ,       TPE.REG_SEQ
        ,       TPE.CLOSE_FG_SEQ
        ,       TPE.CLOSE_FG_NM
        ,       TO_CHAR(TO_DATE(TPE.REG_DT,'YYYYMMDDHH24MISS'),'YYYY.MM.DD HH24:MI:SS') AS REG_DT
        ----------------------------
        ,       NVL((SELECT SUM(NVL(TPES.TOT_SALE_AMT,0))
                    FROM    TB_PS_EXACTCALC_SALE TPES
                    WHERE   TPE.HQ_OFFICE_CD = TPES.HQ_OFFICE_CD
                    AND     TPE.HQ_BRAND_CD = TPES.HQ_BRAND_CD
                    AND     TPE.STORE_CD = TPES.STORE_CD
                    AND     TPE.SALE_DATE = TPES.SALE_DATE
                    AND     TPE.POS_NO = TPES.POS_NO
                    AND     TPE.REG_SEQ = TPES.REG_SEQ
                ),0) AS TOT_SALE_AMT
        ,       NVL((SELECT SUM(NVL(TPES.TOT_DC_AMT,0))
                    FROM TB_PS_EXACTCALC_SALE TPES
                    WHERE TPE.HQ_OFFICE_CD = TPES.HQ_OFFICE_CD
                    AND TPE.HQ_BRAND_CD = TPES.HQ_BRAND_CD
                    AND TPE.STORE_CD = TPES.STORE_CD
                    AND TPE.SALE_DATE = TPES.SALE_DATE
                    AND TPE.POS_NO = TPES.POS_NO
                    AND TPE.REG_SEQ = TPES.REG_SEQ
                ),0) AS TOT_DC_AMT
        ,       NVL((SELECT SUM(NVL(TPES.REAL_SALE_AMT,0))
                    FROM TB_PS_EXACTCALC_SALE TPES
                    WHERE TPE.HQ_OFFICE_CD = TPES.HQ_OFFICE_CD
                    AND TPE.HQ_BRAND_CD = TPES.HQ_BRAND_CD
                    AND TPE.STORE_CD = TPES.STORE_CD
                    AND TPE.SALE_DATE = TPES.SALE_DATE
                    AND TPE.POS_NO = TPES.POS_NO
                    AND TPE.REG_SEQ = TPES.REG_SEQ
                ),0) AS REAL_SALE_AMT
        ------------------------------
        ,       NVL((SELECT SUM(TPEF.FUND_AMT)
                    FROM TB_PS_EXACTCALC_FUND TPEF
                    WHERE TPE.HQ_OFFICE_CD = TPEF.HQ_OFFICE_CD
                    AND TPE.HQ_BRAND_CD = TPEF.HQ_BRAND_CD
                    AND TPE.STORE_CD = TPEF.STORE_CD
                    AND TPE.SALE_DATE = TPEF.SALE_DATE
                    AND TPE.POS_NO = TPEF.POS_NO
                    AND TPE.REG_SEQ = TPEF.REG_SEQ
                ),0) AS FUND_AMT
        ------------------------------     -- 기존 현금 금액 - 현금영수 금액
        ,       NVL((SELECT SUM(TPEC.CASH_EXACT_AMT)
                    FROM TB_PS_EXACTCALC_CASH TPEC --현금
                    WHERE TPE.HQ_OFFICE_CD = TPEC.HQ_OFFICE_CD
                    AND TPE.HQ_BRAND_CD = TPEC.HQ_BRAND_CD
                    AND TPE.STORE_CD = TPEC.STORE_CD
                    AND TPE.SALE_DATE = TPEC.SALE_DATE
                    AND TPE.POS_NO = TPEC.POS_NO
                    AND TPE.REG_SEQ = TPEC.REG_SEQ
                    AND TPEC.CASH_EXACT_CD = '02' <!-- 현금정산구분(NM_GRP_CD: 064) - [02 : 현금판매]  -->
                    )
                -
                    (SELECT	SUM(CASE WHEN TSSPC.APPR_PROC_FG IN ('1','2','4') THEN TSSPC.SALE_AMT ELSE 0 END)<!-- 현금영수증 -->
                    FROM	TB_SL_SALE_PAY_CASH TSSPC
                    WHERE	TPE.HQ_OFFICE_CD = TSSPC.HQ_OFFICE_CD
                    AND		TPE.HQ_BRAND_CD = TSSPC.HQ_BRAND_CD
                    AND		TPE.STORE_CD = TSSPC.STORE_CD
                    AND		TPE.SALE_DATE = TSSPC.SALE_DATE
                    -- 				AND		TPE.POS_NO = TSSPC.POS_NO
                    ), 0) AS CASH_EXACT_AMT
        ------------------------------ -- 기존 현금 금액이 없으면 현금영수 금액도 0원으로 출력
        ,           CASE WHEN NVL((SELECT SUM(TPEC.CASH_EXACT_AMT)
                        FROM TB_PS_EXACTCALC_CASH TPEC --현금
                        WHERE TPE.HQ_OFFICE_CD = TPEC.HQ_OFFICE_CD
                        AND TPE.HQ_BRAND_CD = TPEC.HQ_BRAND_CD
                        AND TPE.STORE_CD = TPEC.STORE_CD
                        AND TPE.SALE_DATE = TPEC.SALE_DATE
                        AND TPE.POS_NO = TPEC.POS_NO
                        AND TPE.REG_SEQ = TPEC.REG_SEQ
                        AND TPEC.CASH_EXACT_CD = '02' <!-- 현금정산구분(NM_GRP_CD: 064) - [02 : 현금판매]  -->
                        ), 0) = 0 THEN 0
                    ELSE
                        (NVL((SELECT SUM(CASE WHEN TSSPC.APPR_PROC_FG IN ('1','2','4') THEN TSSPC.SALE_AMT ELSE 0 END)
                        FROM TB_SL_SALE_PAY_CASH TSSPC
                        WHERE TPE.HQ_OFFICE_CD = TSSPC.HQ_OFFICE_CD
                        AND TPE.HQ_BRAND_CD = TSSPC.HQ_BRAND_CD
                        AND TPE.STORE_CD = TSSPC.STORE_CD
                        AND TPE.SALE_DATE = TSSPC.SALE_DATE
                        -- 					AND TPE.POS_NO = TSSPC.POS_NO
                        ),0))
                    END AS CASH_BILL_SALE_AMT
        ------------------------------
        ,           NVL((SELECT SUM(DECODE(TPEI.ACCNT_FG,'1',TPEI.ACCNT_AMT, 0))
                        FROM TB_PS_EXACTCALC_IOMONEY TPEI --시재
                        WHERE TPE.HQ_OFFICE_CD = TPEI.HQ_OFFICE_CD
                        AND TPE.HQ_BRAND_CD = TPEI.HQ_BRAND_CD
                        AND TPE.STORE_CD = TPEI.STORE_CD
                        AND TPE.SALE_DATE = TPEI.SALE_DATE
                        AND TPE.POS_NO = TPEI.POS_NO
                    ),0) AS ACCNT_IN_AMT
        ,           NVL((SELECT SUM(DECODE(TPEI.ACCNT_FG,'2',TPEI.ACCNT_AMT, 0))
                        FROM TB_PS_EXACTCALC_IOMONEY TPEI --시재
                        WHERE TPE.HQ_OFFICE_CD = TPEI.HQ_OFFICE_CD
                        AND TPE.HQ_BRAND_CD = TPEI.HQ_BRAND_CD
                        AND TPE.STORE_CD = TPEI.STORE_CD
                        AND TPE.SALE_DATE = TPEI.SALE_DATE
                        AND TPE.POS_NO = TPEI.POS_NO
                        AND TPE.REG_SEQ = TPEI.REG_SEQ
                    ),0) AS ACCNT_OUT_AMT
        ------------------------------
        ,           NVL((SELECT SUM(TPECT.CASH_TICKET_AMT)
                        FROM TB_PS_EXACTCALC_CASH_TICKET TPECT
                        WHERE TPE.HQ_OFFICE_CD = TPECT.HQ_OFFICE_CD
                        AND TPE.HQ_BRAND_CD = TPECT.HQ_BRAND_CD
                        AND TPE.STORE_CD = TPECT.STORE_CD
                        AND TPE.SALE_DATE = TPECT.SALE_DATE
                        AND TPE.POS_NO = TPECT.POS_NO
                        AND TPE.REG_SEQ = TPECT.REG_SEQ
                    ),0) AS CASH_TICKET_AMT
        ------------------------------
        ,           NVL((SELECT SUM(TPEL.LOST_AMT)
                        FROM TB_PS_EXACTCALC_LOST TPEL  --과부족
                        WHERE TPE.HQ_OFFICE_CD = TPEL.HQ_OFFICE_CD
                        AND TPE.HQ_BRAND_CD = TPEL.HQ_BRAND_CD
                        AND TPE.STORE_CD = TPEL.STORE_CD
                        AND TPE.SALE_DATE = TPEL.SALE_DATE
                        AND TPE.POS_NO = TPEL.POS_NO
                        AND TPE.REG_SEQ = TPEL.REG_SEQ
                    ),0) AS LOST_AMT
        ----------------------------
        FROM    (
                SELECT  TPE.CLOSE_FG_SEQ
                ,       DECODE(TPE.CLOSE_FG_SEQ, '1', '개점', '2', '중간마감', '일마감') AS CLOSE_FG_NM
                ,       TPE.HQ_OFFICE_CD
                ,       TPE.HQ_BRAND_CD
                ,       TPE.STORE_CD
                ,       TPE.MOMS_TEAM
                ,       TPE.MOMS_AC_SHOP
                ,       TPE.SALE_DATE
                ,       TPE.OPEN_DT
                ,       TPE.CLOSE_DT
                ,       TRUNC((TRUNC((TO_DATE(TPE.CLOSE_DT, 'YYYYMMDD HH24MISS') - TO_DATE(TPE.OPEN_DT, 'YYYYMMDD HH24MISS')) * 24 * 60, 2))/ 60) || '시간' ||	TRUNC(MOD(TRUNC((TO_DATE(TPE.CLOSE_DT, 'YYYYMMDD HH24MISS') - TO_DATE(TPE.OPEN_DT, 'YYYYMMDD HH24MISS')) * 24 * 60, 2), 60)) || '분' AS RUN_TIME
                ,       TPE.POS_NO
                ,       TPE.REG_SEQ
                ,       TPE.REG_DT
                FROM    (
                        SELECT  '1'  AS CLOSE_FG_SEQ
                        ,       '1'  AS CLOSE_POS_SEQ
                        ,       TPE.HQ_OFFICE_CD
                        ,       TPE.HQ_BRAND_CD
                        ,       TPE.STORE_CD
                        ,       tmsi.MOMS_TEAM
                        ,       tmsi.MOMS_AC_SHOP
                        ,       TPE.SALE_DATE
                        ,       TPE.OPEN_DT
                        ,       TPE.CLOSE_DT
                        ,       TPE.POS_NO
                        ,       TPE.REG_SEQ
                        ,       TPE.OPEN_DT   AS REG_DT
                        FROM    TB_PS_EXACTCALC TPE
                        ,       TB_MS_STORE tms
                        ,       TB_MS_STORE_INFO tmsi
                        WHERE   TPE.HQ_OFFICE_CD = tms.HQ_OFFICE_CD
                        AND     TPE.STORE_CD = tms.STORE_CD
                        AND     TPE.STORE_CD = tmsi.STORE_CD (+)
                        AND     TPE.HQ_OFFICE_CD = #{hqOfficeCd}
                        AND     TPE.SALE_DATE = #{saleDate}
                        <if test='storeCds != null and storeCds != ""'>
                            AND
                            <foreach collection="storeCdList" item="item" open="(" close=")" separator="OR">
                                TPE.STORE_CD = #{item}
                            </foreach>
                        </if>
                        <if test='storeHqBrandCd != null and storeHqBrandCd != ""'>
                            AND tms.HQ_BRAND_CD = #{storeHqBrandCd} -- 매장브랜드 선택일때
                        </if>
                        <if test='storeHqBrandCd == null or storeHqBrandCd == ""'>
                            <if test='userBrands != null and userBrands != ""'>
                                -- 매장브랜드 전체일때
                                AND tms.HQ_BRAND_CD IN
                                <foreach collection="userBrandList" item="item" open=" (" separator="," close=")" >
                                    #{item}
                                </foreach>
                            </if>
                        </if>
                        <if test='momsTeam != null and momsTeam != ""'>
                            AND tmsi.MOMS_TEAM = #{momsTeam}
                        </if>
                        <if test='momsAcShop != null and momsAcShop != ""'>
                            AND tmsi.MOMS_AC_SHOP = #{momsAcShop}
                        </if>
                        <if test='momsAreaFg != null and momsAreaFg != ""'>
                            AND tmsi.MOMS_AREA_FG = #{momsAreaFg}
                        </if>
                        <if test='momsCommercial != null and momsCommercial != ""'>
                            AND tmsi.MOMS_COMMERCIAL = #{momsCommercial}
                        </if>
                        <if test='momsShopType != null and momsShopType != ""'>
                            AND tmsi.MOMS_SHOP_TYPE = #{momsShopType}
                        </if>
                        <if test='momsStoreManageType != null and momsStoreManageType != ""'>
                            AND tmsi.MOMS_STORE_MANAGE_TYPE = #{momsStoreManageType}
                        </if>
                        <if test='branchCd != null and branchCd != ""'>
                            AND tms.BRANCH_CD = #{branchCd}
                        </if>
                        <if test='gubun != null and gubun != "" and gubun.toString() == "open"'>
                            AND EXTRACT(HOUR FROM TO_TIMESTAMP(tpe.OPEN_DT, 'YYYYMMDDHH24MISS')) BETWEEN #{min} AND #{max}
                        </if>
                        <if test='gubun != null and gubun != "" and gubun.toString() != "open"'>
                            AND 1 = 2
                        </if>
                        AND TPE.REG_SEQ = '00'
                        UNION ALL
                        SELECT  '3'  AS CLOSE_FG_SEQ
                        ,       '3'  AS CLOSE_POS_SEQ
                        ,       TPE.HQ_OFFICE_CD
                        ,       TPE.HQ_BRAND_CD
                        ,       TPE.STORE_CD
                        ,       tmsi.MOMS_TEAM
                        ,       tmsi.MOMS_AC_SHOP
                        ,       TPE.SALE_DATE
                        ,       TPE.OPEN_DT
                        ,       TPE.CLOSE_DT
                        ,       TPE.POS_NO
                        ,       TPE.REG_SEQ
                        ,       TPE.CLOSE_DT AS REG_DT
                        FROM    TB_PS_EXACTCALC TPE
                        ,       TB_MS_STORE tms
                        ,       TB_MS_STORE_INFO tmsi
                        WHERE   TPE.HQ_OFFICE_CD = tms.HQ_OFFICE_CD
                        AND     TPE.STORE_CD = tms.STORE_CD
                        AND     TPE.STORE_CD = tmsi.STORE_CD (+)
                        AND     TPE.HQ_OFFICE_CD = #{hqOfficeCd}
                        AND     TPE.SALE_DATE = #{saleDate}
                        <if test='storeCds != null and storeCds != ""'>
                            AND
                            <foreach collection="storeCdList" item="item" open="(" close=")" separator="OR">
                                TPE.STORE_CD = #{item}
                            </foreach>
                        </if>
                        <if test='storeHqBrandCd != null and storeHqBrandCd != ""'>
                            AND tms.HQ_BRAND_CD = #{storeHqBrandCd} -- 매장브랜드 선택일때
                        </if>
                        <if test='storeHqBrandCd == null or storeHqBrandCd == ""'>
                            <if test='userBrands != null and userBrands != ""'>
                                -- 매장브랜드 전체일때
                                AND tms.HQ_BRAND_CD IN
                                <foreach collection="userBrandList" item="item" open=" (" separator="," close=")" >
                                    #{item}
                                </foreach>
                            </if>
                        </if>
                        <if test='momsTeam != null and momsTeam != ""'>
                            AND tmsi.MOMS_TEAM = #{momsTeam}
                        </if>
                        <if test='momsAcShop != null and momsAcShop != ""'>
                            AND tmsi.MOMS_AC_SHOP = #{momsAcShop}
                        </if>
                        <if test='momsAreaFg != null and momsAreaFg != ""'>
                            AND tmsi.MOMS_AREA_FG = #{momsAreaFg}
                        </if>
                        <if test='momsCommercial != null and momsCommercial != ""'>
                            AND tmsi.MOMS_COMMERCIAL = #{momsCommercial}
                        </if>
                        <if test='momsShopType != null and momsShopType != ""'>
                            AND tmsi.MOMS_SHOP_TYPE = #{momsShopType}
                        </if>
                        <if test='momsStoreManageType != null and momsStoreManageType != ""'>
                            AND tmsi.MOMS_STORE_MANAGE_TYPE = #{momsStoreManageType}
                        </if>
                        <if test='branchCd != null and branchCd != ""'>
                            AND tms.BRANCH_CD = #{branchCd}
                        </if>
                        <if test='gubun != null and gubun != "" and gubun.toString() == "close"'>
                            AND EXTRACT(HOUR FROM TO_TIMESTAMP(tpe.CLOSE_DT, 'YYYYMMDDHH24MISS')) BETWEEN #{min} AND #{max}
                            AND tpe.CLOSE_FG    =   '2'
                        </if>
                        <if test='gubun != null and gubun != "" and gubun.toString() != "close"'>
                            AND 1 = 2
                        </if>
                        AND TPE.REG_SEQ = '00'
                        ) TPE
                ) TPE
        GROUP BY TPE.HQ_OFFICE_CD
        , TPE.HQ_BRAND_CD
        , TPE.STORE_CD
        , TPE.HQ_BRAND_CD
        , TPE.MOMS_TEAM
        , TPE.MOMS_AC_SHOP
        , TPE.SALE_DATE
        , TPE.OPEN_DT
        , TPE.CLOSE_DT
        , TPE.RUN_TIME
        , TPE.POS_NO
        , TPE.REG_SEQ
        , TPE.CLOSE_FG_SEQ
        , TPE.CLOSE_FG_NM
        , TPE.REG_DT
        ORDER BY TPE.STORE_CD, TPE.SALE_DATE, TPE.CLOSE_FG_SEQ
    </select>

    <!-- 맘스터치 > 점포매출 > 매장 오픈/마감 현황 - 일별 상세 조회 -->
    <!--
        TABLE    : TB_SL_DAILY_TOTAL_ORDAPP
        PARAM    : storeOpenCloseVO
        COMMENTS : 매장 오픈/마감 현황 - 일별 상세 데이터를 조회한다.
    -->
    <select id="getStoreOpenCloseDayDtlNoneList" parameterType="storeOpenCloseVO" resultType="DefaultMap">
    /** storeOpenCloseMapper.getStoreOpenCloseDayDtlNoneList */
        SELECT 	#{saleDate} AS SALE_DATE
        ,     	tms.STORE_CD
        ,       tms.STORE_NM
        ,       tms.HQ_BRAND_CD AS BRAND
        ,       tmsi.MOMS_TEAM
        ,       tmsi.MOMS_AC_SHOP
        FROM 	TB_MS_STORE tms
        ,       TB_MS_STORE_INFO tmsi
        WHERE 	tms.STORE_CD = tmsi.STORE_CD (+)
        AND     tms.HQ_OFFICE_CD = #{hqOfficeCd}
        AND 	tms.STORE_CD NOT IN (   SELECT	DISTINCT STORE_CD
                                        FROM	TB_PS_EXACTCALC tpe
                                        WHERE	tpe.HQ_OFFICE_CD = tms.HQ_OFFICE_CD
                                        AND		SALE_DATE = #{saleDate})
        <if test='storeHqBrandCd != null and storeHqBrandCd != ""'>
            AND tms.HQ_BRAND_CD = #{storeHqBrandCd} -- 매장브랜드 선택일때
        </if>
        <if test='storeHqBrandCd == null or storeHqBrandCd == ""'>
            <if test='userBrands != null and userBrands != ""'>
                -- 매장브랜드 전체일때
                AND tms.HQ_BRAND_CD IN
                <foreach collection="userBrandList" item="item" open=" (" separator="," close=")" >
                    #{item}
                </foreach>
            </if>
        </if>
        <if test='momsTeam != null and momsTeam != ""'>
            AND tmsi.MOMS_TEAM = #{momsTeam}
        </if>
        <if test='momsAcShop != null and momsAcShop != ""'>
            AND tmsi.MOMS_AC_SHOP = #{momsAcShop}
        </if>
        <if test='momsAreaFg != null and momsAreaFg != ""'>
            AND tmsi.MOMS_AREA_FG = #{momsAreaFg}
        </if>
        <if test='momsCommercial != null and momsCommercial != ""'>
            AND tmsi.MOMS_COMMERCIAL = #{momsCommercial}
        </if>
        <if test='momsShopType != null and momsShopType != ""'>
            AND tmsi.MOMS_SHOP_TYPE = #{momsShopType}
        </if>
        <if test='momsStoreManageType != null and momsStoreManageType != ""'>
            AND tmsi.MOMS_STORE_MANAGE_TYPE = #{momsStoreManageType}
        </if>
        <if test='branchCd != null and branchCd != ""'>
            AND tms.BRANCH_CD = #{branchCd}
        </if>
    </select>

    <!-- 맘스터치 > 점포매출 > 매장 오픈/마감 현황 - 월별 탭 조회 -->
    <!--
        TABLE    : TB_SL_DAILY_TOTAL_ORDAPP
        PARAM    : storeOpenCloseVO
        COMMENTS : 매장 오픈/마감 현황 - 월별 데이터를 조회한다.
    -->
    <select id="getStoreOpenCloseMonthList" parameterType="storeOpenCloseVO" resultType="DefaultMap">
        /* USE : StoreOpenCloseMapper.getStoreOpenCloseMonthList */
        SELECT  A.START_MONTH                   AS START_MONTH
        ,       A.END_MONTH                     AS END_MONTH
        ,       A.YYYYMMDD                      AS YYYYMMDD
        ,       A.OPEN_CNT                      AS OPEN_CNT
        ,       A.CLOSE_CNT                     AS CLOSE_CNT
        ,       A.STORE_CNT                     AS STORE_CNT
        ,       (A.STORE_CNT - A.OPEN_CNT)      AS NO_OPEN_CNT
        ,       (A.OPEN_CNT  - A.CLOSE_CNT)     AS NO_CLOSE_CNT
        FROM    (
                SELECT  #{startDate}                                                    AS START_MONTH
                ,       #{endDate}                                                      AS END_MONTH
                ,       TO_CHAR(TO_DATE(A.YYYYMMDD, 'YYYYMMDD'), 'YYYY-MM-DD')          AS YYYYMMDD
                ,       SUM(DECODE(C.REG_SEQ, '00', 1, 0))                              AS OPEN_CNT
                ,       SUM(DECODE(C.REG_SEQ, '00', DECODE(C.CLOSE_FG, '2', 1, 0), 0))  AS CLOSE_CNT
                ,       B.STORE_CNT                                                     AS STORE_CNT
                FROM    TB_CM_DATEM A
                ,       (
                        SELECT  tms.STORE_CD
                        ,       COUNT(*) OVER() AS STORE_CNT
                        FROM    TB_MS_STORE tms
                        ,       TB_MS_STORE_INFO tmsi
                        WHERE   tms.HQ_OFFICE_CD      =   'H0393'
                        AND     tmsi.STORE_CD      (+) =   tms.STORE_CD
                        <if test='storeHqBrandCd != null and storeHqBrandCd != ""'>
                            AND tms.HQ_BRAND_CD = #{storeHqBrandCd} -- 매장브랜드 선택일때
                        </if>
                        <if test='storeHqBrandCd == null or storeHqBrandCd == ""'>
                            <if test='userBrands != null and userBrands != ""'>
                                -- 매장브랜드 전체일때
                                AND tms.HQ_BRAND_CD IN
                                <foreach collection="userBrandList" item="item" open=" (" separator="," close=")" >
                                    #{item}
                                </foreach>
                            </if>
                        </if>
                        <if test='momsTeam != null and momsTeam != ""'>
                            AND tmsi.MOMS_TEAM = #{momsTeam}
                        </if>
                        <if test='momsAcShop != null and momsAcShop != ""'>
                            AND tmsi.MOMS_AC_SHOP = #{momsAcShop}
                        </if>
                        <if test='momsAreaFg != null and momsAreaFg != ""'>
                            AND tmsi.MOMS_AREA_FG = #{momsAreaFg}
                        </if>
                        <if test='momsCommercial != null and momsCommercial != ""'>
                            AND tmsi.MOMS_COMMERCIAL = #{momsCommercial}
                        </if>
                        <if test='momsShopType != null and momsShopType != ""'>
                            AND tmsi.MOMS_SHOP_TYPE = #{momsShopType}
                        </if>
                        <if test='momsStoreManageType != null and momsStoreManageType != ""'>
                            AND tmsi.MOMS_STORE_MANAGE_TYPE = #{momsStoreManageType}
                        </if>
                        <if test='branchCd != null and branchCd != ""'>
                            AND tms.BRANCH_CD = #{branchCd}
                        </if>
                        ) B
                        ,       TB_PS_EXACTCALC C
                WHERE   A.YYYYMMDD BETWEEN #{startDate} and #{endDate}
                AND     C.SALE_DATE     (+) =   A.YYYYMMDD
                AND     C.STORE_CD      (+) =   B.STORE_CD
                GROUP
                BY      A.YYYYMMDD
                ,       B.STORE_CNT
                ) A
        ORDER
        BY      A.YYYYMMDD
    </select>

    <!-- 맘스터치 > 점포매출 > 매장 오픈/마감 현황 - 월별 상세 조회 -->
    <!--
        TABLE    : TB_SL_DAILY_TOTAL_ORDAPP
        PARAM    : storeOpenCloseVO
        COMMENTS : 매장 오픈/마감 현황 - 월별 데이터를 조회한다.
    -->
    <select id="getStoreOpenCloseMonthDtlList" parameterType="storeOpenCloseVO" resultType="DefaultMap">
        /* USE : StoreOpenCloseMapper.getStoreOpenCloseMonthDtlList */
        SELECT 	#{startDate} AS START_MONTH
        ,       #{endDate} AS END_MONTH
        ,       TO_CHAR(TO_DATE(#{saleDate}, 'YYYYMMDD'), 'YYYY-MM-DD') AS SALE_DATE
        ,		tms.STORE_CD
        ,		tms.STORE_NM
        ,       tms.HQ_BRAND_CD AS BRAND
        ,       tmsi.MOMS_TEAM
        ,       tmsi.MOMS_AC_SHOP
        ,		tpe.POS_NO
        ,       TO_CHAR(TO_DATE(tpe.OPEN_DT, 'YYYYMMDDHH24MISS'), 'HH24:MI:SS') AS OPEN_TIME
        ,       TO_CHAR(TO_DATE(tpe.CLOSE_DT, 'YYYYMMDDHH24MISS'), 'HH24:MI:SS') AS CLOSE_TIME
        ,       NVL2(tpe.CLOSE_DT, TRUNC((TRUNC((TO_DATE(tpe.CLOSE_DT, 'YYYYMMDD HH24MISS') - TO_DATE(tpe.OPEN_DT, 'YYYYMMDD HH24MISS')) * 24 * 60, 2))/ 60) || '시간' ||	TRUNC(MOD(TRUNC((TO_DATE(tpe.CLOSE_DT, 'YYYYMMDD HH24MISS') - TO_DATE(tpe.OPEN_DT, 'YYYYMMDD HH24MISS')) * 24 * 60, 2), 60)) || '분', '') AS RUN_TIME
        ,       TO_CHAR(TO_DATE(TPE.REG_DT,'YYYYMMDDHH24MISS'),'YYYY.MM.DD HH24:MI:SS') AS REG_DT
                ----------------------------
        ,       NVL((SELECT SUM(NVL(TPES.TOT_SALE_AMT,0))
                     FROM   TB_PS_EXACTCALC_SALE TPES
                     WHERE  TPE.HQ_OFFICE_CD = TPES.HQ_OFFICE_CD
                     AND    TPE.HQ_BRAND_CD = TPES.HQ_BRAND_CD
                     AND    TPE.STORE_CD = TPES.STORE_CD
                     AND    TPE.SALE_DATE = TPES.SALE_DATE
                     AND    TPE.POS_NO = TPES.POS_NO
                     AND    TPE.REG_SEQ = TPES.REG_SEQ
                ),0) AS TOT_SALE_AMT
        ,       NVL((SELECT SUM(NVL(TPES.TOT_DC_AMT,0))
                     FROM   TB_PS_EXACTCALC_SALE TPES
                     WHERE  TPE.HQ_OFFICE_CD = TPES.HQ_OFFICE_CD
                     AND    TPE.HQ_BRAND_CD = TPES.HQ_BRAND_CD
                     AND    TPE.STORE_CD = TPES.STORE_CD
                     AND    TPE.SALE_DATE = TPES.SALE_DATE
                     AND    TPE.POS_NO = TPES.POS_NO
                     AND    TPE.REG_SEQ = TPES.REG_SEQ
                ),0) AS TOT_DC_AMT
        ,       NVL((SELECT SUM(NVL(TPES.REAL_SALE_AMT,0))
                     FROM   TB_PS_EXACTCALC_SALE TPES
                     WHERE  TPE.HQ_OFFICE_CD = TPES.HQ_OFFICE_CD
                     AND    TPE.HQ_BRAND_CD = TPES.HQ_BRAND_CD
                     AND    TPE.STORE_CD = TPES.STORE_CD
                     AND    TPE.SALE_DATE = TPES.SALE_DATE
                     AND    TPE.POS_NO = TPES.POS_NO
                     AND    TPE.REG_SEQ = TPES.REG_SEQ
                ),0) AS REAL_SALE_AMT
        ------------------------------
        ,       NVL((SELECT SUM(TPEF.FUND_AMT)
                     FROM   TB_PS_EXACTCALC_FUND TPEF
                     WHERE  TPE.HQ_OFFICE_CD = TPEF.HQ_OFFICE_CD
                     AND    TPE.HQ_BRAND_CD = TPEF.HQ_BRAND_CD
                     AND    TPE.STORE_CD = TPEF.STORE_CD
                     AND    TPE.SALE_DATE = TPEF.SALE_DATE
                     AND    TPE.POS_NO = TPEF.POS_NO
                     AND    TPE.REG_SEQ = TPEF.REG_SEQ
                ),0) AS FUND_AMT
        ------------------------------     -- 기존 현금 금액 - 현금영수 금액
        ,       NVL((SELECT SUM(TPEC.CASH_EXACT_AMT)
                     FROM   TB_PS_EXACTCALC_CASH TPEC --현금
                     WHERE  TPE.HQ_OFFICE_CD = TPEC.HQ_OFFICE_CD
                     AND    TPE.HQ_BRAND_CD = TPEC.HQ_BRAND_CD
                     AND    TPE.STORE_CD = TPEC.STORE_CD
                     AND    TPE.SALE_DATE = TPEC.SALE_DATE
                     AND    TPE.POS_NO = TPEC.POS_NO
                     AND    TPE.REG_SEQ = TPEC.REG_SEQ
                     AND    TPEC.CASH_EXACT_CD = '02' <!-- 현금정산구분(NM_GRP_CD: 064) - [02 : 현금판매]  -->
                     )
                     -
                    (SELECT SUM(CASE WHEN TSSPC.APPR_PROC_FG IN ('1','2','4') THEN TSSPC.SALE_AMT ELSE 0 END)<!-- 현금영수증 -->
                     FROM   TB_SL_SALE_PAY_CASH TSSPC
                     WHERE  TPE.HQ_OFFICE_CD = TSSPC.HQ_OFFICE_CD
                     AND    TPE.HQ_BRAND_CD = TSSPC.HQ_BRAND_CD
                     AND    TPE.STORE_CD = TSSPC.STORE_CD
                     AND    TPE.SALE_DATE = TSSPC.SALE_DATE
                     -- AND		TPE.POS_NO = TSSPC.POS_NO
                ), 0) AS CASH_EXACT_AMT
        ------------------------------ -- 기존 현금 금액이 없으면 현금영수 금액도 0원으로 출력
        ,       CASE WHEN NVL((SELECT SUM(TPEC.CASH_EXACT_AMT)
                                FROM TB_PS_EXACTCALC_CASH TPEC --현금
                                WHERE TPE.HQ_OFFICE_CD = TPEC.HQ_OFFICE_CD
                                AND TPE.HQ_BRAND_CD = TPEC.HQ_BRAND_CD
                                AND TPE.STORE_CD = TPEC.STORE_CD
                                AND TPE.SALE_DATE = TPEC.SALE_DATE
                                AND TPE.POS_NO = TPEC.POS_NO
                                AND TPE.REG_SEQ = TPEC.REG_SEQ
                                AND TPEC.CASH_EXACT_CD = '02' <!-- 현금정산구분(NM_GRP_CD: 064) - [02 : 현금판매]  -->
                                ), 0) = 0 THEN 0
                ELSE
                (NVL((SELECT SUM(CASE WHEN TSSPC.APPR_PROC_FG IN ('1','2','4') THEN TSSPC.SALE_AMT ELSE 0 END)
                FROM TB_SL_SALE_PAY_CASH TSSPC
                WHERE TPE.HQ_OFFICE_CD = TSSPC.HQ_OFFICE_CD
                AND TPE.HQ_BRAND_CD = TSSPC.HQ_BRAND_CD
                AND TPE.STORE_CD = TSSPC.STORE_CD
                AND TPE.SALE_DATE = TSSPC.SALE_DATE
                -- 					AND TPE.POS_NO = TSSPC.POS_NO
                ),0))
                END AS CASH_BILL_SALE_AMT
        ------------------------------
        ,       NVL((SELECT SUM(DECODE(TPEI.ACCNT_FG,'1',TPEI.ACCNT_AMT, 0))
                FROM TB_PS_EXACTCALC_IOMONEY TPEI --시재
                WHERE TPE.HQ_OFFICE_CD = TPEI.HQ_OFFICE_CD
                AND TPE.HQ_BRAND_CD = TPEI.HQ_BRAND_CD
                AND TPE.STORE_CD = TPEI.STORE_CD
                AND TPE.SALE_DATE = TPEI.SALE_DATE
                AND TPE.POS_NO = TPEI.POS_NO
                ),0) AS ACCNT_IN_AMT
        ,       NVL((SELECT SUM(DECODE(TPEI.ACCNT_FG,'2',TPEI.ACCNT_AMT, 0))
                FROM TB_PS_EXACTCALC_IOMONEY TPEI --시재
                WHERE TPE.HQ_OFFICE_CD = TPEI.HQ_OFFICE_CD
                AND TPE.HQ_BRAND_CD = TPEI.HQ_BRAND_CD
                AND TPE.STORE_CD = TPEI.STORE_CD
                AND TPE.SALE_DATE = TPEI.SALE_DATE
                AND TPE.POS_NO = TPEI.POS_NO
                AND TPE.REG_SEQ = TPEI.REG_SEQ
                ),0) AS ACCNT_OUT_AMT
        ------------------------------
        ,       NVL((SELECT SUM(TPECT.CASH_TICKET_AMT)
                FROM TB_PS_EXACTCALC_CASH_TICKET TPECT
                WHERE TPE.HQ_OFFICE_CD = TPECT.HQ_OFFICE_CD
                AND TPE.HQ_BRAND_CD = TPECT.HQ_BRAND_CD
                AND TPE.STORE_CD = TPECT.STORE_CD
                AND TPE.SALE_DATE = TPECT.SALE_DATE
                AND TPE.POS_NO = TPECT.POS_NO
                AND TPE.REG_SEQ = TPECT.REG_SEQ
                ),0) AS CASH_TICKET_AMT
        ------------------------------
        ,       NVL((SELECT SUM(TPEL.LOST_AMT)
                FROM TB_PS_EXACTCALC_LOST TPEL  --과부족
                WHERE TPE.HQ_OFFICE_CD = TPEL.HQ_OFFICE_CD
                AND TPE.HQ_BRAND_CD = TPEL.HQ_BRAND_CD
                AND TPE.STORE_CD = TPEL.STORE_CD
                AND TPE.SALE_DATE = TPEL.SALE_DATE
                AND TPE.POS_NO = TPEL.POS_NO
                AND TPE.REG_SEQ = TPEL.REG_SEQ
                ),0) AS LOST_AMT
        ------------------------------
        FROM	TB_MS_STORE tms
        ,       TB_MS_STORE_INFO tmsi
        ,       TB_PS_EXACTCALC tpe
        WHERE 	tms.HQ_OFFICE_CD = #{hqOfficeCd}
        AND 	tms.STORE_CD = tmsi.STORE_CD(+)
        AND 	tms.HQ_OFFICE_CD = tpe.HQ_OFFICE_CD(+)
        AND 	tms.STORE_CD = tpe.STORE_CD(+)
        AND 	#{saleDate} = tpe.SALE_DATE(+)
        AND     '00' = TPE.REG_SEQ(+)
        <if test='storeCds != null and storeCds != ""'>
            AND
            <foreach collection="storeCdList" item="item" open="(" close=")" separator="OR">
                tms.STORE_CD = #{item}
            </foreach>
        </if>
        <if test='storeHqBrandCd != null and storeHqBrandCd != ""'>
            AND tms.HQ_BRAND_CD = #{storeHqBrandCd} -- 매장브랜드 선택일때
        </if>
        <if test='storeHqBrandCd == null or storeHqBrandCd == ""'>
            <if test='userBrands != null and userBrands != ""'>
                -- 매장브랜드 전체일때
                AND tms.HQ_BRAND_CD IN
                <foreach collection="userBrandList" item="item" open=" (" separator="," close=")" >
                    #{item}
                </foreach>
            </if>
        </if>
        <if test='momsTeam != null and momsTeam != ""'>
            AND tmsi.MOMS_TEAM = #{momsTeam}
        </if>
        <if test='momsAcShop != null and momsAcShop != ""'>
            AND tmsi.MOMS_AC_SHOP = #{momsAcShop}
        </if>
        <if test='momsAreaFg != null and momsAreaFg != ""'>
            AND tmsi.MOMS_AREA_FG = #{momsAreaFg}
        </if>
        <if test='momsCommercial != null and momsCommercial != ""'>
            AND tmsi.MOMS_COMMERCIAL = #{momsCommercial}
        </if>
        <if test='momsShopType != null and momsShopType != ""'>
            AND tmsi.MOMS_SHOP_TYPE = #{momsShopType}
        </if>
        <if test='momsStoreManageType != null and momsStoreManageType != ""'>
            AND tmsi.MOMS_STORE_MANAGE_TYPE = #{momsStoreManageType}
        </if>
        <if test='branchCd != null and branchCd != ""'>
            AND tms.BRANCH_CD = #{branchCd}
        </if>
        ORDER BY tms.STORE_CD
    </select>

</mapper>
