<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    View.xml
    매장정보 조회 sql
    ======================================================
    No  ||  수정자 ||  수정일자    ||  수정내역
    ======================================================
    1       김영근     2018.08.13      최초작성
-->
<mapper namespace="kr.co.solbipos.base.store.view.service.impl.ViewMapper">

  <!-- 매장정보조회  -->
  <!--        
      TABLE    : TB_MS_STORE
      COMMENTS : 매장정보조회한다.
  -->
  <select id="getViewList" parameterType="viewVO" resultType="DefaultMap">
    /* USE : ViewMapper.getViewList */
    <include refid="CmmSQL.PagingTemplateHeader"/>
    SELECT TMS.STORE_CD,
           TMS.STORE_NM,
           DECODE(TMS.HQ_OFFICE_CD, '00000', '단독', '가맹') AS STORE_TYPE_NM,
           TMS.CLS_FG,
           (SELECT TCN.NMCODE_NM FROM TB_CM_NMCODE TCN  WHERE TCN.NMCODE_GRP_CD='003' AND TCN.NMCODE_CD = TMS.CLS_FG) AS CLS_FG_NM,
           TMS.BIZ_NO,
           TMS.OWNER_NM,
           TMS.TEL_NO,
           TMS.MP_NO,
           TMS.POST_NO || ') ' || TMS.ADDR || TMS.ADDR_DTL AS ADDRESS,
           TMS.SYS_STAT_FG,
           (SELECT TCN.NMCODE_NM FROM TB_CM_NMCODE TCN  WHERE TCN.NMCODE_GRP_CD='009' AND TCN.NMCODE_CD = TMS.SYS_STAT_FG) AS SYS_STAT_FG_NM,
           (SELECT TMP.POS_VER_NO FROM TB_MS_POS TMP WHERE TMP.STORE_CD = TMS.STORE_CD AND TMP.POS_NO = '01' AND TMP.USE_YN = 'Y') AS POS_VER_NO,
           TMS.SYS_OPEN_DATE,
           TMS.SYS_CLOSURE_DATE
           <include refid="CmmSQL.PagingTemplateCount"/>
      FROM TB_MS_STORE TMS
     WHERE TMS.HQ_OFFICE_CD = #{hqOfficeCd}
       <if test='storeCd != null and storeCd != ""'>
       AND TMS.STORE_CD = #{storeCd}
       </if>
       <if test='storeNm != null and storeNm != ""'>
       AND TMS.STORE_NM  LIKE '%'||#{storeNm}||'%'
       </if>
       <if test='storeType != null and storeType != ""'>
         <if test='storeType == "1"'>
         AND TMS.HQ_OFFICE_CD = '00000'
        </if>
        <if test='storeType == "2"'>
        AND TMS.HQ_OFFICE_CD != '00000'
        </if>
       </if>
       <if test='clsFg != null and clsFg != ""'>
       AND TMS.CLS_FG = #{clsFg}
       </if>
       <if test='sysStatFg != null and sysStatFg != ""'>
       AND TMS.SYS_STAT_FG = #{sysStatFg}
       </if>
  ORDER BY TMS.REG_DT DESC
     <include refid="CmmSQL.PagingTemplateBottom"/>
  </select>
  
  
  
  <!-- 매장정보상세조회  -->
  <!--        
      TABLE    : TB_MS_STORE, TB_MS_STORE_ENVST
      COMMENTS : 매장정보상세조회한다.
  -->
  <select id="getViewDetail" parameterType="viewVO" resultType="DefaultMap">
    /* USE : ViewMapper.getViewDetail */
    SELECT  X.*,
            (SELECT TCED.ENVST_VAL_NM FROM TB_CM_ENVST_DTL TCED WHERE TCED.ENVST_CD = '114' AND TCED.ENVST_VAL_CD = X.CORNER_USE_YN ) CORNER_USE_YN_NM,
            (SELECT TCED.ENVST_VAL_NM FROM TB_CM_ENVST_DTL TCED WHERE TCED.ENVST_CD = '276' AND TCED.ENVST_VAL_CD = X.CASH_BILL_YN ) CASH_BILL_YN_NM
      FROM
      (
        SELECT  TMS.STORE_CD,
                TMS.STORE_NM,
                DECODE(TMS.HQ_OFFICE_CD, '00000', '단독', '가맹') AS STORE_TYPE_NM,
                TMS.CLS_FG,
                (SELECT TCN.NMCODE_NM FROM TB_CM_NMCODE TCN  WHERE TCN.NMCODE_GRP_CD='003' AND TCN.NMCODE_CD = TMS.CLS_FG) AS CLS_FG_NM,
                TMS.SYS_STAT_FG,
                (SELECT TCN.NMCODE_NM FROM TB_CM_NMCODE TCN  WHERE TCN.NMCODE_GRP_CD='009' AND TCN.NMCODE_CD = TMS.SYS_STAT_FG) AS SYS_STAT_FG_NM,
                (SELECT COUNT(TMP.STORE_CD) FROM TB_MS_POS TMP WHERE TMP.STORE_CD = TMS.STORE_CD AND TMP.USE_YN = 'Y') AS POS_CNT,
                TMS.SYS_OPEN_DATE,
                TMS.SYS_CLOSURE_DATE,
                TMS.BIZ_STORE_NM,
                TMS.OWNER_NM,
                TMS.BIZ_NO,
                TMS.TEL_NO,
                TMS.MP_NO,
                TMS.FAX_NO,
                TMS.EMAIL_ADDR,
                TMS.HMPG_ADDR,
                TMS.POST_NO || ') ' || TMS.ADDR || TMS.ADDR_DTL AS ADDRESS,
                TMS.AREA_CD,
                (SELECT TCN.NMCODE_NM FROM TB_CM_NMCODE TCN  WHERE TCN.NMCODE_GRP_CD='092' AND TCN.NMCODE_CD = TMS.AREA_CD) AS AREA_NM,
                TMS.VAN_CD,
                (SELECT TCVC.VAN_NM FROM TB_CM_VAN_CMPNY TCVC  WHERE TCVC.VAN_CD = TMS.VAN_CD) AS VAN_NM,
                TMS.AGENCY_CD,
                (SELECT AGENCY_NM FROM TB_CM_AGENCY TMA WHERE TMA.AGENCY_CD = TMS.AGENCY_CD) AGENCY_NM,
                TMS.SYS_REMARK,
                TMS.HD_REMARK,
                TMS.REMARK,
                NVL((SELECT TMSE.ENVST_VAL FROM TB_MS_STORE_ENVST TMSE WHERE TMSE.STORE_CD   = TMS.STORE_CD AND TMSE.ENVST_CD = '114' ), 0 ) CORNER_USE_YN,
                NVL((SELECT TMSE.ENVST_VAL FROM TB_MS_STORE_ENVST TMSE WHERE TMSE.STORE_CD   = TMS.STORE_CD AND TMSE.ENVST_CD = '276' ), 0 ) CASH_BILL_YN
          FROM  TB_MS_STORE TMS
         WHERE  TMS.STORE_CD = #{storeCd}
       ) X
 
  </select>
  
  <!--
      TABLE    : TB_MS_STORE, TB_MS_CORNER
      PARAM    : vanConfigVO
      COMMENTS : 밴사설정 정보 조회
  -->
  <select id="getVanconfgList" parameterType="vanConfigVO" resultType="DefaultMap">
    /* USE : ViewMapper.getVanconfgList */
    SELECT  TMS.STORE_CD,
            TMS.STORE_NM,
            TMC.CORNR_CD,
            TMC.CORNR_NM,
            TMC.OWNER_NM,
            TMC.BIZ_NO,
            TMC.TEL_NO,
            TMC.VAN_CD,
            (SELECT TCVC.VAN_NM FROM TB_CM_VAN_CMPNY TCVC WHERE TCVC.VAN_CD = TMC.VAN_CD) VAN_NM,
            TMC.VAN_TERMNL_NO,
            TMC.VAN_SER_NO,
            TMC.USE_YN
      FROM  TB_MS_STORE TMS,
            TB_MS_CORNER TMC  
     WHERE  TMS.STORE_CD = TMC.STORE_CD(+)
       AND  TMS.STORE_CD = #{storeCd}
       AND  TMC.CORNR_CD (+)= '00'
  </select>
  
  
  
   <!-- 코너별 승인 목록 조회 -->
  <select id="getCornrApproveList" parameterType="DefaultMap" resultType="DefaultMap">
    /* USE : StoreManageMapper.getCornrApproveList */
    <![CDATA[
    SELECT TMC.STORE_CD,
           TMC.CORNR_CD,
           TMC.CORNR_NM,
           TMC.OWNER_NM,
           TMC.BIZ_NO,
           TMC.TEL_NO,
           TMC.VAN_CD,
           TMC.VAN_TERMNL_NO,
           TMC.VAN_SER_NO,
           TMC.USE_YN,
           DECODE(TMC.USE_YN, 'Y', '사용','N', '미사용', TMC.USE_YN) USE_YN_NM,
           TMC.REG_DT,
           TMC.REG_ID,
           TMC.MOD_DT,
           TMC.MOD_ID
      FROM TB_MS_CORNER TMC
     WHERE TMC.STORE_CD = #{storeCd}
       AND TMC.CORNR_CD <> '00'
     ORDER BY TMC.CORNR_CD
      ]]>
  </select>

  <!-- 포스별 승인 목록 조회 -->
  <select id="getPosApproveList" parameterType="DefaultMap" resultType="DefaultMap">
    /* USE : StoreManageMapper.getPosApproveList */
    <![CDATA[
     SELECT TMP.STORE_CD,
            TMP.POS_NO,
            TMP.POS_NM,
            TMP.HW_AUTH_KEY,
            NVL2(TMP.HW_AUTH_KEY, '인증', '미인증') HW_AUTH_KEY_NM,
            TMP.POS_VER_NO,
            TMP.USE_YN,
            TMP.REMARK,
            TMP.REG_DT,
            TMP.REG_ID,
            TMP.MOD_DT,
            TMP.MOD_ID
       FROM TB_MS_POS TMP
      WHERE TMP.STORE_CD = #{storeCd}
        AND TMP.USE_YN = 'Y'
      ORDER BY TMP.POS_NO
      ]]>
  </select>
</mapper>