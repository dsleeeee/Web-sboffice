<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    DlvrProd.xml
    배달 시스템 상품 명칭 맵핑
    ======================================================
    No  ||  수정자 ||  수정일자    ||  수정내역
    ======================================================
    1       이다솜     2020.10.14     최초작성
-->

<mapper namespace="kr.co.solbipos.base.prod.dlvrProd.service.impl.DlvrProdMapper">

    <!-- 배달시스템 상품 명칭 매핑 - 배달앱구분코드 -->
    <!--
        TABLE    : TB_CM_NMCODE
        PARAM    : dlvrProdVO
        COMMENTS : 배달앱 구분코드를 조회한다.
    -->
    <select id="getDlvrColList" parameterType="dlvrProdVO" resultType="DefaultMap">
        /* USE : DlvrProdMapper.getDlvrColList */
        SELECT  tcn.NMCODE_CD AS DLVR_CD,
                tcn.NMCODE_NM AS DLVR_NM
        FROM TB_CM_NMCODE tcn
        WHERE tcn.NMCODE_GRP_CD = '112'
          AND tcn.NMCODE_CD NOT IN ('1') /* 코드 1(포스앱)은 포스에서 사용하는 코드이므로 나오지 않도록 함 */
        ORDER BY TO_NUMBER(tcn.NMCODE_CD)

    </select>

    <!-- 배달시스템 상품 명칭 매핑 - 상품목록조회 -->
    <!--
        TABLE    : TB_HQ_PRODUCT, TB_HQ_PRODUCT_DLVR_PROD_NM
                   TB_MS_PRODUCT, TB_MS_PRODUCT_DLVR_PROD_NM
        PARAM    : dlvrProdVO
        COMMENTS : 상품 목록을 조회한다. ( 본사/매장 )
    -->
    <select id="getProdList" parameterType="dlvrProdVO" resultType="DefaultMap">
        /* USE : DlvrProdMapper.getProdList */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                <include refid="CmmSQL.PagingTemplateHeader"/>
                SELECT thp.PROD_CD,
                thp.PROD_NM,
                <foreach collection="arrDlvrCol" item="item" separator=",">
                    thpdpn.DLVR_PROD_NM_${item}
                </foreach>
                <include refid="CmmSQL.PagingTemplateCount"/>
                FROM TB_HQ_PRODUCT thp,
                ( SELECT *
                FROM (
                SELECT HQ_OFFICE_CD,
                PROD_CD,
                DLVR_NAME_CD,
                DLVR_PROD_NM,
                REG_DT
                FROM TB_HQ_PRODUCT_DLVR_PROD_NM
                )
                PIVOT (
                MIN(DLVR_PROD_NM)
                FOR DLVR_NAME_CD
                IN (${pivotDlvrCol})
                )
                ) thpdpn
                WHERE thpdpn.HQ_OFFICE_CD (+)= thp.HQ_OFFICE_CD
                AND thpdpn.PROD_CD (+)= thp.PROD_CD
                AND thp.HQ_OFFICE_CD = #{hqOfficeCd}
                <if test="chkDt == false">
                   <if test="startDate != null and startDate != '' and endDate != null and endDate != ''">
                       <if test="regDtType != null and regDtType == 'prod'">
                           <![CDATA[
                           AND thp.REG_DT BETWEEN #{startDate}||'000000' AND #{endDate}||'235959'
                           ]]>
                       </if>
                       <if test="regDtType != null and regDtType == 'dlvrProdNm'">
                           <![CDATA[
                           AND thpdpn.REG_DT BETWEEN #{startDate}||'000000' AND #{endDate}||'235959'
                           ]]>
                       </if>
                   </if>
               </if>
                <if test="prodCd != null and prodCd != ''">
                    AND thp.PROD_CD LIKE '%'||#{prodCd}||'%' --상품코드
                </if>
                <if test="prodNm != null and prodNm != ''">
                    AND thp.PROD_NM LIKE '%'||#{prodNm}||'%' --상품명
                </if>
                <if test="barCd != null and barCd != ''">
                    AND EXISTS (
                    SELECT 1
                    FROM TB_HQ_PRODUCT_BARCD
                    WHERE HQ_OFFICE_CD = thp.HQ_OFFICE_CD
                    AND PROD_CD = thp.PROD_CD
                    AND BARCD_CD = #{barCd}
                    ) --바코드
                </if>
                <if test="prodClassCd != null and prodClassCd != ''">
                    AND thp.PROD_CLASS_CD IN (
                    SELECT PROD_CLASS_CD
                    FROM TB_HQ_PRODUCT_CLASS
                    WHERE HQ_OFFICE_CD = #{hqOfficeCd}
                    START WITH PROD_CLASS_CD = #{prodClassCd} AND HQ_OFFICE_CD = #{hqOfficeCd}
                    CONNECT BY
                    PRIOR PROD_CLASS_CD = P_PROD_CLASS_CD  AND HQ_OFFICE_CD = #{hqOfficeCd}
                    )
                </if>
                <if test="useYn != null and useYn != ''">
                    AND thp.USE_YN = #{useYn} --사용여부
                </if>
                AND (
                ( ((SELECT COUNT(HQ_BRAND_CD) FROM TB_WB_USER_BRAND WHERE USER_ID = #{userId}) != 0) AND (thp.HQ_BRAND_CD IN (SELECT HQ_BRAND_CD FROM TB_WB_USER_BRAND WHERE USER_ID = #{userId})) )
                OR
                ( ((SELECT COUNT(HQ_BRAND_CD) FROM TB_WB_USER_BRAND WHERE USER_ID = #{userId}) = 0) AND 1=1 )
                )
                ORDER BY thp.PROD_CD ASC
                <include refid="CmmSQL.PagingTemplateBottom"/>
            </when>
            <!-- 가맹점 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                <include refid="CmmSQL.PagingTemplateHeader"/>
                SELECT tmp.PROD_CD,
                tmp.PROD_NM,
                <foreach collection="arrDlvrCol" item="item" separator=",">
                    tmpdpn.DLVR_PROD_NM_${item}
                </foreach>
                <include refid="CmmSQL.PagingTemplateCount"/>
                FROM TB_MS_PRODUCT tmp,
                (  SELECT *
                FROM (
                SELECT STORE_CD,
                PROD_CD,
                DLVR_NAME_CD,
                DLVR_PROD_NM
                FROM TB_MS_PRODUCT_DLVR_PROD_NM
                )
                PIVOT (
                MIN(DLVR_PROD_NM)
                FOR DLVR_NAME_CD
                IN (${pivotDlvrCol})
                )
                ) tmpdpn
                WHERE tmpdpn.STORE_CD (+)= tmp.STORE_CD
                AND tmpdpn.PROD_CD (+)= tmp.PROD_CD
                AND tmp.STORE_CD = #{storeCd}
                <if test="chkDt == false">
                    <if test="startDate != null and startDate != '' and endDate != null and endDate != ''">
                        <![CDATA[
                        AND tmp.REG_DT BETWEEN #{startDate}||'000000' AND #{endDate}||'235959'
                        ]]>
                    </if>
                </if>
                <if test="prodCd != null and prodCd != ''">
                    AND tmp.PROD_CD LIKE '%'||#{prodCd}||'%' --상품코드
                </if>
                <if test="prodNm != null and prodNm != ''">
                    AND tmp.PROD_NM LIKE '%'||#{prodNm}||'%' --상품명
                </if>
                <if test="barCd != null and barCd != ''">
                    AND EXISTS (
                    SELECT 1
                    FROM TB_MS_PRODUCT_BARCD
                    WHERE STORE_CD = tmp.STORE_CD
                    AND PROD_CD = tmp.PROD_CD
                    AND BARCD_CD = #{barCd}
                    ) --바코드
                </if>
                <if test="prodClassCd != null and prodClassCd != ''">
                    AND tmp.PROD_CLASS_CD IN (
                    SELECT PROD_CLASS_CD
                    FROM TB_MS_PRODUCT_CLASS
                    WHERE STORE_CD = #{storeCd}
                    START WITH PROD_CLASS_CD = #{prodClassCd} AND STORE_CD = #{storeCd}
                    CONNECT BY
                    PRIOR PROD_CLASS_CD = P_PROD_CLASS_CD AND STORE_CD = #{storeCd}
                    )
                </if>
                <if test="useYn != null and useYn != ''">
                    AND tmp.USE_YN = #{useYn} --사용여부
                </if>
                AND (
                ( ((SELECT COUNT(HQ_BRAND_CD) FROM TB_WB_USER_BRAND WHERE USER_ID = #{userId}) != 0) AND (tmp.HQ_BRAND_CD IN (SELECT HQ_BRAND_CD FROM TB_WB_USER_BRAND WHERE USER_ID = #{userId})) )
                OR
                ( ((SELECT COUNT(HQ_BRAND_CD) FROM TB_WB_USER_BRAND WHERE USER_ID = #{userId}) = 0) AND 1=1 )
                )
                ORDER BY tmp.PROD_CD ASC
                <include refid="CmmSQL.PagingTemplateBottom"/>
            </when>
        </choose>
    </select>

    <!-- 배달시스템 상품 명칭 매핑 - 배달상품명칭삭제 -->
    <!--
        TABLE    : TB_HQ_PRODUCT, TB_HQ_PRODUCT_DLVR_PROD_NM
                   TB_MS_PRODUCT, TB_MS_PRODUCT_DLVR_PROD_NM
        PARAM    : dlvrProdVO
        COMMENTS : 기존 배달상품명칭을 삭제한다. ( 본사/매장 )
    -->
    <delete id="deleteDlvrProdNm" parameterType="dlvrProdVO">
        /* DlvrProdMapper.deleteDlvrProdNm */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                DELETE
                FROM TB_HQ_PRODUCT_DLVR_PROD_NM
                WHERE HQ_OFFICE_CD = #{hqOfficeCd}
                AND PROD_CD = #{prodCd}
                AND DLVR_NAME_CD = #{dlvrNameCd}
            </when>
            <!-- 가맹점 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                DELETE
                FROM TB_MS_PRODUCT_DLVR_PROD_NM
                WHERE STORE_CD = #{storeCd}
                AND PROD_CD = #{prodCd}
                AND DLVR_NAME_CD = #{dlvrNameCd}
            </when>
        </choose>
    </delete>

    <!-- 배달시스템 상품 명칭 매핑 - 배달상품명칭등록 -->
    <!--
        TABLE    : TB_HQ_PRODUCT, TB_HQ_PRODUCT_DLVR_PROD_NM
                   TB_MS_PRODUCT, TB_MS_PRODUCT_DLVR_PROD_NM
        PARAM    : dlvrProdVO
        COMMENTS : 배달상품명칭을 등록한다. ( 본사/매장 )
    -->
    <insert id="insertDlvrProdNm" parameterType="dlvrProdVO">
        /* DlvrProdMapper.insertDlvrProdNm */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                INSERT INTO TB_HQ_PRODUCT_DLVR_PROD_NM
                (
                HQ_OFFICE_CD,
                PROD_CD,
                DLVR_NAME_CD,
                DLVR_PROD_NM,
                REG_ID,
                REG_DT,
                MOD_ID,
                MOD_DT
                )
                VALUES
                (
                #{hqOfficeCd},
                #{prodCd},
                #{dlvrNameCd},
                #{dlvrProdNm},
                #{regId},
                #{regDt},
                #{modId},
                #{modDt}
                )
            </when>
            <!-- 가맹점 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                INSERT INTO TB_MS_PRODUCT_DLVR_PROD_NM
                (
                STORE_CD,
                PROD_CD,
                DLVR_NAME_CD,
                DLVR_PROD_NM,
                REG_ID,
                REG_DT,
                MOD_ID,
                MOD_DT
                )
                VALUES
                (
                #{storeCd},
                #{prodCd},
                #{dlvrNameCd},
                #{dlvrProdNm},
                #{regId},
                #{regDt},
                #{modId},
                #{modDt}
                )
            </when>
        </choose>
    </insert>

    <!-- 배달시스템 상품 명칭 매핑 - 배달상품명칭 복사 전 기존데이터 삭제 -->
    <!--
        TABLE    : TB_MS_PRODUCT_DLVR_PROD_NM
        PARAM    : dlvrProdVO
        COMMENTS : 기준매장의 배달상품명칭을 복사하기 전 적용대상매장의 배달상품명칭을 삭제한다.
    -->
    <delete id="deleteStoreDlvrProdNm" parameterType="dlvrProdVO">
        /* DlvrProdMapper.deleteAllDlvrProdNm */
        DELETE
        FROM TB_MS_PRODUCT_DLVR_PROD_NM
        WHERE STORE_CD = #{targetStoreCd}
    </delete>

    <!-- 배달시스템 상품 명칭 매핑 - 배달상품명칭 복사 -->
    <!--
        TABLE    : TB_MS_PRODUCT_DLVR_PROD_NM
        PARAM    : dlvrProdVO
        COMMENTS : 기준매장의 배달상품명칭을 복사하여 적용대상매장에 등록한다.
    -->
    <insert id="copyStoreDlvrProdNm" parameterType="dlvrProdVO">
        /* USE : DlvrProdMapper.copyStoreDlvrProdNm */
        INSERT INTO TB_MS_PRODUCT_DLVR_PROD_NM
        (
        STORE_CD
        , PROD_CD
        , DLVR_NAME_CD
        , DLVR_PROD_NM
        , REG_DT
        , REG_ID
        , MOD_DT
        , MOD_ID
        )
        <choose>
            <!-- 기준매장이 본사인 경우 -->
            <when test='originalStoreFg != null and originalStoreFg == "H"'>
                SELECT  #{targetStoreCd} AS STORE_CD
                , PROD_CD
                , DLVR_NAME_CD
                , DLVR_PROD_NM
                , #{regDt}
                , #{regId}
                , #{modDt}
                , #{modId}
                FROM TB_HQ_PRODUCT_DLVR_PROD_NM
                WHERE HQ_OFFICE_CD = #{originalStoreCd}
                AND DLVR_NAME_CD IN (SELECT NMCODE_CD
                FROM TB_CM_NMCODE
                WHERE NMCODE_GRP_CD = '112'
                AND NMCODE_CD != '1')
            </when>
            <!-- 기준매장이 매장인 경우 -->
            <when test='originalStoreFg != null and originalStoreFg == "S"'>
                SELECT  #{targetStoreCd} AS STORE_CD
                , PROD_CD
                , DLVR_NAME_CD
                , DLVR_PROD_NM
                , #{regDt}
                , #{regId}
                , #{modDt}
                , #{modId}
                FROM TB_MS_PRODUCT_DLVR_PROD_NM
                WHERE STORE_CD = #{originalStoreCd}
                AND DLVR_NAME_CD IN (SELECT NMCODE_CD
                FROM TB_CM_NMCODE
                WHERE NMCODE_GRP_CD = '112'
                AND NMCODE_CD != '1')
            </when>
        </choose>
    </insert>

    <!-- 배달시스템 상품 명칭 매핑 - 상품명칭 엑셀 업로드 전 상품코드 유효여부 체크  -->
    <!--
        TABLE    : TB_MS_PRODUCT
        PARAM    : dlvrProdVO
        COMMENTS : 상품명칭 엑셀 업로드 전 유효한 상품코드인지 체크한다.
    -->
    <select id="chkDlvrProd" parameterType="dlvrProdVO" resultType="integer">
        /* USE : DlvrProdMapper.chkDlvrProd */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                SELECT COUNT(PROD_CD)
                FROM TB_HQ_PRODUCT
                WHERE HQ_OFFICE_CD = #{hqOfficeCd}
                AND PROD_CD IN
                <foreach collection="arrProdCdCol" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </when>
            <!-- 가맹점 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                SELECT COUNT(PROD_CD)
                FROM TB_MS_PRODUCT
                WHERE STORE_CD = #{storeCd}
                AND PROD_CD IN
                <foreach collection="arrProdCdCol" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </when>
        </choose>
    </select>
</mapper>