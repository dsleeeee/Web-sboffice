<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SendStatus.xml
    문자전송현황
    ======================================================
    No  ||  수정자 ||  수정일자    ||  수정내역
    ======================================================
    1       김설아     2021.06.18     최초작성
-->
<mapper namespace="kr.co.solbipos.adi.sms.sendStatus.service.impl.SendStatusMapper">

    <!-- 메세지그룹 컬럼 리스트 조회 -->
    <!--
        TABLE    : HCS_MSGGR_T
        COMMENTS : [마스터-공용]SMS-고객메세지전송그룹정보
    -->
    <select id="getMsgGrpColList" parameterType="SendStatusVO" resultType="DefaultMap">
        /* SendStatusMapper.getMsgGrpColList */
        SELECT
        hmt.MSG_GRP_CD,
        hmt.MSG_GRP_NM
        FROM HCS_MSGGR_T hmt
        WHERE 1=1
        AND hmt.OGN_CD = #{orgnCd}
        ORDER BY hmt.MSG_GRP_CD
    </select>

    <!-- 문자전송현황 - 조회 -->
    <!--
        TABLE    : SDK_SMS_SEND_ENC, SDK_MMS_SEND_ENC, SDK_SMS_REPORT, SDK_SMS_REPORT_DETAIL, SDK_MMS_REPORT, SDK_MMS_REPORT_DETAIL
        COMMENTS : SMS 발송, LMS/MMS 발송, SMS 문자전송결과, LMS/MMS 문자전송결과
    -->
    <select id="getSendStatusList"  parameterType="SendStatusVO" resultType="DefaultMap">
        /* SendStatusMapper.getSendStatusList */
        <include refid="CmmSQL.PagingTemplateHeader"/>
        SELECT
        hmt.MSG_ID,
        hmt.REG_DT,
        hmt.S_OGN_CD,
        hmt.S_OGN_NM,
        hmt.S_USER_NM,
        hmt.CALLBACK AS S_PHONE_NUMBER,
        hmt.R_OGN_CD,
        hmt.R_OGN_NM,
--         (CASE WHEN hmt.R_OGN_FG = 'C' THEN (SELECT SBPENC.D(MEMBR_NM) FROM TB_MB_MEMBER WHERE MEMBR_ORGN_CD = hmt.R_OGN_CD AND MEMBR_NO = hmt.CST_NO GROUP BY MEMBR_NM)
--                WHEN hmt.R_OGN_FG NOT IN ('C') THEN (SELECT USER_NM FROM TB_WB_USER_INFO_DTL_V01 WHERE ORGN_CD = hmt.R_OGN_CD AND USER_ID = hmt.R_USER_ID GROUP BY USER_NM)
--                ELSE null END
--         ) AS R_USER_NM,
        hmt.PHONE_NUMBER AS R_PHONE_NUMBER,
        hmt.RESERVE_YN,
        hmt.SEND_DATE,
        hmt.READ_DATE,
        hmt.SEND_STATUS,
        (SELECT DECODE(RESULT_NM, NULL, RESULT_CD, RESULT_NM) FROM HCS_MSGCM_T WHERE RESULT_CD = hmt.RESULT_CD) AS RESULT_NM,
        DECODE(hmt.COMPANY, '1', 'MONO', '2', 'SMTNT', NULL) AS COMPANY,
        hmt.SUBJECT,
        hmt.MSG_CONTENT,
        hmt.SMS_SEND_SEQ,
        hmt.GUBUN
        <include refid="CmmSQL.PagingTemplateCount"/>
        FROM
        (
            SELECT *
            FROM
            (
                (
                    --SMS
                    SELECT
                    A.MSG_ID,
                    A.NOW_DATE AS REG_DT,
                    A.RESERVED7 AS S_OGN_CD,
                    (SELECT ORGN_NM FROM TB_WB_USER_INFO_DTL_V01 WHERE ORGN_CD = A.RESERVED7 GROUP BY ORGN_NM) AS S_OGN_NM,
                    A.RESERVED8 AS S_USER_ID,
                    (SELECT USER_NM FROM TB_WB_USER_INFO_DTL_V01 WHERE USER_ID = A.RESERVED8 GROUP BY USER_NM) AS S_USER_NM,
                    SBPENC.D(A.CALLBACK) AS CALLBACK,
                    A.RESERVED4 AS R_OGN_CD,
                    (SELECT ORGN_NM FROM TB_WB_USER_INFO_DTL_V01 WHERE ORGN_CD = A.RESERVED4 GROUP BY ORGN_NM) AS R_OGN_NM,
                    A.RESERVED5 AS R_OGN_FG,
                    A.RESERVED6 AS R_USER_ID,
                    A.RESERVED3 AS CST_NO,
                    SUBSTR(SBPENC.D(A.DEST_INFO), INSTR(SBPENC.D(A.DEST_INFO), '^')+1) AS PHONE_NUMBER,
                    A.SCHEDULE_TYPE AS RESERVE_YN,
                    DECODE(A.SCHEDULE_TYPE, '1', A.SEND_DATE, NULL) AS SEND_DATE,
                    A.SEND_PROC_TIME AS READ_DATE,
                    A.SEND_STATUS,
                    '' AS RESULT_CD,
                    '1' AS COMPANY, --1:KT, 2:SMTNT
                    A.SUBJECT,
                    A.SMS_MSG AS MSG_CONTENT,
                    A.RESERVED9 AS SMS_SEND_SEQ,
                    'SDK_SMS_SEND_ENC' AS GUBUN
                    FROM SDK_SMS_SEND_ENC A
                    WHERE 1=1
                    AND A.NOW_DATE BETWEEN #{startDate}||'000000' AND #{endDate}||'235959'
                    <if test="ssOrgnCd != null and ssOrgnCd != ''">
                        AND A.RESERVED7 LIKE '%' || #{ssOrgnCd} || '%' --S_OGN_CD
                    </if>
                    <if test="rrOrgnCd != null and rrOrgnCd != ''">
                        AND A.RESERVED4 LIKE '%' || #{rrOrgnCd} || '%' --R_OGN_CD
                    </if>
                    <if test="ssPhoneNumber != null and ssPhoneNumber != ''">
                        AND SBPENC.D(A.CALLBACK) LIKE '%' || #{ssPhoneNumber} || '%' --S_PHONE_NUMBER
                    </if>
                )
                UNION ALL
                (
                    --LMS
                    SELECT
                    A.MSG_ID,
                    A.NOW_DATE AS REG_DT,
                    A.RESERVED7 AS S_OGN_CD,
                    (SELECT ORGN_NM FROM TB_WB_USER_INFO_DTL_V01 WHERE ORGN_CD = A.RESERVED7 GROUP BY ORGN_NM) AS S_OGN_NM,
                    A.RESERVED8 AS S_USER_ID,
                    (SELECT USER_NM FROM TB_WB_USER_INFO_DTL_V01 WHERE USER_ID = A.RESERVED8 GROUP BY USER_NM) AS S_USER_NM,
                    SBPENC.D(A.CALLBACK) AS CALLBACK,
                    A.RESERVED4 AS R_OGN_CD,
                    (SELECT ORGN_NM FROM TB_WB_USER_INFO_DTL_V01 WHERE ORGN_CD = A.RESERVED4 GROUP BY ORGN_NM) AS R_OGN_NM,
                    A.RESERVED5 AS R_OGN_FG,
                    A.RESERVED6 AS R_USER_ID,
                    A.RESERVED3 AS CST_NO,
                    SUBSTR(SBPENC.D(A.DEST_INFO), INSTR(SBPENC.D(A.DEST_INFO), '^')+1) AS PHONE_NUMBER,
                    A.SCHEDULE_TYPE AS RESERVE_YN,
                    DECODE(A.SCHEDULE_TYPE, '1', A.SEND_DATE, NULL) AS SEND_DATE,
                    A.SEND_PROC_TIME AS READ_DATE,
                    A.SEND_STATUS,
                    '' AS RESULT_CD,
                    '1' AS COMPANY, --1:KT, 2:SMTNT
                    A.SUBJECT,
                    A.MMS_MSG AS MSG_CONTENT,
                    A.RESERVED9 AS SMS_SEND_SEQ,
                    (CASE WHEN A.CONTENT_COUNT = '0' THEN 'SDK_LMS_SEND_ENC' ELSE 'SDK_MMS_SEND_ENC' END) AS GUBUN
                    FROM SDK_MMS_SEND_ENC A
                    WHERE 1=1
                    AND A.NOW_DATE BETWEEN #{startDate}||'000000' AND #{endDate}||'235959'
                    <if test="ssOrgnCd != null and ssOrgnCd != ''">
                        AND A.RESERVED7 LIKE '%' || #{ssOrgnCd} || '%' --S_OGN_CD
                    </if>
                    <if test="rrOrgnCd != null and rrOrgnCd != ''">
                        AND A.RESERVED4 LIKE '%' || #{rrOrgnCd} || '%' --R_OGN_CD
                    </if>
                    <if test="ssPhoneNumber != null and ssPhoneNumber != ''">
                        AND SBPENC.D(A.CALLBACK) LIKE '%' || #{ssPhoneNumber} || '%' --S_PHONE_NUMBER
                    </if>
                )
                UNION ALL
                (
                    --SMS 문자 전송결과
                    SELECT
                    A.MSG_ID,
                    A.NOW_DATE AS REG_DT,
                    A.RESERVED7 AS S_OGN_CD,
                    (SELECT ORGN_NM FROM TB_WB_USER_INFO_DTL_V01 WHERE ORGN_CD = A.RESERVED7 GROUP BY ORGN_NM) AS S_OGN_NM,
                    A.RESERVED8 AS S_USER_ID,
                    (SELECT USER_NM FROM TB_WB_USER_INFO_DTL_V01 WHERE USER_ID = A.RESERVED8 GROUP BY USER_NM) AS S_USER_NM,
                    A.CALLBACK,
                    A.RESERVED4 AS R_OGN_CD,
                    (SELECT ORGN_NM FROM TB_WB_USER_INFO_DTL_V01 WHERE ORGN_CD = A.RESERVED4 GROUP BY ORGN_NM) AS R_OGN_NM,
                    A.RESERVED5 AS R_OGN_FG,
                    A.RESERVED6 AS R_USER_ID,
                    A.RESERVED3 AS CST_NO,
                    SUBSTR(A.DEST_INFO, INSTR(A.DEST_INFO, '^')+1) AS PHONE_NUMBER,
                    A.SCHEDULE_TYPE AS RESERVE_YN,
                    DECODE(A.SCHEDULE_TYPE, '1', A.SEND_DATE, NULL) AS SEND_DATE,
                    B.DELIVER_DATE AS READ_DATE,
                    (CASE WHEN A.SUCC_COUNT = 0 THEN -1
                           WHEN A.SUCC_COUNT = 1 THEN 3
                           ELSE null END
                    ) AS SEND_STATUS, --현재는 1건씩 전송해서
                    ('1' || '_' || B.TCS_RESULT) AS RESULT_CD, --A.COMPANY || '_' || A.RESULT
                    '1' AS COMPANY, --1:KT, 2:SMTNT
                    A.SUBJECT,
                    A.SMS_MSG AS MSG_CONTENT,
                    A.RESERVED9 AS SMS_SEND_SEQ,
                    'SDK_SMS_REPORT' AS GUBUN
                    FROM SDK_SMS_REPORT A,
                    SDK_SMS_REPORT_DETAIL B
                    WHERE 1=1
                    AND B.MSG_ID = A.MSG_ID
                    AND A.NOW_DATE BETWEEN #{startDate}||'000000' AND #{endDate}||'235959'
                    <if test="ssOrgnCd != null and ssOrgnCd != ''">
                        AND A.RESERVED7 LIKE '%' || #{ssOrgnCd} || '%' --S_OGN_CD
                    </if>
                    <if test="rrOrgnCd != null and rrOrgnCd != ''">
                        AND A.RESERVED4 LIKE '%' || #{rrOrgnCd} || '%' --R_OGN_CD
                    </if>
                    <if test="ssPhoneNumber != null and ssPhoneNumber != ''">
                        AND A.CALLBACK LIKE '%' || #{ssPhoneNumber} || '%' --S_PHONE_NUMBER
                    </if>
                )
                UNION ALL
                (
                    --LMS 문자 전송결과
                    SELECT
                    A.MSG_ID,
                    A.NOW_DATE AS REG_DT,
                    A.RESERVED7 AS S_OGN_CD,
                    (SELECT ORGN_NM FROM TB_WB_USER_INFO_DTL_V01 WHERE ORGN_CD = A.RESERVED7 GROUP BY ORGN_NM) AS S_OGN_NM,
                    A.RESERVED8 AS S_USER_ID,
                    (SELECT USER_NM FROM TB_WB_USER_INFO_DTL_V01 WHERE USER_ID = A.RESERVED8 GROUP BY USER_NM) AS S_USER_NM,
                    A.CALLBACK,
                    A.RESERVED4 AS R_OGN_CD,
                    (SELECT ORGN_NM FROM TB_WB_USER_INFO_DTL_V01 WHERE ORGN_CD = A.RESERVED4 GROUP BY ORGN_NM) AS R_OGN_NM,
                    A.RESERVED5 AS R_OGN_FG,
                    A.RESERVED6 AS R_USER_ID,
                    A.RESERVED3 AS CST_NO,
                    SUBSTR(A.DEST_INFO, INSTR(A.DEST_INFO, '^')+1) AS PHONE_NUMBER,
                    A.SCHEDULE_TYPE AS RESERVE_YN,
                    DECODE(A.SCHEDULE_TYPE, '1', A.SEND_DATE, NULL) AS SEND_DATE,
                    B.DELIVER_DATE AS READ_DATE,
                    (CASE WHEN A.SUCC_COUNT = 0 THEN -1
                           WHEN A.SUCC_COUNT = 1 THEN 3
                           ELSE null END
                    ) AS SEND_STATUS, --현재는 1건씩 전송해서
                    ('1' || '_' || B.TCS_RESULT) AS RESULT_CD, --A.COMPANY || '_' || A.RESULT
                    '1' AS COMPANY, --1:KT, 2:SMTNT
                    A.SUBJECT,
                    A.MMS_MSG AS MSG_CONTENT,
                    A.RESERVED9 AS SMS_SEND_SEQ,
                    'SDK_MMS_REPORT' AS GUBUN
                    FROM SDK_MMS_REPORT A,
                    SDK_MMS_REPORT_DETAIL B
                    WHERE 1=1
                    AND B.MSG_ID = A.MSG_ID
                    AND A.NOW_DATE BETWEEN #{startDate}||'000000' AND #{endDate}||'235959'
                    <if test="ssOrgnCd != null and ssOrgnCd != ''">
                        AND A.RESERVED7 LIKE '%' || #{ssOrgnCd} || '%' --S_OGN_CD
                    </if>
                    <if test="rrOrgnCd != null and rrOrgnCd != ''">
                        AND A.RESERVED4 LIKE '%' || #{rrOrgnCd} || '%' --R_OGN_CD
                    </if>
                    <if test="ssPhoneNumber != null and ssPhoneNumber != ''">
                        AND A.CALLBACK LIKE '%' || #{ssPhoneNumber} || '%' --S_PHONE_NUMBER
                    </if>
                )
            )
            WHERE 1=1
            <if test="ssOrgnNm != null and ssOrgnNm != ''">
                AND S_OGN_NM LIKE '%' || #{ssOrgnNm} || '%'
            </if>
            <if test="rrOrgnNm != null and rrOrgnNm != ''">
                AND R_OGN_NM LIKE '%' || #{rrOrgnNm} || '%'
            </if>
        ) hmt,
        (
            SELECT
            twuidv01.ORGN_FG,
            twuidv01.ORGN_CD,
            twuidv01.ORGN_NM,
            twuidv01.HQ_OFFICE_CD,
            twuidv01.STORE_CD,
            (CASE WHEN twuidv01.ORGN_FG = 'H' THEN (SELECT AGENCY_CD FROM TB_HQ_OFFICE WHERE HQ_OFFICE_CD = twuidv01.HQ_OFFICE_CD)
                  WHEN twuidv01.ORGN_FG = 'S' THEN (SELECT AGENCY_CD FROM TB_MS_STORE WHERE STORE_CD = twuidv01.STORE_CD)
                  ELSE null END
            ) AS AGENCY_CD
            FROM
            (
                SELECT
                DECODE(twuidv01.ORGN_FG, 'A', 'M', twuidv01.ORGN_FG) AS ORGN_FG,
                twuidv01.ORGN_CD,
                twuidv01.ORGN_NM,
                twuidv01.HQ_OFFICE_CD,
                twuidv01.STORE_CD
                FROM TB_WB_USER_INFO_DTL_V01 twuidv01
                GROUP BY twuidv01.ORGN_FG, twuidv01.ORGN_CD, twuidv01.ORGN_NM, twuidv01.HQ_OFFICE_CD, twuidv01.STORE_CD
            ) twuidv01
            WHERE 1=1
            GROUP BY twuidv01.ORGN_FG, twuidv01.ORGN_CD, twuidv01.ORGN_NM, twuidv01.HQ_OFFICE_CD, twuidv01.STORE_CD
        ) twuidv01
        WHERE 1=1
        <choose>
            <when test='orgnFg != null and orgnFg != ""'>
                <!-- 시스템 -->
                <if test='orgnFg == "M"'>
                    <![CDATA[
                    ]]>
                </if>
                <!-- 대리점 -->
                <if test='orgnFg == "A"'>
                    <![CDATA[
                        AND twuidv01.AGENCY_CD = #{orgnCd}
                    ]]>
                </if>
                <!-- 본사 -->
                <if test='orgnFg == "H"'>
                    <![CDATA[
                        AND twuidv01.HQ_OFFICE_CD = #{orgnCd}
                    ]]>
                </if>
                <!-- 매장 -->
                <if test='orgnFg == "S"'>
                    <![CDATA[
                       AND twuidv01.STORE_CD = #{orgnCd}
                    ]]>
                </if>
            </when>
        </choose>
        AND twuidv01.ORGN_CD = hmt.S_OGN_CD
        ORDER BY hmt.REG_DT DESC
        <include refid="CmmSQL.PagingTemplateBottom"/>
    </select>

    <!-- 문자전송현황 - 예약취소 delete -->
    <!--
        TABLE    : SDK_SMS_SEND_ENC, SDK_MMS_SEND_ENC
        COMMENTS : SMS 발송, LMS/MMS 발송
    -->
    <delete id="getSendStatusReserveCancelSaveDelete" parameterType="SendStatusVO">
        /* SendStatusMapper.getSendStatusReserveCancelSaveDelete */
        DELETE SDK_SMS_SEND_ENC
        WHERE 1=1
        AND MSG_ID = #{msgId}
    </delete>
    <delete id="getSendStatusReserveCancelSaveDeleteLMS" parameterType="SendStatusVO">
        /* SendStatusMapper.getSendStatusReserveCancelSaveDeleteLMS */
        DELETE SDK_MMS_SEND_ENC
        WHERE 1=1
        AND MSG_ID = #{msgId}
    </delete>

    <!-- 잔여금액 복구 -->
    <!--
        TABLE    : CET_SMSPT_T
        COMMENTS : [마스터-공용]SMS-본사/매장-SMS잔여수량
    -->
    <update id="getSmsAmtRecoverSaveUpdate" parameterType="SendStatusVO">
        /* SendStatusMapper.getSmsAmtRecoverSaveUpdate */
        UPDATE
        CET_SMSPT_T
        SET
        SMS_AMT = (SELECT (SMS_AMT + (SELECT NMCODE_ITEM_2 FROM TB_CM_NMCODE WHERE NMCODE_GRP_CD = '222' AND NMCODE_CD = #{msgType})) FROM CET_SMSPT_T WHERE OGN_CD = #{orgnCd}),
        MOD_DT = #{modDt},
        MOD_ID = #{modId}
        WHERE 1=1
        AND OGN_CD = #{orgnCd}
    </update>

    <!-- 전송이력 복구 -->
    <!--
        TABLE    : HCS_SMS_SEND_REG_T
        COMMENTS : SMS전송이력
    -->
    <update id="getSmsSendSeqRecoverSaveUpdate" parameterType="SendStatusVO">
        /* SendStatusMapper.getSmsSendSeqRecoverSaveUpdate */
        UPDATE
        HCS_SMS_SEND_REG_T
        SET
        SMS_SEND_COUNT = (SELECT (SMS_SEND_COUNT-1) FROM HCS_SMS_SEND_REG_T WHERE SMS_SEND_ORGN_CD = #{orgnCd} AND SMS_SEND_SEQ = #{smsSendSeq}),
        SEND_QTY = (SELECT (SEND_QTY-1) FROM HCS_SMS_SEND_REG_T WHERE SMS_SEND_ORGN_CD = #{orgnCd} AND SMS_SEND_SEQ = #{smsSendSeq}),
        WAIT_QTY = (SELECT (WAIT_QTY-1) FROM HCS_SMS_SEND_REG_T WHERE SMS_SEND_ORGN_CD = #{orgnCd} AND SMS_SEND_SEQ = #{smsSendSeq}),
        MOD_DT = #{modDt},
        MOD_ID = #{modId}
        WHERE 1=1
        AND SMS_SEND_ORGN_CD = #{orgnCd}
        AND SMS_SEND_SEQ = #{smsSendSeq}
    </update>

    <!-- 일자별 전송현황 - 조회 -->
    <!--
        TABLE    : HCS_DDSMS_T
        COMMENTS : [공통_로그]SMS충전내역
    -->
    <select id="getDaySendStatusList"  parameterType="SendStatusVO" resultType="DefaultMap">
        /* SendStatusMapper.getDaySendStatusList */
        <include refid="CmmSQL.PagingTemplateHeader"/>
        SELECT
        hdt.OGN_CD,
        twuidv01.ORGN_NM,
        hdt.SMS_DATE,
        hdt.SMS_CHARGE_AMT,
        hdt.SMS_CHARGE_CNT,
        hdt.TOT_SEND_QTY,
        hdt.TOT_WAIT_QTY,
        hdt.TOT_SUCCESS_QTY,
        hdt.TOT_FAIL_QTY,
        hdt.SMS_SEND_QTY,
        hdt.SMS_WAIT_QTY,
        hdt.SMS_SUCCESS_QTY,
        hdt.SMS_FAIL_QTY,
        hdt.LMS_SEND_QTY,
        hdt.LMS_WAIT_QTY,
        hdt.LMS_SUCCESS_QTY,
        hdt.LMS_FAIL_QTY,
        hdt.MMS_SEND_QTY,
        hdt.MMS_WAIT_QTY,
        hdt.MMS_SUCCESS_QTY,
        hdt.MMS_FAIL_QTY
        <include refid="CmmSQL.PagingTemplateCount"/>
        FROM HCS_DDSMS_T hdt,
        (
            SELECT
            twuidv01.ORGN_FG,
            twuidv01.ORGN_CD,
            twuidv01.ORGN_NM,
            twuidv01.HQ_OFFICE_CD,
            twuidv01.STORE_CD,
            (CASE WHEN twuidv01.ORGN_FG = 'H' THEN (SELECT AGENCY_CD FROM TB_HQ_OFFICE WHERE HQ_OFFICE_CD = twuidv01.HQ_OFFICE_CD)
                  WHEN twuidv01.ORGN_FG = 'S' THEN (SELECT AGENCY_CD FROM TB_MS_STORE WHERE STORE_CD = twuidv01.STORE_CD)
                  ELSE null END
            ) AS AGENCY_CD
            FROM
            (
                SELECT
                DECODE(twuidv01.ORGN_FG, 'A', 'M', twuidv01.ORGN_FG) AS ORGN_FG,
                twuidv01.ORGN_CD,
                twuidv01.ORGN_NM,
                twuidv01.HQ_OFFICE_CD,
                twuidv01.STORE_CD
                FROM TB_WB_USER_INFO_DTL_V01 twuidv01
                GROUP BY twuidv01.ORGN_FG, twuidv01.ORGN_CD, twuidv01.ORGN_NM, twuidv01.HQ_OFFICE_CD, twuidv01.STORE_CD
            ) twuidv01
            WHERE 1=1
            GROUP BY twuidv01.ORGN_FG, twuidv01.ORGN_CD, twuidv01.ORGN_NM, twuidv01.HQ_OFFICE_CD, twuidv01.STORE_CD
        ) twuidv01
        WHERE 1=1
        AND hdt.SMS_DATE BETWEEN #{startDate} AND #{endDate}
        <choose>
            <when test='orgnFg != null and orgnFg != ""'>
                <!-- 시스템 -->
                <if test='orgnFg == "M"'>
                    <![CDATA[
                    ]]>
                </if>
                <!-- 대리점 -->
                <if test='orgnFg == "A"'>
                    <![CDATA[
                        AND twuidv01.AGENCY_CD = #{orgnCd}
                    ]]>
                </if>
                <!-- 본사 -->
                <if test='orgnFg == "H"'>
                    <![CDATA[
                        AND twuidv01.HQ_OFFICE_CD = #{orgnCd}
                    ]]>
                </if>
                <!-- 매장 -->
                <if test='orgnFg == "S"'>
                    <![CDATA[
                       AND twuidv01.STORE_CD = #{orgnCd}
                    ]]>
                </if>
            </when>
        </choose>
        AND twuidv01.ORGN_CD = hdt.OGN_CD
        ORDER BY hdt.OGN_CD, hdt.SMS_DATE DESC
        <include refid="CmmSQL.PagingTemplateBottom"/>
    </select>



    <!-- 공통 화면 상단 SMS전송(당일) 표시 - [125 SMS전송현황표시]에 등록된 본사 하위 매장인지 조회 -->
    <!--
        TABLE    :
        COMMENTS :
    -->
    <select id="getCmmMainTopStoreCount" parameterType="SendStatusVO" resultType="DefaultMap">
        /* SendStatusMapper.getCmmMainTopStoreCount */
        SELECT
        COUNT(tcn.NMCODE_ITEM_1) AS STORE_CNT
        FROM TB_CM_NMCODE tcn,
        TB_MS_STORE tms
        WHERE 1=1
        AND tcn.NMCODE_GRP_CD = '125'
        AND tms.STORE_CD = #{orgnCd}
        AND tms.HQ_OFFICE_CD (+)= tcn.NMCODE_ITEM_1
    </select>

    <!-- 공통 화면 상단 SMS전송(당일) 표시 - 오늘 SMS전송 건수 조회 -->
    <!--
        TABLE    :
        COMMENTS :
    -->
    <select id="getCmmMainTopSmsSendCount" parameterType="SendStatusVO" resultType="DefaultMap">
        /* SendStatusMapper.getCmmMainTopSmsSendCount */
        SELECT
        SUM(TOT_WAIT_QTY) + SUM(TOT_SEND_QTY) + SUM(TOT_FAIL_QTY) AS TOT_QTY,
        SUM(TOT_WAIT_QTY) AS TOT_WAIT_QTY,
        SUM(TOT_SEND_QTY) AS TOT_SEND_QTY,
        SUM(TOT_FAIL_QTY) AS TOT_FAIL_QTY
        FROM
        (
            (
                SELECT
                NVL(hdt.TOT_WAIT_QTY, 0) AS TOT_WAIT_QTY,
                NVL(hdt.TOT_SUCCESS_QTY + hdt.TOT_FAIL_QTY, 0) AS TOT_SEND_QTY,
                0 AS TOT_FAIL_QTY
                FROM HCS_DDSMS_T hdt
                WHERE 1=1
                AND hdt.OGN_CD = #{orgnCd}
                AND hdt.SMS_DATE = TO_CHAR(SYSDATE, 'yyyyMMdd')
            )
            UNION ALL
            (
                SELECT
                (CASE WHEN ssser.READY_FG = '0' THEN (SELECT COUNT(*) FROM SDK_SMS_SEND_ENC_MEMBER_READY WHERE SMS_SEND_SEQ = ssser.SMS_SEND_SEQ) ELSE 0 END) AS TOT_WAIT_QTY,
                0 AS TOT_SEND_QTY,
                (CASE WHEN ssser.READY_FG = '2' THEN (SELECT COUNT(*) FROM SDK_SMS_SEND_ENC_MEMBER_READY WHERE SMS_SEND_SEQ = ssser.SMS_SEND_SEQ) ELSE 0 END) AS TOT_FAIL_QTY
                FROM SDK_SMS_SEND_ENC_READY ssser
                WHERE 1=1
                AND ssser.USER_ID = #{orgnCd}
                AND SUBSTR(ssser.SEND_DATE, 0, 8) = TO_CHAR(SYSDATE, 'yyyyMMdd')
            )
            UNION ALL
            (
                SELECT
                (CASE WHEN ssser.READY_FG = '0' THEN (SELECT COUNT(*) FROM SDK_SMS_SEND_ENC_MEMBER_READY WHERE SMS_SEND_SEQ = ssser.SMS_SEND_SEQ) ELSE 0 END) AS TOT_WAIT_QTY,
                0 AS TOT_SEND_QTY,
                (CASE WHEN ssser.READY_FG = '2' THEN (SELECT COUNT(*) FROM SDK_SMS_SEND_ENC_MEMBER_READY WHERE SMS_SEND_SEQ = ssser.SMS_SEND_SEQ) ELSE 0 END) AS TOT_FAIL_QTY
                FROM SDK_MMS_SEND_ENC_READY ssser
                WHERE 1=1
                AND ssser.USER_ID = #{orgnCd}
                AND SUBSTR(ssser.SEND_DATE, 0, 8) = TO_CHAR(SYSDATE, 'yyyyMMdd')
            )
            UNION ALL
            (
                SELECT
                0 AS TOT_WAIT_QTY,
                0 AS TOT_SEND_QTY,
                0 AS TOT_FAIL_QTY
                FROM dual
            )
        )
    </select>

</mapper>