<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    StorePosVersion.xml
    매장포스버전현황
    ======================================================
    No  ||  수정자 ||  수정일자    ||  수정내역
    ======================================================
    1       권지현     2023.03.30      최초작성
-->
<mapper namespace="kr.co.solbipos.store.storeMoms.storePosVersion.service.impl.StorePosVersionMapper">

    <!-- 매장포스버전 조회 -->
    <!--
        TABLE    : TB_HQ_BRANCH_MOMS, TB_MS_STORE
        PARAM    : storePosVersionVO
        COMMENTS : 매장포스버전을 조회한다.
    -->
    <select id="getStorePosVersionList" parameterType="storePosVersionVO" resultType="DefaultMap">
        /* USE : StorePosVersionMapper.getStorePosVersionList */
        SELECT  A.STORE_CD
        ,		C.STORE_NM
        ,		A.POS_NO
        ,		A.POS_NM
        ,		A.POS_VER_NO
        ,		A.VER_TYPE_FG
        ,		B.MAX_VER_SER_NO
        ,       E.MAX_SALE_DATE
        ,       #{selectVer}    AS VER_SER_ALL
        ,       (CASE
                    WHEN A.STORE_CD IN(     SELECT  STORE_CD
                                            FROM    TB_CM_POS_VERSN_STORE
                                            WHERE   VER_SER_NO = #{selectVerCd}) THEN '적용등록매장'
                    WHEN A.STORE_CD NOT IN( SELECT  STORE_CD
                                            FROM    TB_CM_POS_VERSN_STORE
                                            WHERE   VER_SER_NO = #{selectVerCd}) THEN '적용미등록매장'
                END
                ) AS REGIST_FG
        ,       F.MAIN_VAL
        ,       G.SUB_VAL
        ,		DECODE(A.POS_VER_NO, #{selectVerCd}, '버전같음', '버전다름') AS VER_CHK
        ,       A.LAST_LOGIN_DT
        FROM    TB_MS_POS A
        ,       (
        SELECT  PROG_FG
        ,       NVL(MAX(VER_SER_NO), '-')   AS MAX_VER_SER_NO
        FROM    TB_CM_POS_VERSN
        WHERE   ORGN_CDS    LIKE '%'|| #{hqOfficeCd} || '%'
        GROUP
        BY      PROG_FG
        ) B
        ,		TB_MS_STORE C
        ,		TB_MS_STORE_INFO D
        ,       (
                SELECT  STORE_CD
                ,       POS_NO
                ,       TO_CHAR(TO_DATE(MAX(SALE_DATE), 'yyyymmdd'), 'yyyy-mm-dd') AS MAX_SALE_DATE
                FROM    TB_SL_DAILY_POS
                WHERE   1=1
                AND     HQ_OFFICE_CD = #{hqOfficeCd}
                GROUP
                BY      STORE_CD
                ,       POS_NO
                ) E
        ,       (
                SELECT 	TMPE.STORE_CD
                ,       TMPE.POS_NO
                ,       TCED.ENVST_VAL_NM AS MAIN_VAL
                FROM 	TB_MS_POS_ENVST tmpe
                ,       TB_CM_ENVST_DTL tced
                WHERE	TMPE.ENVST_CD 	= TCED.ENVST_CD
                AND 	TMPE.ENVST_VAL 	= TCED.ENVST_VAL_CD
                AND		TCED.ENVST_CD 	= '4021'
                <if test='mainVal != null and mainVal !=""'>
                    AND TCED.ENVST_VAL_NM = #{mainVal}
                </if>
                ) F
        ,       (
                SELECT 	TMPE.STORE_CD
                ,       TMPE.POS_NO
                ,       TCED.ENVST_VAL_NM AS SUB_VAL
                FROM 	TB_MS_POS_ENVST tmpe
                ,       TB_CM_ENVST_DTL tced
                WHERE	TMPE.ENVST_CD 	= TCED.ENVST_CD
                AND 	TMPE.ENVST_VAL 	= TCED.ENVST_VAL_CD
                AND 	TCED.ENVST_CD 	= '4019'
                <if test='subVal != null and subVal !=""'>
                    AND TCED.ENVST_VAL_CD = #{subVal}
                </if>
                ) G
        WHERE   B.PROG_FG   (+) =   A.VER_TYPE_FG
        AND   	C.STORE_CD      =   A.STORE_CD
        AND   	D.STORE_CD  (+) =   A.STORE_CD
        AND     E.STORE_CD  (+) =   A.STORE_CD
        AND     E.POS_NO    (+) =   A.POS_NO
        AND     F.STORE_CD      =   A.STORE_CD
        AND     F.POS_NO        =   A.POS_NO
        AND     G.STORE_CD      =   A.STORE_CD
        AND     G.POS_NO        =   A.POS_NO
        AND 	C.HQ_OFFICE_CD  = #{hqOfficeCd}
        <if test="storeCd != null and storeCd != ''">
            AND C.STORE_CD LIKE '%'||#{storeCd}||'%' --매장코드
        </if>
        <if test="storeNm != null and storeNm != ''">
            AND C.STORE_NM LIKE '%'||#{storeNm}||'%' --매장명
        </if>
        <if test='storeHqBrandCd != null and storeHqBrandCd != ""'>
            AND C.HQ_BRAND_CD = #{storeHqBrandCd} -- 매장브랜드 선택일때
        </if>
        <if test='storeHqBrandCd == null or storeHqBrandCd == ""'>
            <if test='userBrands != null and userBrands != ""'>
                -- 매장브랜드 전체일때
                AND C.HQ_BRAND_CD IN
                <foreach collection="userBrandList" item="item" open=" (" separator="," close=")" >
                    #{item}
                </foreach>
            </if>
        </if>
        <if test='momsTeam != null and momsTeam != ""'>
            AND D.MOMS_TEAM = #{momsTeam}
        </if>
        <if test='momsAcShop != null and momsAcShop != ""'>
            AND D.MOMS_AC_SHOP = #{momsAcShop}
        </if>
        <if test='momsAreaFg != null and momsAreaFg != ""'>
            AND D.MOMS_AREA_FG = #{momsAreaFg}
        </if>
        <if test='momsCommercial != null and momsCommercial != ""'>
            AND D.MOMS_COMMERCIAL = #{momsCommercial}
        </if>
        <if test='momsShopType != null and momsShopType != ""'>
            AND D.MOMS_SHOP_TYPE = #{momsShopType}
        </if>
        <if test='momsStoreManageType != null and momsStoreManageType != ""'>
            AND D.MOMS_STORE_MANAGE_TYPE = #{momsStoreManageType}
        </if>
        <if test='branchCd != null and branchCd != ""'>
            AND C.BRANCH_CD = #{branchCd}
        </if>
        <if test='momsStoreFg01 != null and momsStoreFg01 != ""'>
            AND D.MOMS_STORE_FG_01 = #{momsStoreFg01}
        </if>
        <if test='momsStoreFg02 != null and momsStoreFg02 != ""'>
            AND D.MOMS_STORE_FG_02 = #{momsStoreFg02}
        </if>
        <if test='momsStoreFg03 != null and momsStoreFg03 != ""'>
            AND D.MOMS_STORE_FG_03 = #{momsStoreFg03}
        </if>
        <if test='momsStoreFg04 != null and momsStoreFg04 != ""'>
            AND D.MOMS_STORE_FG_04 = #{momsStoreFg04}
        </if>
        <if test='momsStoreFg05 != null and momsStoreFg05 != ""'>
            AND D.MOMS_STORE_FG_05 = #{momsStoreFg05}
        </if>
        <choose>
            <when test='registFg != null and registFg == "Y"'>
                AND A.STORE_CD IN ( SELECT STORE_CD
                                    FROM TB_CM_POS_VERSN_STORE
                                    WHERE VER_SER_NO = #{selectVerCd})
            </when>
            <when test='registFg != null and registFg == "N"'>
                AND A.STORE_CD NOT IN ( SELECT STORE_CD
                                        FROM TB_CM_POS_VERSN_STORE
                                        WHERE VER_SER_NO = #{selectVerCd})
            </when>
        </choose>
        <choose>
            <when test='verChk != null and verChk == "Y"'>
                AND NVL(A.POS_VER_NO,0) = #{selectVerCd}
            </when>
            <when test='verChk != null and verChk == "N"'>
                AND NVL(A.POS_VER_NO,0) != #{selectVerCd}
            </when>
        </choose>
        <if test='posLogDt != null and posLogDt != ""'>
            AND A.LAST_LOGIN_DT BETWEEN TO_CHAR(SYSDATE - #{posLogDt}, 'YYYYMMDD') ||'000000' AND TO_CHAR(SYSDATE, 'YYYYMMDD') ||'235959'
        </if>
        <if test='lastSale != null and lastSale != ""'>
            AND E.MAX_SALE_DATE BETWEEN TO_CHAR(SYSDATE - #{lastSale}, 'yyyy-mm-dd') AND TO_CHAR(SYSDATE, 'yyyy-mm-dd')
        </if>
        ORDER
        BY A.STORE_CD, A.POS_NO
    </select>

    <!-- 포스버전 조회 -->
    <!--
        TABLE    : TB_CM_POS_VERSN
        PARAM    : storePosVersionVO
        COMMENTS : 포스버전을 조회한다.
    -->
    <select id="getSelectVerList" parameterType="storePosVersionVO" resultType="DefaultMap">
        SELECT  '[' || VER_SER_NO || '] ' || FILE_DESC AS NAME
        ,       '[' || VER_SER_NO || '] ' || FILE_DESC AS VALUE
        FROM    TB_CM_POS_VERSN
        WHERE   PROG_FG = '2'
        ORDER
        BY      REG_DT DESC
    </select>

    <!-- 포스용도 조회 -->
    <!--
        TABLE    : TB_CM_POS_VERSN
        PARAM    : storePosVersionVO
        COMMENTS : 포스용도을 조회한다.
    -->
    <select id="getSelectSubPos" parameterType="storePosVersionVO" resultType="DefaultMap">
        SELECT  ENVST_VAL_CD    AS VALUE
        ,       ENVST_VAL_NM    AS NAME
        FROM    TB_CM_ENVST_DTL
        WHERE   ENVST_CD = '4019'
    </select>

</mapper>