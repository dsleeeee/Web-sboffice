"use strict";function RootController(ctrlName,$scope,$http,isPicker){$scope.name=ctrlName;$scope._gridDataInit=function(){$scope.data=new wijmo.collections.CollectionView([])};$scope._inquiryMain=function(url,params,callback){$scope._inquiry(url,params,callback,true,true)};$scope._inquirySub=function(url,params,callback,isView){if(!isView){isView=true}$scope._inquiry(url,params,callback,isView,false)};$scope._inquiry=function(url,params,callback,isView,isMaster){if(isMaster){var el=angular.element('input');var name='';for(var i=0,l=el.length;i<l;i+=1){name=angular.element(el[i]).attr('ng-model');if(name&&$scope[name]){params[name]=$scope[name]}}}if($scope.getCurr()>0){params['curr']=$scope.getCurr()}else{params['curr']=1}$http({method:'POST',url:url,params:params,headers:{'Content-Type':'application/json; charset=utf-8'}}).then(function successCallback(response){var list=response.data.data.list;if(list.length===undefined||list.length===0){$scope.data=new wijmo.collections.CollectionView([]);if(isView){$scope.s_alert(response.data.message)}return}var data=new wijmo.collections.CollectionView(list);data.trackChanges=true;$scope.data=data;if(response.data.data.page.curr){$scope.pagingInfo=response.data.data.page;$scope.pagingInfo.ctrlName=$scope.name;$scope._broadcast('drawPaging',$scope.pagingInfo)}},function errorCallback(response){$scope.s_alert(messages["cmm.error"]);return}).then(function(){if(typeof callback==='function'){setTimeout(function(){callback()},10)}})};$scope._addRow=function(params,pos){var flex=$scope.flex;if(!flex.collectionView){flex.itemsSource=new wijmo.collections.CollectionView()}var newRow=flex.collectionView.addNew();newRow.status="I";newRow.gChk=true;for(var prop in params){newRow[prop]=params[prop]}flex.collectionView.trackChanges=true;flex.collectionView.commitNew();setTimeout(function(){flex.scrollIntoView(flex.rows.length-1,0);flex.select(flex.rows.length-1,1);flex.focus();flex.startEditing(true,flex.rows.length-1,(pos===null?0:pos),true)},50)};$scope._save=function(url,params,callback){if(params.length<=0){$scope.s_alert(messages["cmm.not.modify"]);return}else{params=JSON.stringify(params)}$http({method:'POST',url:url,data:params,headers:{'Content-Type':'application/json; charset=utf-8'}}).then(function successCallback(response){$scope.s_alert(messages["cmm.saveSucc"]);$scope.flex.collectionView.clearChanges()},function errorCallback(response){$scope.s_alert(messages["cmm.saveFail"]);return}).then(function(){if(typeof callback==='function'){setTimeout(function(){callback()},10)}})};$scope._itemFormatter=function(panel,r,c,cell){if(panel.cellType===wijmo.grid.CellType.ColumnHeader){var mRange=$scope.flex.getMergedRange(panel,r,c);if(mRange){cell.innerHTML="<div class='wj-header merged-custom'>"+cell.innerHTML+"</div>"}}else if(panel.cellType===wijmo.grid.CellType.TopLeft){if(!isPicker){$(cell).css({"background":"none","background-color":"#e8e8e8"})}}else if(panel.cellType===wijmo.grid.CellType.RowHeader){if(panel.rows[r]instanceof wijmo.grid.GroupRow){cell.textContent=""}else{if(!isEmpty(panel._rows[r]._data.rnum)){cell.textContent=(panel._rows[r]._data.rnum).toString()}else{cell.textContent=(r+1).toString()}}}else if(panel.cellType===wijmo.grid.CellType.Cell){var col=panel.columns[c];if(col.isReadOnly){wijmo.addClass(cell,'wj-custom-readonly')}}};$scope.$watch('flex',function(){var flex=$scope.flex;if(flex){flex.beginningEdit.addHandler(function(s,e){if(s.columns[e.col].binding!=='gChk'){if(!s.rows[e.row].dataItem.gChk){e.cancel=true;flex.endUpdate()}else{if(s.columns[e.col].dataType!==wijmo.DataType.Boolean){setTimeout(function(){var _cellData=s.getCellData(e.row,e.col,true);if(s.activeEditor!==null&&s.activeEditor.value!==""){wijmo.setSelectionRange(s.activeEditor,_cellData.length)}},0)}}}});flex.cellEditEnded.addHandler(function(s,e){});flex.rowEditEnded.addHandler(function(s,e){})}});$scope._makePickColumns=function(ctrlName){var flex=$scope.flex;if(flex&&isPicker){flex.hostElement.addEventListener('mousedown',function(e){var ht=flex.hitTest(e);if(ht.cellType===wijmo.grid.CellType.TopLeft){if(!$scope.picker){$scope.picker=new wijmo.grid.ColumnPicker('#'+ctrlName);$scope.picker.orgColumns=$scope.flex.columns}$scope.picker.grid=$scope.flex;var pickerPopup=$scope.colPicker;pickerPopup.show(true,function(s){var dr=s.dialogResult;if(dr&&dr.indexOf('apply')>-1){$scope.picker.save()}});e.preventDefault()}})}}};!function(win,$){var app=angular.module('rootApp',['wj','ngSanitize']);app.controller('rootCtrl',['$scope','$http','$compile','comboData','pagingData',function($scope,$http,$compile,comboData,pagingData){$scope._broadcast=function(controllerName,params){$scope.$broadcast('init');$scope.$broadcast(controllerName,params)};$scope._pagingView=function(ctrlName,curr){$scope.setCurr(curr);$scope.$broadcast(ctrlName)};$scope.$on('loadingPopupActive',function(){$scope._loadingTent.show(true)});$scope.$on('loadingPopupInactive',function(){$scope._loadingTent.hide()});$scope.s_alert=function(msg,callback){$scope.s_alert_msg=msg;setTimeout(function(){$scope._alertTent.show(true,function(){if(typeof callback==='function'){setTimeout(function(){callback()},10)}})},100)};$scope.$on('drawPaging',function(event,pagingInfo){var page_scale=pagingInfo.pageScale;var page_end=page_scale==10?9:4;var prevBtnTag="<li class=\"btn_previous\" data-tot={tot}><a href=\"javascript:;\"></a></li>";var pageBtnTag="<li><a href=\"javascript:;\" class=\"{cnm}\" data-value={i} ng-click=\"_pagingView('{ctrlName}', '{i}');\">{i}</a></li>";var nextBtnTag="<li class=\"btn_next\" data-curr={curr}><a href=\"javascript:;\"></a></li>";var pagerTag="";var item={};item.ctrlName=pagingInfo.ctrlName;item.curr=pagingInfo.curr;item.tot=pagingInfo.totCnt;item.start=0;item.end=0;var t=pagingInfo.curr/page_scale;if(t.toString().indexOf(".")===-1){item.end=pagingInfo.curr;item.start=item.end-page_end}else{item.start=(parseInt(t)*page_scale)+1;item.end=item.start+page_end}if(item.end>pagingInfo.totalPage){item.end=pagingInfo.totalPage}if(pagingInfo.totCnt>page_scale){pagerTag+=wijmo.format(prevBtnTag,item)}for(var i=item.start;i<=item.end;i++){item.i=i;item.cnm=i===pagingInfo.curr?"on pagenav":"pagenav";pagerTag+=wijmo.format(pageBtnTag,item)}if(pagingInfo.totalPage>page_scale){pagerTag+=wijmo.format(nextBtnTag,item)}var pager=$compile(pagerTag)($scope);var pagerName=pagingInfo.ctrlName+'Pager';angular.element(document.getElementById(pagerName)).children().remove();angular.element(document.getElementById(pagerName)).append(pager)});$scope.setCurr=function(idx){pagingData.set(idx)};$scope.getCurr=function(){return pagingData.get()};$scope.setComboData=function(id,data){comboData.set(id,data)};$scope.getComboData=function(id){return comboData.get(id)};$scope.initComboBox=function(s){s._tbx.id=s._orgAtts.id.value;s._tbx.setAttribute("ng-model",s._orgAtts['ng-model']);s._tbx.attributes['ng-model'].value=s._orgAtts['ng-model'].value}}]);app.factory('myHttpInterceptor',function($timeout,$q,$rootScope){return{'request':function(config){$rootScope.$broadcast('loadingPopupActive');return config},'requestError':function(rejectionRequest){console.log("from REQUEST ERROR")$rootScope.$broadcast('loadingPopupInactive');return $q.reject("Couldnot have a successfull request, Sorry :(")},'response':function(response){$rootScope.$broadcast('loadingPopupInactive');return response},'responseError':function(rejectionRequest){console.log("from RESPONSE ERROR")$rootScope.$broadcast('loadingPopupInactive');return $q.reject(rejectionRequest)}}}).factory('comboData',function(){var comboDataMap=[];comboDataMap.set=function(id,data){comboDataMap[id]=data}comboDataMap.get=function(id){return comboDataMap[id]}return comboDataMap}).factory('pagingData',function(){var currentPage={};currentPage.set=function(idx){currentPage.value=idx}currentPage.get=function(){return currentPage.value}return currentPage});app.config(function($httpProvider){$httpProvider.interceptors.push('myHttpInterceptor')});var agrid={getApp:function(){return app},getScope:function(ctrlName){var sel='div[ng-controller="'+ctrlName+'"]';return angular.element(sel).scope()}};win.agrid=agrid}("undefined"!=typeof window?window:this,angular);
