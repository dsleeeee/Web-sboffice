<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    PwdManage.xml
    비밀번호 임의변경 sql
    ======================================================
    No  ||  수정자 ||  수정일자    ||  수정내역
    ======================================================
    1       노현수     2018.06.15      최초작성
-->
<mapper namespace="kr.co.solbipos.store.manage.pwdmanage.service.impl.PwdManageMapper">
    
    <!-- 비밀번호 임의변경 대상 목록 조회 -->
    <!--
        TABLE    : TB_MS_EMPLOYEE, TB_MS_STORE, TB_HQ_OFFICE, TB_CM_NMCODE
        PARAM    : pwdManageVO
        COMMENTS : 비밀번호를 변경할 대상 목록을 조회한다.
    -->
    <select id="getPwdManageList" parameterType="pwdManageVO" resultType="DefaultMap">
        /* USE : PwdManageMapper.getPwdManageList */
        <include refid="CmmSQL.PagingTemplateHeader"/>
        SELECT
            tho.HQ_OFFICE_CD,
            tho.HQ_OFFICE_NM,
            tms.STORE_CD,
            tms.STORE_NM,
            tme.EMP_NO,
            tme.EMP_NM AS USER_NM,
            tme.USER_ID,
            tme.SERVICE_FG,
            tme.WEB_USE_YN,
            tme.MP_NO,
            tme.EMAIL_ADDR,
            tme.ADDR || tme.ADDR_DTL AS ADDR
            <include refid="CmmSQL.PagingTemplateCount"/>
        FROM
            TB_MS_EMPLOYEE tme
        LEFT OUTER JOIN TB_MS_STORE tms ON
            tme.STORE_CD = tms.STORE_CD
        LEFT OUTER JOIN TB_HQ_OFFICE tho ON
            tms.HQ_OFFICE_CD = tho.HQ_OFFICE_CD
        LEFT OUTER JOIN TB_CM_NMCODE tcn ON
            tme.SERVICE_FG = tcn.NMCODE_CD
            AND tcn.NMCODE_GRP_CD = '008'
        WHERE
            tho.HQ_OFFICE_CD != '00000'
        <if test='hqOfficeCd != null and hqOfficeCd != ""'>
            AND tho.HQ_OFFICE_CD = #{hqOfficeCd}
        </if>
        <if test='hqOfficeNm != null and hqOfficeNm != ""'>
            <![CDATA[
            AND tho.HQ_OFFICE_NM LIKE #{hqOfficeNm} || '%'
            ]]>
        </if>
        <if test='storeCd != null and storeCd != ""'>
            AND tme.STORE_CD = #{storeCd}
        </if>
        <if test='storeNm != null and storeNm != ""'>
            <![CDATA[
            AND tme.STORE_NM LIKE #{storeNm} || '%'
            ]]>
        </if>
        <if test='userId != null and userId != ""'>
            AND tme.USER_ID LIKE #{userId}||'%'
        </if>
        <if test='userNm != null and userNm != ""'>
            AND tme.USER_NM LIKE #{userNm}||'%'
        </if>
       ORDER BY tho.HQ_OFFICE_CD DESC, tms.STORE_CD DESC, tme.EMP_NM
       <include refid="CmmSQL.PagingTemplateBottom"/>
    </select>
    
    <!-- 기존 비밀번호 조회 -->
    <!--
        TABLE    : TB_WB_USER_INFO, TB_MS_EMPLOYEE
        PARAM    : pwdManageVO
        COMMENTS : 사용자의 기존 비밀번호를 조회한다.
    -->
    <select id="getOldPassword" parameterType="pwdManageVO" resultType="java.lang.String">
        /* USE : PwdManageMapper.getOldPassword */
        <choose>
            <when test='pwdChgFg != null and pwdChgFg.toString() == "WEB"'>
                SELECT
                    USER_PWD
                FROM
                    TB_WB_USER_INFO
                WHERE
                    USER_ID = #{userId}
            </when>
            <otherwise>
                SELECT
                    EMP_PWD
                FROM
                    TB_MS_EMPLOYEE
                WHERE
                    EMP_NO = #{empNo}
            </otherwise>
        </choose>
    </select>
    
    <!-- 비밀번호 변경 -->
    <!--
        TABLE    : TB_WB_USER_INFO, TB_MS_EMPLOYEE
        PARAM    : pwdManageVO
        COMMENTS : 사용자의 비밀번호를 변경한다.
    -->
    <update id="updatePassword" parameterType="pwdManageVO">
        /* USE : PwdManageMapper.updatePassword */
        <choose>
            <when test='pwdChgFg != null and pwdChgFg.toString() == "WEB"'>
                UPDATE
                    TB_WB_USER_INFO
                SET
                    USER_PWD = #{newPassword},
                    LAST_PWD_CHG_DT = #{lastPwdChgDt}
                WHERE
                    USER_ID = #{userId}
            </when>
            <otherwise>
                UPDATE
                    TB_MS_EMPLOYEE
                SET
                    EMP_PWD = #{newPassword},
                    MOD_DT = #{modDt},
                    MOD_ID = #{modId}
                WHERE
                    EMP_NO = #{empNo}
            </otherwise>
        </choose>

    </update>
    
    <!-- 비밀번호 변경이력 저장 -->
    <!--
        TABLE    : TB_WB_PWD_CHG_HIST
        PARAM    : pwdManageVO
        COMMENTS : 사용자의 비밀번호를 변경이력을 저장한다.
    -->
    <insert id="insertPasswordHistory" parameterType="pwdManageVO">
        /* PwdManageMapper.insertPwdChgHist */
        INSERT INTO TB_WB_PWD_CHG_HIST
        (
          USER_ID,
          IDX,
          PRIOR_PWD,
          REG_IP,
          REG_DT,
          REG_ID
        ) VALUES (
          #{userId},
          (SELECT NVL(MAX(IDX),0) + 1 AS MAX FROM TB_WB_PWD_CHG_HIST WHERE USER_ID = #{userId}),
          #{priorPwd},
          #{regIp},
          #{regDt},
          #{regId}
        )
    </insert>
    
</mapper>
