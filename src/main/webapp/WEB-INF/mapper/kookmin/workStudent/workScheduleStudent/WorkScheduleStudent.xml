<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    WorkScheduleStudent.xml
    근로학생 배치 sql
    ======================================================
    No  ||  수정자 ||  수정일자    ||  수정내역
    ======================================================
    1       김유승     2025.09.11
-->
<mapper namespace="kr.co.solbipos.kookmin.workStudent.workScheduleStudent.service.impl.WorkScheduleStudentMapper">
    <!-- 근로학생 배치 조회 -->
    <!--
        TABLE    :
        COMMENTS :
    -->
    <select id="getWorkScheduleStudentList" parameterType="WorkScheduleStudentVO" resultType="DefaultMap">
        /* WorkScheduleStudentMapper.getWorkScheduleStudentList */
        SELECT 	A.TERM_YEAR
        ,		A.TERM_FG
        ,		A.WORK_SCH_CODE
        ,		A.STORE_CD
        ,		B.STORE_NM
        ,		SUBSTR(A.START_TIME, 1, 2) || ':' || SUBSTR(A.START_TIME, 3, 2) || ' ~ ' || SUBSTR(A.END_TIME, 1, 2) || ':' || SUBSTR(A.END_TIME, 3, 2) AS WORK_TIME
        ,		RTRIM	(
                            CASE WHEN INSTR(A.WORK_DAY, '1') > 0 THEN '일, ' ELSE '' END ||
                            CASE WHEN INSTR(A.WORK_DAY, '2') > 0 THEN '월, ' ELSE '' END ||
                            CASE WHEN INSTR(A.WORK_DAY, '3') > 0 THEN '화, ' ELSE '' END ||
                            CASE WHEN INSTR(A.WORK_DAY, '4') > 0 THEN '수, ' ELSE '' END ||
                            CASE WHEN INSTR(A.WORK_DAY, '5') > 0 THEN '목, ' ELSE '' END ||
                            CASE WHEN INSTR(A.WORK_DAY, '6') > 0 THEN '금, ' ELSE '' END ||
                            CASE WHEN INSTR(A.WORK_DAY, '7') > 0 THEN '토, ' ELSE '' END,
                            ', '
                        ) AS WORK_DAY
        ,		TO_NUMBER(A.HOUR_PAY) AS HOUR_PAY
        ,		A.WORK_FG
        ,		A.STUDENT_NO
        ,       NVL(C.STUDENT_NM, '[등록]')   AS STUDENT_NM
        ,		TO_CHAR(TO_DATE(A.START_DAY, 'yyyymmdd'), 'yyyy-mm-dd')    AS START_DAY
        ,		TO_CHAR(TO_DATE(A.END_DAY, 'yyyymmdd'), 'yyyy-mm-dd')      AS END_DAY
        ,       A.REMARK
        FROM 	TB_HQ_WORK_SCHEDULE A
        ,		TB_MS_STORE B
        ,		TB_HQ_WORK_STUDENTS C
        WHERE 	B.STORE_CD 			= A.STORE_CD
        AND 	C.HQ_OFFICE_CD	(+) = A.HQ_OFFICE_CD
        AND 	C.STUDENT_NO 	(+) = A.STUDENT_NO
        AND 	A.HQ_OFFICE_CD 		= #{hqOfficeCd}
        AND 	A.TERM_YEAR 		= #{srchDate}
        AND 	A.TERM_FG 			= #{termFg}
        <if test='regFg != null and regFg != ""'>
            <choose>
                <when test='regFg == "Y"'>
                    AND	C.STUDENT_NO IS NOT NULL
                </when>
                <when test='regFg == "N"'>
                    AND C.STUDENT_NO IS NULL
                </when>
            </choose>
        </if>
        ORDER
        BY		TO_NUMBER(SUBSTR(WORK_SCH_CODE, 2, INSTR(WORK_SCH_CODE, '-') - 2))
        ,		TO_NUMBER(SUBSTR(WORK_SCH_CODE, INSTR(WORK_SCH_CODE, '-') + 1 ))
    </select>

    <!-- 근로학생 등록 팝업 - 근로학생 조회 -->
    <!--
        TABLE    :
        COMMENTS :
    -->
    <select id="getWorkStudentList" parameterType="WorkScheduleStudentVO" resultType="DefaultMap">
        /* WorkScheduleStudentMapper.getWorkStudentList */
        SELECT 	STUDENT_NO
        ,		STUDENT_NM
        ,		DEPARTMENT
        FROM 	TB_HQ_WORK_STUDENTS
        WHERE   HQ_OFFICE_CD    = #{hqOfficeCd}
        <if test='studentNo != null and studentNo != ""'>
            AND STUDENT_NO LIKE '%' || #{studentNo} || '%'
        </if>
        <if test='studentNm != null and studentNm != ""'>
            AND STUDENT_NM LIKE '%' || #{studentNm} || '%'
        </if>
        <if test='department != null and department != ""'>
            AND DEPARTMENT LIKE '%' || #{department} || '%'
        </if>
        ORDER
        BY      STUDENT_NO
    </select>

    <!-- 근로학생 근무배치 저장 -->
    <!--
        TABLE    : TB_HQ_WORK_SCHEDULE
        COMMENTS : 근로학생 근무배치 저장
    -->
    <update id="updateWorkScheduleStudent" parameterType="WorkScheduleStudentVO">
        /* WorkScheduleStudentMapper.updateWorkScheduleStudent */
        UPDATE  TB_HQ_WORK_SCHEDULE
        SET     STUDENT_NO  = #{studentNo}
        ,       START_DAY   = #{startDay}
        ,       END_DAY     = #{endDay}
        ,       REMARK      = #{remark}
        ,       MOD_DT      = #{modDt}
        ,       MOD_ID      = #{modId}
        WHERE   HQ_OFFICE_CD    = #{hqOfficeCd}
        AND     TERM_YEAR       = #{termYear}
        AND     TERM_FG         = #{termFg}
        AND     STORE_CD        = #{storeCd}
        AND     WORK_SCH_CODE   = #{workSchCode}
    </update>
</mapper>