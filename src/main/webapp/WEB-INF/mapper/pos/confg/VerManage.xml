<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    VerManage.xml
    포스버전관리
    ======================================================
    No  ||  수정자 ||  수정일자    ||  수정내역
    ======================================================
    1       김지은     2018.06.08     최초작성
-->

<mapper namespace="kr.co.solbipos.pos.confg.vermanage.service.impl.VerManageMapper">

  <!-- 포스버전 목록 조회  -->
  <!--
      TABLE    : TB_CM_POS_VERSN, TB_CM_POS_VERSN_STORE
      COMMENTS : 포스버전 리스트를 조회한다.
  -->
  <select id="getList" parameterType="verInfoVO" resultType="DefaultMap">
    /* USE : VerManageMapper.getList */
    <include refid="CmmSQL.PagingTemplateHeader"/>
    SELECT A.VER_SER_NO,
           A.VER_SER_NM,
           A.FILE_DESC,
           A.FILE_SIZE,
           A.FILE_DIR,
           A.PROG_FG,
           A.PGM_YN,
           A.DB_YN,
           A.IMG_YN,
           A.USE_YN,
           A.REG_DT,
           A.REG_ID,
           A.MOD_DT,
           A.MOD_ID,
           B.REG_CNT,
           B.RECV_CNT
           <include refid="CmmSQL.PagingTemplateCount"/>
      FROM TB_CM_POS_VERSN A,
           (
      SELECT VER_SER_NO,
             SUM(DECODE(VER_RECV_FG , '1' , 1, 0)) REG_CNT,
             SUM(DECODE(VER_RECV_FG , '2' , 1, 0)) RECV_CNT
        FROM TB_CM_POS_VERSN_STORE
       GROUP BY VER_SER_NO
           ) B
     WHERE B.VER_SER_NO (+)= A.VER_SER_NO
    <if test='verSerNo != null and verSerNo != ""'>
      AND A.VER_SER_NO = #{verSerNo}
    </if>
    <if test='fileDesc != null and fileDesc != ""'>
      AND A.FILE_DESC = #{fileDesc}
    </if>
    ORDER BY A.REG_DT DESC
    <include refid="CmmSQL.PagingTemplateBottom"/>
  </select>

  <!-- 포스버전정보 상세 조회  -->
  <!--
      TABLE    : TB_CM_POS_VERSN
      COMMENTS : 포스버전에 대한 상세 정보를 조회한다.
  -->
  <select id="dtlInfo" parameterType="verInfoVO" resultType="DefaultMap">
    /* USE : VerManageMapper.dtlInfo */
    SELECT VER_SER_NO,
           VER_SER_NM,
           FILE_NM,
           FILE_DESC,
           FILE_SIZE,
           FILE_DIR,
           PROG_FG,
           PGM_YN,
           DB_YN,
           IMG_YN,
           USE_YN,
           REG_DT,
           REG_ID
      FROM TB_CM_POS_VERSN
     WHERE VER_SER_NO = #{verSerNo}
  </select>

  <!-- 버전 등록   -->
  <!--
      TABLE    : TB_CM_POS_VERSN
      COMMENTS : 포스버전을 등록한다.
  -->
  <insert id="verRegist" parameterType="verInfoVO">
    /* USE : VerManageMapper.verRegist */
    <![CDATA[
    INSERT INTO TB_CM_POS_VERSN
    (
      VER_SER_NO,
      VER_SER_NM,
      FILE_NM,
      FILE_SIZE,
      FILE_DIR,
      FILE_DESC,
      PROG_FG,
      PGM_YN,
      DB_YN,
      IMG_YN,
      USE_YN,
      REG_DT,
      REG_ID,
      MOD_DT,
      MOD_ID
    )
    VALUES
    (
      #{verSerNo},
      #{verSerNm},
      #{fileNm},
      #{fileSize},
      #{fileDir},
      #{fileDesc},
      #{progFg},
      #{pgmYn},
      #{dbYn},
      #{imgYn},
      #{useYn},
      #{regDt},
      #{regId},
      #{modDt},
      #{modId}
    )
    ]]>
  </insert>

  <!-- 버전 수정   -->
  <!--
      TABLE    : TB_CM_POS_VERSN
      COMMENTS : 포스버전을 수정한다.
  -->
  <update id="verModify" parameterType="verInfoVO">
    /* USE : VerManageMapper.verModify */
    <![CDATA[
    UPDATE TB_CM_POS_VERSN
       SET VER_SER_NM = #{verSerNm},
           FILE_NM    = #{fileNm},
           FILE_SIZE  = #{fileSize},
           FILE_DIR   = #{fileDir},
           FILE_DESC  = #{fileDesc},
           PROG_FG    = #{progFg},
           PGM_YN     = #{pgmYn},
           DB_YN      = #{dbYn},
           IMG_YN     = #{imgYn},
           USE_YN     = #{useYn},
           MOD_DT     = #{modDt},
           MOD_ID     = #{modId}
     WHERE VER_SER_NO = #{verSerNo}
     ]]>
  </update>

  <!-- 버전 삭제   -->
  <!--
      TABLE    : TB_CM_POS_VERSN
      COMMENTS : 포스버전을 삭제한다.
  -->
  <delete id="verDelete" parameterType="verInfoVO" >
    /* USE : VerManageMapper.deleteVersion */
    DELETE
      FROM TB_CM_POS_VERSN
     WHERE VER_SER_NO = #{verSerNo}
  </delete>

  <!-- 등록 매장 목록 조회  -->
  <!--
      TABLE    : TB_CM_POS_VERSN_STORE, TB_MS_STORE, TB_MS_POS
      COMMENTS : 등록 매장 목록을 조회한다.
  -->
  <select id="storeList" parameterType="verInfoVO" resultType="DefaultMap">
    /* USE : VerManageMapper.storeList */
    SELECT  A.VER_SER_NO,
            A.STORE_CD,
            B.STORE_NM,
            B.SYS_STAT_FG,
            B.CLS_FG,
            A.VER_RECV_FG,
            A.VER_RECV_DT,
            A.POS_IP,
            A.REG_DT,
            A.REG_ID,
            A.MOD_DT,
            A.MOD_ID
            <include refid="CmmSQL.PagingTemplateCount"/>
       FROM TB_CM_POS_VERSN_STORE A,
            TB_MS_STORE B
      WHERE B.STORE_CD = A.STORE_CD
        AND A.VER_SER_NO = #{verSerNo}
  </select>

  <!-- 추가가능한 매장 목록 조회   -->
  <!--
      TABLE    : TB_MS_POS, TB_MS_STORE, TB_HQ_OFFICE
      COMMENTS : 추가가능한 매장 목록을 조회한다.
  -->
  <select id="srchStoreList" parameterType="applcStoreVO" resultType="DefaultMap">
    /* USE : VerManageMapper.srchStoreList */
    <include refid="CmmSQL.PagingTemplateHeader"/>
    SELECT tms.STORE_CD,
           tms.SYS_STAT_FG,
           tms.VAN_CD,
           tms.CLS_FG,
           tms.STORE_NM,
           tho.HQ_OFFICE_CD,
           tho.HQ_OFFICE_NM,
           tcp.LAST_VER_SER_NO
           <include refid="CmmSQL.PagingTemplateCount"/>
      FROM TB_MS_STORE tms,
           TB_HQ_OFFICE tho,
           (
      SELECT STORE_CD,
             MAX(VER_SER_NO) AS LAST_VER_SER_NO
        FROM TB_CM_POS_VERSN_STORE
       GROUP BY STORE_CD
            ) tcp
     WHERE tms.STORE_CD NOT IN (SELECT STORE_CD
                                  FROM TB_CM_POS_VERSN_STORE
                                 WHERE VER_SER_NO = #{verSerNo} )
       AND tho.HQ_OFFICE_CD = tms.HQ_OFFICE_CD
       AND tcp.STORE_CD (+)= tms.STORE_CD
    <if test='hqOfficeCd != null and hqOfficeCd != ""'>
       AND tms.HQ_OFFICE_CD = #{hqOfficeCd}
    </if>
    <if test='hqOfficeNm != null and hqOfficeNm != ""'>
       AND tho.HQ_OFFICE_NM = #{hqOfficeNm}
    </if>
    <if test='storeNm != null and storeNm != ""'>
       AND tms.STORE_NM = #{storeNm}
    </if>
    <if test='clsFg != null and clsFg != "" and clsFg.toString() != "ALL"'>
       AND tms.CLS_FG = #{clsFg}
    </if>
    <if test='sysStatFg != null and sysStatFg != "" and sysStatFg.toString() != "ALL"'>
       AND tms.SYS_STAT_FG = #{sysStatFg}
    </if>
    <if test='vanCd != null and vanCd != "" and vanCd.toString() != "ALL"'>
       AND tms.VAN_CD = #{vanCd}
    </if>
     ORDER BY HQ_OFFICE_CD, STORE_CD
     <include refid="CmmSQL.PagingTemplateBottom"/>
  </select>

  <!-- 버전 적용 매장 등록   -->
  <!--
      TABLE    : TB_CM_POS_VERSN_STORE
      COMMENTS : 버전 적용 매장 등록한다.
  -->
  <insert id="registStore" parameterType="applcStoreVO" >
    /* USE : VerManageMapper.registStore */
    <![CDATA[
    INSERT INTO TB_CM_POS_VERSN_STORE
    (
      VER_SER_NO,
      STORE_CD,
      VER_RECV_FG,
      VER_RECV_DT,
      POS_IP,
      REG_DT,
      REG_ID,
      MOD_DT,
      MOD_ID
    )
    VALUES
    (
      #{verSerNo},
      #{storeCd},
      #{verRecvFg},
      #{verRecvDt},
      #{posIp},
      #{regDt},
      #{regId},
      #{modDt},
      #{modId}
    )
    ]]>
  </insert>

  <!-- 버전 일련번호 중복 체크   -->
  <!--
      TABLE    : TB_CM_POS_VERSN
      COMMENTS : 버전 일련번호 중복 체크한다.
  -->
  <select id="chkVerSerNo" parameterType="verInfoVO" resultType="Integer">
    /* USE : VerManageMapper.chkVerSerNo */
    SELECT COUNT(1)
      FROM TB_CM_POS_VERSN
     WHERE VER_SER_NO = ${verSerNo}
  </select>

  <!-- 버전 적용 매장 삭제   -->
  <!--
      TABLE    : TB_CM_POS_VERSN_STORE
      COMMENTS : 버전 적용 매장 삭제한다.
  -->
  <delete id="removeStore" parameterType="applcStoreVO" >
    /* USE : VerManageMapper.removeStore */
    <![CDATA[
    DELETE TB_CM_POS_VERSN_STORE
     WHERE VER_SER_NO = #{verSerNo}
       AND STORE_CD = #{storeCd}
    ]]>
  </delete>

</mapper>

