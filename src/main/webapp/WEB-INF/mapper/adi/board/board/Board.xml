<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    Board.xml
    일반게시판
    ======================================================
    No  ||  수정자 ||  수정일자    ||  수정내역
    ======================================================
    1       김설아     2020.02.11     최초작성
-->
<mapper namespace="kr.co.solbipos.adi.board.board.service.impl.BoardMapper">

    <!-- Clob -->
    <resultMap id="BoardListMap" type="DefaultMap">
        <result column="CONTENT" property="content" javaType="java.lang.String"/>
    </resultMap>

    <!-- 일반게시판 조회 -->
    <!--
        TABLE    : TB_WB_BOARD_INFO, TB_WB_USER_INFO_DTL_V01
        COMMENTS : 게시판 정보, 웹 사용자 정보 veiw
    -->
    <select id="getBoardList" parameterType="BoardVO" resultType="DefaultMap">
        /* BoardMapper.getBoardList */
        <include refid="CmmSQL.PagingTemplateHeader"/>
        SELECT *
        FROM
        (
            SELECT
            twbi.BOARD_CD,
            twbi.BOARD_SEQ_NO,
            twbi.TITLE || ' [' || twbi.ANSWER_CNT || ']' AS TITLE,
            twbi.VIEW_CNT,
            twbi.TARGET_FG,
            twbi.APPR_FG,
            twuidv01.ORGN_FG,
            twuidv01.ORGN_NM  AS AGENCY_NM,
            twbi.USER_ID,
            twbi.USER_NM,
            (TO_CHAR(TO_DATE(twbi.START_DATE, 'YYYYMMDD'), 'yyyy-mm-dd') || ' ~ ' || TO_CHAR(TO_DATE(twbi.END_DATE, 'YYYYMMDD'), 'yyyy-mm-dd')) AS NOTICE_DATE,
            twbi.REMARK,
            DECODE(twbrh.VIEW_YN, null, 'N', 'Y') AS VIEW_YN,
            DECODE(twbi.FULL_SiZE_YN, null, 'N', twbi.FULL_SiZE_YN) AS FULL_SiZE_YN
            <include refid="CmmSQL.PagingTemplateCount"/>
            FROM TB_WB_BOARD_INFO twbi,
            TB_WB_USER_INFO_DTL_V01 twuidv01,
            (
                SELECT
                BOARD_CD,
                BOARD_SEQ_NO,
                USER_ID,
                COUNT(IDX) AS VIEW_YN
                FROM TB_WB_BOARD_READNG_HIST
                WHERE 1=1
                AND BOARD_CD = #{boardCd}
                AND USER_ID = #{userId}
                GROUP BY BOARD_CD, BOARD_SEQ_NO, USER_ID
            ) twbrh
            WHERE 1=1
            AND twbi.BOARD_CD = #{boardCd}
            AND twbi.USE_YN = 'Y'
            <choose>
                <when test='gubunCombo != null'>
                    <if test="gubunName != null and gubunName != ''">
                        <!-- 제목 -->
                        <if test='gubunCombo == "1"'>
                            <![CDATA[
                                AND twbi.TITLE LIKE '%'||#{gubunName}||'%'
                            ]]>
                        </if>
                        <!-- 내용 -->
                        <if test='gubunCombo == "2"'>
                            <![CDATA[
                                AND twbi.CONTENT LIKE '%'||#{gubunName}||'%'
                            ]]>
                        </if>
                        <!-- 제목 + 내용 -->
                        <if test='gubunCombo == "3"'>
                            <![CDATA[
                                AND twbi.TITLE LIKE '%'||#{gubunName}||'%'
                                AND twbi.CONTENT LIKE '%'||#{gubunName}||'%'
                            ]]>
                        </if>
                        <!-- 작성자 -->
                        <if test='gubunCombo == "4"'>
                            <![CDATA[
                                AND twuidv01.USER_NM LIKE '%'||#{gubunName}||'%'
                            ]]>
                        </if>
                    </if>
                </when>
            </choose>
            <choose>
                <when test='orgnFg != null and orgnFg != ""'>
                    <!-- 본사 -->
                    <if test='orgnFg == "H"'>
        <![CDATA[
              AND(
                    (       -- 본인이 작성한 글
                            twuidv01.ORGN_FG = 'H'
                        AND twuidv01.HQ_OFFICE_CD = #{hqOfficeCd}
                    )
                OR  (       -- 게시대상으로 설정된 글
                            twbi.APPR_FG = '2'
                        AND twbi.TARGET_FG = '6'
                        AND twbi.BOARD_SEQ_NO IN (SELECT BOARD_SEQ_NO FROM TB_WB_BOARD_PART_STORE WHERE BOARD_CD = #{boardCd} AND PART_ORGN_CD = #{hqOfficeCd} AND USE_YN = 'Y')
                    )
                OR  (       -- 관리자가 등록한 글
                            twbi.APPR_FG = '2'
                        AND twuidv01.ORGN_FG = 'M'
                        AND twbi.TARGET_FG LIKE '%4%'
                    )
                OR  (       -- 총판/대리점이 등록한 글
                            twbi.APPR_FG = '2'
                        AND twuidv01.ORGN_FG = 'A'
                        AND twbi.TARGET_FG LIKE '%4%'
                        AND twuidv01.ORGN_CD = (SELECT AGENCY_CD FROM TB_HQ_OFFICE WHERE HQ_OFFICE_CD = #{hqOfficeCd})
                    )
                )
        ]]>
                    </if>
                    <!-- 매장 -->
                    <if test='orgnFg == "S"'>
        <![CDATA[
            AND (
                    (       -- 본인이 작성한 글
                            twuidv01.ORGN_FG = 'S' AND twuidv01.STORE_CD = #{storeCd}
                    )
                OR  (       -- 게시대상으로 설정된 글
                            twbi.APPR_FG = '2'
                        AND twbi.TARGET_FG = '6'
                        AND twbi.BOARD_SEQ_NO IN (SELECT BOARD_SEQ_NO FROM TB_WB_BOARD_PART_STORE WHERE BOARD_CD = #{boardCd} AND PART_ORGN_CD = #{storeCd} AND USE_YN = 'Y')
                    )
                OR  (       -- 관리자가 등록한 글
                            twbi.APPR_FG = '2'
                        AND twuidv01.ORGN_FG = 'M'
                        AND twbi.TARGET_FG LIKE '%5%'
                    )
                OR  (       -- 총판/대리점이 등록한 글
                            twbi.APPR_FG = '2'
                        AND twuidv01.ORGN_FG = 'A'
                        AND twbi.TARGET_FG LIKE '%5%'
                        AND twuidv01.ORGN_CD = (SELECT AGENCY_CD FROM TB_MS_STORE WHERE STORE_CD = #{storeCd})
                    )
                OR  (       -- 본사가 등록한 글
                            twbi.APPR_FG = '2'
                        AND twuidv01.ORGN_FG = 'H'
                        AND twbi.TARGET_FG LIKE '%5%'
                        AND twuidv01.HQ_OFFICE_CD = (SELECT HQ_OFFICE_CD FROM TB_MS_STORE WHERE STORE_CD = #{storeCd})
                    )
                )
        ]]>
                    </if>
                    <!-- 시스템 -->
                    <if test='orgnFg == "M"'>
                AND twuidv01.ORGN_FG = 'M'
                AND (
                        (twbi.APPR_FG = '2')
                        OR (twbi.APPR_FG = '1' AND twbi.USER_ID = #{userId})
                        OR (twbi.APPR_FG = '3' AND twbi.USER_ID = #{userId})
                    )
                    </if>
                    <!-- 대리점 -->
                    <if test='orgnFg == "A"'>
                <![CDATA[
                AND (
                        (       -- 본인이 작성한 글
                                twuidv01.ORGN_FG = 'A'
                            AND twuidv01.ORGN_CD = #{orgnGrpCd}
                        )
                    OR (       -- 게시대상으로 설정된 글
                                twbi.TARGET_FG = '6'
                            AND twbi.BOARD_SEQ_NO IN (SELECT BOARD_SEQ_NO FROM TB_WB_BOARD_PART_STORE WHERE BOARD_CD = #{boardCd} AND PART_ORGN_CD = #{orgnGrpCd} AND USE_YN = 'Y')
                        )
                    OR  (       -- 관리자가 등록한 글
                                twbi.APPR_FG = '2'
                            AND twuidv01.ORGN_FG = 'M'
                            AND twbi.TARGET_FG LIKE '%' || CASE WHEN (SELECT P_AGENCY_CD
                                                                        FROM TB_CM_AGENCY
                                                                        WHERE AGENCY_CD = #{orgnGrpCd}) = '00000'
                                                                        THEN '2'
                                                                        ELSE '3'
                                                                        END || '%'
                        )
                     OR (       -- 총판/대리점이 등록한 글
                                twuidv01.ORGN_FG = 'A'
                            AND twuidv01.ORGN_CD != #{orgnGrpCd}
                            AND twbi.APPR_FG = '2'
                            AND twbi.TARGET_FG LIKE '%' || CASE WHEN (SELECT P_AGENCY_CD
                                                                        FROM TB_CM_AGENCY
                                                                        WHERE AGENCY_CD = #{orgnGrpCd}) = '00000'
                                                                        THEN '2'
                                                                        ELSE '3'
                                                                        END || '%'
                        )
                    )
                ]]>
                    </if>
                </when>
            </choose>
            AND twuidv01.USER_ID (+)= twbi.USER_ID
            AND twbrh.BOARD_CD (+)= twbi.BOARD_CD
            AND twbrh.BOARD_SEQ_NO (+)= twbi.BOARD_SEQ_NO
            ORDER BY 1
                    <!-- 시스템 -->
                    <if test='orgnFg == "M"'>
                    ,   twbi.REG_DT DESC
                    </if>
                    ,   twbi.MOD_DT DESC
        )
        WHERE 1=1
        <if test='gubunReadCombo != null'>
            <![CDATA[
                AND VIEW_YN = #{gubunReadCombo}
            ]]>
        </if>
        <include refid="CmmSQL.PagingTemplateBottom"/>
    </select>

    <!-- 게시판 상세 팝업 - 조회 -->
    <!--
        TABLE    : TB_WB_BOARD_INFO, TB_WB_BOARD_MASTER, TB_WB_BOARD_PART_STORE, TB_MS_STORE
        COMMENTS : 게시판 정보, 게시판 마스터, 게시판 일부 매장, [매장]매장 정보
    -->
    <select id="getBoardDetailList" parameterType="BoardVO" resultMap="BoardListMap">
        /* BoardMapper.getBoardDetailList */
        SELECT
        twbi.TITLE,
        twbi.USER_NM,
        twbi.APPR_FG,
        twbi.TARGET_FG,
        twbps.PART_ORGN_CD,
        twbps.PART_ORGN_NM,
        twbi.NOTICE_YN,
        --sms전송
        twbi.START_DATE,
        twbi.END_DATE,
        twbi.CONTENT,
        TO_CHAR(TO_DATE(twbi.REG_DT, 'YYYY-MM-DD HH24:MI:SS'), 'YYYY-MM-DD HH24:MI:SS') AS REG_DT,
        twbm.ANSWER_FG,
        twbi.REMARK,
        twbi.EMERGENCY_YN,
        twbi.FULL_SIZE_YN,
        twbi.POPUP_YN
        FROM TB_WB_BOARD_INFO twbi,
        TB_WB_BOARD_MASTER twbm,
        (
            SELECT
            twbps.BOARD_CD,
            twbps.BOARD_SEQ_NO,
            LISTAGG(twbps.PART_ORGN_CD, ',') WITHIN GROUP (ORDER BY twbps.PART_ORGN_CD) AS PART_ORGN_CD,
            LISTAGG(info.NM, ',') WITHIN GROUP (ORDER BY info.NM) AS PART_ORGN_NM
            FROM TB_WB_BOARD_PART_STORE twbps,
            (
                SELECT	tms.STORE_CD AS CD, TMS.STORE_NM AS NM
                FROM 	TB_MS_STORE tms
                WHERE 	tms.STORE_CD IN (SELECT PART_ORGN_CD FROM TB_WB_BOARD_PART_STORE WHERE BOARD_CD = #{boardCd} AND BOARD_SEQ_NO = #{boardSeqNo})
                UNION ALL
                SELECT	tho.HQ_OFFICE_CD AS CD, tho.HQ_OFFICE_NM AS NM
                FROM 	TB_HQ_OFFICE tho
                WHERE 	tho.HQ_OFFICE_CD IN (SELECT PART_ORGN_CD FROM TB_WB_BOARD_PART_STORE WHERE BOARD_CD = #{boardCd} AND BOARD_SEQ_NO = #{boardSeqNo})
            ) info
            WHERE 1=1
            AND info.CD (+)= twbps.PART_ORGN_CD
            AND twbps.USE_YN = 'Y'
            GROUP BY twbps.BOARD_CD, twbps.BOARD_SEQ_NO
        ) twbps
        WHERE 1=1
        AND twbi.BOARD_CD = #{boardCd}
        AND twbi.BOARD_SEQ_NO = #{boardSeqNo}
        AND twbm.BOARD_CD (+)= twbi.BOARD_CD
        AND twbps.BOARD_CD (+)= twbi.BOARD_CD
        AND twbps.BOARD_SEQ_NO (+)= twbi.BOARD_SEQ_NO
    </select>

    <!-- 팝업 게시판 조회(본사/매장) -->
    <!--
        TABLE    : TB_WB_BOARD_READNG_HIST
        COMMENTS : 게시판 조회
    -->
    <select id="getPopUpBoardList" parameterType="BoardVO" resultMap="BoardListMap">
        /* ContentMapper.getPopUpBoardList */
        SELECT  twbi.TITLE,
                twbi.CONTENT
        FROM    TB_WB_BOARD_INFO twbi,
                TB_WB_USER_INFO_DTL_V01 twuidv01
        WHERE   twbi.BOARD_CD = '01'
        AND     twbi.USE_YN = 'Y'
        AND     twbi.POPUP_YN = 'Y'
        <if test='orgnFg == "H"'>
              AND(
                    (       -- 게시대상으로 설정된 글
                            twbi.TARGET_FG = '6'
                        AND twbi.BOARD_SEQ_NO IN (SELECT BOARD_SEQ_NO FROM TB_WB_BOARD_PART_STORE WHERE BOARD_CD = '01' AND PART_ORGN_CD = #{hqOfficeCd} AND USE_YN = 'Y')
                    )
                OR  (       -- 관리자가 등록한 글
                            twuidv01.ORGN_FG = 'M'
                        AND twbi.TARGET_FG LIKE '%4%'
                    )
                OR  (       -- 총판/대리점이 등록한 글
                            twuidv01.ORGN_FG = 'A'
                        AND twbi.TARGET_FG LIKE '%4%'
                        AND twuidv01.ORGN_CD = (SELECT AGENCY_CD FROM TB_HQ_OFFICE WHERE HQ_OFFICE_CD = #{hqOfficeCd})
                    )
                )
        </if>
        <if test='orgnFg == "S"'>
            AND (
                    (       -- 게시대상으로 설정된 글
                            twbi.TARGET_FG = '6'
                        AND twbi.BOARD_SEQ_NO IN (SELECT BOARD_SEQ_NO FROM TB_WB_BOARD_PART_STORE WHERE BOARD_CD = '01' AND PART_ORGN_CD = #{storeCd} AND USE_YN = 'Y')
                    )
                OR  (       -- 관리자가 등록한 글
                            twuidv01.ORGN_FG = 'M'
                        AND twbi.TARGET_FG LIKE '%5%'
                    )
                OR  (       -- 총판/대리점이 등록한 글
                            twuidv01.ORGN_FG = 'A'
                        AND twbi.TARGET_FG LIKE '%5%'
                        AND twuidv01.ORGN_CD = (SELECT AGENCY_CD FROM TB_MS_STORE WHERE STORE_CD = #{storeCd})
                    )
                OR  (       -- 본사가 등록한 글
                            twuidv01.ORGN_FG = 'H'
                        AND twbi.TARGET_FG LIKE '%5%'
                        AND twuidv01.HQ_OFFICE_CD = #{hqOfficeCd}
                    )
                )
        </if>
        AND     twbi.APPR_FG = '2'
        AND     twuidv01.USER_ID (+)= twbi.USER_ID
    <![CDATA[
        AND     twbi.START_DATE <= TO_CHAR(SYSDATE, 'yyyyMMdd')
        AND     twbi.END_DATE >= TO_CHAR(SYSDATE, 'yyyyMMdd')
    ]]>
        ORDER BY 1, twbi.MOD_DT DESC
    </select>

    <!-- 팝업 게시판 조회(대리점) -->
    <!--
        TABLE    : TB_WB_BOARD_READNG_HIST
        COMMENTS : 게시판 조회
    -->
    <select id="getAgencyPopUpBoardList" parameterType="BoardVO" resultMap="BoardListMap">
        /* ContentMapper.getAgencyPopUpBoardList */
        SELECT  twbi.TITLE,
                twbi.CONTENT
        FROM    TB_WB_BOARD_INFO twbi
        WHERE   twbi.BOARD_CD = '01'
        AND     twbi.USE_YN = 'Y'
        AND     twbi.POPUP_YN =  'Y'
          AND (
                    (       -- 게시대상으로 설정된 글
                            twbi.TARGET_FG = '6'
                        AND twbi.BOARD_SEQ_NO IN (SELECT BOARD_SEQ_NO FROM TB_WB_BOARD_PART_STORE WHERE BOARD_CD = '01' AND PART_ORGN_CD = #{orgnGrpCd} AND USE_YN = 'Y')
                    )
                OR  (       -- 게시대상이 총판/대리점인 경우
                            twbi.TARGET_FG LIKE '%' || CASE WHEN (SELECT P_AGENCY_CD
                                                                    FROM TB_CM_AGENCY
                                                                   WHERE AGENCY_CD = #{orgnGrpCd}) = '00000'
                                                       THEN '2'
                                                       ELSE '3'
                                                       END || '%'
                    )
            )
    <![CDATA[
        -- 본인이 작성한 글 제외
        AND     twbi.USER_ID != #{userId}
        AND     twbi.APPR_FG = '2'
        AND     twbi.START_DATE <= TO_CHAR(SYSDATE, 'yyyyMMdd')
        AND     twbi.END_DATE >= TO_CHAR(SYSDATE, 'yyyyMMdd')
    ]]>
        ORDER BY 1, twbi.MOD_DT DESC
    </select>


    <!-- 팝업 게시판 조회(관리자) -->
    <!--
        TABLE    : TB_WB_BOARD_READNG_HIST
        COMMENTS : 게시판 조회
    -->
    <select id="getSystemPopUpBoardList" parameterType="BoardVO" resultMap="BoardListMap">
        /* ContentMapper.getSystemPopUpBoardList */
        SELECT  twbi.TITLE,
                twbi.CONTENT
        FROM    TB_WB_BOARD_INFO twbi
        WHERE   twbi.BOARD_CD = '01'
        AND     twbi.USE_YN = 'Y'
        AND     twbi.POPUP_YN = 'Y'
        AND     twbi.TARGET_FG LIKE '%1%'
        -- 본인이 작성한 글 제외
        AND     twbi.USER_ID != #{userId}
        AND     twbi.APPR_FG = '2'
    <![CDATA[
       AND      twbi.START_DATE <= TO_CHAR(SYSDATE, 'yyyyMMdd')
       AND      twbi.END_DATE >= TO_CHAR(SYSDATE, 'yyyyMMdd')
    ]]>
        ORDER BY 1, twbi.MOD_DT DESC
    </select>

    <!-- 게시판 조회수 조회 -->
    <!--
        TABLE    : TB_WB_BOARD_READNG_HIST
        COMMENTS : 게시판 열람 이력
    -->
    <select id="getBoardViewCnt" parameterType="BoardVO" resultType="String">
        /* BoardMapper.getBoardViewCnt */
        SELECT
        COUNT(twbrh.IDX) AS VIEW_CNT
        FROM TB_WB_BOARD_READNG_HIST twbrh
        WHERE 1=1
        AND twbrh.BOARD_CD = #{boardCd}
        AND twbrh.BOARD_SEQ_NO = #{boardSeqNo}
    </select>

    <!-- 게시판 조회수 update -->
    <!--
        TABLE    : TB_WB_BOARD_INFO
        COMMENTS : 게시판 정보
    -->
    <update id="getBoardViewCntUpdate" parameterType="BoardVO">
        /* BoardMapper.getBoardViewCntUpdate */
        UPDATE
        TB_WB_BOARD_INFO
        SET
        VIEW_CNT = #{viewCnt}
        WHERE 1=1
        AND BOARD_CD = #{boardCd}
        AND BOARD_SEQ_NO = #{boardSeqNo}
    </update>

    <!-- 게시판 열람 이력 인덱스 조회(자동채번) -->
    <!--
        TABLE    : TB_WB_BOARD_READNG_HIST
        COMMENTS : 게시판 열람 이력
    -->
    <select id="getBoardReadingHistIdx" parameterType="BoardVO" resultType="String">
        /* BoardMapper.getBoardReadingHistIdx */
        SELECT
        (NVL(MAX(twbrh.IDX), 0) + 1) AS IDX
        FROM TB_WB_BOARD_READNG_HIST twbrh
        WHERE 1=1
        AND twbrh.BOARD_CD = #{boardCd}
        AND twbrh.BOARD_SEQ_NO = #{boardSeqNo}
    </select>

    <!-- 게시판 열람 이력 insert -->
    <!--
        TABLE    : TB_WB_BOARD_READNG_HIST
        COMMENTS : 게시판 열람 이력
    -->
    <insert id="getBoardReadingHistInsert" parameterType="BoardVO">
        /* BoardMapper.getBoardReadingHistInsert */
        INSERT INTO TB_WB_BOARD_READNG_HIST
        (
            BOARD_CD,
            BOARD_SEQ_NO,
            USER_ID,
            READNG_DT,
            REG_DT,
            REG_ID,
            IDX
        ) VALUES (
            #{boardCd},
            #{boardSeqNo},
            #{regId},
            #{regDt},
            #{regDt},
            #{regId},
            #{idx}
        )
    </insert>

    <!-- 게시판 게시일련번호 조회(자동채번) -->
    <!--
        TABLE    : TB_WB_BOARD_INFO
        COMMENTS : 게시판 정보
    -->
    <select id="getBoardBoardSeqNo" parameterType="BoardVO" resultType="String">
        /* BoardMapper.getBoardBoardSeqNo */
        SELECT
        (NVL(MAX(twbi.BOARD_SEQ_NO), 0) + 1) AS BOARD_SEQ_NO
        FROM TB_WB_BOARD_INFO twbi
        WHERE 1=1
        AND twbi.BOARD_CD = #{boardCd}
    </select>

    <!-- 게시판 신규등록,수정 팝업 - 저장 isert -->
    <!--
        TABLE    : TB_WB_BOARD_INFO
        COMMENTS : 게시판 정보
    -->
    <insert id="getBoardInfoSaveInsert" parameterType="BoardVO">
        /* BoardMapper.getBoardInfoSaveInsert */
        INSERT INTO TB_WB_BOARD_INFO
        (
            BOARD_CD,
            START_DATE,
            END_DATE,
            TITLE,
            NOTICE_YN,
            APPR_FG,
            TARGET_FG,
            VIEW_CNT,
            ANSWER_CNT,
            CONTENT,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID,
            BOARD_SEQ_NO,
            USE_YN,
            USER_ID,
            USER_NM,
            REMARK,
            EMERGENCY_YN,
            FULL_SIZE_YN,
            POPUP_YN
        ) VALUES (
            #{boardCd},
            #{startDate},
            #{endDate},
            REPLACE(#{title}, CHR(39),'＇'),
            #{noticeYn},
            #{apprFg},
            #{targetFg},
            0,
            0,
            #{content},
            #{regDt},
            #{regId},
            #{modDt},
            #{modId},
            #{boardSeqNo},
            'Y',
            #{regId},
            #{userNm},
            #{remark},
            #{emergencyYn},
            #{fullSizeYn},
            #{popupYn}
        )
    </insert>

    <!-- 게시판 신규등록,수정 팝업 -  저장 update -->
    <!--
        TABLE    : TB_WB_BOARD_INFO
        COMMENTS : 게시판 정보
    -->
    <update id="getBoardInfoSaveUpdate" parameterType="BoardVO">
        /* BoardMapper.getBoardInfoSaveUpdate */
        UPDATE
        TB_WB_BOARD_INFO
        SET
        START_DATE = #{startDate},
        END_DATE = #{endDate},
        TITLE = #{title},
        NOTICE_YN = #{noticeYn},
        APPR_FG = #{apprFg},
        TARGET_FG = #{targetFg},
        CONTENT = #{content},
        USER_NM = #{userNm},
        MOD_DT = #{modDt},
        MOD_ID = #{modId},
        REMARK = #{remark},
        EMERGENCY_YN = #{emergencyYn},
        FULL_SIZE_YN = #{fullSizeYn},
        POPUP_YN = #{popupYn}
        WHERE 1=1
        AND BOARD_CD = #{boardCd}
        AND BOARD_SEQ_NO = #{boardSeqNo}
    </update>

    <!-- 게시판 신규등록,수정 팝업 -  저장 delete -->
    <!--
        TABLE    : TB_WB_BOARD_INFO
        COMMENTS : 게시판 정보
    -->
    <update id="getBoardInfoSaveDelete" parameterType="BoardVO">
        /* BoardMapper.getBoardInfoSaveDelete */
        UPDATE
        TB_WB_BOARD_INFO
        SET
        USE_YN = 'N',
        MOD_DT = #{modDt},
        MOD_ID = #{modId}
        WHERE 1=1
        AND BOARD_CD = #{boardCd}
        AND BOARD_SEQ_NO = #{boardSeqNo}
    </update>

    <!-- 게시판 전체 댓글 delete -->
    <!--
        TABLE    : TB_WB_BOARD_ANSWER
        COMMENTS : 게시판 댓글
    -->
    <!--<update id="getBoardDetailAnswerSaveTotDelete" parameterType="BoardVO">-->
        <!--/* BoardMapper.getBoardDetailAnswerSaveTotDelete */-->
        <!--UPDATE-->
        <!--TB_WB_BOARD_ANSWER-->
        <!--SET-->
        <!--USE_YN = 'N',-->
        <!--MOD_DT = #{modDt},-->
        <!--MOD_ID = #{modId}-->
        <!--WHERE 1=1-->
        <!--AND BOARD_CD = #{boardCd}-->
        <!--AND BOARD_SEQ_NO = #{boardSeqNo}-->
    <!--</update>-->

    <!-- 게시판 공개대상 insert -->
    <!--
        TABLE    : TB_WB_BOARD_PART_STORE
        COMMENTS : 게시판 일부 매장
    -->
    <insert id="getBoardPartStoreSaveInsert" parameterType="BoardVO">
        /* BoardMapper.getBoardPartStoreSaveInsert */
        INSERT INTO TB_WB_BOARD_PART_STORE
        (
            BOARD_CD,
            BOARD_SEQ_NO,
            PART_ORGN_CD,
            USE_YN,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID
        ) VALUES (
            #{boardCd},
            #{boardSeqNo},
            #{storeCd},
            'Y',
            #{regDt},
            #{regId},
            #{modDt},
            #{modId}
        )
    </insert>

    <!-- 게시판 공개대상에 선택한 매장이있는지 select -->
    <!--
        TABLE    : TB_WB_BOARD_PART_STORE
        COMMENTS : 게시판 일부 매장
    -->
    <select id="getBoardParStorePartOrgnCd" parameterType="BoardVO" resultType="String">
        /* BoardMapper.getBoardParStorePartOrgnCd */
        SELECT
        COUNT(twbps.PART_ORGN_CD)
        FROM TB_WB_BOARD_PART_STORE twbps
        WHERE 1=1
        AND twbps.BOARD_CD = #{boardCd}
        AND twbps.BOARD_SEQ_NO = #{boardSeqNo}
        AND twbps.PART_ORGN_CD = #{storeCd}
    </select>

    <!-- 게시판 공개대상 update -->
    <!--
        TABLE    : TB_WB_BOARD_PART_STORE
        COMMENTS : 게시판 일부 매장
    -->
    <update id="getBoardPartStoreSaveUpdate" parameterType="BoardVO">
        /* BoardMapper.getBoardPartStoreSaveUpdate */
        UPDATE
        TB_WB_BOARD_PART_STORE
        SET
        USE_YN = 'Y',
        MOD_DT = #{modDt},
        MOD_ID = #{modId}
        WHERE 1=1
        AND BOARD_CD = #{boardCd}
        AND BOARD_SEQ_NO = #{boardSeqNo}
        AND PART_ORGN_CD = #{storeCd}
    </update>

    <!-- 게시판 공개대상 delete -->
    <!--
        TABLE    : TB_WB_BOARD_PART_STORE
        COMMENTS : 게시판 일부 매장
    -->
    <update id="getBoardPartStoreSaveDelete" parameterType="BoardVO">
        /* BoardMapper.getBoardPartStoreSaveDelete */
        UPDATE
        TB_WB_BOARD_PART_STORE
        SET
        USE_YN = 'N',
        MOD_DT = #{modDt},
        MOD_ID = #{modId}
        WHERE 1=1
        AND BOARD_CD = #{boardCd}
        AND BOARD_SEQ_NO = #{boardSeqNo}
    </update>

    <!-- 첨부파일 저장시 IDX (자동채번) -->
    <!--
        TABLE    : TB_WB_BOARD_ATCH
        COMMENTS : 게시판 첨부
    -->
    <select id="getBoardAtchIdx" parameterType="BoardVO" resultType="String">
        /* BoardMapper.getBoardAtchIdx */
        SELECT
        (NVL(MAX(twba.IDX), 0) + 1) AS IDX
        FROM TB_WB_BOARD_ATCH twba
        WHERE 1=1
        AND twba.BOARD_CD = #{boardCd}
        AND twba.BOARD_SEQ_NO = #{boardSeqNo}
    </select>

    <!-- 게시판 신규등록,수정 팝업 - 첨부파일 저장 isert -->
    <!--
        TABLE    : TB_WB_BOARD_ATCH
        COMMENTS : 게시판 첨부
    -->
    <insert id="getBoardInfoAtchSaveIsert" parameterType="BoardVO">
        /* BoardMapper.getBoardInfoAtchSaveIsert */
        INSERT INTO TB_WB_BOARD_ATCH
        (
            BOARD_CD,
            BOARD_SEQ_NO,
            IDX,
            FILE_PATH,
            FILE_NM,
            ORGINL_FILE_NM,
            FILE_EXT,
            USE_YN,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID
        ) VALUES (
            #{boardCd},
            #{boardSeqNo},
            #{idx},
            #{filePath},
            #{fileNm},
            #{orginlFileNm},
            #{fileExt},
            'Y',
            #{regDt},
            #{regId},
            #{modDt},
            #{modId}
        )
    </insert>

    <!-- 게시판 댓글 조회 -->
    <!--
        TABLE    : TB_WB_BOARD_ANSWER
        COMMENTS : 게시판 댓글
    -->
    <select id="getBoardDetailAnswerList" parameterType="BoardVO" resultType="DefaultMap">
        /* BoardMapper.getBoardDetailAnswerList */
        SELECT
        twba.IDX,
        (CASE WHEN twba.USER_ID = #{userId} THEN '수정' ELSE '' END) AS EDIT,
        (CASE WHEN twba.USER_ID = #{userId} THEN '저장' ELSE '' END) AS SAVE,
        (CASE WHEN twba.USER_ID = #{userId} THEN '삭제' ELSE '' END) AS DEL,
        twba.USER_NM,
        twba.CONTENT,
        twba.REG_DT,
        twba.REG_ID,
        TO_CHAR(TO_DATE(twba.MOD_DT, 'YYYYMMDDHH24MISS'), 'YYYY.MM.DD HH24:MI:SS') AS MOD_DT
        FROM TB_WB_BOARD_ANSWER twba
        WHERE 1=1
        AND twba.BOARD_CD = #{boardCd}
        AND twba.BOARD_SEQ_NO = #{boardSeqNo}
        AND twba.USE_YN = 'Y'
        ORDER BY twba.REG_DT DESC
    </select>

    <!-- 사용자이름 조회 -->
    <!--
        TABLE    : TB_WB_USER_INFO_DTL_V01
        COMMENTS : 웹 사용자 정보 veiw
    -->
    <select id="getBoardUserNm" parameterType="BoardVO" resultType="String">
        /* BoardMapper.getBoardUserNm */
        SELECT twuidv01.USER_NM
        FROM TB_WB_USER_INFO_DTL_V01 twuidv01
        WHERE 1=1
        AND twuidv01.USER_ID = #{userId}
    </select>

    <!-- 게시판 댓글번호 조회(자동채번) -->
    <!--
        TABLE    : TB_WB_BOARD_ANSWER
        COMMENTS : 게시판 댓글
    -->
    <select id="getBoardAnswerIdx" parameterType="BoardVO" resultType="String">
        /* BoardMapper.getBoardAnswerIdx */
        SELECT
        (NVL(MAX(twba.IDX), 0) + 1) AS IDX
        FROM TB_WB_BOARD_ANSWER twba
        WHERE 1=1
        AND twba.BOARD_CD = #{boardCd}
        AND twba.BOARD_SEQ_NO = #{boardSeqNo}
    </select>

    <!-- 게시판 댓글 저장 isert -->
    <!--
        TABLE    : TB_WB_BOARD_ANSWER
        COMMENTS : 게시판 댓글
    -->
    <insert id="getBoardDetailAnswerSaveInsert" parameterType="BoardVO">
        /* BoardMapper.getBoardDetailAnswerSaveInsert */
        INSERT INTO TB_WB_BOARD_ANSWER
        (
            BOARD_CD,
            BOARD_SEQ_NO,
            IDX,
            CONTENT,
            USE_YN,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID,
            ORGN_CD,
            USER_ID,
            USER_NM
        ) VALUES (
            #{boardCd},
            #{boardSeqNo},
            #{idx},
            #{content},
            'Y',
            #{regDt},
            #{regId},
            #{modDt},
            #{modId},
            '',
            #{regId},
            #{userNm}
        )
    </insert>

    <!-- 게시판 댓글 저장 update -->
    <!--
        TABLE    : TB_WB_BOARD_ANSWER
        COMMENTS : 게시판 댓글
    -->
    <update id="getBoardDetailAnswerSaveUpdate" parameterType="BoardVO">
        /* BoardMapper.getBoardDetailAnswerSaveUpdate */
        UPDATE
        TB_WB_BOARD_ANSWER
        SET
        CONTENT = #{content},
        MOD_DT = #{modDt},
        MOD_ID = #{modId}
        WHERE 1=1
        AND BOARD_CD = #{boardCd}
        AND BOARD_SEQ_NO = #{boardSeqNo}
        AND IDX = #{idx}
    </update>

    <!-- 게시판 댓글 저장 delete -->
    <!--
        TABLE    : TB_WB_BOARD_ANSWER
        COMMENTS : 게시판 댓글
    -->
    <update id="getBoardDetailAnswerSaveDelete" parameterType="BoardVO">
        /* BoardMapper.getBoardDetailAnswerSaveDelete */
        UPDATE
        TB_WB_BOARD_ANSWER
        SET
        USE_YN = 'N',
        MOD_DT = #{modDt},
        MOD_ID = #{modId}
        WHERE 1=1
        AND BOARD_CD = #{boardCd}
        AND BOARD_SEQ_NO = #{boardSeqNo}
        AND IDX = #{idx}
    </update>

    <!-- 게시판 댓글수 조회 -->
    <!--
        TABLE    : TB_WB_BOARD_ANSWER
        COMMENTS : 게시판 댓글
    -->
    <select id="getBoardAnswerCnt" parameterType="BoardVO" resultType="String">
        /* BoardMapper.getBoardAnswerCnt */
        SELECT
        COUNT(twba.IDX) AS ANSWER_CNT
        FROM TB_WB_BOARD_ANSWER twba
        WHERE 1=1
        AND twba.BOARD_CD = #{boardCd}
        AND twba.BOARD_SEQ_NO = #{boardSeqNo}
        AND twba.USE_YN = 'Y'
    </select>

    <!-- 게시판 댓글수 update -->
    <!--
        TABLE    : TB_WB_BOARD_INFO
        COMMENTS : 게시판 정보
    -->
    <update id="getBoardAnswerCntUpdate" parameterType="BoardVO">
        /* BoardMapper.getBoardAnswerCntUpdate */
        UPDATE
        TB_WB_BOARD_INFO
        SET
        ANSWER_CNT = #{answerCnt}
        WHERE 1=1
        AND BOARD_CD = #{boardCd}
        AND BOARD_SEQ_NO = #{boardSeqNo}
    </update>

    <!-- 게시판 첨부파일 조회 -->
    <!--
        TABLE    : TB_WB_BOARD_ATCH
        COMMENTS : 게시판 첨부
    -->
    <select id="getBoardInfoAtchList" parameterType="BoardVO" resultType="DefaultMap">
        /* BoardMapper.getBoardInfoAtchList */
        SELECT
--         SUBSTR(SUBSTR(twba.ORGINL_FILE_NM, INSTR(twba.ORGINL_FILE_NM, '\', -1, 1)), 2) AS ORGINL_FILE_NM,
        (twba.ORGINL_FILE_NM || '.' || twba.FILE_EXT) AS ORGINL_FILE_NM,
        '본문적용' AS IMG_APPLY,
        '삭제' AS DEL,
        twba.IDX,
        twba.FILE_NM AS TEMP_PATH,
        twba.FILE_EXT
        FROM TB_WB_BOARD_ATCH twba
        WHERE 1=1
        AND twba.BOARD_CD = #{boardCd}
        AND twba.BOARD_SEQ_NO = #{boardSeqNo}
        AND twba.USE_YN = 'Y'
        ORDER BY twba.BOARD_CD, twba.BOARD_SEQ_NO, twba.IDX
    </select>

    <!-- 게시판 첨부파일 조회 -->
    <!--
        TABLE    : TB_WB_BOARD_ATCH
        COMMENTS : 게시판 첨부
    -->
    <select id="getBoardDetailAtchList" parameterType="BoardVO" resultType="BoardVO">
        /* BoardMapper.getBoardDetailAtchList */
        SELECT
        twba.ORGINL_FILE_NM,
        twba.FILE_NM,
        twba.FILE_EXT
        FROM TB_WB_BOARD_ATCH twba
        WHERE 1=1
        AND twba.BOARD_CD = #{boardCd}
        AND twba.BOARD_SEQ_NO = #{boardSeqNo}
        AND twba.USE_YN = 'Y'
        ORDER BY twba.BOARD_CD, twba.BOARD_SEQ_NO, twba.IDX
    </select>

    <!-- 게시판 첨부파일 삭제 -->
    <!--
        TABLE    : TB_WB_BOARD_ATCH
        COMMENTS : 게시판 첨부
    -->
    <update id="getBoardInfoAtchDel" parameterType="BoardVO">
        /* BoardMapper.getBoardInfoAtchDel */
        UPDATE
        TB_WB_BOARD_ATCH
        SET
        USE_YN = 'N',
        MOD_DT = #{modDt},
        MOD_ID = #{modId}
        WHERE 1=1
        AND BOARD_CD = #{boardCd}
        AND BOARD_SEQ_NO = #{boardSeqNo}
        AND IDX = #{idx}
    </update>

    <!-- 열람자목록 팝업 - 검색 -->
    <!--
        TABLE    : TB_WB_BOARD_READNG_HIST, TB_WB_USER_INFO_DTL_V01
        COMMENTS : 게시판 열람 이력, 웹 사용자 정보 veiw
    -->
    <select id="getBoardReadingHistList" parameterType="BoardVO" resultType="DefaultMap">
        /* BoardMapper.getBoardReadingHistList */
        SELECT *
        FROM
        (
            SELECT
            twbrh.BOARD_CD,
            twbrh.BOARD_SEQ_NO,
            twuidv01.HQ_OFFICE_NM AS HQ_OFFICE_NM,
            twuidv01.STORE_NM AS STORE_NM,
            twuidv01.ORGN_FG AS AUTH_GRP_NM,
            --부서구분
            twuidv01.USER_NM,
            MAX(twbrh.READNG_DT) AS READNG_DT
            FROM TB_WB_BOARD_READNG_HIST twbrh,
            TB_WB_USER_INFO_DTL_V01 twuidv01
            WHERE 1=1
            AND twbrh.BOARD_CD = #{boardCd}
            AND twbrh.BOARD_SEQ_NO = #{boardSeqNo}
            AND twuidv01.USER_NM LIKE '%'||#{userNm}||'%'
            <choose>
                <!-- 전체 체크박스 제외 -->
                <when test='authGrpNm != null and authGrpNm != "" and authGrpNm != "all"'>
                    <!-- 본사 로그인시 전체 체크박스 -->
                    <if test='authGrpNm == "allHQ"'>
                        <![CDATA[
                            AND twuidv01.ORGN_FG IN ('H','S')
                        ]]>
                    </if>
                    <!-- 나머지(시스템,대리점,본사,매장 만) -->
                    <if test='authGrpNm != "allHQ"'>
                        <![CDATA[
                            AND twuidv01.ORGN_FG = #{authGrpNm}
                        ]]>
                    </if>
                </when>
            </choose>
            <if test='membrOrgnCd != null and membrOrgnCd != ""'>
                <![CDATA[
                    AND twuidv01.HQ_OFFICE_CD = #{membrOrgnCd}
                ]]>
            </if>
            <if test='storeCd != null and storeCd != ""'>
                <![CDATA[
                    AND twuidv01.STORE_CD = #{storeCd}
                ]]>
            </if>
            AND twuidv01.USER_ID (+)= twbrh.USER_ID
            GROUP BY twbrh.BOARD_CD, twbrh.BOARD_SEQ_NO, twuidv01.HQ_OFFICE_NM, twuidv01.STORE_NM, twuidv01.ORGN_FG, twuidv01.USER_NM
        )
        WHERE 1=1
        ORDER BY READNG_DT DESC
    </select>

    <!-- 첨부파일에 임시경로 UPDATE -->
    <!--
        TABLE    : TB_WB_BOARD_ATCH
        COMMENTS : 첨부파일에 임시경로 UPDATE
    -->
    <update id="setTempPath" parameterType="BoardVO">
        /* BoardMapper.setTempPath */
        UPDATE TB_WB_BOARD_ATCH
           SET TEMP_PATH = #{tempPath}
         WHERE 1=1
           AND BOARD_CD = #{boardCd}
           AND BOARD_SEQ_NO = #{boardSeqNo}
           AND (ORGINL_FILE_NM || '.' || FILE_EXT) = #{orginlFileNm}
           AND USE_YN = 'Y'
    </update>

    <!-- 게시글에 속한 첨부파일 조회 -->
    <!--
        TABLE    : TB_WB_BOARD_ATCH
        COMMENTS :  게시글에 속한 첨부파일 조회
    -->
    <select id="getAtchList" parameterType="BoardVO" resultType="DefaultMap">
        /* BoardMapper.getAtchList */
        SELECT TEMP_PATH,
                FILE_NM
          FROM TB_WB_BOARD_ATCH
         WHERE BOARD_CD = #{boardCd}
           AND BOARD_SEQ_NO = #{boardSeqNo}
           AND USE_YN = 'Y'
    </select>

    <!-- 게시글 내 이미지 파일 임시경로 서버경로로 치환 -->
    <!--
        TABLE    : TB_WB_BOARD_INFO
        COMMENTS : 게시글 내 이미지 파일 임시경로 서버경로로 치환
    -->
    <update id="saveBoardInfoContent" parameterType="BoardVO">
        /* BoardMapper.saveBoardInfoContent */
        UPDATE TB_WB_BOARD_INFO
           SET CONTENT = REPLACE(CONTENT, #{tempPath}, #{rootUrl}),
                MOD_DT = #{modDt},
                MOD_ID = #{modId}
         WHERE BOARD_CD = #{boardCd}
           AND BOARD_SEQ_NO = #{boardSeqNo}
           AND USE_YN = 'Y'
    </update>

    <!-- 본사매장선택 조회 -->
    <!--
        TABLE    : TB_MS_STORE
        PARAM    : BoardVO
        COMMENTS : 본사매장선택 리스트를 조회한다.
    -->
    <select id="selectHqStoreList" parameterType="BoardVO" resultType="DefaultMap">
        /* USE : BoardMapper.selecthqstorelist */
        <if test='orgnFg != "H"'>
            SELECT 	HQ_OFFICE_CD AS CD,
                    HQ_OFFICE_NM AS NM,
                    '본사' AS GUBUN
            FROM	TB_HQ_OFFICE tho
            WHERE   1=1
            <if test='storeCd != null and storeCd != ""'>
                AND tho.HQ_OFFICE_CD LIKE '%'||#{storeCd}||'%'
            </if>
            <if test='storeNm != null and storeNm != ""'>
                AND tho.HQ_OFFICE_NM LIKE '%'||#{storeNm}||'%'
            </if>
            <if test='orgnFg == "A"'>
                AND tho.AGENCY_CD = #{orgnGrpCd}
            </if>
            UNION ALL
        </if>
        SELECT 	STORE_CD AS CD,
                STORE_NM AS NM,
                '매장' AS GUBUN
        FROM 	TB_MS_STORE tms
        WHERE   1=1
        <if test='storeCd != null and storeCd != ""'>
            AND tms.STORE_CD LIKE '%'||#{storeCd}||'%'
        </if>
        <if test='storeNm != null and storeNm != ""'>
            AND tms.STORE_NM LIKE '%'||#{storeNm}||'%'
        </if>
        <if test='orgnFg == "A"'>
            AND tms.AGENCY_CD = #{orgnGrpCd}
        </if>
        <if test='orgnFg == "H"'>
            AND tms.HQ_OFFICE_CD = #{hqOfficeCd}
        </if>
        ORDER BY GUBUN DESC, CD ASC
    </select>

</mapper>