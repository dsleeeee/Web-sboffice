<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    hq/hqBrand.xml
    브랜드 관리
    ======================================================
    No  ||  수정자 ||  수정일자    ||  수정내역
    ======================================================
    1       김지은     2018.06.01     최초작성
-->


<mapper namespace="kr.co.solbipos.store.hq.brand.service.impl.HqBrandMapper">
  
  <!-- 브랜드목록 조회 -->
  <!--
      TABLE    : TB_HQ_BRAND, TB_HQ_OFFICE
      COMMENTS : 브랜드 목록을 조회한다.
  -->
  <select id="list" parameterType="DefaultMap" resultType="DefaultMap">
    /* USE : HqBrandMapper.list */
    <![CDATA[
    SELECT COUNT(1) OVER (PARTITION BY 1 ORDER BY 1) TOT_CNT,
           ROW_NUMBER() OVER(PARTITION BY 1 ORDER BY 1) RNUM,
           A.HQ_OFFICE_CD,
           B.HQ_OFFICE_NM,
           A.HQ_BRAND_CD,
           A.HQ_BRAND_NM,
           A.USE_YN
      FROM TB_HQ_BRAND A,
           TB_HQ_OFFICE B
     WHERE B.HQ_OFFICE_CD = A.HQ_OFFICE_CD
    ]]>
    <if test='hqOfficeCd != null and hqOfficeCd != ""'>
       AND A.HQ_OFFICE_CD LIKE '%'||#{hqOfficeCd}||'%'
    </if>
    <if test='hqOfficeNm != null and hqOfficeNm != ""'>
       AND B.HQ_OFFICE_NM LIKE '%'||#{hqOfficeNm}||'%'
    </if>
    <if test='hqBrandCd != null and hqBrandCd != ""'>
       AND A.HQ_BRAND_CD LIKE '%'||#{hqBrandCd}||'%'
    </if>
    <if test='hqBrandNm != null and hqBrandNm != ""'>
       AND A.HQ_BRAND_NM LIKE '%'||#{hqBrandNm}||'%'
    </if>
    <if test='useYn != null and useYn.toString() != "ALL"'>
       AND A.USE_YN = #{useYn}
    </if>
     ORDER BY A.REG_DT, A.HQ_OFFICE_CD, A.HQ_BRAND_CD ASC
  </select>

  <select id="getHqBrandCd" parameterType="hqBrandVO" resultType="String">
    /* USE : HqBrandMapper.getHqBrandCd */
    SELECT CONCAT(#{hqOfficeCd}, LPAD(SUBSTR(NVL(MAX(HQ_BRAND_CD), '0000000'), 6, 2) +1, 2, '0'))
      FROM TB_HQ_BRAND
     WHERE HQ_OFFICE_CD = #{hqOfficeCd}
  </select>

  <insert id="insertBrand" parameterType="DefaultMap">
    /* USE : HqBrandMapper.insertBrand */
      INSERT INTO TB_HQ_BRAND
    (
      HQ_BRAND_CD,
      HQ_BRAND_NM,
      HQ_OFFICE_CD,
      USE_YN,
      REG_DT,
      REG_ID,
      MOD_DT,
      MOD_ID
    )
    VALUES
    (
       #{hqBrandCd},
       #{hqBrandNm},
       #{hqOfficeCd},
       #{useYn},
       #{regDt},
       #{regId},
       #{modDt},
       #{modId}
    )
  </insert>

  <update id="updateBrand" parameterType="hqBrandVO">
    /* USE : HqBrandMapper.updateBrand */
    UPDATE TB_HQ_BRAND
       SET USE_YN = #{useYn}
     WHERE HQ_BRAND_CD = #{hqBrandCd}
       AND HQ_OFFICE_CD = #{hqOfficeCd}
  </update>

  <delete id="deleteBrand" parameterType="hqBrandVO">
    /* USE : HqBrandMapper.deleteBrand */
    DELETE TB_HQ_BRAND
     WHERE HQ_BRAND_CD = #{hqBrandCd}
       AND HQ_OFFICE_CD = #{hqOfficeCd}
  </delete>


  <!-- 브랜드환경정보 조회 -->
  <!--
      TABLE    : TB_CM_ENVST, TB_CM_ENVST_DTL, TB_HQ_ENVST, TB_CM_NMCODE, TB_HQ_BRAND, TB_HQ_OFFICE
      COMMENTS : 브랜드의 환경정보를 조회한다.
  -->
  <select id="getConfigList" parameterType="hqBrandVO" resultType="DefaultMap">
    /* USE : HqBrandMapper.getConfigList */
    SELECT tce2.ENVST_GRP_CD,
           tcn.NMCODE_NM,
           tce2.ENVST_CD,
           tce2.ENVST_NM,
           tce2.DIRCT_IN_YN,
           tce2.REMARK,
           tce2.ENVST_VAL_CD,
           tce2.ENVST_VAL_NM,
           tce2.DEFLT_YN,
           tce2.TARGT_FG,
           DECODE(the.ENVST_CD, NULL, 'N', 'Y') AS EXIST_FG,
           the.ENVST_VAL AS SEL_ENVST_VAL,
           tce3.ENVST_CD_CNT
      FROM (
      SELECT tce.ENVST_GRP_CD,
             tce.ENVST_CD,
             tce.ENVST_NM,
             tce.ENVST_FG,
             tce.TARGT_FG,
             tce.DIRCT_IN_YN,
             tce.REMARK,
             tcd.ENVST_VAL_CD,
             tcd.ENVST_VAL_NM,
             tcd.DEFLT_YN
        FROM TB_CM_ENVST tce,
             TB_CM_ENVST_DTL tcd
       WHERE tce.TARGT_FG IN ('H','X','C')
         AND tce.USE_YN = 'Y'
         AND tcd.ENVST_CD (+)= tce.ENVST_CD
            ) tce2,
            (
       SELECT tce.ENVST_GRP_CD,
              COUNT(*) AS ENVST_CD_CNT
         FROM TB_CM_ENVST tce
        WHERE tce.TARGT_FG IN ('H','X','C')
          AND tce.USE_YN = 'Y'
        GROUP BY tce.ENVST_GRP_CD
            ) tce3,
           TB_HQ_ENVST the,
           TB_CM_NMCODE tcn,
            (
       SELECT thb.HQ_BRAND_CD,
              tho.HQ_OFFICE_CD,
              tho.CLS_FG
         FROM TB_HQ_BRAND thb,
              TB_HQ_OFFICE tho
        WHERE tho.HQ_OFFICE_CD = thb.HQ_OFFICE_CD
            ) thb
     WHERE the.HQ_BRAND_CD (+)= #{hqBrandCd}
       AND the.ENVST_CD (+)= tce2.ENVST_CD
       AND tcn.NMCODE_GRP_CD = '048'
       AND tcn.NMCODE_CD = tce2.ENVST_GRP_CD
       AND thb.HQ_BRAND_CD (+)= the.HQ_BRAND_CD
       AND tce3.ENVST_GRP_CD = tce2.ENVST_GRP_CD
     ORDER BY tce2.ENVST_GRP_CD, tce2.ENVST_CD, tce2.ENVST_VAL_CD
  </select>

  <!-- 브랜드환경정보 등록 -->
  <!--
      TABLE    : TB_HQ_ENVST
      COMMENTS : 브랜드의 환경정보를 조회한다.
  -->
  <insert id="insertConfig" parameterType="DefaultMap">
    /* USE : HqBrandMapper.insertConfig */
    INSERT INTO TB_HQ_ENVST
    (
      HQ_BRAND_CD,
      ENVST_CD,
      ENVST_VAL,
      DIRCT_IN_YN,
      USE_YN,
      REG_DT,
      REG_ID,
      MOD_DT,
      MOD_ID
    )
    VALUES
    (
      #{hqBrandCd},
      #{envstCd},
      #{envstVal},
      #{dirctInYn},
      #{useYn},
      #{regDt},
      #{regId},
      #{modDt},
      #{modId}
    )
  </insert>

  <update id="updateConfig" parameterType="DefaultMap">
    /* USE : HqBrandMapper.updateConfig */
    UPDATE TB_HQ_ENVST
       SET ENVST_VAL = #{envstVal},
           MOD_DT = #{modDt},
           MOD_ID = #{modId}
     WHERE HQ_BRAND_CD = #{hqBrandCd}
       AND ENVST_CD = #{envstCd}
  </update>

  <update id="updateConfigStore" parameterType="DefaultMap">
    /* USE : HqBrandMapper.updateConfigStore */
    UPDATE TB_MS_STORE_ENVST
       SET ENVST_VAL = #{envstVal}
     WHERE STORE_CD IN (SELECT STORE_CD FROM TB_MS_STORE WHERE HQ_OFFICE_CD = #{hqOfficeCd} AND HQ_BRAND_CD = #{hqBrandCd} )
       AND ENVST_CD = #{envstCd}
  </update>

  <select id="getClsList" parameterType="hqBrandVO" resultType="DefaultMap">
    /* USE : HqBrandMapper.getClsList */
    SELECT HQ_BRAND_CD,
           PROD_CLASS_CD,
           PROD_CLASS_NM,
           P_PROD_CLASS_CD
      FROM TB_HQ_PRODUCT_CLASS
     WHERE HQ_BRAND_CD = #{hqBrandCd}
  </select>

  <select id="getClsCd" parameterType="hqClsVO" resultType="String">
    /* USE : HqBrandMapper.getClsCd */
    SELECT LPAD( NVL(MAX(PROD_CLASS_CD), 0) + 1, 5, '0') PROD_CLASS_CD
      FROM TB_HQ_PRODUCT_CLASS
     WHERE HQ_BRAND_CD = #{hqBrandCd}
  </select>

  <select id="getPProdClsCd" parameterType="hqClsVO" resultType="String">
    /* USE : HqBrandMapper.getPProdClsCd */
    SELECT MAX(PROD_CLASS_CD)
      FROM TB_HQ_PRODUCT_CLASS
     WHERE HQ_BRAND_CD = #{hqBrandCd}
  </select>

  <insert id="insertCls" parameterType="hqClsVO">
    /* USE : HqBrandMapper.insertCls */
    INSERT INTO TB_HQ_PRODUCT_CLASS
    (
      HQ_BRAND_CD,
      PROD_CLASS_CD,
      PROD_CLASS_NM,
      P_PROD_CLASS_CD,
      REG_DT,
      REG_ID,
      MOD_DT,
      MOD_ID
    )
    VALUES
    (
      #{hqBrandCd},
      #{prodClassCd},
      #{prodClassNm},
      #{pProdClassCd},
      #{regDt},
      #{regId},
      #{modDt},
      #{modId}
    )
  </insert>

  <update id="updateCls" parameterType="hqClsVO">
    /* USE : HqBrandMapper.updateCls */
    MERGE INTO TB_HQ_PRODUCT_CLASS A
    USING (
          SELECT #{hqBrandCd} HQ_BRAND_CD,
                 #{prodClassCd} PROD_CLASS_CD,
                 #{prodClassNm} PROD_CLASS_NM,
                 #{pProdClassCd} P_PROD_CLASS_CD,
                 #{regDt} REG_DT,
                 #{regId} REG_ID,
                 #{modDt} MOD_DT,
                 #{modId} MOD_ID
            FROM DUAL
          ) B
       ON
        (
          B.HQ_BRAND_CD = A.HQ_BRAND_CD
      AND B.PROD_CLASS_CD = A.PROD_CLASS_CD
        )
     WHEN MATCHED THEN
          UPDATE SET
                 A.PROD_CLASS_NM = B.PROD_CLASS_NM,
                 A.MOD_DT = B.MOD_DT,
                 A.MOD_ID = B.MOD_ID
     WHEN NOT MATCHED THEN
          INSERT
          (
            A.HQ_BRAND_CD,
            A.PROD_CLASS_CD,
            A.PROD_CLASS_NM,
            A.P_PROD_CLASS_CD,
            A.REG_DT,
            A.REG_ID,
            A.MOD_DT,
            A.MOD_ID
          )
          VALUES
          (
            B.HQ_BRAND_CD,
            B.PROD_CLASS_CD,
            B.PROD_CLASS_NM,
            B.P_PROD_CLASS_CD,
            B.REG_DT,
            B.REG_ID,
            B.MOD_DT,
            B.MOD_ID
          )
  </update>

  <select id="chkProdCnt" parameterType="hqClsVO" resultType="Integer">
    /* USE : HqBrandMapper.chkProdCnt */
    SELECT COUNT(1)
      FROM TB_HQ_PRODUCT
     WHERE HQ_BRAND_CD = #{hqBrandCd}
       AND PROD_CLASS_CD = #{prodClassCd}
  </select>

  <delete id="deleteCls">
    /* USE : HqBrandMapper.deleteCls */
    DELETE TB_HQ_PRODUCT_CLASS
     WHERE HQ_BRAND_CD = #{hqBrandCd}
       AND PROD_CLASS_CD = #{prodClassCd}
  </delete>

</mapper>