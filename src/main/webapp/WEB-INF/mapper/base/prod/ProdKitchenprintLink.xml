<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    ProdKitchenprintLink.xml
    상품엑셀업로드
    ======================================================
    No  ||  수정자 ||  수정일자    ||  수정내역
    ======================================================
    1       권지현     2021.02.09     최초작성
-->
<mapper namespace="kr.co.solbipos.base.prod.prodKitchenprintLink.service.impl.ProdKitchenprintLinkMapper">

    <!-- 상품 조회 -->
    <!--
        TABLE    : TB_HQ_PRODUCT, TB_HQ_PRODUCT_SALE_PRICE
        PARAM    : prodKitchenprintLinkVO
        COMMENTS : 상품의 목록을 조회한다.
    -->
    <select id="getProdList" parameterType="prodKitchenprintLinkVO" resultType="DefaultMap">
        /* USE : ProdKitchenprintLinkMapper.getProdList */
        SELECT
        thp.PROD_CD,
        thp.PROD_NM,
        NVL(thpsp.SALE_UPRC, 0) AS SALE_UPRC -- 판매단가
        FROM
        TB_HQ_PRODUCT thp
        LEFT OUTER JOIN (
        SELECT
        HQ_OFFICE_CD,
        PROD_CD,
        MIN(SALE_UPRC) KEEP( DENSE_RANK FIRST
        ORDER BY
        START_DATE DESC ) AS SALE_UPRC
        FROM
        TB_HQ_PRODUCT_SALE_PRICE
        WHERE
        HQ_OFFICE_CD = #{hqOfficeCd}
        <![CDATA[
                        AND START_DATE <= TO_CHAR(SYSDATE, 'yyyyMMdd')
                        AND END_DATE >= TO_CHAR(SYSDATE, 'yyyyMMdd')
                        ]]>
        AND SALE_PRC_FG = '1'
        GROUP BY
        HQ_OFFICE_CD, PROD_CD
        ) thpsp ON
        thp.HQ_OFFICE_CD = thpsp.HQ_OFFICE_CD
        AND thp.PROD_CD = thpsp.PROD_CD
        WHERE
        thp.HQ_OFFICE_CD = #{hqOfficeCd}
        <if test="chkDt == false">
            <if test="startDate != null and startDate != '' and endDate != null and endDate != ''">
                <![CDATA[
                        AND thp.REG_DT BETWEEN #{startDate}||'000000' AND #{endDate}||'235959'
                        ]]>
            </if>
        </if>
        <if test="prodCd != null and prodCd != ''">
            AND thp.PROD_CD LIKE '%'||#{prodCd}||'%' --상품코드
        </if>
        <if test="prodNm != null and prodNm != ''">
            AND thp.PROD_NM LIKE '%'||#{prodNm}||'%' --상품명
        </if>
        <if test="barCd != null and barCd != ''">
            AND EXISTS (
            SELECT 1
            FROM
            TB_HQ_PRODUCT_BARCD
            WHERE
            HQ_OFFICE_CD = thp.HQ_OFFICE_CD
            AND PROD_CD = thp.PROD_CD
            AND BARCD_CD = #{barCd}
            ) --바코드
        </if>
        <if test="prodClassCd != null and prodClassCd != ''">
            AND thp.PROD_CLASS_CD IN (
            SELECT
            PROD_CLASS_CD
            FROM
            TB_HQ_PRODUCT_CLASS
            WHERE
            HQ_OFFICE_CD = #{hqOfficeCd}
            START WITH
            PROD_CLASS_CD = #{prodClassCd} AND HQ_OFFICE_CD = #{hqOfficeCd}
            CONNECT BY
            PRIOR PROD_CLASS_CD = P_PROD_CLASS_CD AND HQ_OFFICE_CD = #{hqOfficeCd}
            )
        </if>
        <if test="useYn != null and useYn != ''">
            AND thp.USE_YN = #{useYn} --사용여부
        </if>
        <if test='arrStoreCd != null and arrStoreCd != ""'>
            AND STORE_CD IN
            <foreach collection="arrStoreCd" item="item" open="("  separator="," close=")">
                #{item}
            </foreach>
        </if>
        ORDER BY thp.PROD_CD ASC
    </select>

    <!-- 연결된 프린터 -->
    <!--
        TABLE    : TB_HQ_PRODUCT, TB_HQ_PRODUCT_SALE_PRICE
        PARAM    : prodKitchenprintLinkVO
        COMMENTS : 상품의 연결된 프린터 목록을 조회한다.
    -->
    <select id="getLinkedList" parameterType="prodKitchenprintLinkVO" resultType="DefaultMap">
        /* USE : ProdKitchenprintLinkMapper.getLinkedList */
        SELECT tms.STORE_CD,
               tms.STORE_NM,
               tmpp.PRTER_NO,
               TMP.PRTER_NM
        FROM TB_MS_PRINTER_PROD tmpp, TB_MS_STORE tms, TB_MS_PRINTER tmp
        WHERE tmpp.STORE_CD = tms.STORE_CD
          AND tmpp.STORE_CD = tmp.STORE_CD
          AND tmpp.PRTER_no = tmp.PRTER_no
          AND tms.HQ_OFFICE_CD = #{hqOfficeCd}
          AND PROD_CD = #{prodCd}
      <if test='arrStoreCd != null and arrStoreCd.toString() != ""'>
          AND tms.STORE_CD IN
          <foreach collection="arrStoreCd" item="item" open="("  separator="," close=")">
              #{item}
          </foreach>
      </if>
      <if test='sysStatFg != null and sysStatFg.toString() != ""'>
          AND tms.SYS_STAT_FG = #{sysStatFg}
      </if>
    </select>

    <!-- 연결된 프린터 연결 해제 -->
    <!--
        TABLE    : TB_HQ_PRODUCT_SALE_PRICE
        PARAM    : prodKitchenprintLinkVO
        COMMENTS : 상품의 연결된 프린터를 삭제한다.
    -->
    <delete id="unlinkPrter" parameterType="DefaultMap">
        DELETE TB_MS_PRINTER_PROD tmpp
          WHERE STORE_CD LIKE #{storeCd}
            AND PRTER_NO = #{prterNo}
            AND PROD_CD = #{prodCd}

    </delete>

    <!-- 안연결된 프린터 -->
    <!--
        TABLE    : TB_HQ_PRODUCT, TB_HQ_PRODUCT_SALE_PRICE
        PARAM    : prodKitchenprintLinkVO
        COMMENTS : 상품의 안연결된 프린터 목록을 조회한다.
    -->
    <select id="getUnlinkList" parameterType="prodKitchenprintLinkVO" resultType="DefaultMap">
        /* USE : ProdKitchenprintLinkMapper.getUnlinkList */
        SELECT tms.STORE_NM,
               tms.STORE_CD,
               tmp2.PRTER_NO,
               tmp2.PRTER_NM
        FROM TB_MS_STORE tms,TB_MS_PRINTER tmp2, TB_MS_PRODUCT tmp
             LEFT JOIN TB_MS_PRINTER_PROD tmpp
                    ON tmp.STORE_CD = tmpp.STORE_CD
                   AND tmp.PROD_CD = tmpp.PROD_CD
        WHERE tmp.STORE_CD = tms.STORE_CD
          AND tmp.STORE_CD = tmp2.STORE_CD
          AND tms.HQ_OFFICE_CD = #{hqOfficeCd}
          AND TMP.USE_YN ='Y'
          AND TMP.PROD_CD = #{prodCd}
          AND TMPP.PRTER_NO IS NULL
        <if test='arrStoreCd != null and arrStoreCd.toString() != ""'>
            AND tms.STORE_CD IN
            <foreach collection="arrStoreCd" item="item" open="("  separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test='sysStatFg != null and sysStatFg.toString() != ""'>
            AND tms.SYS_STAT_FG = #{sysStatFg}
        </if>
    </select>

    <!-- 안연결된 프린터 연결 -->
    <!--
        TABLE    : TB_HQ_PRODUCT_SALE_PRICE
        PARAM    : prodKitchenprintLinkVO
        COMMENTS : 상품의 연결된 프린터를 저장한다.
    -->
    <insert id="linkedPrter" parameterType="prodKitchenprintLinkVO">
        INSERT INTO TB_MS_PRINTER_PROD
            (
                STORE_CD,
                PRTER_NO,
                PROD_CD,
                REG_DT,
                REG_ID,
                MOD_DT,
                MOD_ID
            )
        VALUES (
                #{storeCd},
                #{prterNo},
                #{prodCd},
                #{regDt},
                #{regId},
                #{modDt},
                #{modId}
               )
    </insert>

</mapper>