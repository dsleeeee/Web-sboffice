<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    Install.xml
    설치관리
    ======================================================
    No  ||  수정자 ||  수정일자    ||  수정내역
    ======================================================
    1       김지은     2019.01.03     최초작성
-->
<mapper namespace="kr.co.solbipos.pos.install.service.impl.InstallManageMapper">

    <!-- 설치요청 목록 조회 -->
    <!--
        TABLE    : TB_CM_INSTLL, TB_MS_STORE, TB_CM_AGENCY
        COMMENTS : 설치요청 목록 조회
    -->
    <select id="getInstallRequestList"  parameterType="installVO" resultType="DefaultMap">
        /* InstallManageMapper.getInstallRequestList */
      <include refid="CmmSQL.PagingTemplateHeader"/>
        SELECT tci.STORE_CD,
               tms.STORE_NM ,
               tci.POS_NO,
               tci.SEQ_NO,
               tci.INST_FG,
               tci.AGENCY_CD,
               tca.AGENCY_NM ,
               TO_CHAR(TO_DATE(tci.INST_REQ_DT ,'YYYYMMDDhh24miss'), 'YYYY/MM/DD hh24:mi:ss') AS INST_REQ_DT,
               tci.INST_REQ_ID,
               TO_CHAR(TO_DATE(tci.INST_INS_DT ,'YYYYMMDDhh24miss'), 'YYYY/MM/DD hh24:mi:ss') AS INST_INS_DT,
               tci.INST_INS_ID,
               tci.INST_REASON,
               tci.REMARK
      <include refid="CmmSQL.PagingTemplateCount"/>
          FROM TB_CM_INSTLL tci,
               TB_MS_STORE tms,
               TB_CM_AGENCY tca
         WHERE tms.STORE_CD = tci.STORE_CD
           AND tca.AGENCY_CD = tci.AGENCY_CD
      <if test='storeCd != null and storeCd.toString() == ""'>
        AND tci.STORE_CD = #{storeCd}
      </if>
      <if test='storeNm != null and storeNm.storeNm() == ""'>
        AND tms.STORE_NM LIKE '%'||#{storeNm}||'%'
      </if>
      <if test='agencyCd != null and agencyCd.toString() == ""'>
        AND tci.AGENCY_CD = #{agencyCd}
      </if>
      <if test='agencyNm != null and agencyNm.toString() == ""'>
        AND tca.AGENCY_NM LIKE '%'|| #{agencyNm} ||'%'
      </if>
      <if test='instFg != null and instFg.toString() == "HQ"'>
        AND tci.INST_FG = #{instFg}
      </if>
         ORDER BY INST_REQ_DT DESC
      <include refid="CmmSQL.PagingTemplateBottom"/>
    </select>


    <!-- 포스 목록 조회 -->
    <!--
        TABLE    : TB_MS_POS, TB_MS_STORE, TB_HQ_OFFICE, TB_CM_INSTLL, TB_CM_AGENCY
        COMMENTS : 포스 목록 조회
    -->
    <select id="getPosList"  parameterType="installVO" resultType="DefaultMap">
        /* InstallManageMapper.getPosList */
      <include refid="CmmSQL.PagingTemplateHeader"/>
        SELECT tms.HQ_OFFICE_CD,
               tho.HQ_OFFICE_NM,
               tms.STORE_NM,
               tmp.STORE_CD,
               tmp.POS_NO,
               tms.SYS_STAT_FG,
               tci.SEQ_NO,
               tci.INST_FG,
      --       tci.INST_REASON,
               tci.AGENCY_CD,
               tca.AGENCY_NM,
      <include refid="CmmSQL.PagingTemplateCount"/>
          FROM TB_MS_POS tmp,
               TB_MS_STORE tms,
               TB_HQ_OFFICE tho,
               (
               SELECT STORE_CD, POS_NO,
                      MAX(SEQ_NO) KEEP( DENSE_RANK FIRST ORDER BY SEQ_NO DESC ) AS SEQ_NO,
                      MAX(INST_FG) KEEP( DENSE_RANK FIRST ORDER BY SEQ_NO DESC ) AS INST_FG,
--                       MAX(INST_REASON) KEEP( DENSE_RANK FIRST ORDER BY SEQ_NO DESC ) AS INST_REASON,
                      MAX(AGENCY_CD) KEEP( DENSE_RANK FIRST ORDER BY SEQ_NO DESC ) AS AGENCY_CD
                 FROM TB_CM_INSTLL
                GROUP BY STORE_CD , POS_NO
               ) tci,
               TB_CM_AGENCY tca
         WHERE tms.STORE_CD = tmp.STORE_CD
           AND tho.HQ_OFFICE_CD = tms.HQ_OFFICE_CD
           AND tci.STORE_CD (+)= tmp.STORE_CD
           AND tci.POS_NO (+)= tmp.POS_NO
           AND tca.AGENCY_CD (+)= tci.AGENCY_CD
      <if test='hqOfficeCd != null and hqOfficeCd == ""'>
           AND tms.HQ_OFFICE_CD = #{hqOfficeCd}
      </if>
      <if test='hqOfficeNm != null and hqOfficeNm == ""'>
           AND tho.HQ_OFFICE_NM LIKE '%'||#{hqOfficeNm}||'%'
      </if>
      <if test='storeCd != null and storeCd == ""'>
           AND tms.STORE_CD = #{storeCd}
      </if>
      <if test='storeNm != null and storeNm == ""'>
           AND tms.STORE_NM LIKE '%'||#{storeNm}||'%'
      </if>
      <if test='agencyCd != null and agencyCd == ""'>
           AND tci.AGENCY_CD = #{agencyCd}
      </if>
      <if test='instFg != null and instFg == ""'>
           AND tci.INST_FG = #{instFg}
      </if>
      ORDER BY tms.HQ_OFFICE_CD, tmp.STORE_CD, tci.SEQ_NO DESC
      <include refid="CmmSQL.PagingTemplateBottom"/>
    </select>

    <!-- 설치요청 등록 -->
    <!--
        TABLE    : TB_CM_INSTLL
        COMMENTS : 설치요청을 등록한다.
    -->
    <insert id="saveInstallRequest"  parameterType="installVO" >
        /* InstallManageMapper.saveInstallRequest */
        INSERT INTO TB_CM_INSTLL
        (
            STORE_CD,
            POS_NO,
            SEQ_NO,
            INST_FG,
            AGENCY_CD,
            INST_REQ_DT,
            INST_REQ_ID,
            INST_REASON,
            REMARK,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID
        )
        VALUES
        (
            #{storeCd},
            #{posNo},
            (
            SELECT NVL(MAX(SEQ_NO)+ 1, 0)+1 AS SEQ_NO
              FROM TB_CM_INSTLL
             WHERE STORE_CD = #{storeCd} AND POS_NO = #{posNo}
            ),
            #{instFg},
            #{agencyCd},
            #{instReqDt},
            #{instReqId},
            #{instReason},
            #{remark},
            #{regDt},
            #{regId},
            #{modDt},
            #{modId}
        )
    </insert>

  <!-- 회원등급 리스트 조회-->
    <!--
        TABLE    : TB_HQ_OFFICE, TB_HQ_BRAND, TB_MS_STORE
        COMMENTS : 회원정보 등록시 등록매장 콤보박스 내용 조회
    -->
  <!--
    <select id="getMemberClassList"  parameterType="membrClassVO" resultType="DefaultMap">
        /* RegistMapper.getMemberClassList */
        SELECT MEMBR_CLASS_CD AS VALUE,
               MEMBR_CLASS_NM AS NAME
          FROM TB_MB_MEMBER_CLASS
         WHERE USE_YN = 'Y'
           AND MEMBR_ORGN_CD = #{membrOrgnCd}
         ORDER BY DEFLT_YN DESC
    </select>
-->

    <!-- 회원정보 조회 -->
    <!--
        TABLE    : TB_MB_MEMBER
        COMMENTS : 회원정보 리스트 조회
    -->
  <!--
    <select id="getMemberList" parameterType="registVO" resultType="DefaultMap">
        /* RegistMapper.getMemberList */
        <include refid="CmmSQL.PagingTemplateHeader"/>
        SELECT tmm.MEMBR_NO,
               tmm.MEMBR_NM,
               tmm.MEMBR_CLASS_CD,
               tmmc.MEMBR_CLASS_NM,
               tmm.MEMBR_CARD_NO,
               tmm.SHORT_NO,
               tmm.MEMBR_ORGN_CD,
               tmm.REG_STORE_CD,
               tms.STORE_NM AS REG_STORE_NM,
               tmm.POST_NO,
               tmm.ADDR,
               tmm.ADDR_DTL,
               tmm.TEL_NO,
               tmm.EMAIL_ADDR,
               tmm.EMAIL_RECV_YN,
               tmm.BIRTHDAY,
               tmm.GENDR_FG,
               tmm.SMS_RECV_YN,
               tmm.WEDDING_YN,
               tmm.WEDDINGDAY,
               tmm.LUNAR_YN,
               tmm.USE_YN,
               tmm.MEMBR_NICKNM,
               tmm.MEMBER_ENG_NM,
               tmm.REMARK,
               '후불적용매장등록' AS POSTPAID_STORE
        <include refid="CmmSQL.PagingTemplateCount"/>
          FROM TB_MB_MEMBER tmm,
               TB_MB_MEMBER_CLASS tmmc,
               TB_MS_STORE tms
         WHERE tmm.MEMBR_ORGN_CD = #{hqOfficeCd}
        <if test='orgnFg != null and orgnFg.toString() == "HQ"'>
           AND tmmc.MEMBR_ORGN_CD (+)= #{hqOfficeCd}
        </if>
        <if test='orgnFg != null and orgnFg.toString() == "STORE"'>
           AND tmmc.MEMBR_ORGN_CD (+)= #{storeCd}
        </if>
           AND tmmc.MEMBR_CLASS_CD (+)= tmm.MEMBR_CLASS_CD
           AND tms.HQ_OFFICE_CD = #{hqOfficeCd}
           AND tms.STORE_CD = tmm.REG_STORE_CD
           AND tmm.USE_YN = 'Y'
        <if test='storeCd != null and storeCd.toString() != ""'>
           AND tmm.REG_STORE_CD = #{storeCd}
        </if>
        <if test='membrCardNo != null and membrCardNo.toString() != ""'>
           AND tmm.MEMBR_CARD_NO = #{membrCardNo}
        </if>
        <if test='membrNo != null and membrNo.toString() != ""'>
           AND tmm.MEMBR_NO = #{membrNo}
        </if>
        <if test='membrNm != null and membrNm.toString() != ""'>
           AND tmm.MEMBR_NM LIKE '%'|| #{membrNm} ||'%'
        </if>
        <if test='telNo != null and telNo.toString() != ""'>
           AND tmm.TEL_NO LIKE '%'|| #{telNo} ||'%'
        </if>
        <if test='emailAddr != null and emailAddr.toString() != ""'>
           AND tmm.EMAIL_ADDR LIKE '%'|| #{emailAddr}||'%'
        </if>
        <if test='regStoreCd != null and regStoreCd.toString() != ""'>
           AND tmm.REG_STORE_CD IN
          <foreach collection="regStoreCds" item="item" open="("  separator="," close=")" >
            #{item}
          </foreach>
        </if>
        <if test='membrClassCd != null and membrClassCd.toString() != ""'>
           AND tmm.MEMBR_CLASS_CD = #{membrClassCd}
        </if>
        <if test='gendrFg != null and gendrFg.toString() != ""'>
           AND tmm.GENDR_FG = #{gendrFg}
        </if>
        <if test='emailRecvYn != null and emailRecvYn.toString() != ""'>
           AND tmm.EMAIL_RECV_YN = #{emailRecvYn}
        </if>
        <if test='smsRecvYn != null and smsRecvYn.toString() != ""'>
           AND tmm.SMS_RECV_YN = #{smsRecvYn}
        </if>
        <if test='periodType != null and periodType.toString() != ""'>
            <if test='periodType.getCode() == "reg"'>
           AND tmm.REG_DT BETWEEN #{periodStartDate}||'000000' AND #{periodEndDate}||'999999'
            </if>
            <if test='periodType.getCode() == "last"'>
            </if>
        </if>
        <if test='anvType != null and anvType.toString() != ""'>
            <if test='anvType.getCode() == "1"'>
          AND tmm.BIRTHDAY BETWEEN #{anvStartDate} AND #{anvEndDate}
            </if>
        </if>
         ORDER BY tmm.MEMBR_NO
        <include refid="CmmSQL.PagingTemplateBottom"/>
    </select>
-->

    <!-- 회원정보 조회 -->
    <!--
        TABLE    : TB_MB_MEMBER
        COMMENTS : 회원정보 조회
    -->
  <!--
    <select id="getMemberInfo" parameterType="registVO" resultType="DefaultMap">
        /* RegistMapper.getMemberInfo */
        SELECT tmm.MEMBR_ORGN_CD,
               tmm.MEMBR_NO,
               tmm.MEMBR_NM,
               tmm.MEMBR_NICKNM,
               tmm.MEMBR_CLASS_CD,
               tmm.MEMBR_CARD_NO,
               tmm.REG_STORE_CD,
               tmm.POST_NO,
               tmm.ADDR,
               tmm.ADDR_DTL,
               tmm.LUNAR_YN,
               tmm.BIRTHDAY,
               tmm.GENDR_FG,
               tmm.TEL_NO,
               tmm.SHORT_NO,
               tmm.WEDDING_YN,
               tmm.WEDDINGDAY,
               tmm.EMAIL_ADDR,
               tmm.EMAIL_RECV_YN,
               tmm.SMS_RECV_YN,
               tmm.REMARK,
               tmm.USE_YN,
               tmm.REG_DT,
               tmm.REG_ID,
               tmm.MOD_DT,
               tmm.MOD_ID,
               tmmp.CD_COMPANY,
			         tmmp.CD_PARTNER,
			         tnsp.LN_PARTNER,
			         tnsp.NO_COMPANY,
			         tnsp.NM_CEO
          FROM TB_MB_MEMBER tmm,
               TB_MB_MEMBER_PTN tmmp,
               TB_NEOE_SPOS_PTN tnsp
         WHERE tmm.MEMBR_NO = #{membrNo}
           AND tmm.MEMBR_ORGN_CD = #{membrOrgnCd}
           AND tmmp.MEMBR_ORGN_CD (+)= tmm.MEMBR_ORGN_CD
           AND tmmp.MEMBR_NO (+)= tmm.MEMBR_NO
           AND tnsp.CD_COMPANY (+)= tmmp.CD_COMPANY
           AND tnsp.CD_PARTNER (+)= tmmp.CD_PARTNER
    </select>
-->

</mapper>
