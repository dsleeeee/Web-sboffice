<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    RecpOrigin.xml
    원산지관리
    ======================================================
    No  ||  수정자 ||  수정일자    ||  수정내역
    ======================================================
    1       김설아     2020.07.10     최초작성
-->
<mapper namespace="kr.co.solbipos.base.prod.recpOrigin.service.impl.RecpOriginMapper">

    <!-- 원산지관리 조회 -->
    <!--
        TABLE    : TB_HQ_PRODUCT_RECP_ORIGIN, TB_MS_PRODUCT_RECP_ORIGIN
        COMMENTS : [본사]재료-원산지정보, [매장]재료-원산지정보
    -->
    <select id="getRecpOriginList"  parameterType="RecpOriginVO" resultType="DefaultMap">
        /* RecpOriginMapper.getRecpOriginList */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                SELECT
                thpro.RECIPES_CD,
                thpro.RECIPES_NM,
                thpro.ORGPLCE_NM,
                NVL(thb.HQ_BRAND_CD,'0') as HQ_BRAND_CD
                FROM TB_HQ_PRODUCT_RECP_ORIGIN thpro,
                TB_HQ_BRAND thb
                WHERE 1=1
                AND thpro.HQ_OFFICE_CD = #{hqOfficeCd}
                AND thb.HQ_OFFICE_CD (+)= THPRO.HQ_OFFICE_CD
                AND thb.HQ_BRAND_CD (+)= thpro.HQ_BRAND_CD
                ORDER BY thpro.RECIPES_CD
            </when>
            <!-- 매장 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                SELECT
                tmpro.RECIPES_CD,
                tmpro.RECIPES_NM,
                tmpro.ORGPLCE_NM
                FROM TB_MS_PRODUCT_RECP_ORIGIN tmpro
                WHERE 1=1
                AND tmpro.STORE_CD = #{storeCd}
                ORDER BY tmpro.RECIPES_CD
            </when>
        </choose>
    </select>

    <!-- 브랜드 콤보박스 리스트 조회 -->
    <!--
        TABLE    : TB_HQ_BRAND
        PARAM    : RecpOriginVO
        COMMENTS : 콤보박스에 넣을 브랜드를 조회한다.
    -->
    <select id="getBrandComboList" parameterType="RecpOriginVO" resultType="DefaultMap">
        SELECT
        HQ_BRAND_CD AS NMCODE_CD,
        HQ_BRAND_NM AS NMCODE_NM
        FROM TB_HQ_BRAND
        WHERE HQ_OFFICE_CD = #{hqOfficeCd}
    </select>

    <!-- 재료코드(자동채번) -->
    <!--
        TABLE    : TB_HQ_PRODUCT_RECP_ORIGIN, TB_MS_PRODUCT_RECP_ORIGIN
        COMMENTS : [매장]재료-원산지정보, [본사]재료-원산지정보
    -->
    <select id="getRecpOriginRecipesCd" parameterType="RecpOriginVO" resultType="String">
        /* RecpOriginMapper.getRecpOriginRecipesCd */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                SELECT
                LPAD(NVL(MAX(thpro.RECIPES_CD), 0) + 1, 4, '0')
                FROM TB_HQ_PRODUCT_RECP_ORIGIN thpro
                WHERE 1=1
                AND thpro.HQ_OFFICE_CD = #{hqOfficeCd}
            </when>
            <!-- 매장 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                SELECT
                LPAD(NVL(MAX(tmpro.RECIPES_CD), 0) + 1, 4, '0')
                FROM TB_MS_PRODUCT_RECP_ORIGIN tmpro
                WHERE 1=1
                AND tmpro.STORE_CD = #{storeCd}
            </when>
        </choose>
    </select>

    <!-- 원산지관리 저장 insert -->
    <!--
        TABLE    : TB_HQ_PRODUCT_RECP_ORIGIN, TB_MS_PRODUCT_RECP_ORIGIN
        COMMENTS : [본사]재료-원산지정보, [매장]재료-원산지정보
    -->
    <insert id="getRecpOriginSaveInsert" parameterType="RecpOriginVO">
        /* RecpOriginMapper.getRecpOriginSaveInsert */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                INSERT INTO TB_HQ_PRODUCT_RECP_ORIGIN
                (
                    HQ_OFFICE_CD,
                    <if test="hqBrandCd != null and hqBrandCd != ''">
                        HQ_BRAND_CD,
                    </if>
                    RECIPES_CD,
                    RECIPES_NM,
                    ORGPLCE_NM,
                    REG_DT,
                    REG_ID,
                    MOD_DT,
                    MOD_ID
                ) VALUES (
                    #{hqOfficeCd},
                    <if test="hqBrandCd != null and hqBrandCd != ''">
                        #{hqBrandCd},
                    </if>
                    #{recipesCd},
                    #{recipesNm},
                    #{orgplceNm},
                    #{regDt},
                    #{regId},
                    #{modDt},
                    #{modId}
                )
            </when>
            <!-- 매장 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                INSERT INTO TB_MS_PRODUCT_RECP_ORIGIN
                (
                    STORE_CD,
                    RECIPES_CD,
                    RECIPES_NM,
                    ORGPLCE_NM,
                    REG_DT,
                    REG_ID,
                    MOD_DT,
                    MOD_ID
                ) VALUES (
                    #{storeCd},
                    #{recipesCd},
                    #{recipesNm},
                    #{orgplceNm},
                    #{regDt},
                    #{regId},
                    #{modDt},
                    #{modId}
                )
            </when>
        </choose>
    </insert>

    <!-- 원산지관리 저장 update -->
    <!--
        TABLE    : TB_HQ_PRODUCT_RECP_ORIGIN, TB_MS_PRODUCT_RECP_ORIGIN
        COMMENTS : [본사]재료-원산지정보, [매장]재료-원산지정보
    -->
    <update id="getRecpOriginSaveUpdate" parameterType="RecpOriginVO">
        /* RecpOriginMapper.getRecpOriginSaveUpdate */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                UPDATE
                TB_HQ_PRODUCT_RECP_ORIGIN
                SET
                <if test="hqBrandCd != null and hqBrandCd != ''">
                    HQ_BRAND_CD = #{hqBrandCd},
                </if>
                RECIPES_NM = #{recipesNm},
                ORGPLCE_NM = #{orgplceNm},
                MOD_DT = #{modDt},
                MOD_ID = #{modId}
                WHERE 1=1
                AND HQ_OFFICE_CD = #{hqOfficeCd}
                AND RECIPES_CD = #{recipesCd}
            </when>
            <!-- 매장 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                UPDATE
                TB_MS_PRODUCT_RECP_ORIGIN
                SET
                RECIPES_NM = #{recipesNm},
                ORGPLCE_NM = #{orgplceNm},
                MOD_DT = #{modDt},
                MOD_ID = #{modId}
                WHERE 1=1
                AND STORE_CD = #{storeCd}
                AND RECIPES_CD = #{recipesCd}
            </when>
        </choose>
    </update>

    <!-- 원산지관리 저장 delete -->
    <!--
        TABLE    : TB_HQ_PRODUCT_RECP_ORIGIN, TB_MS_PRODUCT_RECP_ORIGIN
        COMMENTS : [본사]재료-원산지정보, [매장]재료-원산지정보
    -->
    <delete id="getRecpOriginSaveDelete" parameterType="RecpOriginVO">
        /* RecpOriginMapper.getRecpOriginSaveDelete */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                DELETE
                TB_HQ_PRODUCT_RECP_ORIGIN
                WHERE 1=1
                AND HQ_OFFICE_CD = #{hqOfficeCd}
                AND RECIPES_CD = #{recipesCd}
            </when>
            <!-- 매장 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                DELETE
                TB_MS_PRODUCT_RECP_ORIGIN
                WHERE 1=1
                AND STORE_CD = #{storeCd}
                AND RECIPES_CD = #{recipesCd}
            </when>
        </choose>
    </delete>

    <!-- 원산지관리 저장 delete 시, 재료-상품 저장 delete -->
    <!--
        TABLE    : TB_HQ_PRODUCT_RECP_PROD, TB_MS_PRODUCT_RECP_PROD
        COMMENTS : [본사]재료-원산지정보, [매장]재료-원산지정보
    -->
    <delete id="getRecpProdSaveDeleteAll" parameterType="RecpOriginVO">
        /* RecpOriginMapper.getRecpProdSaveDeleteAll */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                DELETE
                TB_HQ_PRODUCT_RECP_PROD
                WHERE 1=1
                AND HQ_OFFICE_CD = #{hqOfficeCd}
                AND RECIPES_CD = #{recipesCd}
            </when>
            <!-- 매장 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                DELETE
                TB_MS_PRODUCT_RECP_PROD
                WHERE 1=1
                AND STORE_CD = #{storeCd}
                AND RECIPES_CD = #{recipesCd}
            </when>
        </choose>
    </delete>

    <!-- 재료-상품 조회 -->
    <!--
        TABLE    : TB_HQ_PRODUCT_RECP_PROD, TB_HQ_PRODUCT, TB_HQ_PRODUCT_CLASS, TB_HQ_PRODUCT_SALE_PRICE_V99,
                   TB_MS_PRODUCT_RECP_PROD, TB_MS_PRODUCT, TB_MS_PRODUCT_CLASS, TB_MS_PRODUCT_SALE_PRICE_V99
        COMMENTS : [본사]재료-원산지정보, [본사]상품, [본사]상품_분류,
                   [매장]재료-원산지정보, [매장]상품, [매장]상품_분류
    -->
    <select id="getRecpOriginDetailList"  parameterType="RecpOriginVO" resultType="DefaultMap">
        /* RecpOriginMapper.getRecpOriginDetailList */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                SELECT
                SUBSTR(thpc_p.PATH_NM, 2) AS PATH_NM,
                thprp.PROD_CD,
                thp.PROD_NM,
                NVL(thpspv99.SALE_UPRC, 0) AS SALE_UPRC
                FROM TB_HQ_PRODUCT_RECP_PROD thprp,
                TB_HQ_PRODUCT thp,
                (
                    SELECT
                    thpc.HQ_OFFICE_CD
                    , thpc.PROD_CLASS_CD
                    , SYS_CONNECT_BY_PATH (thpc.PROD_CLASS_CD,'▶') PATH
                    , SYS_CONNECT_BY_PATH (thpc.PROD_CLASS_NM,'▶') PATH_NM
                    FROM TB_HQ_PRODUCT_CLASS thpc
                    WHERE 1=1
                    AND thpc.HQ_OFFICE_CD = #{hqOfficeCd}
                    START WITH thpc.P_PROD_CLASS_CD = '00000' AND thpc.HQ_OFFICE_CD = #{hqOfficeCd}
                    CONNECT BY thpc.P_PROD_CLASS_CD = PRIOR thpc.PROD_CLASS_CD AND thpc.HQ_OFFICE_CD = #{hqOfficeCd}
                ) thpc_p,
                TB_HQ_PRODUCT_SALE_PRICE_V99 thpspv99 --view
                WHERE 1=1
                AND thprp.HQ_OFFICE_CD = thp.HQ_OFFICE_CD
                AND thprp.PROD_CD = thp.PROD_CD
                AND thpc_p.HQ_OFFICE_CD = thp.HQ_OFFICE_CD
                AND thpc_p.PROD_CLASS_CD = thp.PROD_CLASS_CD
                AND thprp.HQ_OFFICE_CD = #{hqOfficeCd}
                AND thprp.RECIPES_CD = #{recipesCd}
                AND thpspv99.HQ_OFFICE_CD = thp.HQ_OFFICE_CD
                AND thpspv99.PROD_CD = thp.PROD_CD
                <![CDATA[
                    AND thpspv99.START_DATE <= TO_CHAR(SYSDATE, 'yyyyMMdd')
                    AND thpspv99.END_DATE >= TO_CHAR(SYSDATE, 'yyyyMMdd')
                ]]>
                ORDER BY thprp.PROD_CD
            </when>
            <!-- 매장 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                SELECT
                SUBSTR(tmpc_p.PATH_NM, 2) AS PATH_NM,
                tmprp.PROD_CD,
                tmp.PROD_NM,
                NVL(tmpspv99.SALE_UPRC, 0) AS SALE_UPRC
                FROM TB_MS_PRODUCT_RECP_PROD tmprp,
                TB_MS_PRODUCT tmp,
                (
                    SELECT
                    tmpc.STORE_CD
                    , tmpc.PROD_CLASS_CD
                    , SYS_CONNECT_BY_PATH (tmpc.PROD_CLASS_CD,'▶') PATH
                    , SYS_CONNECT_BY_PATH (tmpc.PROD_CLASS_NM,'▶') PATH_NM
                    FROM (SELECT * FROM TB_MS_PRODUCT_CLASS WHERE STORE_CD = #{storeCd}) tmpc
                    WHERE 1=1
                    START WITH tmpc.P_PROD_CLASS_CD = '00000' AND tmpc.STORE_CD = #{storeCd}
                    CONNECT BY tmpc.P_PROD_CLASS_CD = PRIOR tmpc.PROD_CLASS_CD AND tmpc.STORE_CD = #{storeCd}
                ) tmpc_p,
                TB_MS_PRODUCT_SALE_PRICE_V99 tmpspv99 --view
                WHERE 1=1
                AND tmprp.STORE_CD = tmp.STORE_CD
                AND tmprp.PROD_CD = tmp.PROD_CD
                AND tmpc_p.STORE_CD = tmp.STORE_CD
                AND tmpc_p.PROD_CLASS_CD = tmp.PROD_CLASS_CD
                AND tmprp.STORE_CD = #{storeCd}
                AND tmprp.RECIPES_CD = #{recipesCd}
                AND tmpspv99.STORE_CD = tmp.STORE_CD
                AND tmpspv99.PROD_CD = tmp.PROD_CD
                <![CDATA[
                    AND tmpspv99.START_DATE <= TO_CHAR(SYSDATE, 'yyyyMMdd')
                    AND tmpspv99.END_DATE >= TO_CHAR(SYSDATE, 'yyyyMMdd')
                ]]>
                ORDER BY tmprp.PROD_CD
            </when>
        </choose>
    </select>

    <!-- 재료-상품 조회 -->
    <!--
        TABLE    : TB_HQ_PRODUCT, TB_HQ_PRODUCT_CLASS, TB_HQ_PRODUCT_RECP_PROD, TB_HQ_PRODUCT_SALE_PRICE_V99,
                   TB_MS_PRODUCT, TB_MS_PRODUCT_CLASS, TB_MS_PRODUCT_RECP_PROD, TB_MS_PRODUCT_SALE_PRICE_V99
        COMMENTS : [본사]상품, [본사]상품_분류, [본사]재료-상품맵핑정보,
                   [매장]상품, [매장]상품_분류, [매장]재료-상품맵핑정보
    -->
    <select id="getRecpProdList"  parameterType="RecpOriginVO" resultType="DefaultMap">
        /* RecpOriginMapper.getRecpProdList */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                SELECT
                SUBSTR(thpc_p.PATH_NM, 2) AS PATH_NM,
                thp.PROD_CD,
                thp.PROD_NM,
                NVL(thpspv99.SALE_UPRC, 0) AS SALE_UPRC
                FROM TB_HQ_PRODUCT thp,
                TB_HQ_PRODUCT_CLASS thpc,
                (
                    SELECT
                    thpc.PROD_CLASS_CD
                    , SYS_CONNECT_BY_PATH (thpc.PROD_CLASS_CD,'▶') PATH
                    , SYS_CONNECT_BY_PATH (thpc.PROD_CLASS_NM,'▶') PATH_NM
                    FROM TB_HQ_PRODUCT_CLASS thpc
                    WHERE 1=1
                    AND thpc.HQ_OFFICE_CD = #{hqOfficeCd}
                    START WITH thpc.P_PROD_CLASS_CD = '00000' AND thpc.HQ_OFFICE_CD = #{hqOfficeCd}
                    CONNECT BY thpc.P_PROD_CLASS_CD = PRIOR thpc.PROD_CLASS_CD AND thpc.HQ_OFFICE_CD = #{hqOfficeCd}
                ) thpc_p,
                TB_HQ_PRODUCT_SALE_PRICE_V99 thpspv99 --view
                WHERE 1=1
                AND thp.HQ_OFFICE_CD = #{hqOfficeCd}
                <if test="prodCd != null and prodCd != ''">
                    AND thp.PROD_CD LIKE '%'|| #{prodCd} ||'%'
                </if>
                <if test="prodNm != null and prodNm != ''">
                    AND thp.PROD_NM LIKE '%'|| #{prodNm} ||'%'
                </if>
                <if test="prodClassCd != null and prodClassCd != ''">
                    AND thpc.PROD_CLASS_CD = #{prodClassCd}
                </if>
                <if test="hqBrandCd != null and hqBrandCd != ''">
                    AND thp.HQ_BRAND_CD = #{hqBrandCd}
                </if>
                AND thpc.HQ_OFFICE_CD = thp.HQ_OFFICE_CD
                AND thpc.PROD_CLASS_CD = thp.PROD_CLASS_CD
                AND thpc_p.PROD_CLASS_CD = thpc.PROD_CLASS_CD
                AND thpspv99.HQ_OFFICE_CD = thp.HQ_OFFICE_CD
                AND thpspv99.PROD_CD = thp.PROD_CD
                <![CDATA[
                    AND thpspv99.START_DATE <= TO_CHAR(SYSDATE, 'yyyyMMdd')
                    AND thpspv99.END_DATE >= TO_CHAR(SYSDATE, 'yyyyMMdd')
                ]]>
                AND NOT EXISTS
                (
                    SELECT 1
                    FROM TB_HQ_PRODUCT_RECP_PROD thprp
                    WHERE 1=1
                    AND thprp.HQ_OFFICE_CD = thp.HQ_OFFICE_CD
                    AND thprp.PROD_CD = thp.PROD_CD
                    AND thprp.RECIPES_CD = #{recipesCd}
                )
                ORDER BY thpc_p.PATH_NM
            </when>
            <!-- 매장 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                SELECT
                SUBSTR(tmpc_p.PATH_NM, 2) AS PATH_NM,
                tmp.PROD_CD,
                tmp.PROD_NM,
                NVL(tmpspv99.SALE_UPRC, 0) AS SALE_UPRC
                FROM TB_MS_PRODUCT tmp,
                TB_MS_PRODUCT_CLASS tmpc,
                (
                    SELECT
                    tmpc.PROD_CLASS_CD
                    , SYS_CONNECT_BY_PATH (tmpc.PROD_CLASS_CD,'▶') PATH
                    , SYS_CONNECT_BY_PATH (tmpc.PROD_CLASS_NM,'▶') PATH_NM
                    FROM (SELECT * FROM TB_MS_PRODUCT_CLASS WHERE STORE_CD = #{storeCd}) tmpc
                    WHERE 1=1
                    START WITH tmpc.P_PROD_CLASS_CD = '00000' AND tmpc.STORE_CD = #{storeCd}
                    CONNECT BY tmpc.P_PROD_CLASS_CD = PRIOR tmpc.PROD_CLASS_CD AND tmpc.STORE_CD = #{storeCd}
                ) tmpc_p,
                TB_MS_PRODUCT_SALE_PRICE_V99 tmpspv99 --view
                WHERE 1=1
                AND tmp.STORE_CD = #{storeCd}
                <if test="prodCd != null and prodCd != ''">
                    AND tmp.PROD_CD LIKE '%'|| #{prodCd} ||'%'
                </if>
                <if test="prodNm != null and prodNm != ''">
                    AND tmp.PROD_NM LIKE '%'|| #{prodNm} ||'%'
                </if>
                <if test="prodClassCd != null and prodClassCd != ''">
                    AND tmpc.PROD_CLASS_CD = #{prodClassCd}
                </if>
                AND tmpc.STORE_CD = tmp.STORE_CD
                AND tmpc.PROD_CLASS_CD = tmp.PROD_CLASS_CD
                AND tmpc_p.PROD_CLASS_CD = tmpc.PROD_CLASS_CD
                AND tmpspv99.STORE_CD = tmp.STORE_CD
                AND tmpspv99.PROD_CD = tmp.PROD_CD
                <![CDATA[
                    AND tmpspv99.START_DATE <= TO_CHAR(SYSDATE, 'yyyyMMdd')
                    AND tmpspv99.END_DATE >= TO_CHAR(SYSDATE, 'yyyyMMdd')
                ]]>
                AND NOT EXISTS
                (
                    SELECT 1
                    FROM TB_MS_PRODUCT_RECP_PROD tmprp
                    WHERE 1=1
                    AND tmprp.STORE_CD = tmp.STORE_CD
                    AND tmprp.PROD_CD = tmp.PROD_CD
                    AND tmprp.RECIPES_CD = #{recipesCd}
                )
                ORDER BY tmpc_p.PATH_NM
            </when>
        </choose>
    </select>

    <!-- 재료-상품 등록 팝업 - 재료-상품 저장 insert -->
    <!--
        TABLE    : TB_HQ_PRODUCT_RECP_PROD, TB_MS_PRODUCT_RECP_PROD
        COMMENTS : [본사]재료-원산지정보, [매장]재료-원산지정보
    -->
    <insert id="getRecpProdSaveInsert" parameterType="RecpOriginVO">
        /* RecpOriginMapper.getRecpProdSaveInsert */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                INSERT INTO TB_HQ_PRODUCT_RECP_PROD
                (
                    HQ_OFFICE_CD,
                    <if test="hqBrandCd != null and hqBrandCd != ''">
                        HQ_BRAND_CD,
                    </if>
                    RECIPES_CD,
                    PROD_CD,
                    REG_DT,
                    REG_ID,
                    MOD_DT,
                    MOD_ID,
                    RECP_SEQ
                ) VALUES (
                    #{hqOfficeCd},
                    <if test="hqBrandCd != null and hqBrandCd != ''">
                        #{hqBrandCd},
                    </if>
                    #{recipesCd},
                    #{prodCd},
                    #{regDt},
                    #{regId},
                    #{modDt},
                    #{modId},
                    #{recpSeq}
                )
            </when>
            <!-- 매장 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                INSERT INTO TB_MS_PRODUCT_RECP_PROD
                (
                    STORE_CD,
                    RECIPES_CD,
                    PROD_CD,
                    REG_DT,
                    REG_ID,
                    MOD_DT,
                    MOD_ID,
                    RECP_SEQ
                ) VALUES (
                    #{storeCd},
                    #{recipesCd},
                    #{prodCd},
                    #{regDt},
                    #{regId},
                    #{modDt},
                    #{modId},
                    #{recpSeq}
                )
            </when>
        </choose>
    </insert>

    <!-- 재료-상품 등록 팝업 - 재료-상품 저장 delete -->
    <!--
        TABLE    : TB_HQ_PRODUCT_RECP_PROD, TB_MS_PRODUCT_RECP_PROD
        COMMENTS : [본사]재료-원산지정보, [매장]재료-원산지정보
    -->
    <delete id="getRecpProdSaveDelete" parameterType="RecpOriginVO">
        /* RecpOriginMapper.getRecpProdSaveDelete */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                DELETE
                TB_HQ_PRODUCT_RECP_PROD
                WHERE 1=1
                AND HQ_OFFICE_CD = #{hqOfficeCd}
                AND RECIPES_CD = #{recipesCd}
                AND PROD_CD = #{prodCd}
            </when>
            <!-- 매장 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                DELETE
                TB_MS_PRODUCT_RECP_PROD
                WHERE 1=1
                AND STORE_CD = #{storeCd}
                AND RECIPES_CD = #{recipesCd}
                AND PROD_CD = #{prodCd}
            </when>
        </choose>
    </delete>

    <!-- 재료-상품 등록 팝업 - 재료-상품 저장 update -->
    <!--
        TABLE    : TB_HQ_PRODUCT_RECP_PROD, TB_MS_PRODUCT_RECP_PROD
        COMMENTS : [본사]재료-원산지정보, [매장]재료-원산지정보
    -->
    <update id="getRecpProdSaveUpdate" parameterType="RecpOriginVO">
        /* RecpOriginMapper.getRecpProdSaveUpdate */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                UPDATE
                TB_HQ_PRODUCT_RECP_PROD
                SET
                RECP_SEQ = #{recpSeq},
                MOD_DT = #{modDt},
                MOD_ID = #{modId}
                WHERE 1=1
                AND HQ_OFFICE_CD = #{hqOfficeCd}
                AND PROD_CD = #{prodCd}
                AND RECIPES_CD = #{recipesCd}
            </when>
            <!-- 매장 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                UPDATE
                TB_MS_PRODUCT_RECP_PROD
                SET
                RECP_SEQ = #{recpSeq},
                MOD_DT = #{modDt},
                MOD_ID = #{modId}
                WHERE 1=1
                AND STORE_CD = #{storeCd}
                AND PROD_CD = #{prodCd}
                AND RECIPES_CD = #{recipesCd}
            </when>
        </choose>
    </update>

    <!-- 상품-원산지관리탭 - 조회 -->
    <!--
        TABLE    : TB_HQ_PRODUCT, TB_HQ_PRODUCT_BARCD, TB_HQ_PRODUCT_RECP_PROD
                   TB_MS_PRODUCT, TB_MS_PRODUCT_BARCD, TB_MS_PRODUCT_RECP_PROD
        COMMENTS : [본사]상품, [본사]상품_바코드, [본사]재료-원산지정보
                   [매장]상품, [매장]상품_바코드, [매장]재료-원산지정보
    -->
    <select id="getProdRecpOriginList"  parameterType="RecpOriginVO" resultType="DefaultMap">
        /* RecpOriginMapper.getProdRecpOriginList */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                SELECT
                thp.PATH_NM,
                thp.PROD_CD,
                thp.PROD_NM,
                NVL(thprp.RECP_ORIGIN_CNT, 0) AS RECP_ORIGIN_CNT,
                thp.HQ_BRAND_CD,
                thp.HQ_BRAND_CD AS HQ_BRAND_CD_COMBO
                FROM
                (
                    SELECT
                    thp.HQ_OFFICE_CD,
                    thp.PROD_CLASS_CD,
                    FN_GET_PROD_CLASS_CD_NM_STR(thp.HQ_OFFICE_CD, thp.PROD_CLASS_CD, 'NM_STR') AS PATH_NM,
                    thp.HQ_BRAND_CD,
                    thp.PROD_CD,
                    thp.PROD_NM,
                    thpb.BARCD_CD
                    FROM TB_HQ_PRODUCT thp,
                    TB_HQ_PRODUCT_BARCD thpb
                    WHERE 1=1
                    AND thp.HQ_OFFICE_CD = #{hqOfficeCd}
                    <if test='chkDt != true'>
                        <if test="startDate != null and startDate != '' and endDate != null and endDate != ''">
                            <![CDATA[
                                AND thp.REG_DT BETWEEN #{startDate} AND #{endDate}
                            ]]>
                        </if>
                    </if>
                    <if test="prodCd != null and prodCd != ''">
                        AND thp.PROD_CD LIKE '%'|| #{prodCd} ||'%'
                    </if>
                    <if test="prodNm != null and prodNm != ''">
                        AND thp.PROD_NM LIKE '%'|| #{prodNm} ||'%'
                    </if>
                    <if test="prodClassCd != null and prodClassCd != ''">
                        AND thp.PROD_CLASS_CD IN (
                        SELECT
                        PROD_CLASS_CD
                        FROM
                        TB_HQ_PRODUCT_CLASS
                        WHERE
                        HQ_OFFICE_CD = #{hqOfficeCd}
                        START WITH
                        PROD_CLASS_CD = #{prodClassCd} AND HQ_OFFICE_CD = #{hqOfficeCd}
                        CONNECT BY
                        PRIOR PROD_CLASS_CD = P_PROD_CLASS_CD AND HQ_OFFICE_CD = #{hqOfficeCd}
                        )
                    </if>
                    <if test="barCd != null and barCd != ''">
                        AND thpb.BARCD_CD = #{barCd}
                    </if>
                    <if test="useYn != null and useYn != ''">
                        AND thp.USE_YN = #{useYn}
                    </if>
                    AND thpb.HQ_OFFICE_CD (+)= thp.HQ_OFFICE_CD
                    AND thpb.PROD_CD (+)= thp.PROD_CD
                    ORDER BY thp.PROD_CD
                ) thp,
                (
                    SELECT
                    thprp.HQ_OFFICE_CD,
                    thprp.PROD_CD,
                    COUNT(thprp.RECIPES_CD) AS RECP_ORIGIN_CNT
                    FROM TB_HQ_PRODUCT_RECP_PROD thprp
                    <if test="hqOfficeCd == 'A0001'">
                        , TB_HQ_PRODUCT thp
                    </if>
                    WHERE 1=1
                    AND thprp.HQ_OFFICE_CD = #{hqOfficeCd}
                    <if test="hqOfficeCd == 'A0001'">
                        AND thp.HQ_OFFICE_CD = thprp.HQ_OFFICE_CD
                        AND thp.PROD_CD = thprp.PROD_CD
                        AND thp.HQ_BRAND_CD = thprp.HQ_BRAND_CD
                    </if>
                    GROUP BY thprp.HQ_OFFICE_CD, thprp.PROD_CD
                    ORDER BY thprp.PROD_CD
                ) thprp
                WHERE 1=1
                <choose>
                    <when test='recpOriginUseYn != null'>
                        <if test='recpOriginUseYn == "Y"'>
                            AND thprp.RECP_ORIGIN_CNT IS NOT NULL
                        </if>
                        <if test='recpOriginUseYn == "N"'>
                            AND thprp.RECP_ORIGIN_CNT IS NULL
                        </if>
                    </when>
                </choose>
                AND thprp.HQ_OFFICE_CD (+)= thp.HQ_OFFICE_CD
                AND thprp.PROD_CD (+)= thp.PROD_CD
                ORDER BY thp.PROD_CD
            </when>
            <!-- 매장 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                SELECT
                tmp.PATH_NM,
                tmp.PROD_CD,
                tmp.PROD_NM,
                NVL(tmprp.RECP_ORIGIN_CNT, 0) AS RECP_ORIGIN_CNT
                FROM
                (
                    SELECT
                    tmp.STORE_CD,
                    tmp.PROD_CLASS_CD,
                    FN_GET_PROD_CLASS_CD_NM_STR(tmp.STORE_CD, tmp.PROD_CLASS_CD, 'NM_STR') AS PATH_NM,
                    tmp.PROD_CD,
                    tmp.PROD_NM,
                    tmpb.BARCD_CD
                    FROM TB_MS_PRODUCT tmp,
                    TB_MS_PRODUCT_BARCD tmpb
                    WHERE 1=1
                    AND tmp.STORE_CD = #{storeCd}
                    <if test='chkDt != true'>
                        <if test="startDate != null and startDate != '' and endDate != null and endDate != ''">
                            <![CDATA[
                                AND tmp.REG_DT BETWEEN #{startDate} AND #{endDate}
                            ]]>
                        </if>
                    </if>
                    <if test="prodCd != null and prodCd != ''">
                        AND tmp.PROD_CD LIKE '%'|| #{prodCd} ||'%'
                    </if>
                    <if test="prodNm != null and prodNm != ''">
                        AND tmp.PROD_NM LIKE '%'|| #{prodNm} ||'%'
                    </if>
                    <if test="prodClassCd != null and prodClassCd != ''">
                        AND tmp.PROD_CLASS_CD IN (
                        SELECT
                        PROD_CLASS_CD
                        FROM
                        TB_MS_PRODUCT_CLASS
                        WHERE
                        STORE_CD = #{storeCd}
                        START WITH
                        PROD_CLASS_CD = #{prodClassCd} AND STORE_CD = #{storeCd}
                        CONNECT BY
                        PRIOR PROD_CLASS_CD = P_PROD_CLASS_CD AND STORE_CD = #{storeCd}
                        )
                    </if>
                    <if test="barCd != null and barCd != ''">
                        AND tmpb.BARCD_CD = #{barCd}
                    </if>
                    <if test="useYn != null and useYn != ''">
                        AND tmp.USE_YN = #{useYn}
                    </if>
                    AND tmpb.STORE_CD (+)= tmp.STORE_CD
                    AND tmpb.PROD_CD (+)= tmp.PROD_CD
                    ORDER BY tmp.PROD_CD
                ) tmp,
                (
                    SELECT
                    tmprp.STORE_CD,
                    tmprp.PROD_CD,
                    COUNT(tmprp.RECIPES_CD) AS RECP_ORIGIN_CNT
                    FROM TB_MS_PRODUCT_RECP_PROD tmprp
                    WHERE 1=1
                    AND tmprp.STORE_CD = #{storeCd}
                    GROUP BY tmprp.STORE_CD, tmprp.PROD_CD
                    ORDER BY tmprp.PROD_CD
                ) tmprp
                WHERE 1=1
                <choose>
                    <when test='recpOriginUseYn != null'>
                        <if test='recpOriginUseYn == "Y"'>
                            AND tmprp.RECP_ORIGIN_CNT IS NOT NULL
                        </if>
                        <if test='recpOriginUseYn == "N"'>
                            AND tmprp.RECP_ORIGIN_CNT IS NULL
                        </if>
                    </when>
                </choose>
                AND tmprp.STORE_CD (+)= tmp.STORE_CD
                AND tmprp.PROD_CD (+)= tmp.PROD_CD
                ORDER BY tmp.PROD_CD
            </when>
        </choose>
    </select>

    <!-- 상품-원산지관리탭 - 재료 및 원산지 등록 조회 -->
    <!--
        TABLE    : TB_HQ_PRODUCT_RECP_PROD, TB_HQ_PRODUCT_RECP_ORIGIN
                   TB_MS_PRODUCT_RECP_PROD, TB_MS_PRODUCT_RECP_ORIGIN
        COMMENTS : [본사]재료-원산지정보, [본사]재료-원산지정보
                   [매장]재료-원산지정보, [매장]재료-원산지정보
    -->
    <select id="getProdRecpOriginDetailList"  parameterType="RecpOriginVO" resultType="DefaultMap">
        /* RecpOriginMapper.getProdRecpOriginDetailList */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                SELECT
                thprp.HQ_BRAND_CD,
                (SELECT HQ_BRAND_NM FROM TB_HQ_BRAND WHERE HQ_OFFICE_CD = #{hqOfficeCd} AND HQ_BRAND_CD = thprp.HQ_BRAND_CD) AS HQ_BRAND_NM,
                thprp.RECIPES_CD,
                thpro.RECIPES_NM,
                thpro.ORGPLCE_NM,
                thprp.RECP_SEQ
                FROM TB_HQ_PRODUCT_RECP_PROD thprp,
                TB_HQ_PRODUCT_RECP_ORIGIN thpro
                WHERE 1=1
                AND thprp.HQ_OFFICE_CD = #{hqOfficeCd}
                AND thprp.PROD_CD = #{prodCd}
                <if test="hqOfficeCd == 'A0001'">
                    <if test="hqBrandCd != null and hqBrandCd != ''">
                        AND thprp.HQ_BRAND_CD = #{hqBrandCd}
                    </if>
                </if>
                AND thpro.HQ_OFFICE_CD (+)= thprp.HQ_OFFICE_CD
                AND thpro.RECIPES_CD (+)= thprp.RECIPES_CD
                ORDER BY thprp.RECP_SEQ, thprp.RECIPES_CD
            </when>
            <!-- 매장 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                SELECT
                tmprp.RECIPES_CD,
                tmpro.RECIPES_NM,
                tmpro.ORGPLCE_NM,
                tmprp.RECP_SEQ
                FROM TB_MS_PRODUCT_RECP_PROD tmprp,
                TB_MS_PRODUCT_RECP_ORIGIN tmpro
                WHERE 1=1
                AND tmprp.STORE_CD = #{storeCd}
                AND tmprp.PROD_CD = #{prodCd}
                AND tmpro.STORE_CD (+)= tmprp.STORE_CD
                AND tmpro.RECIPES_CD (+)= tmprp.RECIPES_CD
                ORDER BY tmprp.RECP_SEQ, tmprp.RECIPES_CD
            </when>
        </choose>
    </select>

    <!-- 재료 및 원산지 등록 팝업 - 조회 -->
    <!--
        TABLE    : TB_HQ_PRODUCT_RECP_PROD, TB_HQ_PRODUCT_RECP_ORIGIN
                   TB_MS_PRODUCT_RECP_PROD, TB_MS_PRODUCT_RECP_ORIGIN
        COMMENTS : [본사]재료-원산지정보, [본사]재료-원산지정보
                   [매장]재료-원산지정보, [매장]재료-원산지정보
    -->
    <select id="getProdRecpOriginAddList"  parameterType="RecpOriginVO" resultType="DefaultMap">
        /* RecpOriginMapper.getProdRecpOriginAddList */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                SELECT
                thpro.RECIPES_CD,
                thpro.RECIPES_NM,
                thpro.ORGPLCE_NM,
                thpro.HQ_BRAND_CD,
                (SELECT HQ_BRAND_NM FROM TB_HQ_BRAND WHERE HQ_OFFICE_CD = #{hqOfficeCd} AND HQ_BRAND_CD = thpro.HQ_BRAND_CD) AS HQ_BRAND_NM
                FROM TB_HQ_PRODUCT_RECP_ORIGIN thpro
                WHERE 1=1
                AND thpro.HQ_OFFICE_CD = #{hqOfficeCd}
                <if test="hqOfficeCd == 'A0001'">
                    <if test="hqBrandCd != null and hqBrandCd != ''">
                        AND thpro.HQ_BRAND_CD = #{hqBrandCd}
                    </if>
                </if>
                <if test="recipesNm != null and recipesNm != ''">
                    AND thpro.RECIPES_NM LIKE '%'|| #{recipesNm} ||'%'
                </if>
                <if test="orgplceNm != null and orgplceNm != ''">
                    AND thpro.ORGPLCE_NM LIKE '%'|| #{orgplceNm} ||'%'
                </if>
                AND NOT EXISTS
                (
                    SELECT 1
                    FROM TB_HQ_PRODUCT_RECP_PROD thprp
                    WHERE 1=1
                    AND thprp.HQ_OFFICE_CD = #{hqOfficeCd}
                    AND thprp.PROD_CD = #{prodCd}
                    AND thprp.HQ_OFFICE_CD = thpro.HQ_OFFICE_CD
                    AND thprp.RECIPES_CD = thpro.RECIPES_CD
                )
                ORDER BY thpro.RECIPES_CD
            </when>
            <!-- 매장 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                SELECT
                tmpro.RECIPES_CD,
                tmpro.RECIPES_NM,
                tmpro.ORGPLCE_NM
                FROM TB_MS_PRODUCT_RECP_ORIGIN tmpro
                WHERE 1=1
                AND tmpro.STORE_CD = #{storeCd}
                <if test="recipesNm != null and recipesNm != ''">
                    AND tmpro.RECIPES_NM LIKE '%'|| #{recipesNm} ||'%'
                </if>
                <if test="orgplceNm != null and orgplceNm != ''">
                    AND tmpro.ORGPLCE_NM LIKE '%'|| #{orgplceNm} ||'%'
                </if>
                AND NOT EXISTS
                (
                    SELECT 1
                    FROM TB_MS_PRODUCT_RECP_PROD tmprp
                    WHERE 1=1
                    AND tmprp.STORE_CD = #{storeCd}
                    AND tmprp.PROD_CD = #{prodCd}
                    AND tmprp.STORE_CD = tmpro.STORE_CD
                    AND tmprp.RECIPES_CD = tmpro.RECIPES_CD
                )
                ORDER BY tmpro.RECIPES_CD
            </when>
        </choose>
    </select>

    <!-- 원산지출력순서 조회(자동채번) -->
    <!--
        TABLE    : TB_HQ_PRODUCT_RECP_PROD, TB_MS_PRODUCT_RECP_PROD
        COMMENTS : [본사]재료-원산지정보, [매장]재료-원산지정보
    -->
    <select id="getRecpSeq"  parameterType="RecpOriginVO" resultType="String">
        /* RecpOriginMapper.getRecpSeq */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                SELECT
                (NVL(MAX(thprp.RECP_SEQ), 0) + 1) AS RECP_SEQ
                FROM TB_HQ_PRODUCT_RECP_PROD thprp
                WHERE 1=1
                AND thprp.HQ_OFFICE_CD = #{hqOfficeCd}
                AND thprp.PROD_CD = #{prodCd}
            </when>
            <!-- 매장 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                SELECT
                (NVL(MAX(tmprp.RECP_SEQ), 0) + 1) AS RECP_SEQ
                FROM TB_MS_PRODUCT_RECP_PROD tmprp
                WHERE 1=1
                AND tmprp.STORE_CD = #{storeCd}
                AND tmprp.PROD_CD = #{prodCd}
            </when>
        </choose>
    </select>

    <!-- 상품-원산지관리탭 - 저장 update -->
    <!--
        TABLE    : TB_HQ_PRODUCT
        COMMENTS : [본사]상품
    -->
    <update id="getProdRecpOriginSave" parameterType="EnvConfgBatchChangeVO">
        /* RecpOriginMapper.getProdRecpOriginSave */
        UPDATE
        TB_HQ_PRODUCT
        SET
        HQ_BRAND_CD = #{hqBrandCd},
        MOD_DT = #{modDt},
        MOD_ID = #{modId}
        WHERE 1=1
        AND HQ_OFFICE_CD = #{hqOfficeCd}
        AND PROD_CD = #{prodCd}
    </update>

</mapper>