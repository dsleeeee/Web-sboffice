<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.solbipos.sale.status.dc.dcfg.service.impl.DcDcfgMapper">

    <select id="getDcDcfgList" parameterType="dcDcfgVO" resultType="DefaultMap">
    	<include refid="CmmSQL.PagingTemplateHeader"/>
    	SELECT STORE.STORE_NM
    		 , TSDT.STORE_CD
     		 , TSDT.SALE_DATE
     		 , NMCODE.NMCODE_CD AS DC_CD
     		 , NMCODE.NMCODE_NM AS DC_NM
     		 , TSDD.TOT_SALE_QTY
     		 , TSDT.TOT_SALE_AMT
     		 , TSDD.TOT_DC_AMT AS DC_AMT
     		 , TSDT.TOT_DC_AMT
     		 , TSDD.REAL_SALE_AMT
     	<include refid="CmmSQL.PagingTemplateCount"/>
  		FROM TB_SL_DAILY_TOTAL TSDT
  		   , TB_SL_DAILY_DC TSDD
     	   , TB_MS_STORE STORE
     	   ,(SELECT NMCODE_CD, NMCODE_NM FROM TB_CM_NMCODE
       		 WHERE PARENT_CD = '041') NMCODE
 		WHERE TSDT.STORE_CD = TSDD.STORE_CD
   		  AND TSDT.SALE_DATE = TSDD.SALE_DATE
   	 	  AND TSDT.STORE_CD = STORE.STORE_CD
   		  AND TSDD.DC_CD = NMCODE.NMCODE_CD
   		  <if test="startDate != null and startDate != '' and endDate != null and endDate != ''">
   		  	AND TSDT.SALE_DATE BETWEEN #{startDate} AND #{endDate}
   		  </if>
   		  <if test='arrStoreCd != null and arrStoreCd.length >= 0'>
           	AND TSDT.STORE_CD IN
            <foreach collection="arrStoreCd" item="item" open="(" close=")" separator=",">
               	#{item}
            </foreach>
      	  </if>
      	  <if test='arrDcCd != null and arrDcCd.length >= 0'>
           	AND TSDD.DC_CD IN
            <foreach collection="arrDcCd" item="item" open="(" close=")" separator=",">
               	#{item}
            </foreach>
      	  </if>
		  <!-- <if test='arrStoreCd != null and arrStoreCd != ""'>
		  	AND TSDT.STORE_CD IN
		  	<foreach collection="arrStoreCd" item="item" open="(" close=")" separator=",">
		  		#{item}
		  	</foreach>
		  </if>
		  <if test='dcCd != null and dcCd != ""'>
          	AND TSDD.DC_CD = #{dcCd}
      	  </if> -->
      	  ORDER BY TSDT.SALE_DATE DESC, TSDT.STORE_CD, NMCODE.NMCODE_CD, TSDD.TOT_SALE_AMT DESC
    	<include refid="CmmSQL.PagingTemplateBottom"/>
    </select>

    <select id="getDcDcfgDtlList" parameterType="dcDcfgVO" resultType="DefaultMap">
	       SELECT A.STORE_NM
             , A.SALE_DATE
             , A.LV1_NM
		     , A.LV2_NM
		     , A.LV3_NM
		     , A.PROD_CD
		     , A.PROD_NM
		     , A.DC_CD
		     , A.DC_NM
		     , A.DC_REASON_CD
		     , NVL(A.MS_COUPN_NM, A.HQ_COUPN_NM)                   AS DCDTL_DC_NM
		     , A.SALE_QTY
		     , A.SALE_AMT
		     , A.DC_AMT
		     , A.TOT_DC_AMT
		     , A.REAL_SALE_AMT
		  FROM (
		      SELECT C.LV1_NM
		          , C.LV2_NM
		          , C.LV3_NM
		          , C.PROD_NM
		          , TSSD.SALE_DATE
                  , TSSD.PROD_CD
                  , TMS.STORE_NM
		          , TSSDD.DC_CD
		          , (
		                   SELECT  '(' || TSSDD.DC_CD || ')' || NMCODE_NM
		                    FROM    TB_CM_NMCODE
		                    WHERE   NMCODE_GRP_CD   = '041'
		                    AND     NMCODE_CD       = TSSDD.DC_CD)              AS DC_NM
		           , TSSDD.DC_REASON_CD
		           , (
		                 SELECT  COUPN_NM
		                 FROM    TB_HQ_COUPON
		                 WHERE   1 = 1
		                 <if test='hqOfficeCd != null and hqOfficeCd != ""'>
		                  AND HQ_OFFICE_CD                =  #{hqOfficeCd}
		                 </if>
		                 AND     PAY_CLASS_CD || COUPN_CD    = TSSDD.DC_REASON_CD
		             )   AS HQ_COUPN_NM
		          , (
		                 SELECT  MAX(COUPN_NM)               AS COUPN_NM
		                 FROM    TB_MS_COUPON
		                 WHERE 1 = 1
		                 <if test='storeCd != null and storeCd != ""'>
		                  AND   STORE_CD                    = #{storeCd}
		                 </if>
		                 AND     PAY_CLASS_CD || COUPN_CD    = TSSDD.DC_REASON_CD
		             )   AS MS_COUPN_NM
		           , SUM(TSSD.SALE_QTY) AS SALE_QTY
		           , SUM(TSSD.SALE_AMT) AS SALE_AMT
		           , SUM(TSSDD.DC_AMT) AS DC_AMT
		           , SUM(TSSD.DC_AMT) AS TOT_DC_AMT
		           , SUM(TSSD.REAL_SALE_AMT) AS REAL_SALE_AMT
		        FROM TB_SL_SALE_DTL TSSD
		           , TB_SL_SALE_DTL_DC TSSDD
		           , TB_MS_STORE TMS
		         <choose>
		         <when test='orgnFg != null and orgnFg == "H"'>    <!-- 본사 -->
		           , (
		               SELECT  A.LV1_NM,
		                   A.LV2_NM,
		                   A.LV3_NM,
		                   B.PROD_CD,
		                   B.PROD_NM
		               FROM(
		                      SELECT  A.P_PROD_CLASS_CD   AS LV1_CD,
		                                 A.PROD_CLASS_CD     AS LV2_CD,
		                                 A.PROD_CLASS_NM     AS LV2_NM,
		                                 B.PROD_CLASS_CD     AS LV3_CD,
		                                 B.PROD_CLASS_NM     AS LV3_NM,
		                                 (SELECT  SF_GET_PROD_CLASSES('H', #{hqOfficeCd},    A.P_PROD_CLASS_CD) FROM DUAL)    AS LV1_NM,
		                                 (SELECT  SF_GET_PROD_CLASSES('H', #{hqOfficeCd},    A.PROD_CLASS_CD  ) FROM DUAL)    AS LV2_NM_FULL,
		                                 (SELECT  SF_GET_PROD_CLASSES('H', #{hqOfficeCd},    B.PROD_CLASS_CD  ) FROM DUAL)    AS LV3_NM_FULL
		                         FROM    (
		                                     SELECT  HQ_OFFICE_CD,
		                                           P_PROD_CLASS_CD,
		                                           PROD_CLASS_CD,
		                                           PROD_CLASS_NM
		                                     FROM    TB_HQ_PRODUCT_CLASS
		                                     WHERE   HQ_OFFICE_CD    = #{hqOfficeCd}
		                                     AND     P_PROD_CLASS_CD IN (
		                                                                    SELECT  PROD_CLASS_CD
		                                                                    FROM    TB_HQ_PRODUCT_CLASS
		                                                                    WHERE   HQ_OFFICE_CD    = #{hqOfficeCd}
		                                                                    AND     P_PROD_CLASS_CD = '00000'
		                                                                 )
		                                 )                      A,
		                                 TB_HQ_PRODUCT_CLASS    B
		                         WHERE   B.P_PROD_CLASS_CD IN    (
		                                                             SELECT  PROD_CLASS_CD
		                                                             FROM    TB_HQ_PRODUCT_CLASS
		                                                             WHERE   HQ_OFFICE_CD    = #{hqOfficeCd}
		                                                             AND     P_PROD_CLASS_CD IN (
		                                                                                      SELECT  PROD_CLASS_CD
		                                                                                            FROM    TB_HQ_PRODUCT_CLASS
		                                                                                            WHERE   HQ_OFFICE_CD    = #{hqOfficeCd}
		                                                                                            AND     P_PROD_CLASS_CD = '00000'
		                                                                                         )
		                                                         )
		                         AND     A.HQ_OFFICE_CD  = B.HQ_OFFICE_CD
		                         AND     A.PROD_CLASS_CD = B.P_PROD_CLASS_CD
		                     )                   A,
		                     TB_HQ_PRODUCT       B
		             WHERE   B.HQ_OFFICE_CD   = #{hqOfficeCd}
		             AND     B.PROD_CLASS_CD = A.LV3_CD
		             ) C
		         </when>
		         <when test='orgnFg != null and orgnFg == "S"'>    <!-- 가맹점 -->
		           , (
		              SELECT  A.LV1_NM,
		                   A.LV2_NM,
		                   A.LV3_NM,
		                   B.PROD_CD,
		                   B.PROD_NM
		               FROM(
		                         SELECT  A.P_PROD_CLASS_CD   AS LV1_CD,
		                                 A.PROD_CLASS_CD     AS LV2_CD,
		                                 A.PROD_CLASS_NM     AS LV2_NM,
		                                 B.PROD_CLASS_CD     AS LV3_CD,
		                                 B.PROD_CLASS_NM     AS LV3_NM,
		                                 (SELECT  SF_GET_PROD_CLASSES('S', #{storeCd}, A.P_PROD_CLASS_CD) FROM DUAL)    AS LV1_NM,
		                                 (SELECT  SF_GET_PROD_CLASSES('S', #{storeCd}, A.PROD_CLASS_CD  ) FROM DUAL)    AS LV2_NM_FULL,
		                                 (SELECT  SF_GET_PROD_CLASSES('S', #{storeCd}, B.PROD_CLASS_CD  ) FROM DUAL)    AS LV3_NM_FULL
		                         FROM    (
		                                     SELECT  STORE_CD,
		                                           P_PROD_CLASS_CD,
		                                           PROD_CLASS_CD,
		                                           PROD_CLASS_NM
		                                     FROM    TB_MS_PRODUCT_CLASS
		                                     WHERE   STORE_CD        = #{storeCd}
		                                     AND     P_PROD_CLASS_CD IN (
		                                                                    SELECT  PROD_CLASS_CD
		                                                                    FROM    TB_MS_PRODUCT_CLASS
		                                                                    WHERE   STORE_CD        = #{storeCd}
		                                                                    AND     P_PROD_CLASS_CD = '00000'
		                                                                 )
		                                 )                      A,
		                                 TB_MS_PRODUCT_CLASS    B
		                         WHERE   B.P_PROD_CLASS_CD IN    (
		                                                             SELECT  PROD_CLASS_CD
		                                                             FROM    TB_MS_PRODUCT_CLASS
		                                                             WHERE   STORE_CD        = #{storeCd}
		                                                             AND     P_PROD_CLASS_CD IN (
		                                                                                      SELECT  PROD_CLASS_CD
		                                                                                            FROM    TB_MS_PRODUCT_CLASS
		                                                                                            WHERE   STORE_CD        = #{storeCd}
		                                                                                            AND     P_PROD_CLASS_CD = '00000'
		                                                                                         )
		                                                         )
		                         AND     A.STORE_CD      = B.STORE_CD
		                         AND     A.PROD_CLASS_CD = B.P_PROD_CLASS_CD
		                     )                   A,
		                     TB_MS_PRODUCT       B
		             WHERE   B.STORE_CD      = #{storeCd}
		             AND     B.PROD_CLASS_CD = A.LV3_CD
		             ) C
		            </when>
		       </choose>
		       WHERE TSSD.HQ_OFFICE_CD = TSSDD.HQ_OFFICE_CD
		         AND TSSD.HQ_BRAND_CD  = TSSDD.HQ_BRAND_CD
		         AND TSSD.STORE_CD     = TSSDD.STORE_CD
		         AND TSSD.SALE_DATE    = TSSDD.SALE_DATE
		         AND TSSD.POS_NO       = TSSDD.POS_NO
		         AND TSSD.BILL_NO      = TSSDD.BILL_NO
		         AND TSSD.BILL_DTL_NO  = TSSDD.BILL_DTL_NO
		         AND TSSD.PROD_CD      = C.PROD_CD
		         AND TSSD.STORE_CD = TMS.STORE_CD
		         <if test='storeCd != null and storeCd != ""'>
		          AND TSSD.STORE_CD 	   = #{storeCd}
		         </if>
		         <if test="startDate != null and startDate != '' and endDate != null and endDate != ''">
	               AND TSSD.SALE_DATE     BETWEEN #{startDate}   AND     #{endDate}
	             </if>
                 <if test='dcCd != null and dcCd != ""'>
		          AND TSSDD.DC_CD 	   = #{dcCd}
		         </if>
		       GROUP BY TSSD.SALE_DATE, TMS.STORE_NM, TSSD.PROD_CD, TSSDD.DC_CD, TSSDD.DC_REASON_CD, C.LV1_NM, C.LV2_NM, C.LV3_NM, C.PROD_NM
		      ) A
		ORDER BY A.SALE_DATE, A.STORE_NM, A.DC_REASON_CD, A.PROD_CD, A.DC_CD
    </select>

    <select id="getDcNmList" parameterType="dcDcfgVO" resultType="DefaultMap">
    	SELECT DISTINCT DC.DC_CD DC_CD
    		 , NMCODE.NMCODE_NM DC_NM
    		 , (SELECT STORE_NM FROM TB_MS_STORE WHERE STORE_CD = DC.STORE_CD) AS STORE_NM
		FROM TB_SL_SALE_DTL_DC DC, TB_CM_NMCODE NMCODE
		WHERE 1=1
			  AND DC.DC_CD = NMCODE.NMCODE_CD
			  AND NMCODE.PARENT_CD = '041'
			  <if test='hqOfficeCd != null and hqOfficeCd != ""'>
			     AND DC.HQ_OFFICE_CD = #{hqOfficeCd}
			  </if>
			  <if test='arrStoreCd != null and arrStoreCd != ""'>
			  	AND DC.STORE_CD IN
			  	<foreach collection="arrStoreCd" item="item" open="(" close=")" separator=",">
			  		#{item}
			  	</foreach>
			  </if>
		ORDER BY NMCODE.NMCODE_NM
    </select>

</mapper>
