<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.solbipos.kds.anals.chart.service.impl.KdsMapper">
    <select id="getKdsMonth" parameterType="KdsVO" resultType="DefaultMap">
        /* KdsMapper.getKdsMonth */
        SELECT
        A.LV1_CD,
        A.LV2_CD,
        A.LV2_NM,
        A.LV3_CD,
        A.LV3_NM,
        A.LV1_NM,
        A.LV2_NM_FULL,
        A.LV3_NM_FULL,
        C.STORE_CD,
        C.PROD_CD,
        C.SALE_MON,
        B.PROD_NM,
        D.STORE_NM,
        SUM(C.SALE_QTY) AS SALE_QTY,
        SUM(C.AVG_MAKE) AS AVG_MAKE,
        SUM(C.AVG_PIC) AS AVG_PIC
        FROM
        <choose>
            <when test='orgnFg != null and orgnFg == "HQ"'>
                (
                SELECT  A.P_PROD_CLASS_CD   AS LV1_CD,
                A.PROD_CLASS_CD     AS LV2_CD,
                A.PROD_CLASS_NM     AS LV2_NM,
                B.PROD_CLASS_CD     AS LV3_CD,
                B.PROD_CLASS_NM     AS LV3_NM,
                (SELECT  SF_GET_PROD_CLASSES('H', #{hqOfficeCd},    A.P_PROD_CLASS_CD) FROM DUAL)    AS LV1_NM,
                (SELECT  SF_GET_PROD_CLASSES('H', #{hqOfficeCd},    A.PROD_CLASS_CD  ) FROM DUAL)    AS LV2_NM_FULL,
                (SELECT  SF_GET_PROD_CLASSES('H', #{hqOfficeCd},    B.PROD_CLASS_CD  ) FROM DUAL)    AS LV3_NM_FULL
                FROM    (
                SELECT  HQ_OFFICE_CD,
                P_PROD_CLASS_CD,
                PROD_CLASS_CD,
                PROD_CLASS_NM
                FROM    TB_HQ_PRODUCT_CLASS
                WHERE   HQ_OFFICE_CD    = #{hqOfficeCd}
                AND     P_PROD_CLASS_CD IN (
                SELECT  PROD_CLASS_CD
                FROM    TB_HQ_PRODUCT_CLASS
                WHERE   HQ_OFFICE_CD    = #{hqOfficeCd}
                AND     P_PROD_CLASS_CD = '00000'
                )
                )                      A,
                TB_HQ_PRODUCT_CLASS    B
                WHERE   B.P_PROD_CLASS_CD IN    (
                SELECT  PROD_CLASS_CD
                FROM    TB_HQ_PRODUCT_CLASS
                WHERE   HQ_OFFICE_CD    = #{hqOfficeCd}
                AND     P_PROD_CLASS_CD IN (
                SELECT  PROD_CLASS_CD
                FROM    TB_HQ_PRODUCT_CLASS
                WHERE   HQ_OFFICE_CD    = #{hqOfficeCd}
                AND     P_PROD_CLASS_CD = '00000'
                )
                )
                AND     A.HQ_OFFICE_CD  = B.HQ_OFFICE_CD
                AND     A.PROD_CLASS_CD = B.P_PROD_CLASS_CD
                )                   A,
                TB_HQ_PRODUCT       B,
            </when>
            <when test='orgnFg != null and orgnFg == "STORE"'>
                (
                SELECT  A.P_PROD_CLASS_CD   AS LV1_CD,
                A.PROD_CLASS_CD     AS LV2_CD,
                A.PROD_CLASS_NM     AS LV2_NM,
                B.PROD_CLASS_CD     AS LV3_CD,
                B.PROD_CLASS_NM     AS LV3_NM,
                (SELECT  SF_GET_PROD_CLASSES('S', #{storeCd}, A.P_PROD_CLASS_CD) FROM DUAL)    AS LV1_NM,
                (SELECT  SF_GET_PROD_CLASSES('S', #{storeCd}, A.PROD_CLASS_CD  ) FROM DUAL)    AS LV2_NM_FULL,
                (SELECT  SF_GET_PROD_CLASSES('S', #{storeCd}, B.PROD_CLASS_CD  ) FROM DUAL)    AS LV3_NM_FULL
                FROM    (
                SELECT  STORE_CD,
                P_PROD_CLASS_CD,
                PROD_CLASS_CD,
                PROD_CLASS_NM
                FROM    TB_MS_PRODUCT_CLASS
                WHERE   STORE_CD        = #{storeCd}
                AND     P_PROD_CLASS_CD IN (
                SELECT  PROD_CLASS_CD
                FROM    TB_MS_PRODUCT_CLASS
                WHERE   STORE_CD        = #{storeCd}
                AND     P_PROD_CLASS_CD = '00000'
                )
                )                      A,
                TB_MS_PRODUCT_CLASS    B
                WHERE   B.P_PROD_CLASS_CD IN    (
                SELECT  PROD_CLASS_CD
                FROM    TB_MS_PRODUCT_CLASS
                WHERE   STORE_CD        = #{storeCd}
                AND     P_PROD_CLASS_CD IN (
                SELECT  PROD_CLASS_CD
                FROM    TB_MS_PRODUCT_CLASS
                WHERE   STORE_CD        = #{storeCd}
                AND     P_PROD_CLASS_CD = '00000'
                )
                )
                AND     A.STORE_CD      = B.STORE_CD
                AND     A.PROD_CLASS_CD = B.P_PROD_CLASS_CD
                )                   A,
                TB_MS_PRODUCT       B,
            </when>
        </choose>
        (
        SELECT
        toodkd.STORE_CD, SUM(toodkd.SALE_QTY) AS SALE_QTY , toodkd.PROD_CD , SUBSTR(toodkd.SALE_DATE, 0, 6) AS SALE_MON , SUM(toodkd.SALE_QTY)
        <if test = 'makeDate == 0'>
            , AVG(toodkd.AVG_S_CK_TO_E_CK) AS AVG_MAKE
        </if>
        <if test = "makeDate == 1">
            , AVG(toodkd.AVG_L_OD_TO_E_CK) AS AVG_MAKE
        </if>
        <if test = 'picDate == 0'>
            , AVG(toodkd.AVG_S_OD_TO_E_PK) AS AVG_PIC
        </if>
        <if test = "picDate == 1">
            , AVG(toodkd.AVG_E_CK_TO_E_PK) AS AVG_PIC
        </if>
        FROM
        TB_OD_ORDER_DTL_KDS_DAILY toodkd
        GROUP BY
        SUBSTR(toodkd.SALE_DATE, 0, 6), toodkd.STORE_CD, toodkd.PROD_CD ) C,
        TB_MS_STORE D
        WHERE
            B.PROD_CD = C.PROD_CD
        AND B.PROD_CLASS_CD = A.LV3_CD
        AND C.STORE_CD = D.STORE_CD(+)
        <if test = 'hqOfficeCd != null and hqOfficeCd != ""'>
            AND B.HQ_OFFICE_CD = #{hqOfficeCd}
        </if>
        <if test = 'storeCd != null and storeCd != ""'>
            AND C.STORE_CD = #{storeCd}
        </if>
        <if test = 'prodCd != null and prodCd != ""'>
           AND C.PROD_CD = #{prodCd}
        </if>
        <if test='prodClassCd != null and prodClassCd != ""'>
            AND B.PROD_CLASS_CD	= #{prodClassCd}
        </if>
        AND C.SALE_MON BETWEEN #{kdsDayStartDate} AND #{kdsDayEndDate}
        GROUP BY
            A.LV1_CD,
            A.LV2_CD,
            A.LV2_NM,
            A.LV3_CD,
            A.LV3_NM,
            A.LV1_NM,
            A.LV2_NM_FULL,
            A.LV3_NM_FULL,
            C.PROD_CD,
            B.PROD_NM,
            C.STORE_CD,
            C.SALE_MON,
            D.STORE_NM
        ORDER BY
            C.SALE_MON
    </select>
</mapper>
