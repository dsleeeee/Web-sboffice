<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    LsmStore.xml
    LSM사용매장조회
    ======================================================
    No  ||  수정자 ||  수정일자    ||  수정내역
    ======================================================
    1       권지현     2023.04.26      최초작성
-->
<mapper namespace="kr.co.solbipos.store.storeMoms.lsmStore.service.impl.LsmStoreMapper">

    <!-- LSM사용매장 조회 -->
    <!--
        TABLE    : TB_HQ_BRANCH_MOMS, TB_MS_STORE
        PARAM    : lsmStoreVO
        COMMENTS : LSM사용매장을 조회한다.
    -->
    <select id="getLsmStoreList" parameterType="lsmStoreVO" resultType="DefaultMap">
        /* USE : LsmStoreMapper.getLsmStoreList */
        <include refid="CmmSQL.PagingTemplateHeader"/>
        SELECT  A.STORE_CD
        ,		E.STORE_NM
        ,		F.POS_NO
        ,		A.TUKEY_GRP_CD
        ,		B.TUKEY_GRP_NM
        ,		A.TUKEY_CLASS_CD
        ,		A.TUKEY_CLASS_NM
        ,		C.PROD_CD
        ,		D.PROD_NM
        ,		J.SALE_UPRC
        <include refid="CmmSQL.PagingTemplateCount"/>
        FROM    TB_MS_TOUCH_KEY_CLASS A
        ,       TB_MS_TOUCH_KEY_GROUP B
        ,       TB_MS_TOUCH_KEY C
        ,		TB_MS_PRODUCT D
        ,		TB_MS_STORE E
        ,		TB_MS_POS_ENVST F
        ,		TB_MS_STORE_ENVST G
        ,		TB_HQ_TOUCH_KEY_CLASS H
        ,		TB_HQ_NMCODE I
        ,		(
                SELECT	STORE_CD
                ,		PROD_CD
                ,		MIN(SALE_UPRC) KEEP( DENSE_RANK FIRST ORDER BY START_DATE DESC ) AS SALE_UPRC
                FROM 	TB_MS_PRODUCT_SALE_PRICE
                WHERE 	STORE_CD IN (SELECT STORE_CD FROM TB_MS_STORE WHERE HQ_OFFICE_CD = #{hqOfficeCd})
                <![CDATA[
                    AND START_DATE <= TO_CHAR(SYSDATE, 'yyyyMMdd')
                    AND END_DATE >= TO_CHAR(SYSDATE, 'yyyyMMdd')
                ]]>
                AND 	SALE_PRC_FG = '1'
                GROUP
                BY 		STORE_CD
                , 		PROD_CD
                ) J
        WHERE 	A.STORE_CD IN (SELECT STORE_CD FROM TB_MS_STORE WHERE HQ_OFFICE_CD = #{hqOfficeCd})
        AND 	B.STORE_CD (+) = A.STORE_CD
        AND 	B.TUKEY_GRP_CD (+) = A.TUKEY_GRP_CD
        AND 	C.STORE_CD (+) = A.STORE_CD
        AND 	C.TUKEY_GRP_CD (+) = A.TUKEY_GRP_CD
        AND 	C.TUKEY_CLASS_CD (+) = A.TUKEY_CLASS_CD
        AND 	C.TUKEY_FG (+) = '01'
        AND 	D.STORE_CD (+) = A.STORE_CD
        AND 	D.PROD_CD (+) = C.PROD_CD
        AND 	E.STORE_CD = A.STORE_CD
        AND 	F.STORE_CD = A.STORE_CD
        AND 	F.ENVST_CD = '4038'
        AND 	F.ENVST_VAL != '*'
        AND 	F.ENVST_VAL = A.TUKEY_GRP_CD
        AND 	G.STORE_CD = A.STORE_CD
        AND 	G.ENVST_CD = '1248'
        AND 	G.ENVST_VAL = '2'
        AND 	H.HQ_OFFICE_CD = #{hqOfficeCd}
        AND 	H.HQ_OFFICE_CD = I.HQ_OFFICE_CD(+)
        AND 	H.TUKEY_GRP_CD = I.NMCODE_NM(+)
        AND 	H.TUKEY_CLASS_CD = I.NMCODE_ITEM_1(+)
        AND 	'228' = I.NMCODE_GRP_CD(+)
        AND 	I.NMCODE_ITEM_2 = 'Y'
        AND 	H.TUKEY_GRP_CD = A.TUKEY_GRP_CD
        AND 	H.TUKEY_CLASS_CD = A.TUKEY_CLASS_CD
        AND 	J.STORE_CD = A.STORE_CD
        AND 	J.PROD_CD = C.PROD_CD
        ORDER BY A.STORE_CD, F.POS_NO, A.TUKEY_GRP_CD, A.PAGE_NO, A.Y, A.X, C.PAGE_NO, C.Y, C.X
        <include refid="CmmSQL.PagingTemplateBottom"/>
    </select>

    <!-- LSM사용매장 조회 -->
    <!--
        TABLE    : TB_HQ_BRANCH_MOMS, TB_MS_STORE
        PARAM    : lsmStoreVO
        COMMENTS : LSM사용매장을 조회한다.
    -->
    <select id="getLsmStoreExcelList" parameterType="lsmStoreVO" resultType="DefaultMap">
        /* USE : LsmStoreMapper.getLsmStoreExcelList */
        SELECT  A.STORE_CD
        ,		E.STORE_NM
        ,		F.POS_NO
        ,		A.TUKEY_GRP_CD
        ,		B.TUKEY_GRP_NM
        ,		A.TUKEY_CLASS_CD
        ,		A.TUKEY_CLASS_NM
        ,		C.PROD_CD
        ,		D.PROD_NM
        ,		J.SALE_UPRC
        FROM    TB_MS_TOUCH_KEY_CLASS A
        ,       TB_MS_TOUCH_KEY_GROUP B
        ,       TB_MS_TOUCH_KEY C
        ,		TB_MS_PRODUCT D
        ,		TB_MS_STORE E
        ,		TB_MS_POS_ENVST F
        ,		TB_MS_STORE_ENVST G
        ,		TB_HQ_TOUCH_KEY_CLASS H
        ,		TB_HQ_NMCODE I
        ,		(
                    SELECT	STORE_CD
                    ,		PROD_CD
                    ,		MIN(SALE_UPRC) KEEP( DENSE_RANK FIRST ORDER BY START_DATE DESC ) AS SALE_UPRC
                    FROM 	TB_MS_PRODUCT_SALE_PRICE
                    WHERE 	STORE_CD IN (SELECT STORE_CD FROM TB_MS_STORE WHERE HQ_OFFICE_CD = #{hqOfficeCd})
                    <![CDATA[
                        AND START_DATE <= TO_CHAR(SYSDATE, 'yyyyMMdd')
                        AND END_DATE >= TO_CHAR(SYSDATE, 'yyyyMMdd')
                    ]]>
                    AND 	SALE_PRC_FG = '1'
                    GROUP
                    BY 		STORE_CD
                    , 		PROD_CD
                ) J
        WHERE 	A.STORE_CD IN (SELECT STORE_CD FROM TB_MS_STORE WHERE HQ_OFFICE_CD = #{hqOfficeCd})
        AND 	B.STORE_CD (+) = A.STORE_CD
        AND 	B.TUKEY_GRP_CD (+) = A.TUKEY_GRP_CD
        AND 	C.STORE_CD (+) = A.STORE_CD
        AND 	C.TUKEY_GRP_CD (+) = A.TUKEY_GRP_CD
        AND 	C.TUKEY_CLASS_CD (+) = A.TUKEY_CLASS_CD
        AND 	C.TUKEY_FG (+) = '01'
        AND 	D.STORE_CD (+) = A.STORE_CD
        AND 	D.PROD_CD (+) = C.PROD_CD
        AND 	E.STORE_CD = A.STORE_CD
        AND 	F.STORE_CD = A.STORE_CD
        AND 	F.ENVST_CD = '4038'
        AND 	F.ENVST_VAL != '*'
        AND 	F.ENVST_VAL = A.TUKEY_GRP_CD
        AND 	G.STORE_CD = A.STORE_CD
        AND 	G.ENVST_CD = '1248'
        AND 	G.ENVST_VAL = '2'
        AND 	H.HQ_OFFICE_CD = #{hqOfficeCd}
        AND 	H.HQ_OFFICE_CD = I.HQ_OFFICE_CD(+)
        AND 	H.TUKEY_GRP_CD = I.NMCODE_NM(+)
        AND 	H.TUKEY_CLASS_CD = I.NMCODE_ITEM_1(+)
        AND 	'228' = I.NMCODE_GRP_CD(+)
        AND 	I.NMCODE_ITEM_2 = 'Y'
        AND 	H.TUKEY_GRP_CD = A.TUKEY_GRP_CD
          AND 	H.TUKEY_CLASS_CD = A.TUKEY_CLASS_CD
        AND 	J.STORE_CD = A.STORE_CD
        AND 	J.PROD_CD = C.PROD_CD
        ORDER BY A.STORE_CD, F.POS_NO, A.TUKEY_GRP_CD, A.PAGE_NO, A.Y, A.X, C.PAGE_NO, C.Y, C.X
    </select>

    <!-- 키오스크 리스트 조회 -->
    <!--
        TABLE    : TB_MS_TOUCH_KEY_CLASS, TB_MS_TOUCH_KEY_GROUP
        PARAM    : lsmStoreVO
        COMMENTS : 키오스크 리스트를 조회한다.
    -->
    <select id="getLsmKioskStoreList" parameterType="lsmStoreVO" resultType="DefaultMap">
        /* USE : LsmStoreMapper.getLsmKioskStoreList */
        <include refid="CmmSQL.PagingTemplateHeader"/>
        SELECT 	A.STORE_CD
        ,		E.STORE_NM
        ,		A.POS_NO
        ,		A.TU_CLS_TYPE
        ,		B.TU_CLS_TYPE_NM
        ,		A.TU_CLS_CD
        ,		A.TU_CLS_NM
        ,		C.PROD_CD
        ,		D.PROD_NM
        ,		J.SALE_UPRC
        <include refid="CmmSQL.PagingTemplateCount"/>
        FROM 	TB_MS_KIOSK_CLS A
        ,		TB_MS_KIOSK_GROUP B
        ,		TB_MS_KIOSK_KEY C
        ,		TB_MS_PRODUCT D
        ,		TB_MS_STORE	E
        ,		TB_MS_POS_ENVST F
        ,		TB_MS_STORE_ENVST G
        ,		TB_HQ_KIOSK_CLS H
        ,		TB_HQ_NMCODE I
        ,		(
                SELECT	STORE_CD
                ,		PROD_CD
                ,		MIN(SALE_UPRC) KEEP( DENSE_RANK FIRST ORDER BY START_DATE DESC ) AS SALE_UPRC
                FROM 	TB_MS_PRODUCT_SALE_PRICE
                WHERE 	STORE_CD IN (SELECT STORE_CD FROM TB_MS_STORE WHERE HQ_OFFICE_CD = #{hqOfficeCd})
                <![CDATA[
                        AND START_DATE  <= TO_CHAR(SYSDATE, 'yyyyMMdd')
                        AND END_DATE    >= TO_CHAR(SYSDATE, 'yyyyMMdd')
                        ]]>
                AND 	SALE_PRC_FG = '1'
                GROUP
                BY 		STORE_CD
                , 		PROD_CD
                ) J
        WHERE 	A.STORE_CD IN (SELECT STORE_CD FROM TB_MS_STORE WHERE HQ_OFFICE_CD = #{hqOfficeCd} )
        AND 	A.TU_CLS_TYPE   NOT IN ('00')
        AND 	B.STORE_CD    (+)   = A.STORE_CD
        AND 	B.TU_CLS_TYPE (+)   = A.TU_CLS_TYPE
        AND 	B.POS_NO      (+)   = A.POS_NO
        AND 	C.STORE_CD    (+)   = A.STORE_CD
        AND 	C.POS_NO      (+)   = A.POS_NO
        AND 	C.TU_CLS_CD   (+)   = A.TU_CLS_CD
        AND 	C.TU_CLS_TYPE (+)   = A.TU_CLS_TYPE
        AND 	D.STORE_CD    (+)   = C.STORE_CD
        AND 	D.PROD_CD     (+)   = C.PROD_CD
        AND 	E.STORE_CD          = A.STORE_CD
        AND 	F.STORE_CD          = A.STORE_CD
        AND 	F.ENVST_CD          IN ('4068', '4069')
        AND 	F.ENVST_VAL         = A.TU_CLS_TYPE
        AND 	F.ENVST_VAL         != '*'
        AND 	F.POS_NO            = A.POS_NO
        AND 	G.STORE_CD          = A.STORE_CD
        AND 	G.ENVST_CD          = '1249'
        AND 	G.ENVST_VAL         = '2'
        AND 	H.HQ_OFFICE_CD      = #{hqOfficeCd}
        AND 	H.TU_CLS_TYPE       = A.TU_CLS_TYPE
        AND 	H.TU_CLS_CD         = A.TU_CLS_CD
        AND 	H.TU_CLS_NM         = A.TU_CLS_NM
        AND 	H.HQ_OFFICE_CD      = I.HQ_OFFICE_CD  (+)
        AND 	H.TU_CLS_TYPE       = I.NMCODE_NM     (+)
        AND 	H.TU_CLS_CD         = I.NMCODE_ITEM_1 (+)
        AND 	'229'               = I.NMCODE_GRP_CD (+)
        AND 	I.NMCODE_ITEM_2     = 'Y'
        AND 	I.NMCODE_NM	        = A.TU_CLS_TYPE
        AND 	I.NMCODE_ITEM_1	    = A.TU_CLS_CD
        AND 	J.STORE_CD          = A.STORE_CD
        AND 	J.PROD_CD           = C.PROD_CD
        ORDER
        BY 		A.STORE_CD, F.POS_NO, A.TU_CLS_TYPE, A.TU_PAGE, A.Y, A.X, C.TU_PAGE, C.Y, C.X
        <include refid="CmmSQL.PagingTemplateBottom"/>
    </select>

    <!-- 키오스크 엑셀 조회 -->
    <!--
        TABLE    : TB_MS_TOUCH_KEY_CLASS, TB_MS_TOUCH_KEY_GROUP
        PARAM    : lsmStoreVO
        COMMENTS : 키오스크 엑셀리스트를 조회한다.
    -->
    <select id="getLsmKioskStoreExcelList" parameterType="lsmStoreVO" resultType="DefaultMap">
        /* USE : LsmStoreMapper.getLsmKioskStoreExcelList */
        SELECT 	A.STORE_CD
        ,		E.STORE_NM
        ,		A.POS_NO
        ,		A.TU_CLS_TYPE
        ,		B.TU_CLS_TYPE_NM
        ,		A.TU_CLS_CD
        ,		A.TU_CLS_NM
        ,		C.PROD_CD
        ,		D.PROD_NM
        ,		J.SALE_UPRC
        FROM 	TB_MS_KIOSK_CLS A
        ,		TB_MS_KIOSK_GROUP B
        ,		TB_MS_KIOSK_KEY C
        ,		TB_MS_PRODUCT D
        ,		TB_MS_STORE	E
        ,		TB_MS_POS_ENVST F
        ,		TB_MS_STORE_ENVST G
        ,		TB_HQ_KIOSK_CLS H
        ,		TB_HQ_NMCODE I
        ,		(
                SELECT	STORE_CD
                ,		PROD_CD
                ,		MIN(SALE_UPRC) KEEP( DENSE_RANK FIRST ORDER BY START_DATE DESC ) AS SALE_UPRC
                FROM 	TB_MS_PRODUCT_SALE_PRICE
                WHERE 	STORE_CD IN (SELECT STORE_CD FROM TB_MS_STORE WHERE HQ_OFFICE_CD = #{hqOfficeCd})
                <![CDATA[
                        AND START_DATE  <= TO_CHAR(SYSDATE, 'yyyyMMdd')
                        AND END_DATE    >= TO_CHAR(SYSDATE, 'yyyyMMdd')
                        ]]>
                AND 	SALE_PRC_FG = '1'
                GROUP
                BY 		STORE_CD
                , 		PROD_CD
                ) J
        WHERE 	A.STORE_CD IN (SELECT STORE_CD FROM TB_MS_STORE WHERE HQ_OFFICE_CD = #{hqOfficeCd} )
        AND 	A.TU_CLS_TYPE   NOT IN ('00')
        AND 	B.STORE_CD    (+)   = A.STORE_CD
        AND 	B.TU_CLS_TYPE (+)   = A.TU_CLS_TYPE
        AND 	B.POS_NO      (+)   = A.POS_NO
        AND 	C.STORE_CD    (+)   = A.STORE_CD
        AND 	C.POS_NO      (+)   = A.POS_NO
        AND 	C.TU_CLS_CD   (+)   = A.TU_CLS_CD
        AND 	C.TU_CLS_TYPE (+)   = A.TU_CLS_TYPE
        AND 	D.STORE_CD    (+)   = C.STORE_CD
        AND 	D.PROD_CD     (+)   = C.PROD_CD
        AND 	E.STORE_CD          = A.STORE_CD
        AND 	F.STORE_CD          = A.STORE_CD
        AND 	F.ENVST_CD          IN ('4068', '4069')
        AND 	F.ENVST_VAL         = A.TU_CLS_TYPE
        AND 	F.ENVST_VAL         != '*'
        AND 	F.POS_NO            = A.POS_NO
        AND 	G.STORE_CD          = A.STORE_CD
        AND 	G.ENVST_CD          = '1249'
        AND 	G.ENVST_VAL         = '2'
        AND 	H.HQ_OFFICE_CD      = #{hqOfficeCd}
        AND 	H.TU_CLS_TYPE       = A.TU_CLS_TYPE
        AND 	H.TU_CLS_CD         = A.TU_CLS_CD
        AND 	H.TU_CLS_NM         = A.TU_CLS_NM
        AND 	H.HQ_OFFICE_CD      = I.HQ_OFFICE_CD  (+)
        AND 	H.TU_CLS_TYPE       = I.NMCODE_NM     (+)
        AND 	H.TU_CLS_CD         = I.NMCODE_ITEM_1 (+)
        AND 	'229'               = I.NMCODE_GRP_CD (+)
        AND 	I.NMCODE_ITEM_2     = 'Y'
        AND 	I.NMCODE_NM	        = A.TU_CLS_TYPE
        AND 	I.NMCODE_ITEM_1	    = A.TU_CLS_CD
        AND 	J.STORE_CD          = A.STORE_CD
        AND 	J.PROD_CD           = C.PROD_CD
        ORDER
        BY 		A.STORE_CD, F.POS_NO, A.TU_CLS_TYPE, A.TU_PAGE, A.Y, A.X, C.TU_PAGE, C.Y, C.X
    </select>

</mapper>