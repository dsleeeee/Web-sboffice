<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.solbipos.iostock.vendr.vendrInstock.service.impl.VendrInstockMapper">

    <!-- 거래처 입고/반출등록 - 거래처 입고/반출 리스트 조회(본사) -->
    <!--
        TABLE    : TB_PO_HQ_VENDR_INSTOCK, TB_HQ_BRAND, TB_HQ_VENDOR
        PARAM    : vendrInstockVO
        COMMENTS : 거래처 입고/반출등록 - 거래처 입고/반출 리스트 조회를 조회한다.
    -->
    <select id="getHqVendrInstockList" parameterType="vendrInstockVO" resultType="DefaultMap">
        /* USE : VendrInstockMapper.getHqVendrInstockList */
        <![CDATA[
        SELECT  tphvi.SLIP_NO, tphvi.SLIP_FG, tphvi.PROC_FG, thv.VENDR_NM
        ,       DECODE(tphvi.ORDER_SLIP_NO, NULL, 'N', 'Y') AS INSTOCK_TYPE
        ,       tphvi.INSTOCK_DATE
        FROM    TB_PO_HQ_VENDR_INSTOCK tphvi
        ,       (   SELECT  thv.VENDR_CD, thv.VENDR_NM
                    FROM    TB_HQ_BRAND thb
                    ,       TB_HQ_VENDOR thv
                    WHERE   thb.HQ_OFFICE_CD    =   #{hqOfficeCd}
                    AND     thv.HQ_BRAND_CD     =   thb.HQ_BRAND_CD
                ) thv
        WHERE   tphvi.HQ_OFFICE_CD  = #{hqOfficeCd}
        AND     thv.VENDR_CD        = tphvi.VENDR_CD
        ]]>
        <if test='dateFg == "reg"'>
            AND tphvi.REG_DT BETWEEN #{startDate}||'000000' AND #{endDate}||'235959'
        </if>
        <if test='dateFg == "in"'>
            AND tphvi.INSTOCK_DATE BETWEEN #{startDate} AND #{endDate}
        </if>
        <if test='slipNo != null and slipNo != ""'>
            AND tphvi.SLIP_NO = #{slipNo}
        </if>
        <if test='orderSlipNo != null and orderSlipNo != ""'>
            AND tphvi.ORDER_SLIP_NO = #{orderSlipNo}
        </if>
        <if test='slipFg != null and slipFg != ""'>
            AND tphvi.SLIP_FG = #{slipFg}
        </if>
        <if test='procFg != null and procFg != ""'>
            AND tphvi.PROC_FG = #{procFg}
        </if>
        <![CDATA[
        ORDER BY tphvi.SLIP_NO DESC
        ]]>
    </select>


    <!-- 거래처 입고/반출등록 - 거래처 입고/반출 등록시 발주번호 리스트 조회(본사)(본사) -->
    <!--
        TABLE    : TB_PO_HQ_VENDR_INSTOCK, TB_HQ_BRAND, TB_HQ_VENDOR
        PARAM    : vendrInstockVO
        COMMENTS : 거래처 입고/반출등록 - 거래처 입고/반출 등록시 발주번호 리스트를 조회한다.
    -->
    <select id="getHqVendrInstockOrderSlipList" parameterType="vendrInstockVO" resultType="DefaultMap">
        /* USE : VendrInstockMapper.getHqVendrInstockOrderSlipList */
        <![CDATA[
        SELECT  tphvo.SLIP_NO, tphvo.ORDER_DATE, tphvo.VENDR_CD, thv.VENDR_NM
        FROM    TB_PO_HQ_VENDR_ORDER tphvo
        ,       (   SELECT  thv.VENDR_CD, thv.VENDR_NM
                    FROM    TB_HQ_BRAND thb
                    ,       TB_HQ_VENDOR thv
                    WHERE   thb.HQ_OFFICE_CD    =   #{hqOfficeCd}
                    AND     thv.HQ_BRAND_CD     =   thb.HQ_BRAND_CD
                ) thv
        WHERE   tphvo.HQ_OFFICE_CD  = #{hqOfficeCd}
        AND     tphvo.ORDER_DATE    BETWEEN #{startDate} AND #{endDate}
        AND     tphvo.PROC_FG       IN ('1','3','4')
        AND     thv.VENDR_CD        = tphvo.VENDR_CD
        ]]>
        <if test='vendrCd != null and vendrCd != ""'>
            AND tphvo.VENDR_CD = #{vendrCd}
        </if>
        <![CDATA[
        ORDER BY tphvo.SLIP_NO DESC
        ]]>
    </select>


    <!-- 거래처 입고/반출등록 - 입고/반출 상세 조회(본사) -->
    <!--
        TABLE    : TB_ST_HQ_SETPROD_COMPOSITION, TB_HQ_PRODUCT
        PARAM    : vendrInstockVO
        COMMENTS : 거래처 입고/반출등록 - 입고/반출 상세 내역을 조회한다.
    -->
    <select id="getHqSlipInfo" parameterType="vendrInstockVO" resultType="DefaultMap">
        /* USE : VendrInstockMapper.getHqSlipInfo */
        <![CDATA[
        SELECT  tphvi.SLIP_NO, tphvi.PROC_FG, tphvi.VENDR_CD, thv.VENDR_NM
        ,       DECODE(tphvi.ORDER_SLIP_NO, NULL, 'N', 'Y') AS INSTOCK_TYPE
        ,       tphvi.INSTOCK_DATE, tphvi.DTL_CNT, tphvi.REMARK
        ,       tphvi.ORDER_SLIP_NO
        ,       tphvi.REG_DT
        ,       thereg.EMP_NM AS REG_NM
        ,       DECODE(tphvi.PROC_FG, 0, NULL, tphvi.CONFM_DT) AS CONFM_DT
        ,       DECODE(tphvi.PROC_FG, 0, NULL, theconfm.EMP_NM) AS CONFM_NM
        ,       tphvi.IN_TOT_QTY * tphvi.SLIP_FG AS IN_TOT_QTY
        ,       tphvi.IN_TOT * tphvi.SLIP_FG AS IN_TOT
        FROM    TB_PO_HQ_VENDR_INSTOCK tphvi
        ,       (   SELECT  thv.VENDR_CD, thv.VENDR_NM
                    FROM    TB_HQ_BRAND thb
                    ,       TB_HQ_VENDOR thv
                    WHERE   thb.HQ_OFFICE_CD    =   #{hqOfficeCd}
                    AND     thv.HQ_BRAND_CD     =   thb.HQ_BRAND_CD
                ) thv
        ,       TB_HQ_EMPLOYEE thereg
        ,       TB_HQ_EMPLOYEE theconfm
        WHERE   tphvi.HQ_OFFICE_CD        = #{hqOfficeCd}
        AND     tphvi.SLIP_NO             = #{slipNo}
        AND     thv.VENDR_CD              = tphvi.VENDR_CD
        AND     thereg.HQ_OFFICE_CD   (+) = tphvi.HQ_OFFICE_CD
        AND     thereg.USER_ID        (+) = tphvi.REG_ID
        AND     theconfm.HQ_OFFICE_CD (+) = tphvi.HQ_OFFICE_CD
        AND     theconfm.USER_ID      (+) = tphvi.CONFM_ID
        ]]>
    </select>


    <!-- 거래처 입고/반출등록 - 신규전표번호 조회 -->
    <!--
        TABLE    : TB_PO_HQ_VENDR_INSTOCK
        PARAM    : vendrInstockVO
        COMMENTS : 거래처 입고/반출등록 신규전표번호를 조회한다.
    -->
    <select id="getHqNewSlipNo" parameterType="vendrInstockVO" resultType="String">
        /* USE : VendrInstockMapper.getHqNewSlipNo */
        <![CDATA[
        SELECT  NVL(MAX(tphvi.SLIP_NO), #{yymm}||'0000')+1 AS SLIP_NO
        FROM    TB_PO_HQ_VENDR_INSTOCK tphvi
        WHERE   tphvi.HQ_OFFICE_CD  =     #{hqOfficeCd}
        AND     tphvi.SLIP_NO       LIKE  #{yymm}||'%'
        ]]>
    </select>


    <!-- 거래처 입고/반출등록 - 입고/반출상품 리스트 조회(본사) -->
    <!--
        TABLE    : TB_PO_HQ_VENDR_IN_DTL, TB_HQ_PRODUCT, TB_HQ_ENVST
        PARAM    : vendrInstockVO
        COMMENTS : 거래처 입고/반출등록 - 입고/반출상품 리스트를 조회한다.
    -->
    <select id="getHqVendrInstockProdList" parameterType="vendrInstockVO" resultType="DefaultMap">
        /* USE : VendrInstockMapper.getHqVendrInstockProdList */
        <![CDATA[
        SELECT  tphvid.PROD_CD, thp.PROD_NM, tphvid.PO_UNIT_FG, tphvid.PO_UNIT_QTY, thp.PO_UNIT_ALLOW_FG
        ,       tphvid.SLIP_FG, tphvid.COST_UPRC, thp.PO_MIN_QTY
        ,       TO_NUMBER(DECODE(tphvid.IN_TOT_QTY , 0, NULL, tphvid.IN_TOT_QTY *tphvid.SLIP_FG)) AS PREV_IN_TOT_QTY
        ,       TO_NUMBER(DECODE(tphvid.IN_UNIT_QTY, 0, NULL, tphvid.IN_UNIT_QTY*tphvid.SLIP_FG)) AS IN_UNIT_QTY
        ,       TO_NUMBER(DECODE(tphvid.IN_ETC_QTY , 0, NULL, tphvid.IN_ETC_QTY *tphvid.SLIP_FG)) AS IN_ETC_QTY
        ,       TO_NUMBER(DECODE(tphvid.IN_TOT_QTY , 0, NULL, tphvid.IN_TOT_QTY *tphvid.SLIP_FG)) AS IN_TOT_QTY
        ,       tphvid.IN_AMT*tphvid.SLIP_FG AS IN_AMT
        ,       tphvid.IN_VAT*tphvid.SLIP_FG AS IN_VAT
        ,       tphvid.IN_TOT*tphvid.SLIP_FG AS IN_TOT
        ,       DECODE(thp.VAT_FG, 'Y', 1, 0) AS VAT_FG01
        ,       the.ENVST_VAL AS ENVST0011
        FROM    TB_PO_HQ_VENDR_INSTOCK_DTL tphvid
        ,       TB_HQ_PRODUCT thp
        ,       TB_HQ_ENVST the
        WHERE   tphvid.HQ_OFFICE_CD =   #{hqOfficeCd}
        AND     tphvid.SLIP_NO      =   #{slipNo}
        AND     thp.HQ_OFFICE_CD    =   tphvid.HQ_OFFICE_CD
        AND     thp.PROD_CD         =   tphvid.PROD_CD
        AND     the.HQ_OFFICE_CD    =   tphvid.HQ_OFFICE_CD
        AND     the.ENVST_CD        =   '0011'
        ORDER
        BY      tphvid.PROD_CD
        ]]>
    </select>


    <!-- 거래처 입고/반출등록 - 진행구분 조회(본사) -->
    <!--
        TABLE    : TB_PO_HQ_VENDR_ORDER
        PARAM    : vendrInstockVO
        COMMENTS : 거래처 입고/반출등록 - 진행구분을 조회한다.
    -->
    <select id="getHqProcFgCheck" parameterType="vendrInstockVO" resultType="DefaultMap">
        /* USE : VendrInstockMapper.getHqProcFgCheck */
        <![CDATA[
        SELECT  tphvi.PROC_FG, tphvi.DTL_CNT
        ,       DECODE(tphvi.ORDER_SLIP_NO, NULL, 'N', 'Y') AS INSTOCK_TYPE
        FROM    TB_PO_HQ_VENDR_INSTOCK tphvi
        WHERE   tphvi.HQ_OFFICE_CD  = #{hqOfficeCd}
        AND     tphvi.SLIP_NO       = #{slipNo}
        ]]>
    </select>


    <!-- 거래처 입고/반출등록 - 입고/반출상품 추가/변경 등록 리스트 조회(본사) -->
    <!--
        TABLE    : TB_PO_HQ_VENDR_INSTOCK_DTL, TB_HQ_PRODUCT, TB_HQ_ENVST
        PARAM    : vendrInstockVO
        COMMENTS : 거래처 입고/반출등록 - 입고/반출상품 추가/변경 등록 리스트를 조회한다.
    -->
    <select id="getHqVendrInstockProdRegList" parameterType="vendrInstockVO" resultType="DefaultMap">
        /* USE : VendrInstockMapper.getHqVendrInstockProdRegList */
        <include refid="CmmSQL.PagingTemplateHeader"/>
        <![CDATA[
        SELECT  thvp.PROD_CD
        ,       thp.PROD_NM
        ,       DECODE(thp.VAT_FG,'Y',1,0) AS VAT_FG01
        , 		NVL(tphvid.COST_UPRC, thp.COST_UPRC) AS COST_UPRC
        , 		thp.LAST_COST_UPRC
        ,       thp.PO_UNIT_ALLOW_FG
        ,       thp.PO_UNIT_FG
        ,       thp.PO_UNIT_QTY
        ,       the.ENVST_VAL AS ENVST0011
        ,       TO_NUMBER(DECODE(tphvid.IN_UNIT_QTY, 0, NULL, tphvid.IN_UNIT_QTY*tphvid.SLIP_FG)) AS PREV_IN_UNIT_QTY
        ,       TO_NUMBER(DECODE(tphvid.IN_ETC_QTY,  0, NULL, tphvid.IN_ETC_QTY*tphvid.SLIP_FG )) AS PREV_IN_ETC_QTY
        ,       TO_NUMBER(DECODE(tphvid.IN_TOT_QTY,  0, NULL, tphvid.IN_TOT_QTY*tphvid.SLIP_FG )) AS PREV_IN_TOT_QTY
        ,       TO_NUMBER(DECODE(tphvid.IN_AMT    ,  0, NULL, tphvid.IN_AMT*tphvid.SLIP_FG     )) AS IN_AMT
        ,       TO_NUMBER(DECODE(tphvid.IN_VAT    ,  0, NULL, tphvid.IN_VAT*tphvid.SLIP_FG     )) AS IN_VAT
        ,       TO_NUMBER(DECODE(tphvid.IN_TOT    ,  0, NULL, tphvid.IN_TOT*tphvid.SLIP_FG     )) AS IN_TOT
        ]]>
        <include refid="CmmSQL.PagingTemplateCount"/>
        <![CDATA[
        FROM    TB_HQ_BRAND thb
        ,       TB_HQ_VENDOR_PROD thvp
        ,       TB_HQ_PRODUCT thp
        ,       TB_PO_HQ_VENDR_INSTOCK_DTL tphvid
        ,       TB_HQ_ENVST the
        WHERE   thb.HQ_OFFICE_CD      =   #{hqOfficeCd}
        AND     thvp.HQ_BRAND_CD      =   thb.HQ_BRAND_CD
        AND     thvp.VENDR_CD         =   #{vendrCd}
        AND     thp.HQ_OFFICE_CD      =   #{hqOfficeCd}
        AND     thp.PROD_CD           =   thvp.PROD_CD
        AND     thp.USE_YN            =   'Y'
        AND     tphvid.HQ_OFFICE_CD(+)=   thp.HQ_OFFICE_CD
        AND     tphvid.SLIP_NO    (+) =   #{slipNo}
        AND     tphvid.PROD_CD    (+) =   thp.PROD_CD
        AND     the.HQ_OFFICE_CD      =   #{hqOfficeCd}
        AND     the.ENVST_CD          =   '0011'
        ]]>
        <if test='prodCd != null and prodCd != ""'>
            AND thp.PROD_CD = #{prodCd}
        </if>
        <if test='prodNm != null and prodNm != ""'>
            AND thp.PROD_NM LIKE '%'||#{prodNm}||'%'
        </if>
        ORDER BY thp.PROD_CD
        <include refid="CmmSQL.PagingTemplateBottom"/>
    </select>


    <!-- 거래처 입고/반출등록 - 입고/반출 삭제시 상품이 있는지 여부 조회(본사) -->
    <!--
        TABLE    : TB_PO_HQ_VENDR_INSTOCK_DTL
        PARAM    : vendrInstockVO
        COMMENTS : 거래처 입고/반출등록 - 입고/반출 삭제시 상품이 있는지 여부를 조회한다.
    -->
    <select id="getHqDtlProdExist" parameterType="vendrInstockVO" resultType="String">
        /* USE : VendrInstockMapper.getHqDtlProdExist */
        <![CDATA[
        SELECT  DECODE(COUNT(tshvid.PROD_CD), 0, 'N', 'Y') AS IS_EXIST
        FROM    TB_PO_HQ_VENDR_INSTOCK_DTL tshvid
        WHERE   tshvid.HQ_OFFICE_CD = #{hqOfficeCd}
        AND     tshvid.SLIP_NO      = #{slipNo}
        AND     ROWNUM              = 1
        ]]>
    </select>


    <!-- 거래처 입고/반출등록 - 입고/반출상품 발주내역으로 세팅 리스트 조회(본사) -->
    <!--
        TABLE    : TB_PO_HQ_VENDR_IN_DTL, TB_HQ_PRODUCT, TB_HQ_ENVST
        PARAM    : vendrInstockVO
        COMMENTS : 거래처 입고/반출등록 - 입고/반출상품 발주내역으로 세팅 리스트를 조회한다.
    -->
    <select id="getHqVendrInstockOrderInfoRegList" parameterType="vendrInstockVO" resultType="DefaultMap">
        /* USE : VendrInstockMapper.getHqVendrInstockOrderInfoRegList */
        <![CDATA[
        SELECT  tphvod.PROD_CD, thp.PROD_NM, tphvod.PO_UNIT_FG, tphvod.PO_UNIT_QTY, thp.PO_UNIT_ALLOW_FG
        ,       tphvod.SLIP_FG, thp.PO_MIN_QTY
        ,       thp.LAST_COST_UPRC
        ,       tphvod.COST_UPRC AS ORDER_COST_UPRC
        ,       TO_NUMBER(SF_ZERO_TO_NULL(tphvod.ORDER_UNIT_QTY*tphvod.SLIP_FG)) AS ORDER_UNIT_QTY
        ,       TO_NUMBER(SF_ZERO_TO_NULL(tphvod.ORDER_ETC_QTY *tphvod.SLIP_FG)) AS ORDER_ETC_QTY
        ,       TO_NUMBER(SF_ZERO_TO_NULL(tphvod.ORDER_TOT_QTY *tphvod.SLIP_FG)) AS ORDER_TOT_QTY
        ,       tphvid.COST_UPRC
        ,       TO_NUMBER(SF_ZERO_TO_NULL(tphvid.IN_UNIT_QTY*tphvid.SLIP_FG)) AS IN_UNIT_QTY
        ,       TO_NUMBER(SF_ZERO_TO_NULL(tphvid.IN_ETC_QTY *tphvid.SLIP_FG)) AS IN_ETC_QTY
        ,       TO_NUMBER(SF_ZERO_TO_NULL(tphvid.IN_TOT_QTY *tphvid.SLIP_FG)) AS IN_TOT_QTY
        ,       TO_NUMBER(SF_ZERO_TO_NULL(tphvid.IN_TOT_QTY *tphvid.SLIP_FG)) AS PREV_IN_TOT_QTY
        ,       tphvid.IN_AMT*tphvid.SLIP_FG AS IN_AMT
        ,       tphvid.IN_VAT*tphvid.SLIP_FG AS IN_VAT
        ,       tphvid.IN_TOT*tphvid.SLIP_FG AS IN_TOT
        ,       DECODE(thp.VAT_FG, 'Y', 1, 0) AS VAT_FG01
        ,       the.ENVST_VAL AS ENVST0011
        FROM    TB_PO_HQ_VENDR_ORDER_DTL tphvod
        ,       TB_PO_HQ_VENDR_INSTOCK_DTL tphvid
        ,       TB_HQ_PRODUCT thp
        ,       TB_HQ_ENVST the
        WHERE   tphvod.HQ_OFFICE_CD   =   #{hqOfficeCd}
        AND     tphvod.SLIP_NO        =   #{orderSlipNo}
        AND     tphvid.HQ_OFFICE_CD(+)=   tphvod.HQ_OFFICE_CD
        AND     tphvid.SLIP_NO     (+)=   #{slipNo}
        AND     tphvid.PROD_CD     (+)=   tphvod.PROD_CD
        AND     thp.HQ_OFFICE_CD      =   tphvod.HQ_OFFICE_CD
        AND     thp.PROD_CD           =   tphvod.PROD_CD
        AND     the.HQ_OFFICE_CD      =   tphvod.HQ_OFFICE_CD
        AND     the.ENVST_CD          =   '0011'
        ORDER
        BY      tphvid.PROD_CD
        ]]>
    </select>


    <!-- 거래처 입고/반출등록 - 입고/반출정보 HD 등록(본사) -->
    <!--
        TABLE    : TB_PO_HQ_VENDR_INSTOCK
        PARAM    : vendrInstockVO
        COMMENTS : 거래처 입고/반출정보를 등록한다.
    -->
    <insert id="insertHqVendrInstockHd" parameterType="vendrInstockVO">
        /* USE : VendrInstockMapper.insertHqVendrInstockHd */
        INSERT INTO TB_PO_HQ_VENDR_INSTOCK
        (
            HQ_OFFICE_CD,
            SLIP_NO,
            SLIP_FG,
            VENDR_CD,
            PROC_FG,
            ORDER_SLIP_NO,
            INSTOCK_DATE,
            DTL_CNT,
            IN_TOT_QTY,
            IN_AMT,
            IN_VAT,
            IN_TOT,
            REMARK,
            IN_REG_DT,
            IN_REG_ID,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID
        )
        VALUES
        (
            #{hqOfficeCd},
            #{slipNo},
            #{slipFg},
            #{vendrCd},
            #{procFg},
            #{orderSlipNo},
            #{instockDate},
            0,
            0,
            0,
            0,
            0,
            #{remark},
            #{regDt},
            #{regId},
            #{regDt},
            #{regId},
            #{modDt},
            #{modId}
        )
    </insert>


    <!-- 거래처 입고/반출등록 - 입고/반출정보 HD 수정(본사) -->
    <!--
        TABLE    : TB_PO_HQ_VENDR_INSTOCK
        PARAM    : vendrInstockVO
        COMMENTS : 거래처 입고/반출정보를 수정한다.
    -->
    <update id="updateHqVendrInstockHd" parameterType="vendrInstockVO">
        /* USE : VendrInstockMapper.updateHqVendrInstockHd */
        UPDATE  TB_PO_HQ_VENDR_INSTOCK
        SET     VENDR_CD        = #{vendrCd}
        ,       ORDER_SLIP_NO   = #{orderSlipNo}
        ,       INSTOCK_DATE    = #{instockDate}
        ,       REMARK          = #{remark}
        ,       MOD_DT          = #{modDt}
        ,       MOD_ID          = #{modId}
        WHERE   HQ_OFFICE_CD  = #{hqOfficeCd}
        AND     SLIP_NO       = #{slipNo}
    </update>


    <!-- 거래처 입고/반출등록 - 입고/반출정보 DTL의 집계정보 HD에 수정(본사) -->
    <!--
        TABLE    : TB_PO_HQ_VENDR_INSTOCK
        PARAM    : vendrInstockVO
        COMMENTS : 거래처 입고/반출정보 DTL의 집계정보를 HD에 수정한다.
    -->
    <update id="updateHqVendrInstockDtlSumHd" parameterType="vendrInstockVO">
        /* USE : VendrInstockMapper.updateHqVendrInstockDtlSumHd */
        UPDATE  TB_PO_HQ_VENDR_INSTOCK
        SET     ( DTL_CNT, IN_TOT_QTY
                , IN_AMT, IN_VAT, IN_TOT)
            =   ( SELECT  COUNT(tphvid.PROD_CD), NVL(SUM(tphvid.IN_TOT_QTY),0)
                ,       NVL(SUM(tphvid.IN_AMT),0), NVL(SUM(tphvid.IN_VAT),0), NVL(SUM(tphvid.IN_TOT),0)
                  FROM    TB_PO_HQ_VENDR_INSTOCK_DTL tphvid
                  WHERE   tphvid.HQ_OFFICE_CD  = #{hqOfficeCd}
                  AND     tphvid.SLIP_NO       = #{slipNo}
                )
                ,       MOD_DT = #{modDt}
                ,       MOD_ID = #{modId}
        WHERE   HQ_OFFICE_CD  = #{hqOfficeCd}
        AND     SLIP_NO       = #{slipNo}
    </update>


    <!-- 거래처 입고/반출등록 - 입고/반출정보 HD 삭제(본사) -->
    <!--
        TABLE    : TB_PO_HQ_VENDR_INSTOCK
        PARAM    : vendrInstockVO
        COMMENTS : 거래처 입고/반출정보를 삭제한다.
    -->
    <delete id="deleteHqVendrInstockHd" parameterType="vendrInstockVO">
        /* USE : VendrInstockMapper.deleteHqVendrInstockHd */
        DELETE  TB_PO_HQ_VENDR_INSTOCK
        WHERE   HQ_OFFICE_CD  = #{hqOfficeCd}
        AND     SLIP_NO       = #{slipNo}
    </delete>


    <!-- 거래처 입고/반출등록 - 입고/반출정보 진행상태 변경시 발주 DT 내역의 입고관련 정보 초기화(본사) -->
    <!--
        TABLE    : TB_PO_HQ_VENDR_ORDER_DTL
        PARAM    : vendrInstockVO
        COMMENTS : 거래처 입고/반출정보 진행상태 변경시 발주 DT 내역의 입고관련 정보를 초기화한다.
    -->
    <update id="updateHqDefaultVendrOrderDtl" parameterType="vendrInstockVO">
        /* USE : VendrInstockMapper.updateHqDefaultVendrOrderDtl */
        UPDATE  TB_PO_HQ_VENDR_ORDER_DTL
        SET     IN_UNIT_QTY   = 0
        ,       IN_ETC_QTY    = 0
        ,       IN_TOT_QTY    = 0
        ,       IN_AMT        = 0
        ,       IN_VAT        = 0
        ,       IN_TOT        = 0
        ,       IN_FIRST_DATE = NULL
        ,       IN_LAST_DATE  = NULL
        ,       MOD_DT        = #{modDt}
        ,       MOD_ID        = #{modId}
        WHERE   HQ_OFFICE_CD  = #{hqOfficeCd}
        AND     SLIP_NO       = #{orderSlipNo}
    </update>


    <!-- 거래처 입고/반출등록 - 입고/반출정보 진행상태 변경시 발주 DT 내역의 입고관련 정보 갱신(본사) -->
    <!--
        TABLE    : TB_PO_HQ_VENDR_ORDER_DTL
        PARAM    : vendrInstockVO
        COMMENTS : 거래처 입고/반출정보 진행상태 변경시 발주 DT 내역의 입고관련 정보를 갱신한다.
    -->
    <update id="updateHqVendrInstockToOrderDtl" parameterType="vendrInstockVO">
        /* USE : VendrInstockMapper.updateHqVendrInstockToOrderDtl */
        UPDATE  TB_PO_HQ_VENDR_ORDER_DTL tphvod
        SET     (   IN_UNIT_QTY, IN_ETC_QTY, IN_TOT_QTY
                ,   IN_AMT , IN_VAT , IN_TOT
                ,   IN_FIRST_DATE, IN_LAST_DATE )
            =   (   SELECT  NVL(FLOOR(SUM(tphvid.IN_TOT_QTY)/tphvod.PO_UNIT_QTY),0)
                ,       NVL(MOD  (SUM(tphvid.IN_TOT_QTY),tphvod.PO_UNIT_QTY),0)
                ,       NVL(SUM(tphvid.IN_TOT_QTY),0)
                ,       NVL(SUM(tphvid.IN_AMT),0)
                ,       NVL(SUM(tphvid.IN_VAT),0)
                ,       NVL(SUM(tphvid.IN_TOT),0)
                ,       MIN(tphvi.INSTOCK_DATE)
                ,       MAX(tphvi.INSTOCK_DATE)
                FROM    TB_PO_HQ_VENDR_INSTOCK tphvi
                ,       TB_PO_HQ_VENDR_INSTOCK_DTL tphvid
                WHERE   tphvi.HQ_OFFICE_CD  =   #{hqOfficeCd}
                AND     tphvi.ORDER_SLIP_NO =   #{orderSlipNo}
                AND     tphvi.PROC_FG       =   '1'
                AND     tphvid.HQ_OFFICE_CD =   tphvi.HQ_OFFICE_CD
                AND     tphvid.SLIP_NO      =   tphvi.SLIP_NO
                AND     tphvid.PROD_CD      =   tphvod.PROD_CD
                GROUP
                BY      tphvod.PO_UNIT_QTY
            )
        ,       MOD_DT  =   #{modDt}
        ,       MOD_ID  =   #{modId}
        WHERE    HQ_OFFICE_CD =   #{hqOfficeCd}
        AND      SLIP_NO      =   #{orderSlipNo}
        AND      PROD_CD      IN  ( SELECT  tphvid.PROD_CD
                                    FROM    TB_PO_HQ_VENDR_INSTOCK tphvi
                                    ,       TB_PO_HQ_VENDR_INSTOCK_DTL tphvid
                                    WHERE   tphvi.HQ_OFFICE_CD  =   #{hqOfficeCd}
                                    AND     tphvi.ORDER_SLIP_NO =   #{orderSlipNo}
                                    AND     tphvi.PROC_FG       =   '1'
                                    AND     tphvid.HQ_OFFICE_CD =   tphvi.HQ_OFFICE_CD
                                    AND     tphvid.SLIP_NO      =   tphvi.SLIP_NO
                                    GROUP
                                    BY      tphvid.PROD_CD
                                 )
    </update>


    <!-- 거래처 입고/반출등록 - 입고/반출정보 진행상태 변경시 입고DT에 있으면서 발주 DT 내역에 없는 내역은 신규로 생성(본사) -->
    <!--
        TABLE    : TB_PO_HQ_VENDR_ORDER_DTL
        PARAM    : vendrInstockVO
        COMMENTS : 거래처 입고/반출정보 진행상태 변경시 입고DT에 있으면서 발주 DT 내역에 없는 내역은 신규로 생성한다.
    -->
    <insert id="insertHqVendrInstockToOrderDtl" parameterType="vendrInstockVO">
        /* USE : VendrInstockMapper.insertHqVendrInstockToOrderDtl */
        INSERT INTO TB_PO_HQ_VENDR_ORDER_DTL
        (        HQ_OFFICE_CD           ,   SLIP_NO                 ,   PROD_CD         ,   SLIP_FG
        ,        COST_UPRC
        ,        PO_UNIT_FG             ,   PO_UNIT_QTY
        ,        ORDER_UNIT_QTY         ,   ORDER_ETC_QTY           ,   ORDER_TOT_QTY
        ,        ORDER_AMT              ,   ORDER_VAT               ,   ORDER_TOT
        ,        IN_UNIT_QTY            ,   IN_ETC_QTY              ,   IN_TOT_QTY
        ,        IN_AMT                 ,   IN_VAT                  ,   IN_TOT
        ,        IN_FIRST_DATE          ,   IN_LAST_DATE
        ,        REG_DT                 ,   REG_ID
        ,        MOD_DT                 ,   MOD_ID
        )
        SELECT   tphvid.HQ_OFFICE_CD    ,   #{orderSlipNo}          ,   tphvid.PROD_CD       ,   tphvid.SLIP_FG
        ,        SUM(tphvid.COST_UPRC)
        ,        SUM(tphvid.PO_UNIT_FG) ,   SUM(tphvid.PO_UNIT_QTY)
        ,        0                      ,   0                       ,   0
        ,        0                      ,   0                       ,   0
        ,        SUM(tphvid.IN_UNIT_QTY),   SUM(tphvid.IN_ETC_QTY)  ,   SUM(tphvid.IN_TOT_QTY)
        ,        SUM(tphvid.IN_AMT)     ,   SUM(tphvid.IN_VAT)      ,   SUM(tphvid.IN_TOT)
        ,        MIN(tphvi.INSTOCK_DATE),   MAX(tphvi.INSTOCK_DATE)
        ,        #{regDt}       ,   #{regId}
        ,        #{modDt}       ,   #{modId}
        FROM     TB_PO_HQ_VENDR_INSTOCK_DTL tphvid
        ,        TB_PO_HQ_VENDR_INSTOCK tphvi
        WHERE    tphvid.HQ_OFFICE_CD  =   #{hqOfficeCd}
        AND      tphvid.SLIP_NO       =   #{slipNo}
        AND      tphvid.PROD_CD       IN  ( SELECT  PROD_CD
                                            FROM    TB_PO_HQ_VENDR_INSTOCK_DTL
                                            WHERE   HQ_OFFICE_CD  =   #{hqOfficeCd}
                                            AND     SLIP_NO       =   #{slipNo}
                                            MINUS
                                            SELECT  PROD_CD
                                            FROM    TB_PO_HQ_VENDR_ORDER_DTL
                                            WHERE   HQ_OFFICE_CD  =   #{hqOfficeCd}
                                            AND     SLIP_NO       =   #{orderSlipNo}
                                          )
        AND      tphvi.HQ_OFFICE_CD =   tphvid.HQ_OFFICE_CD
        AND      tphvi.SLIP_NO      =   tphvid.SLIP_NO
        GROUP
        BY       tphvid.HQ_OFFICE_CD    ,   #{orderSlipNo}          ,   tphvid.PROD_CD       ,   tphvid.SLIP_FG
    </insert>


    <!-- 거래처 입고/반출등록 - 입고/반출정보 진행상태 변경시 발주 DT 내역의 집계정보 HD에 수정(본사) -->
    <!--
        TABLE    : TB_PO_HQ_VENDR_ORDER_DTL
        PARAM    : vendrInstockVO
        COMMENTS : 거래처 입고/반출정보 진행상태 변경시 발주 DT 내역의 집계정보 HD에 수정한다.
    -->
    <update id="updateHqVendrOrderDtlSumHd" parameterType="vendrInstockVO">
        /* USE : VendrOrderMapper.updateHqVendrOrderDtlSumHd */
        UPDATE  TB_PO_HQ_VENDR_ORDER
        SET     ( DTL_CNT
                , ORDER_QTY, ORDER_AMT, ORDER_VAT, ORDER_TOT
                , IN_TOT_QTY, IN_AMT, IN_VAT, IN_TOT
                )
            =   ( SELECT  COUNT(tphvod.PROD_CD)
                ,         NVL(SUM(tphvod.ORDER_TOT_QTY),0), NVL(SUM(tphvod.ORDER_AMT),0), NVL(SUM(tphvod.ORDER_VAT),0), NVL(SUM(tphvod.ORDER_TOT),0)
                ,         NVL(SUM(tphvod.IN_TOT_QTY),0), NVL(SUM(tphvod.IN_AMT),0), NVL(SUM(tphvod.IN_VAT),0), NVL(SUM(tphvod.IN_TOT),0)
                FROM    TB_PO_HQ_VENDR_ORDER_DTL tphvod
                WHERE   tphvod.HQ_OFFICE_CD  = #{hqOfficeCd}
                AND     tphvod.SLIP_NO       = #{orderSlipNo}
                )
        ,       MOD_DT = #{modDt}
        ,       MOD_ID = #{modId}
        WHERE   HQ_OFFICE_CD  = #{hqOfficeCd}
        AND     SLIP_NO       = #{orderSlipNo}
    </update>


    <!-- 거래처 발주등록 - 입고/반출정보 진행상태 변경시 발주 테이블의 진행구분 수정(본사) -->
    <!--
        TABLE    : TB_PO_HQ_VENDR_ORDER
        PARAM    : vendrOrderVO
        COMMENTS : 거래처 입고/반출정보 진행상태 변경시 발주 테이블의 진행구분 수정한다.
    -->
    <update id="updateHqVendrOrderProcFg" parameterType="vendrInstockVO">
        /* USE : VendrOrderMapper.updateHqVendrOrderProcFg */
        UPDATE  TB_PO_HQ_VENDR_ORDER
        SET     PROC_FG   = #{procFg}
        <if test='procFg == "0" or procFg == "1" or procFg == "2"'>
            ,       CONFM_DT = #{modDt}
            ,       CONFM_ID = #{modId}
        </if>
        <if test='procFg == "3"'>
            ,       VENDR_CHK_DT = #{modDt}
            ,       VENDR_CHK_ID = #{modId}
        </if>
        <if test='procFg == "5"'>
            ,       END_DT = #{modDt}
            ,       END_ID = #{modId}
        </if>
        ,       MOD_DT = #{modDt}
        ,       MOD_ID = #{modId}
        WHERE   HQ_OFFICE_CD  = #{hqOfficeCd}
        AND     SLIP_NO       = #{orderSlipNo}
    </update>


    <!-- 거래처 입고/반출등록 - 입고/반출정보 진행상태 변경(본사) -->
    <!--
        TABLE    : TB_PO_HQ_VENDR_INSTOCK
        PARAM    : vendrInstockVO
        COMMENTS : 거래처 입고/반출정보 진행상태를 변경한다.
    -->
    <update id="updateHqProcFg" parameterType="vendrInstockVO">
        /* USE : VendrInstockMapper.updateHqProcFg */
        UPDATE  TB_PO_HQ_VENDR_INSTOCK
        SET     PROC_FG   = #{procFg}
        <if test='procFg == "0"'>
            ,       CONFM_DT = NULL
            ,       CONFM_ID = NULL
        </if>
        <if test='procFg == "1"'>
            ,       CONFM_DT = #{modDt}
            ,       CONFM_ID = #{modId}
        </if>
        ,       MOD_DT = #{modDt}
        ,       MOD_ID = #{modId}
        WHERE   HQ_OFFICE_CD  = #{hqOfficeCd}
        AND     SLIP_NO       = #{slipNo}
    </update>


    <!-- 거래처 입고/반출등록 - 입고/반출정보 DTL 등록(본사) -->
    <!--
        TABLE    : TB_PO_HQ_VENDR_INSTOCK_DTL
        PARAM    : vendrInstockVO
        COMMENTS : 거래처 입고/반출정보 DTL을 등록한다.
    -->
    <insert id="insertHqVendrInstockDtl" parameterType="vendrInstockVO">
        /* USE : VendrInstockMapper.insertHqVendrInstockDtl */
        INSERT INTO TB_PO_HQ_VENDR_INSTOCK_DTL (
            HQ_OFFICE_CD,
            SLIP_NO,
            STORAGE_CD,
            HQ_BRAND_CD,
            PROD_CD,
            SLIP_FG,
            COST_UPRC,
            PO_UNIT_FG,
            PO_UNIT_QTY,
            IN_UNIT_QTY,
            IN_ETC_QTY,
            IN_TOT_QTY,
            IN_AMT,
            IN_VAT,
            IN_TOT,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID
        )
        VALUES
        (
            #{hqOfficeCd},
            #{slipNo},
            #{storageCd},
            #{hqBrandCd},
            #{prodCd},
            #{slipFg},
            #{costUprc},
            #{poUnitFg},
            #{poUnitQty},
            #{inUnitQty},
            #{inEtcQty},
            #{inTotQty},
            #{inAmt},
            #{inVat},
            #{inTot},
            #{regDt},
            #{regId},
            #{modDt},
            #{modId}
        )
    </insert>


    <!-- 거래처 입고/반출등록 - 입고/반출정보 DTL 수정(본사) -->
    <!--
        TABLE    : TB_PO_HQ_VENDR_INSTOCK_DTL
        PARAM    : vendrInstockVO
        COMMENTS : 거래처 입고/반출정보 DTL을 수정한다.
    -->
    <update id="updateHqVendrInstockDtl" parameterType="vendrInstockVO">
        /* USE : VendrInstockMapper.updateHqVendrInstockDtl */
        UPDATE  TB_PO_HQ_VENDR_INSTOCK_DTL
        SET     COST_UPRC   = #{costUprc}
        ,       IN_UNIT_QTY = #{inUnitQty}
        ,       IN_ETC_QTY  = #{inEtcQty}
        ,       IN_TOT_QTY  = #{inTotQty}
        ,       IN_AMT      = #{inAmt}
        ,       IN_VAT      = #{inVat}
        ,       IN_TOT      = #{inTot}
        ,       MOD_DT      = #{modDt}
        ,       MOD_ID      = #{modId}
        WHERE   HQ_OFFICE_CD  = #{hqOfficeCd}
        AND     SLIP_NO       = #{slipNo}
        AND     PROD_CD       = #{prodCd}
    </update>


    <!-- 거래처 입고/반출등록 - 입고/반출정보 DTL 삭제(본사) -->
    <!--
        TABLE    : TB_PO_HQ_VENDR_INSTOCK_DTL
        PARAM    : vendrInstockVO
        COMMENTS : 거래처 입고/반출정보 DTL을 삭제한다.
    -->
    <delete id="deleteHqVendrInstockDtl" parameterType="vendrInstockVO">
        /* USE : VendrInstockMapper.deleteHqVendrInstockDtl */
        DELETE  TB_PO_HQ_VENDR_INSTOCK_DTL
        WHERE   HQ_OFFICE_CD  = #{hqOfficeCd}
        AND     SLIP_NO       = #{slipNo}
        AND     PROD_CD       = #{prodCd}
    </delete>
</mapper>
