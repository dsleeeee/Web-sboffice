<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    Board.xml
    일반게시판
    ======================================================
    No  ||  수정자 ||  수정일자    ||  수정내역
    ======================================================
    1       김설아     2020.02.11     최초작성
-->
<mapper namespace="kr.co.solbipos.adi.board.board.service.impl.BoardMapper">

    <!-- Clob -->
    <resultMap id="BoardListMap" type="DefaultMap">
        <result column="CONTENT" property="content" javaType="java.lang.String"/>
    </resultMap>

    <!-- 일반게시판 조회 -->
    <!--
        TABLE    : TB_WB_BOARD_INFO, TB_WB_USER_INFO, TB_WB_AUTHOR_GRP_INFO,
                   TB_HQ_EMPLOYEE, TB_HQ_OFFICE,
                   TB_MS_EMPLOYEE, TB_MS_STORE,
                   TB_CM_EMPLOYEE, TB_CM_AGENCY
        COMMENTS : 게시판 정보, 웹 사용자 정보, 권한 그룹 정보,
                   [본사]사원 정보, [본사]본사 정보,
                   [매장]사원 정보, [매장]매장 정보,
                   [공통]시스템/대리점 사원 정보, [공통]대리점 정보
    -->
    <select id="getBoardList"  parameterType="BoardVO" resultType="DefaultMap">
        /* BoardMapper.getBoardList */
        <include refid="CmmSQL.PagingTemplateHeader"/>
        SELECT
        twbi.BOARD_CD,
        twbi.BOARD_SEQ_NO,
        twbi.TITLE || ' [' || twbi.ANSWER_CNT || ']' AS TITLE,
        twbi.VIEW_CNT,
        twbi.TARGET_FG,
        twbi.APPR_FG,
        (CASE  WHEN twagi.AUTH_GRP_NM = 'HQ' THEN (SELECT HQ_OFFICE_NM FROM TB_HQ_OFFICE WHERE HQ_OFFICE_CD = UPPER(twbi.USER_ID)) --본사
               WHEN twagi.AUTH_GRP_NM = 'STORE' THEN (SELECT STORE_NM FROM TB_MS_STORE WHERE STORE_CD = UPPER(twbi.USER_ID))  --매장
               WHEN twagi.AUTH_GRP_NM in ('SYSTEM','AGENCY') THEN (SELECT AGENCY_NM FROM TB_CM_AGENCY WHERE AGENCY_CD =(SELECT AGENCY_CD FROM TB_CM_EMPLOYEE WHERE USER_ID = twbi.USER_ID)) --관리자,총판
              ELSE null END
        ) AS AGENCY_NM,
        twbi.USER_ID,
        twbi.USER_NM,
        twbi.MOD_DT
        <include refid="CmmSQL.PagingTemplateCount"/>
        FROM TB_WB_BOARD_INFO twbi,
        TB_WB_USER_INFO twui,
        TB_WB_AUTHOR_GRP_INFO twagi
        WHERE 1=1
        AND twbi.BOARD_CD = #{boardCd}
        AND twbi.USE_YN = 'Y'
        <choose>
            <when test='gubunCombo != null'>
                <!-- 제목 -->
                <if test='gubunCombo == "1"'>
                    <![CDATA[
                        AND twbi.TITLE LIKE '%'||#{gubunName}||'%'
                    ]]>
                </if>
                <!-- 내용 -->
                <if test='gubunCombo == "2"'>
                    <![CDATA[
                        AND twbi.CONTENT LIKE '%'||#{gubunName}||'%'
                    ]]>
                </if>
                <!-- 제목 + 내용 -->
                <if test='gubunCombo == "3"'>
                    <![CDATA[
                        AND twbi.TITLE LIKE '%'||#{gubunName}||'%'
                        AND twbi.CONTENT LIKE '%'||#{gubunName}||'%'
                    ]]>
                </if>
                <!-- 작성자 -->
                <if test='gubunCombo == "4"'>
                    <![CDATA[
                        AND tce.EMP_NM LIKE '%'||#{gubunName}||'%'
                    ]]>
                </if>
            </when>
        </choose>
        <choose>
            <when test='orgnFg != null and orgnFg != ""'>
                <!-- 매장 -->
                <if test='orgnFg == "S"'>
                    <![CDATA[
                        AND twbi.APPR_FG = '2'
                    ]]>
                </if>
            </when>
        </choose>
        AND twui.USER_ID (+)= twbi.USER_ID
        AND twagi.AUTH_GRP_CD (+)= twui.AUTH_GRP_CD
        ORDER BY twbi.BOARD_CD, twbi.BOARD_SEQ_NO
        <include refid="CmmSQL.PagingTemplateBottom"/>
    </select>

    <!-- 게시판 상세 팝업 - 조회 -->
    <!--
        TABLE    : TB_WB_BOARD_INFO, TB_WB_BOARD_MASTER, TB_WB_BOARD_PART_STORE, TB_MS_STORE
        COMMENTS : 게시판 정보, 게시판 마스터, 게시판 일부 매장, [매장]매장 정보
    -->
    <select id="getBoardDetailList" parameterType="BoardVO" resultMap="BoardListMap">
        /* BoardMapper.getBoardDetailList */
        SELECT
        twbi.TITLE,
        twbi.USER_NM,
        twbi.APPR_FG,
        twbi.TARGET_FG,
        twbps.PART_ORGN_CD,
        twbps.PART_ORGN_NM,
        twbi.NOTICE_YN,
        --sms전송
        twbi.START_DATE,
        twbi.END_DATE,
        twbi.CONTENT,
        TO_CHAR(TO_DATE(twbi.REG_DT, 'YYYY-MM-DD HH24:MI:SS'), 'YYYY-MM-DD HH24:MI:SS') AS REG_DT,
        twbm.ANSWER_FG
        FROM TB_WB_BOARD_INFO twbi,
        TB_WB_BOARD_MASTER twbm,
        (
          SELECT
          twbps.BOARD_CD,
          twbps.BOARD_SEQ_NO,
          LISTAGG(twbps.PART_ORGN_CD, ',') WITHIN GROUP (ORDER BY twbps.PART_ORGN_CD) AS PART_ORGN_CD,
          LISTAGG(tms.STORE_NM, ',') WITHIN GROUP (ORDER BY tms.STORE_NM) AS PART_ORGN_NM
          FROM TB_WB_BOARD_PART_STORE twbps,
          TB_MS_STORE tms
          WHERE 1=1
          AND tms.STORE_CD (+)= twbps.PART_ORGN_CD
          GROUP BY twbps.BOARD_CD, twbps.BOARD_SEQ_NO
        ) twbps
        WHERE 1=1
        AND twbi.BOARD_CD = #{boardCd}
        AND twbi.BOARD_SEQ_NO = #{boardSeqNo}
        AND twbm.BOARD_CD (+)= twbi.BOARD_CD
        AND twbps.BOARD_CD (+)= twbi.BOARD_CD
        AND twbps.BOARD_SEQ_NO (+)= twbi.BOARD_SEQ_NO
    </select>

    <!-- 게시판 조회수 조회 -->
    <!--
        TABLE    : TB_WB_BOARD_READNG_HIST
        COMMENTS : 게시판 열람 이력
    -->
    <select id="getBoardViewCnt"  parameterType="BoardVO" resultType="String">
        /* BoardMapper.getBoardViewCnt */
        SELECT
        COUNT(twbrh.IDX) AS VIEW_CNT
        FROM TB_WB_BOARD_READNG_HIST twbrh
        WHERE 1=1
        AND twbrh.BOARD_CD = #{boardCd}
        AND twbrh.BOARD_SEQ_NO = #{boardSeqNo}
    </select>

    <!-- 게시판 조회수 update -->
    <!--
        TABLE    : TB_WB_BOARD_INFO
        COMMENTS : 게시판 정보
    -->
    <update id="getBoardViewCntUpdate" parameterType="BoardVO">
        /* BoardMapper.getBoardViewCntUpdate */
        UPDATE
        TB_WB_BOARD_INFO
        SET
        VIEW_CNT = #{viewCnt}
        WHERE 1=1
        AND BOARD_CD = #{boardCd}
        AND BOARD_SEQ_NO = #{boardSeqNo}
    </update>

    <!-- 게시판 열람 이력 인덱스 조회(자동채번) -->
    <!--
        TABLE    : TB_WB_BOARD_READNG_HIST
        COMMENTS : 게시판 열람 이력
    -->
    <select id="getBoardReadingHistIdx"  parameterType="BoardVO" resultType="String">
        /* BoardMapper.getBoardReadingHistIdx */
        SELECT
        (NVL(MAX(twbrh.IDX), 0) + 1) AS IDX
        FROM TB_WB_BOARD_READNG_HIST twbrh
        WHERE 1=1
        AND twbrh.BOARD_CD = #{boardCd}
        AND twbrh.BOARD_SEQ_NO = #{boardSeqNo}
    </select>

    <!-- 게시판 열람 이력 insert -->
    <!--
        TABLE    : TB_WB_BOARD_READNG_HIST
        COMMENTS : 게시판 열람 이력
    -->
    <insert id="getBoardReadingHistInsert" parameterType="BoardVO">
        /* BoardMapper.getBoardReadingHistInsert */
        INSERT INTO TB_WB_BOARD_READNG_HIST
        (
            BOARD_CD,
            BOARD_SEQ_NO,
            USER_ID,
            READNG_DT,
            REG_DT,
            REG_ID,
            IDX
        ) VALUES (
            #{boardCd},
            #{boardSeqNo},
            #{regId},
            #{regDt},
            #{regDt},
            #{regId},
            #{idx}
        )
    </insert>

    <!-- 게시판 게시일련번호 조회(자동채번) -->
    <!--
        TABLE    : TB_WB_BOARD_INFO
        COMMENTS : 게시판 정보
    -->
    <select id="getBoardBoardSeqNo"  parameterType="BoardVO" resultType="String">
        /* BoardMapper.getBoardBoardSeqNo */
        SELECT
        (NVL(MAX(twbi.BOARD_SEQ_NO), 0) + 1) AS BOARD_SEQ_NO
        FROM TB_WB_BOARD_INFO twbi
        WHERE 1=1
        AND twbi.BOARD_CD = #{boardCd}
    </select>

    <!-- 게시판 신규등록,수정 팝업 - 저장 isert -->
    <!--
        TABLE    : TB_WB_BOARD_INFO
        COMMENTS : 게시판 정보
    -->
    <insert id="getBoardInfoSaveInsert" parameterType="BoardVO">
        /* BoardMapper.getBoardInfoSaveInsert */
        INSERT INTO TB_WB_BOARD_INFO
        (
            BOARD_CD,
            START_DATE,
            END_DATE,
            TITLE,
            NOTICE_YN,
            APPR_FG,
            TARGET_FG,
            VIEW_CNT,
            ANSWER_CNT,
            CONTENT,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID,
            BOARD_SEQ_NO,
            USE_YN,
            USER_ID,
            USER_NM
        ) VALUES (
            #{boardCd},
            #{startDate},
            #{endDate},
            #{title},
            #{noticeYn},
            #{apprFg},
            #{targetFg},
            0,
            0,
            #{content},
            #{regDt},
            #{regId},
            #{modDt},
            #{modId},
            #{boardSeqNo},
            'Y',
            #{regId},
            #{userNm}
        )
    </insert>

    <!-- 게시판 신규등록,수정 팝업 -  저장 update -->
    <!--
        TABLE    : TB_WB_BOARD_INFO
        COMMENTS : 게시판 정보
    -->
    <update id="getBoardInfoSaveUpdate" parameterType="BoardVO">
        /* BoardMapper.getBoardInfoSaveUpdate */
        UPDATE
        TB_WB_BOARD_INFO
        SET
        START_DATE = #{startDate},
        END_DATE = #{endDate},
        TITLE = #{title},
        NOTICE_YN = #{noticeYn},
        APPR_FG = #{apprFg},
        TARGET_FG = #{targetFg},
        CONTENT = #{content},
        USER_NM = #{userNm},
        MOD_DT = #{modDt},
        MOD_ID = #{modId}
        WHERE 1=1
        AND BOARD_CD = #{boardCd}
        AND BOARD_SEQ_NO = #{boardSeqNo}
    </update>

    <!-- 게시판 신규등록,수정 팝업 -  저장 delete -->
    <!--
        TABLE    : TB_WB_BOARD_INFO
        COMMENTS : 게시판 정보
    -->
    <update id="getBoardInfoSaveDelete" parameterType="BoardVO">
        /* BoardMapper.getBoardInfoSaveDelete */
        UPDATE
        TB_WB_BOARD_INFO
        SET
        USE_YN = 'N',
        MOD_DT = #{modDt},
        MOD_ID = #{modId}
        WHERE 1=1
        AND BOARD_CD = #{boardCd}
        AND BOARD_SEQ_NO = #{boardSeqNo}
    </update>

    <!-- 게시판 전체 댓글 delete -->
    <!--
        TABLE    : TB_WB_BOARD_ANSWER
        COMMENTS : 게시판 댓글
    -->
    <update id="getBoardDetailAnswerSaveTotDelete" parameterType="BoardVO">
        /* BoardMapper.getBoardDetailAnswerSaveTotDelete */
        UPDATE
        TB_WB_BOARD_ANSWER
        SET
        USE_YN = 'N',
        MOD_DT = #{modDt},
        MOD_ID = #{modId}
        WHERE 1=1
        AND BOARD_CD = #{boardCd}
        AND BOARD_SEQ_NO = #{boardSeqNo}
    </update>

    <!-- 게시판 공개대상 insert -->
    <!--
        TABLE    : TB_WB_BOARD_PART_STORE
        COMMENTS : 게시판 일부 매장
    -->
    <insert id="getBoardPartStoreSaveInsert" parameterType="BoardVO">
        /* BoardMapper.getBoardPartStoreSaveInsert */
        INSERT INTO TB_WB_BOARD_PART_STORE
        (
            BOARD_CD,
            BOARD_SEQ_NO,
            PART_ORGN_CD,
            USE_YN,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID
        ) VALUES (
            #{boardCd},
            #{boardSeqNo},
            #{storeCd},
            'Y',
            #{regDt},
            #{regId},
            #{modDt},
            #{modId}
        )
    </insert>

    <!-- 게시판 공개대상에 선택한 매장이있는지 select -->
    <!--
      TABLE    : TB_WB_BOARD_PART_STORE
        COMMENTS : 게시판 일부 매장
    -->
    <select id="getBoardParStorePartOrgnCd"  parameterType="BoardVO" resultType="String">
        /* BoardMapper.getBoardParStorePartOrgnCd */
        SELECT
        COUNT(twbps.PART_ORGN_CD)
        FROM TB_WB_BOARD_PART_STORE twbps
        WHERE 1=1
        AND twbps.BOARD_CD = #{boardCd}
        AND twbps.BOARD_SEQ_NO = #{boardSeqNo}
        AND twbps.PART_ORGN_CD = #{storeCd}
    </select>

    <!-- 게시판 공개대상 update -->
    <!--
        TABLE    : TB_WB_BOARD_PART_STORE
        COMMENTS : 게시판 일부 매장
    -->
    <update id="getBoardPartStoreSaveUpdate" parameterType="BoardVO">
        /* BoardMapper.getBoardPartStoreSaveUpdate */
        UPDATE
        TB_WB_BOARD_PART_STORE
        SET
        USE_YN = 'Y',
        MOD_DT = #{modDt},
        MOD_ID = #{modId}
        WHERE 1=1
        AND BOARD_CD = #{boardCd}
        AND BOARD_SEQ_NO = #{boardSeqNo}
        AND PART_ORGN_CD = #{storeCd}
    </update>

    <!-- 게시판 공개대상 delete -->
    <!--
        TABLE    : TB_WB_BOARD_PART_STORE
        COMMENTS : 게시판 일부 매장
    -->
    <update id="getBoardPartStoreSaveDelete" parameterType="BoardVO">
        /* BoardMapper.getBoardPartStoreSaveDelete */
        UPDATE
        TB_WB_BOARD_PART_STORE
        SET
        USE_YN = 'N',
        MOD_DT = #{modDt},
        MOD_ID = #{modId}
        WHERE 1=1
        AND BOARD_CD = #{boardCd}
        AND BOARD_SEQ_NO = #{boardSeqNo}
    </update>








    <!-- 게시판 신규등록,수정 팝업 - 첨부파일 저장시 boardSeqNo 가져오기 -->
    <!--
        TABLE    : TB_WB_BOARD_INFO
        COMMENTS : 게시판 정보
    -->
    <select id="getBoardAtchBoardSeqNo"  parameterType="BoardVO" resultType="String">
        /* BoardMapper.getBoardAtchBoardSeqNo */
        SELECT
        MAX(twbi.BOARD_SEQ_NO) AS BOARD_SEQ_NO
        FROM TB_WB_BOARD_INFO twbi
        WHERE 1=1
        AND twbi.BOARD_CD = #{boardCd}
        AND twbi.TITLE = #{title}
        AND twbi.USER_NM = #{userNm}
        AND twbi.REG_ID = #{regId}
    </select>

    <!-- 첨부파일 저장시 IDX (자동채번) -->
    <!--
        TABLE    : TB_WB_BOARD_ATCH
        COMMENTS : 게시판 첨부
    -->
    <select id="getBoardAtchIdx"  parameterType="BoardVO" resultType="String">
        /* BoardMapper.getBoardAtchIdx */
        SELECT
        (NVL(MAX(twba.IDX), 0) + 1) AS IDX
        FROM TB_WB_BOARD_ATCH twba
        WHERE 1=1
        AND twba.BOARD_CD = #{boardCd}
        AND twba.BOARD_SEQ_NO = #{boardSeqNo}
    </select>

    <!-- 게시판 신규등록,수정 팝업 - 첨부파일 저장 isert -->
    <!--
        TABLE    : TB_WB_BOARD_ATCH
        COMMENTS : 게시판 첨부
    -->
    <insert id="getBoardInfoAtchSaveIsert" parameterType="BoardVO">
        /* BoardMapper.getBoardInfoAtchSaveIsert */
        INSERT INTO TB_WB_BOARD_ATCH
        (
            BOARD_CD,
            BOARD_SEQ_NO,
            IDX,
            FILE_PATH,
            FILE_NM,
            ORGINL_FILE_NM,
            USE_YN,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID
        ) VALUES (
            #{boardCd},
            #{boardSeqNo},
            #{idx},
            #{filePath},
            #{fileNm},
            #{orginlFileNm},
            'Y',
            #{regDt},
            #{regId},
            #{modDt},
            #{modId}
        )
    </insert>

    <!-- 게시판 댓글 조회 -->
    <!--
        TABLE    : TB_WB_BOARD_ANSWER
        COMMENTS : 게시판 댓글
    -->
    <select id="getBoardDetailAnswerList"  parameterType="BoardVO" resultType="DefaultMap">
        /* BoardMapper.getBoardDetailAnswerList */
        SELECT
        twba.IDX,
        (CASE WHEN twba.USER_ID = #{userId} THEN '수정' ELSE '' END) AS EDIT,
        (CASE WHEN twba.USER_ID = #{userId} THEN '저장' ELSE '' END) AS SAVE,
        (CASE WHEN twba.USER_ID = #{userId} THEN '삭제' ELSE '' END) AS DEL,
        twba.USER_NM,
        twba.CONTENT,
        twba.REG_DT
        FROM TB_WB_BOARD_ANSWER twba
        WHERE 1=1
        AND twba.BOARD_CD = #{boardCd}
        AND twba.BOARD_SEQ_NO = #{boardSeqNo}
        AND twba.USE_YN = 'Y'
        ORDER BY twba.REG_DT DESC
    </select>

    <!-- 게시판 댓글번호 조회(자동채번) -->
    <!--
        TABLE    : TB_WB_BOARD_ANSWER
        COMMENTS : 게시판 댓글
    -->
    <select id="getBoardAnswerIdx"  parameterType="BoardVO" resultType="String">
        /* BoardMapper.getBoardAnswerIdx */
        SELECT
        (NVL(MAX(twba.IDX), 0) + 1) AS IDX
        FROM TB_WB_BOARD_ANSWER twba
        WHERE 1=1
        AND twba.BOARD_CD = #{boardCd}
        AND twba.BOARD_SEQ_NO = #{boardSeqNo}
    </select>

    <!-- 아이디에 따른 작성자 조회 -->
    <!--
        TABLE    : TB_CM_EMPLOYEE
        COMMENTS : [공통]시스템/대리점 사원 정보
    -->
    <select id="getBoardUserNm"  parameterType="BoardVO" resultType="String">
        /* BoardMapper.getBoardUserNm */
        SELECT
        tce.EMP_NM
        FROM TB_CM_EMPLOYEE tce
        WHERE 1=1
        AND tce.USER_ID = #{userId}
    </select>

    <!-- 게시판 댓글 저장 isert -->
    <!--
        TABLE    : TB_WB_BOARD_ANSWER
        COMMENTS : 게시판 댓글
    -->
    <insert id="getBoardDetailAnswerSaveInsert" parameterType="BoardVO">
        /* BoardMapper.getBoardDetailAnswerSaveInsert */
        INSERT INTO TB_WB_BOARD_ANSWER
        (
            BOARD_CD,
            BOARD_SEQ_NO,
            IDX,
            CONTENT,
            USE_YN,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID,
            ORGN_CD,
            USER_ID,
            USER_NM
        ) VALUES (
            #{boardCd},
            #{boardSeqNo},
            #{idx},
            #{content},
            'Y',
            #{regDt},
            #{regId},
            #{modDt},
            #{modId},
            '',
            #{regId},
            #{userNm}
        )
    </insert>

    <!-- 게시판 댓글 저장 update -->
    <!--
        TABLE    : TB_WB_BOARD_ANSWER
        COMMENTS : 게시판 댓글
    -->
    <update id="getBoardDetailAnswerSaveUpdate" parameterType="BoardVO">
        /* BoardMapper.getBoardDetailAnswerSaveUpdate */
        UPDATE
        TB_WB_BOARD_ANSWER
        SET
        CONTENT = #{content},
        MOD_DT = #{modDt},
        MOD_ID = #{modId}
        WHERE 1=1
        AND BOARD_CD = #{boardCd}
        AND BOARD_SEQ_NO = #{boardSeqNo}
        AND IDX = #{idx}
    </update>

    <!-- 게시판 댓글 저장 delete -->
    <!--
        TABLE    : TB_WB_BOARD_ANSWER
        COMMENTS : 게시판 댓글
    -->
    <update id="getBoardDetailAnswerSaveDelete" parameterType="BoardVO">
        /* BoardMapper.getBoardDetailAnswerSaveDelete */
        UPDATE
        TB_WB_BOARD_ANSWER
        SET
        USE_YN = 'N',
        MOD_DT = #{modDt},
        MOD_ID = #{modId}
        WHERE 1=1
        AND BOARD_CD = #{boardCd}
        AND BOARD_SEQ_NO = #{boardSeqNo}
        AND IDX = #{idx}
    </update>

    <!-- 게시판 댓글수 조회 -->
    <!--
        TABLE    : TB_WB_BOARD_ANSWER
        COMMENTS : 게시판 댓글
    -->
    <select id="getBoardAnswerCnt"  parameterType="BoardVO" resultType="String">
        /* BoardMapper.getBoardAnswerCnt */
        SELECT
        COUNT(twba.IDX) AS ANSWER_CNT
        FROM TB_WB_BOARD_ANSWER twba
        WHERE 1=1
        AND twba.BOARD_CD = #{boardCd}
        AND twba.BOARD_SEQ_NO = #{boardSeqNo}
        AND twba.USE_YN = 'Y'
    </select>

    <!-- 게시판 댓글수 update -->
    <!--
        TABLE    : TB_WB_BOARD_INFO
        COMMENTS : 게시판 정보
    -->
    <update id="getBoardAnswerCntUpdate" parameterType="BoardVO">
        /* BoardMapper.getBoardAnswerCntUpdate */
        UPDATE
        TB_WB_BOARD_INFO
        SET
        ANSWER_CNT = #{answerCnt}
        WHERE 1=1
        AND BOARD_CD = #{boardCd}
        AND BOARD_SEQ_NO = #{boardSeqNo}
    </update>

    <!-- 게시판 첨부파일 조회 -->
    <!--
        TABLE    : TB_WB_BOARD_ATCH
        COMMENTS : 게시판 첨부
    -->
    <select id="getBoardInfoAtchList"  parameterType="BoardVO" resultType="DefaultMap">
        /* BoardMapper.getBoardInfoAtchList */
        SELECT
--         SUBSTR(SUBSTR(twba.ORGINL_FILE_NM, INSTR(twba.ORGINL_FILE_NM, '\', -1, 1)), 2) AS ORGINL_FILE_NM,
        twba.ORGINL_FILE_NM,
        '삭제' AS DEL,
        twba.IDX
        FROM TB_WB_BOARD_ATCH twba
        WHERE 1=1
        AND twba.BOARD_CD = #{boardCd}
        AND twba.BOARD_SEQ_NO = #{boardSeqNo}
        AND twba.USE_YN = 'Y'
        ORDER BY twba.BOARD_CD, twba.BOARD_SEQ_NO, twba.IDX
    </select>

    <!-- 게시판 첨부파일 조회 -->
    <!--
        TABLE    : TB_WB_BOARD_ATCH
        COMMENTS : 게시판 첨부
    -->
    <select id="getBoardDetailAtchList"  parameterType="BoardVO" resultType="BoardVO">
        /* BoardMapper.getBoardDetailAtchList */
        SELECT
        twba.ORGINL_FILE_NM,
        SUBSTR(twba.FILE_PATH, INSTR(twba.FILE_PATH, '\', 1, 1)) || twba.FILE_NM AS FILE_PATH
        FROM TB_WB_BOARD_ATCH twba
        WHERE 1=1
        AND twba.BOARD_CD = #{boardCd}
        AND twba.BOARD_SEQ_NO = #{boardSeqNo}
        AND twba.USE_YN = 'Y'
        ORDER BY twba.BOARD_CD, twba.BOARD_SEQ_NO, twba.IDX
    </select>

    <!-- 게시판 첨부파일 삭제 -->
    <!--
        TABLE    : TB_WB_BOARD_ATCH
        COMMENTS : 게시판 첨부
    -->
    <update id="getBoardInfoAtchDel" parameterType="BoardVO">
        /* BoardMapper.getBoardInfoAtchDel */
        UPDATE
        TB_WB_BOARD_ATCH
        SET
        USE_YN = 'N',
        MOD_DT = #{modDt},
        MOD_ID = #{modId}
        WHERE 1=1
        AND BOARD_CD = #{boardCd}
        AND BOARD_SEQ_NO = #{boardSeqNo}
        AND IDX = #{idx}
    </update>

    <!-- 열람자목록 팝업 - 검색 -->
    <!--
        TABLE    : TB_WB_BOARD_READNG_HIST, TB_WB_USER_INFO, TB_WB_AUTHOR_GRP_INFO,
                   TB_HQ_EMPLOYEE, TB_HQ_OFFICE,
                   TB_MS_EMPLOYEE, TB_MS_STORE,
                   TB_CM_EMPLOYEE, TB_CM_AGENCY
        COMMENTS : 게시판 열람 이력, 웹 사용자 정보, 권한 그룹 정보,
                   [본사]사원 정보, [본사]본사 정보,
                   [매장]사원 정보, [매장]매장 정보,
                   [공통]시스템/대리점 사원 정보, [공통]대리점 정보
    -->
    <select id="getBoardReadingHistList"  parameterType="BoardVO" resultType="DefaultMap">
        /* BoardMapper.getBoardReadingHistList */
        SELECT
        twbrh.BOARD_CD,
        twbrh.BOARD_SEQ_NO,
        tce.HQ_OFFICE_NM,
        tce.STORE_NM,
        (CASE WHEN twagi.AUTH_GRP_NM = 'SYSTEM' THEN 'M'
              WHEN twagi.AUTH_GRP_NM = 'AGENCY' THEN 'A'
              WHEN twagi.AUTH_GRP_NM = 'HQ' THEN 'H'
              WHEN twagi.AUTH_GRP_NM = 'STORE' THEN 'S'
              ELSE null END
        ) AS AUTH_GRP_NM,
        --부서구분
        tce.USER_NM,
        MAX(twbrh.READNG_DT) AS READNG_DT
        FROM TB_WB_BOARD_READNG_HIST twbrh,
        (
            (
                --본사
                SELECT
                A.USER_ID,
                'H' AS ORGN_FG,
                A.HQ_OFFICE_CD AS ORGN_CD,
                B.HQ_OFFICE_NM AS ORGN_NM,
                A.EMP_NM AS USER_NM,
                A.EMP_NO,
                '' AS STORE_CD,
                '' AS STORE_NM,
                A.HQ_OFFICE_CD,
                B.HQ_OFFICE_NM,
                A.HQ_OFFICE_CD AS ORGN_GRP_CD,
                B.HQ_OFFICE_NM AS ORGN_GRP_NM,
                '' AS P_AGENCY_CD
                FROM
                TB_HQ_EMPLOYEE A,
                TB_HQ_OFFICE B
                WHERE 1=1
                AND A.HQ_OFFICE_CD = B.HQ_OFFICE_CD
            )
            UNION ALL
            (
                --매장
                SELECT
                A.USER_ID,
                'S' AS ORGN_FG,
                A.STORE_CD AS ORGN_CD,
                B.STORE_NM AS ORGN_NM,
                A.EMP_NM AS USER_NM,
                A.EMP_NO,
                A.STORE_CD AS STORE_CD,
                B.STORE_NM AS STORE_NM,
                C.HQ_OFFICE_CD,
                C.HQ_OFFICE_NM,
                DECODE( C.HQ_OFFICE_CD, '00000', A.STORE_CD, C.HQ_OFFICE_CD ) AS ORGN_GRP_CD,
                DECODE( C.HQ_OFFICE_CD, '00000', B.STORE_NM, C.HQ_OFFICE_NM ) AS ORGN_GRP_NM,
                '' AS P_AGENCY_CD
                FROM
                TB_MS_EMPLOYEE A,
                TB_MS_STORE B,
                TB_HQ_OFFICE C
                WHERE 1=1
                AND A.STORE_CD = B.STORE_CD
                AND B.HQ_OFFICE_CD = C.HQ_OFFICE_CD
            )
            UNION ALL
            (
                --관리자,총판
                SELECT
                A.USER_ID,
                DECODE( A.ADMIN_FG, 'A', 'M', 'A' ) AS ORGN_FG,
                A.AGENCY_CD AS ORGN_CD,
                B.AGENCY_NM AS ORGN_NM,
                A.EMP_NM AS USER_NM,
                A.EMP_NO,
                '' AS STORE_CD,
                '' AS STORE_NM,
                '' AS HQ_OFFICE_CD,
                '' AS HQ_OFFICE_NM,
                A.AGENCY_CD AS ORGN_GRP_CD,
                B.AGENCY_NM AS ORGN_GRP_NM,
                B.P_AGENCY_CD AS P_AGENCY_CD
                FROM
                TB_CM_EMPLOYEE A,
                TB_CM_AGENCY B
                WHERE 1=1
                AND A.AGENCY_CD = B.AGENCY_CD
            )
        ) tce,
        TB_WB_USER_INFO twui,
        TB_WB_AUTHOR_GRP_INFO twagi
        WHERE 1=1
        AND twbrh.BOARD_CD = #{boardCd}
        AND twbrh.BOARD_SEQ_NO = #{boardSeqNo}
        AND tce.USER_NM LIKE '%'||#{userNm}||'%'
        <choose>
            <!-- 전체 체크박스 제외 -->
            <when test='authGrpNm != null and authGrpNm != "" and authGrpNm != "all"'>
                <!-- 본사 로그인시 전체 체크박스 -->
                <if test='authGrpNm == "allHQ"'>
                    <![CDATA[
                        AND twagi.AUTH_GRP_NM IN ('HQ','STORE')
                    ]]>
                </if>
                <!-- 나머지(시스템,대리점,본사,매장 만) -->
                <if test='authGrpNm != "allHQ"'>
                    <![CDATA[
                        AND twagi.AUTH_GRP_NM = #{authGrpNm}
                    ]]>
                </if>
            </when>
        </choose>
        <if test='membrOrgnCd != null and membrOrgnCd != ""'>
            <![CDATA[
                AND tce.HQ_OFFICE_CD = #{membrOrgnCd}
            ]]>
        </if>
        <if test='storeCd != null and storeCd != ""'>
            <![CDATA[
                AND tce.STORE_CD = #{storeCd}
            ]]>
        </if>
        AND tce.USER_ID (+)= twbrh.USER_ID
        AND twui.USER_ID (+)= twbrh.USER_ID
        AND twagi.AUTH_GRP_CD (+)= twui.AUTH_GRP_CD
        GROUP BY twbrh.BOARD_CD, twbrh.BOARD_SEQ_NO, tce.HQ_OFFICE_NM, tce.STORE_NM, twagi.AUTH_GRP_NM, tce.USER_NM
        ORDER BY twbrh.BOARD_CD, twbrh.BOARD_SEQ_NO, twagi.AUTH_GRP_NM
    </select>

</mapper>