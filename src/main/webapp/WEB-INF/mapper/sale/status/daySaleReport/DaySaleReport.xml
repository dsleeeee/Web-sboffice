<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    DaySaleReport.xml
    일별매출내역 다운로드(제너시스올떡 분식대장)
    ======================================================
    No  ||  수정자 ||  수정일자    ||  수정내역
    ======================================================
    1       김설아     2021.12.08     최초작성
-->
<mapper namespace="kr.co.solbipos.sale.status.daySaleReport.service.impl.DaySaleReportMapper">

    <!-- 일별매출내역 다운로드 - 조회 -->
    <!--
        TABLE    :
        COMMENTS :
    -->
    <select id="getDaySaleReportList"  parameterType="DaySaleReportVO" resultType="DefaultMap">
        /* DaySaleReportMapper.getDaySaleReportList */
        SELECT
        SUBSTR(tmsr.FROM_SALE_DATE, 0, 6) AS SALE_MONTH,
        tmsr.STORE_CD,
        tms.STORE_NM,
        '전체매장통합파일' AS PROC_GUBUN,
        tmsr.PROC_DT,
        (SELECT USER_NM FROM TB_WB_USER_INFO_DTL_V01 WHERE USER_ID = tmsr.REG_ID) AS USER_NM,
        tmsr.PROC_FG,
        tmsr.PROC_MSG,
        '다운로드' AS DOWNLOAD,
        tmsr.FROM_SALE_DATE,
        tmsr.TO_SALE_DATE,
        tmsr.FILE_NAME
        FROM TB_MS_SALE_REPORT tmsr,
        TB_MS_STORE tms
        WHERE 1=1
        AND tmsr.HQ_OFFICE_CD = #{hqOfficeCd}
        <![CDATA[
            AND tmsr.FROM_SALE_DATE >= #{startMonth}||'01'
            AND tmsr.TO_SALE_DATE <= #{endMonth}||'31'
        ]]>
        AND tmsr.REPORT_TYPE = '02'
        AND tms.HQ_OFFICE_CD = tmsr.HQ_OFFICE_CD
        AND tms.STORE_CD = tmsr.STORE_CD
        ORDER BY tmsr.FROM_SALE_DATE DESC, tmsr.STORE_CD
    </select>

    <!-- 일별매출내역 다운로드 - 자료생성 저장 insert -->
    <!--
        TABLE    :
        COMMENTS :
    -->
    <insert id="getDaySaleReportSaveInsert" parameterType="DaySaleReportVO">
        /* DaySaleReportMapper.getDaySaleReportSaveInsert */
        INSERT INTO TB_MS_SALE_REPORT
        (
            HQ_OFFICE_CD,
            STORE_CD,
            REQ_DATE,
            REQ_TIME,
            REPORT_TYPE,
            FROM_SALE_DATE,
            TO_SALE_DATE,
            PROC_FG,
            PROC_MSG,
            PROC_DT,
            FILE_NAME,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID
        ) VALUES (
            #{hqOfficeCd},
            #{storeCd},
            #{reqDate},
            #{reqTime},
            '02',
            #{dataCreateMonth}||'01',
            #{dataCreateMonth}||#{dataCreateMonthLastDate},
            '0',
            '',
            '',
            '',
            #{regDt},
            #{regId},
            #{modDt},
            #{modId}
        )
    </insert>

    <!-- 일별매출내역 다운로드 - 삭제 -->
    <!--
        TABLE    :
        COMMENTS :
    -->
    <delete id="getDaySaleReportDel" parameterType="DaySaleReportVO">
        /* DaySaleReportMapper.getDaySaleReportDel */
        DELETE TB_MS_SALE_REPORT
        WHERE 1=1
        AND HQ_OFFICE_CD = #{hqOfficeCd}
        AND STORE_CD = #{storeCd}
        AND FROM_SALE_DATE = #{fromSaleDate}
        AND TO_SALE_DATE = #{toSaleDate}
        AND REPORT_TYPE = '02'
    </delete>

    <!-- 일별매출내역 다운로드 - 자료생성 요청건 존재여부 확인 -->
    <!--
        TABLE    :
        COMMENTS :
    -->
    <select id="getDaySaleReportChk" parameterType="DaySaleReportVO" resultType="DefaultMap">
        /* DaySaleReportMapper.getDaySaleReportChk */
        SELECT
        COUNT(tmsr.REPORT_TYPE) AS CNT
        FROM TB_MS_SALE_REPORT tmsr
        WHERE 1=1
        AND tmsr.HQ_OFFICE_CD = #{hqOfficeCd}
        <if test='storeCds != null and storeCds != ""'>
            AND tmsr.STORE_CD IN
            <foreach collection="storeCdList" item="item" open="("  separator="," close=")" >
                #{item}
            </foreach>
        </if>
        AND tmsr.FROM_SALE_DATE = #{dataCreateMonth}||'01'
        AND tmsr.TO_SALE_DATE = #{dataCreateMonth}||#{dataCreateMonthLastDate}
        AND tmsr.REPORT_TYPE = '02'
    </select>

</mapper>