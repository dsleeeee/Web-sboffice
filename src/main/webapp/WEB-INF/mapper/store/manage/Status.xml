<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    Status.xml
    매장현황
    ======================================================
    No  ||  수정자 ||  수정일자    ||  수정내역
    ======================================================
    1       김설아     2019.08.13     최초작성
-->
<mapper namespace="kr.co.solbipos.store.manage.status.service.impl.StoreStatusMapper">

    <!-- 매장탭 - 매장정보조회-->
    <!--
        TABLE    : TB_MS_STORE, TB_HQ_OFFICE, TB_MS_STORE_ENVST
        COMMENTS : [매장]매장 정보 와 [본사]본사 정보, [매장]환경설정
    -->
    <select id="getStatusStoreList"  parameterType="StoreStatusVO" resultType="DefaultMap">
        /* StoreStatusMapper.getStatusStoreList */
        <include refid="CmmSQL.PagingTemplateHeader"/>
        SELECT
        tms.HQ_OFFICE_CD,
        tho.HQ_OFFICE_NM,
        tms.STORE_CD,
        tms.STORE_NM,
        (SUBSTR(tms.BIZ_NO, 1,3) || '-' || SUBSTR(tms.BIZ_NO, 4,2) || '-' || SUBSTR(tms.BIZ_NO, 6)) AS BIZ_NO,
        tms.OWNER_NM,
        tms.SYS_STAT_FG,
        tms.CLS_FG,
        (SELECT COUNT(POS_NO) FROM TB_MS_POS WHERE STORE_CD = tms.STORE_CD) AS POS_CNT,
        tms.AGENCY_CD,
        (SELECT AGENCY_NM FROM TB_CM_AGENCY WHERE AGENCY_CD = tms.AGENCY_CD) AS AGENCY_NM,
        (SELECT VAN_NM FROM TB_CM_VAN_CMPNY WHERE VAN_CD = tms.VAN_CD AND VAN_FG = '01') AS VAN_NM,
        (SELECT ENVST_VAL_NM FROM TB_CM_ENVST_DTL WHERE ENVST_VAL_CD = NVL(tmse.ENVST_VAL,'0') AND ENVST_CD = tmse.ENVST_CD AND USE_YN = tmse.USE_YN) AS ENVST_VAL_NM,
        TO_CHAR(TO_DATE(tms.SYS_OPEN_DATE, 'yyyymmdd'), 'yyyy-mm-dd') AS SYS_OPEN_DATE
        ,       CASE WHEN G.MIN_SALE_DATE IS NOT NULL THEN TO_CHAR(TO_DATE(G.MIN_SALE_DATE, 'yyyymmdd'), 'yyyy-mm-dd') ELSE '' END AS MIN_SALE_DATE
        ,       CASE WHEN G.MAX_SALE_DATE IS NOT NULL THEN TO_CHAR(TO_DATE(G.MAX_SALE_DATE, 'yyyymmdd'), 'yyyy-mm-dd') ELSE '' END AS MAX_SALE_DATE
        <include refid="CmmSQL.PagingTemplateCount"/>
        FROM TB_MS_STORE tms,
        TB_HQ_OFFICE tho,
        TB_MS_STORE_ENVST tmse
        ,       (
                    SELECT  A.STORE_CD              STORE_CD
                    ,       A.BILL_CNT              BILL_CNT
                    ,       A.SALE_CNT              SALE_CNT
                    ,       A.RTN_SALE_CNT          RTN_SALE_CNT
                    ,       A.REAL_SALE_CNT         REAL_SALE_CNT
                    ,       A.TOT_GUEST_CNT         TOT_GUEST_CNT
                    ,       A.TOT_DLVR_CNT          TOT_DLVR_CNT
                    ,       A.TOT_RESVE_CNT         TOT_RESVE_CNT
                    ,       A.TOT_REFUND_CNT        TOT_REFUND_CNT
                    ,       A.MIN_SALE_YM           MIN_SALE_YM
                    ,       A.MAX_SALE_YM           MAX_SALE_YM
                    ,       MIN(B.SALE_DATE)        MIN_SALE_DATE
                    ,       MAX(C.SALE_DATE)        MAX_SALE_DATE
                    FROM    (
                                SELECT  A.STORE_CD
                                ,       SUM(NVL(A.BILL_CNT      , 0))   BILL_CNT
                                ,       SUM(NVL(A.SALE_CNT      , 0))   SALE_CNT
                                ,       SUM(NVL(A.RTN_SALE_CNT  , 0))   RTN_SALE_CNT
                                ,       SUM(NVL(A.REAL_SALE_CNT , 0))   REAL_SALE_CNT
                                ,       SUM(NVL(A.TOT_GUEST_CNT , 0))   TOT_GUEST_CNT
                                ,       SUM(NVL(A.TOT_DLVR_CNT  , 0))   TOT_DLVR_CNT
                                ,       SUM(NVL(A.TOT_RESVE_CNT , 0))   TOT_RESVE_CNT
                                ,       SUM(NVL(A.TOT_REFUND_CNT, 0))   TOT_REFUND_CNT
                                ,       MIN(A.SALE_YM)                  MIN_SALE_YM
                                ,       MAX(A.SALE_YM)                  MAX_SALE_YM
                                FROM    TB_SL_MONTHLY_TOTAL A
                                GROUP
                                BY      A.STORE_CD
                            ) A
                    ,       TB_SL_DAILY_TOTAL B
                    ,       TB_SL_DAILY_TOTAL C
                    WHERE   B.STORE_CD  (+) =   A.STORE_CD
                    AND     B.SALE_DATE (+) LIKE    A.MIN_SALE_YM||'%'
                    AND     C.STORE_CD  (+) =   A.STORE_CD
                    AND     C.SALE_DATE (+) LIKE    A.MAX_SALE_YM||'%'
                    GROUP
                    BY      A.STORE_CD
                    ,       A.BILL_CNT
                    ,       A.SALE_CNT
                    ,       A.RTN_SALE_CNT
                    ,       A.REAL_SALE_CNT
                    ,       A.TOT_GUEST_CNT
                    ,       A.TOT_DLVR_CNT
                    ,       A.TOT_RESVE_CNT
                    ,       A.TOT_REFUND_CNT
                    ,       A.MIN_SALE_YM
                    ,       A.MAX_SALE_YM
                ) G
        WHERE 1=1
        <if test='hqOfficeCd != null and hqOfficeCd != ""'>
            <![CDATA[
                AND tms.HQ_OFFICE_CD LIKE '%'|| #{hqOfficeCd} ||'%'
            ]]>
        </if>
        <if test='hqOfficeNm != null and hqOfficeNm != ""'>
            <![CDATA[
                AND tho.HQ_OFFICE_NM LIKE '%'|| #{hqOfficeNm} ||'%'
            ]]>
        </if>
        <if test='storeCd != null and storeCd != ""'>
            <![CDATA[
                 AND tms.STORE_CD LIKE '%'|| #{storeCd} ||'%'
            ]]>
        </if>
        <if test='storeNm != null and storeNm != ""'>
            <![CDATA[
                AND tms.STORE_NM LIKE '%'|| #{storeNm} ||'%'
            ]]>
        </if>
        AND tms.HQ_OFFICE_CD = tho.HQ_OFFICE_CD
        <if test='clsFg != null and clsFg != ""'>
            AND tms.CLS_FG = #{clsFg}
        </if>
        <if test='sysStatFg != null and sysStatFg != ""'>
            AND tms.SYS_STAT_FG = #{sysStatFg}
        </if>
        <if test='agencyCd != null and agencyCd != ""'>
            <![CDATA[
                AND tms.AGENCY_CD = #{agencyCd}
            ]]>
        </if>
        <if test='vanCd != null and vanCd != ""'>
            <![CDATA[
                AND tms.VAN_CD = #{vanCd}
            ]]>
        </if>
        <if test='storeFg == 1'>
            <![CDATA[
                AND tho. HQ_OFFICE_CD = '00000'
            ]]>
        </if>
        <if test='storeFg == 2'>
            <![CDATA[
                AND tho. HQ_OFFICE_CD != '00000'
            ]]>
        </if>
        AND     tmse.STORE_CD   (+) =   tms.STORE_CD
        AND     tmse.ENVST_CD   (+) =   '2028'
        AND     tmse.USE_YN     (+) =   'Y'
        AND     G.STORE_CD      (+) =   tms.STORE_CD
        ORDER BY tms.HQ_OFFICE_CD, tms.STORE_CD
        <include refid="CmmSQL.PagingTemplateBottom"/>
    </select>

    <!-- 메장탭 - 코너 상세조회-->
    <!--
        TABLE    : TB_MS_CORNER, TB_MS_STORE, TB_MS_CORNER_TERMNL
        COMMENTS : [매장]코너 와 [매장]매장 정보, [매장]코너별_터미널관리
    -->
    <select id="getStatusStoreCornerList"  parameterType="StoreStatusVO" resultType="DefaultMap">
        /* StoreStatusMapper.getStatusStoreCornerList */
        SELECT
        tmc.CORNR_NM,
        tmct.VENDOR_TERMNL_NO,
        --현금수수료율
        --카드수수료율
        --기타수수료율
        tms.OWNER_NM,
        (SUBSTR(tms.BIZ_NO, 1,3) || '-' || SUBSTR(tms.BIZ_NO, 4,2) || '-' || SUBSTR(tms.BIZ_NO, 6)) AS BIZ_NO,
        --업태
        --종목
        tms.TEL_NO,
        tmc.USE_YN
        FROM TB_MS_CORNER tmc,
        TB_MS_STORE tms,
        TB_MS_CORNER_TERMNL tmct
        WHERE 1=1
        AND tms.STORE_CD = #{storeCd}
        and tmc.STORE_CD (+)= tms.STORE_CD
        AND tmct.STORE_CD (+)= tmc.STORE_CD
        ORDER BY tmc.CORNR_CD
    </select>

    <!-- 관리업체탭 - 관리업체 조회-->
    <!--
        TABLE    : TB_CM_AGENCY, TB_MS_STORE
        COMMENTS : [공통]대리점 정보 와 [매장]매장 정보
    -->
    <select id="getStatusAgencyList"  parameterType="StoreStatusVO" resultType="DefaultMap">
        /* StoreStatusMapper.getStatusAgencyList */
        <include refid="CmmSQL.PagingTemplateHeader"/>
        SELECT
        AGENCY_CD,
        AGENCY_NM,
        COUNT(STORE_CD) AS STORE_CNT,
        SUM(POS_CNT) AS TOT_POS_CNT
        <include refid="CmmSQL.PagingTemplateCount"/>
        FROM (
                SELECT
                tca.AGENCY_CD,
                tca.AGENCY_NM,
                tms.STORE_CD,
                (SELECT COUNT(POS_NO) FROM TB_MS_POS WHERE STORE_CD = tms.STORE_CD) AS POS_CNT,
                tms.CLS_FG,
                tms.SYS_STAT_FG
                FROM TB_CM_AGENCY tca,
                TB_MS_STORE tms
                WHERE 1=1
                  AND tms.AGENCY_CD (+)= tca.AGENCY_CD
                  AND tca.AGENCY_CD != '00000'
                <choose>
                    <!-- 총판 -->
                    <when test='orgnFg != null and orgnFg == "AGENCY"'>
                        <![CDATA[
                            AND (tca.AGENCY_CD = #{agencyCd} OR tca.P_AGENCY_CD =  #{agencyCd})
                        ]]>
                    </when>
                </choose>
                <if test='srchAgencyCd != null and srchAgencyCd != ""'>
                    <![CDATA[
                    AND tca.AGENCY_CD LIKE '%'|| #{srchAgencyCd} ||'%'
                    ]]>
                </if>
                <if test='srchAgencyNm != null and srchAgencyNm != ""'>
                    <![CDATA[
                    AND tca.AGENCY_NM LIKE '%'|| #{srchAgencyNm} ||'%'
                    ]]>
                </if>
                <if test='agencyFg != null and agencyFg != ""'>
                    <if test='agencyFg == 1'>
                        <![CDATA[
                        AND tca.AGENCY_CD = #{agencyCd}
                        ]]>
                    </if>
                    <if test='agencyFg == 2'>
                        <![CDATA[
                        AND tca.P_AGENCY_CD =  #{agencyCd}
                        ]]>
                    </if>
                </if>
                <if test='useYn != null and useYn != ""'>
                    <![CDATA[
                        AND tca.USE_YN = #{useYn}
                    ]]>
                </if>
                <if test='clsFg != null and clsFg != ""'>
                    AND tms.CLS_FG = #{clsFg}
                </if>
                <if test='sysStatFg != null and sysStatFg != ""'>
                    AND tms.SYS_STAT_FG = #{sysStatFg}
                </if>
                )
        GROUP BY AGENCY_CD, AGENCY_NM
        ORDER BY AGENCY_CD
        <include refid="CmmSQL.PagingTemplateBottom"/>
    </select>

    <!-- 관리업체탭 - 관리업체 상세조회-->
    <!--
        TABLE    : TB_MS_STORE
        COMMENTS : [매장]매장 정보
    -->
    <select id="getStatusAgencyDetailList"  parameterType="StoreStatusVO" resultType="DefaultMap">
        /* StoreStatusMapper.getStatusAgencyDetailList */
        <include refid="CmmSQL.PagingTemplateHeader"/>
        SELECT
        tms.HQ_OFFICE_CD,
        (SELECT HQ_OFFICE_NM FROM TB_HQ_OFFICE WHERE HQ_OFFICE_CD = tms.HQ_OFFICE_CD) AS HQ_OFFICE_NM,
        tms.STORE_CD,
        tms.STORE_NM,
        tms.SYS_STAT_FG,
        tms.CLS_FG,
        TO_CHAR(TO_DATE((SELECT MIN(SALE_DATE) FROM TB_SL_SALE_HDR WHERE HQ_OFFICE_CD = tms.HQ_OFFICE_CD AND STORE_CD = tms.STORE_CD), 'yyyymmdd'), 'yyyy-mm-dd') AS MIN_SALE_DATE,
        TO_CHAR(TO_DATE((SELECT MAX(SALE_DATE) FROM TB_SL_SALE_HDR WHERE HQ_OFFICE_CD = tms.HQ_OFFICE_CD AND STORE_CD = tms.STORE_CD), 'yyyymmdd'), 'yyyy-mm-dd') AS MAX_SALE_DATE,
        (SELECT COUNT(POS_NO) FROM TB_MS_POS WHERE STORE_CD = tms.STORE_CD) AS POS_CNT
        <include refid="CmmSQL.PagingTemplateCount"/>
        FROM TB_MS_STORE tms
        WHERE 1=1
        AND tms.AGENCY_CD =  #{agencyCd}
        <if test='clsFg != null and clsFg != ""'>
            AND tms.CLS_FG = #{clsFg}
        </if>
        <if test='sysStatFg != null and sysStatFg != ""'>
            AND tms.SYS_STAT_FG = #{sysStatFg}
        </if>
        ORDER BY tms.HQ_OFFICE_CD, tms.STORE_CD
        <include refid="CmmSQL.PagingTemplateBottom"/>
    </select>

    <!-- VAN사탭 - VAN사 조회-->
    <!--
        TABLE    : TB_CM_VAN_CMPNY, TB_MS_STORE
        COMMENTS : [공통]밴사 정보 와 [매장]매장 정보
    -->
    <select id="getStatusVanList"  parameterType="StoreStatusVO" resultType="DefaultMap">
        /* StoreStatusMapper.getStatusVanList */
        SELECT
        VAN_CD,
        VAN_NM,
        COUNT(STORE_CD) AS STORE_CNT
        FROM (
              SELECT
              tcvc.VAN_CD,
              tcvc.VAN_NM,
              tms.STORE_CD,
              tms.SYS_STAT_FG,
              tms.CLS_FG
              FROM TB_CM_VAN_CMPNY tcvc,
              TB_MS_STORE tms
              WHERE 1=1
                AND tcvc.VAN_CD = tms.VAN_CD
                AND tcvc.VAN_FG = '01'
              <if test='vanCd != null and vanCd != ""'>
                  <![CDATA[
                      AND tcvc.VAN_CD LIKE '%'|| #{vanCd} ||'%'
                  ]]>
              </if>
              <if test='vanNm != null and vanNm != ""'>
                  <![CDATA[
                       AND tcvc.VAN_NM LIKE '%'|| #{vanNm} ||'%'
                  ]]>
              </if>
              <if test='clsFg != null and clsFg != ""'>
                  <![CDATA[
                  AND tms.CLS_FG = #{clsFg}
                  ]]>
              </if>
              <if test='sysStatFg != null and sysStatFg != ""'>
                  <![CDATA[
                  AND tms.SYS_STAT_FG = #{sysStatFg}
                  ]]>
              </if>
              <choose>
                  <!-- 총판 -->
                  <when test='orgnFg != null and orgnFg == "AGENCY"'>
                      <![CDATA[
                          AND tms.AGENCY_CD = #{agencyCd}
                      ]]>
                   </when>
              </choose>
              )
        GROUP BY VAN_CD, VAN_NM
        ORDER BY VAN_CD
    </select>

    <!-- VAN사탭 - VAN사 상세조회-->
    <!--
        TABLE    : TB_MS_STORE
        COMMENTS : [매장]매장 정보
    -->
    <select id="getStatusVanDetailList"  parameterType="StoreStatusVO" resultType="DefaultMap">
        /* StoreStatusMapper.getStatusVanDetailList */
        <include refid="CmmSQL.PagingTemplateHeader"/>
        SELECT
        tms.HQ_OFFICE_CD,
        (SELECT HQ_OFFICE_NM FROM TB_HQ_OFFICE WHERE HQ_OFFICE_CD = tms.HQ_OFFICE_CD) AS HQ_OFFICE_NM,
        tms.STORE_CD,
        tms.STORE_NM,
        tms.SYS_STAT_FG,
        tms.CLS_FG,
        TO_CHAR(TO_DATE((SELECT MIN(SALE_DATE) FROM TB_SL_SALE_HDR WHERE HQ_OFFICE_CD = tms.HQ_OFFICE_CD AND STORE_CD = tms.STORE_CD), 'yyyymmdd'), 'yyyy-mm-dd') AS MIN_SALE_DATE,
        TO_CHAR(TO_DATE((SELECT MAX(SALE_DATE) FROM TB_SL_SALE_HDR WHERE HQ_OFFICE_CD = tms.HQ_OFFICE_CD AND STORE_CD = tms.STORE_CD), 'yyyymmdd'), 'yyyy-mm-dd') AS MAX_SALE_DATE,
        (SELECT COUNT(POS_NO) FROM TB_MS_POS WHERE STORE_CD = tms.STORE_CD) AS POS_CNT
        <include refid="CmmSQL.PagingTemplateCount"/>
        FROM TB_MS_STORE tms
        WHERE 1=1
        AND tms.VAN_CD = #{vanCd}
        <if test='clsFg != null and clsFg != ""'>
            <![CDATA[
                  AND tms.CLS_FG = #{clsFg}
                  ]]>
        </if>
        <if test='sysStatFg != null and sysStatFg != ""'>
            <![CDATA[
                  AND tms.SYS_STAT_FG = #{sysStatFg}
                  ]]>
        </if>
        <choose>
            <!-- 총판 -->
            <when test='orgnFg != null and orgnFg == "AGENCY"'>
                <![CDATA[
                    AND tms.AGENCY_CD = #{agencyCd}
                ]]>
            </when>
        </choose>
        ORDER BY tms.HQ_OFFICE_CD, tms.STORE_CD
        <include refid="CmmSQL.PagingTemplateBottom"/>
    </select>

    <!-- POS설치현황탭 - POS설치현황 조회-->
    <!--
        TABLE    : TB_CM_INSTLL, TB_MS_STORE, TB_HQ_OFFICE
        COMMENTS : 설치요청 와 [매장]매장 정보, [본사]본사 정보
    -->
    <select id="getStatusPosInstallList"  parameterType="StoreStatusVO" resultType="DefaultMap">
        /* StoreStatusMapper.getStatusPosInstallList */
        <include refid="CmmSQL.PagingTemplateHeader"/>
        SELECT
        tms.HQ_OFFICE_CD,
        tho.HQ_OFFICE_NM,
        tci.STORE_CD,
        tms.STORE_NM,
        (SELECT COUNT(POS_NO) FROM TB_MS_POS WHERE STORE_CD = tci.STORE_CD) AS POS_CNT,
        tci.INST_INS_DT,
        tci.INST_FG,
        (SELECT AGENCY_NM FROM TB_CM_AGENCY WHERE AGENCY_CD = tms.AGENCY_CD) AS AGENCY_NM,
        (SELECT AGENCY_NM FROM TB_CM_AGENCY WHERE AGENCY_CD = tci.AGENCY_CD) AS INST_AGENCY_NM,
        tci.INST_INS_ID
        <include refid="CmmSQL.PagingTemplateCount"/>
        FROM TB_CM_INSTLL tci,
        TB_MS_STORE tms,
        TB_HQ_OFFICE tho
        WHERE 1=1
        <if test='chkDt != true'>
            <if test="startDate != null and startDate != '' and endDate != null and endDate != ''">
                <![CDATA[
                    AND tci.INST_INS_DT BETWEEN #{startDate} AND #{endDate}
                ]]>
            </if>
        </if>
        <if test='hqOfficeCd != null and hqOfficeCd != ""'>
            <![CDATA[
                AND tho.HQ_OFFICE_CD LIKE '%'|| #{hqOfficeCd} ||'%'
            ]]>
        </if>
        <if test='hqOfficeNm != null and hqOfficeNm != ""'>
            <![CDATA[
                AND tho.HQ_OFFICE_NM LIKE '%'|| #{hqOfficeNm} ||'%'
            ]]>
        </if>
        <if test='storeCd != null and storeCd != ""'>
            <![CDATA[
                AND tms.STORE_CD LIKE '%'|| #{storeCd} ||'%'
            ]]>
        </if>
        <if test='storeNm != null and storeNm != ""'>
            <![CDATA[
                AND tms.STORE_NM LIKE '%'|| #{storeNm} ||'%'
            ]]>
        </if>
        <if test='instFg != null and instFg != ""'>
            <![CDATA[
                AND tci.INST_FG = #{instFg}
            ]]>
        </if>
        AND tci.STORE_CD = tms.STORE_CD
        AND tms.HQ_OFFICE_CD = tho.HQ_OFFICE_CD
        <choose>
            <!-- 총판 -->
            <when test='orgnFg != null and orgnFg == "AGENCY"'>
                <![CDATA[
                    AND tms.AGENCY_CD = #{agencyCd}
                ]]>
            </when>
        </choose>
        ORDER BY tms.HQ_OFFICE_CD, tci.STORE_CD
        <include refid="CmmSQL.PagingTemplateBottom"/>
    </select>

    <!-- 관리매장 승인내역 목록 조회 -->
    <!--
        TABLE    : TB_LG_CARD_APPR, TB_LG_CASH_APPR, TB_MS_STORE
        PARAM    : storeStatusVO
        COMMENTS : 관리매장 승인내역 목록을 조회한다.
    -->
    <select id="getStatusApprList" parameterType="storeStatusVO" resultType="DefaultMap">
      /* USE : StoreStatusMapper.getStatusApprList */
        <include refid="CmmSQL.PagingTemplateHeader"/>
        SELECT
                tms.AGENCY_CD,
                tca.AGENCY_NM,
                tms.HQ_OFFICE_CD,
                tho.HQ_OFFICE_NM,
                tms.STORE_CD,
                tms.STORE_NM,
                SUBSTR(tms.BIZ_NO,0,3)||'-'||SUBSTR(tms.BIZ_NO,4,2)||'-'||SUBSTR(tms.BIZ_NO,6,5) AS BIZ_NO,
                tms.OWNER_NM,
                TO_CHAR(TO_DATE(tms.SYS_OPEN_DATE, 'YYYYMMDD') , 'YYYY/MM/DD') AS SYS_OPEN_DATE,
                TO_CHAR(TO_DATE(tms.SYS_CLOSURE_DATE, 'YYYYMMDD') , 'YYYY/MM/DD') AS SYS_CLOSURE_DATE,
                tlcra.CARD_APPR_CNT,
                tlcra.CARD_REQ_AMT,
                tlcsa.CASH_APPR_CNT,
                tlcsa.CASH_REQ_AMT
        <include refid="CmmSQL.PagingTemplateCount"/>
          FROM TB_MS_STORE tms,
                TB_CM_AGENCY tca,
                TB_HQ_OFFICE tho,
                (
                    SELECT
                        HQ_OFFICE_CD,
                        HQ_BRAND_CD,
                        STORE_CD,
                        --VAN_TERMNL_NO,
                        COUNT(APPR_NO) AS CARD_APPR_CNT,
                        SUM(APPR_AMT) AS CARD_APPR_AMT,
                        SUM(REQ_AMT) AS CARD_REQ_AMT
                      FROM TB_LG_CARD_APPR
                     WHERE 1=1
                       AND SALE_DATE BETWEEN #{startDate} AND #{endDate}
                 GROUP BY HQ_OFFICE_CD, HQ_BRAND_CD, STORE_CD--, VAN_TERMNL_NO
                ) tlcra,
                (
                    SELECT
                        HQ_OFFICE_CD,
                        HQ_BRAND_CD,
                        STORE_CD,
                        COUNT(APPR_NO) AS CASH_APPR_CNT,
                        SUM(APPR_AMT) AS CASH_APPR_AMT,
                        SUM(REQ_AMT) AS CASH_REQ_AMT
                      FROM TB_LG_CASH_APPR
                      WHERE 1=1
                        AND SALE_DATE BETWEEN #{startDate} AND #{endDate}
                  GROUP BY HQ_OFFICE_CD, HQ_BRAND_CD, STORE_CD
                ) tlcsa
        WHERE 1=1
          AND tca.AGENCY_CD = tms.AGENCY_CD
          AND tho.HQ_OFFICE_CD = tms.HQ_OFFICE_CD
          AND tlcra.HQ_OFFICE_CD = tms.HQ_OFFICE_CD
          AND tlcra.HQ_BRAND_CD = tms.HQ_BRAND_CD
          AND tlcra.STORE_CD = tms.STORE_CD
          AND tlcsa.STORE_CD = tms.STORE_CD
          AND tlcsa.HQ_BRAND_CD = tms.HQ_BRAND_CD
          AND tlcsa.STORE_CD = tms.STORE_CD
        <choose>
            <!-- 시스템 -->
            <when test='orgnFg != null and orgnFg == "M"'><!-- Agency Master Code -->
                <if test='agencyNm != null and agencyNm.toString() != ""'>
                    AND tca.AGENCY_NM LIKE '%'|| #{agencyNm} ||'%'
                </if>
            </when>
            <!-- 총판 -->
            <when test='orgnFg != null and orgnFg == "A"'>
                AND tms.AGENCY_CD = #{agencyCd}
            </when>
        </choose>
        <if test='storeNm != null and storeNm != ""'>
            AND tms.STORE_NM LIKE '%'||#{storeNm}||'%'
        </if>
        <if test='bizNo != null and bizNo != ""'>
            AND tms.BIZ_NO LIKE '%'||#{bizNo}||'%'
        </if>
    ORDER BY tms.AGENCY_CD, tms.HQ_OFFICE_CD, tms.STORE_CD
    <include refid="CmmSQL.PagingTemplateBottom"/>
    </select>

    <!-- 카드승인현황 -->
    <!--
        TABLE    : TB_LG_CARD_APPR, TB_SL_SALE_PAY_CARD
        PARAM    : storeStatusVO
        COMMENTS : 카드승인현황
    -->
    <select id="getCardAppr" parameterType="storeStatusVO" resultType="DefaultMap">
        /* USE : StoreStatusMapper.getCardAppr */
        SELECT
                tlca.HQ_OFFICE_CD,
                tms.AGENCY_CD,
                tlca.STORE_CD,
                tlca.HQ_BRAND_CD,
                tlca.SALE_DATE,
                tlca.POS_NO,
                tsspc.BILL_NO,
                tlca.APPR_FG,
                tlca.APPR_PROC_FG,
                tlca.ACQUIRE_NM,
                --tlca.CARD_NO,
                SUBSTR(tlca.CARD_NO,0,4)||'-'||SUBSTR(tlca.CARD_NO,5,4)||'-'||SUBSTR(tlca.CARD_NO,9,4) ||'-'||SUBSTR(tlca.CARD_NO,13,4)AS CARD_NO,
                tlca.REQ_AMT,
                tlca.TIP_AMT,
                tlca.VAT_AMT,
                tlca.INST_CNT,
                tlca.APPR_DT,
                tlca.APPR_NO,
                tlca.APPR_AMT,
                'CARD' AS payApprType
        FROM   TB_LG_CARD_APPR tlca,
                TB_SL_SALE_PAY_CARD tsspc,
                TB_MS_STORE tms
        WHERE  1=1
          AND  tsspc.HQ_OFFICE_CD (+)= tlca.HQ_OFFICE_CD
          AND  tsspc.HQ_BRAND_CD (+)= tlca.HQ_BRAND_CD
          AND  tsspc.STORE_CD (+)= tlca.STORE_CD
          AND  tsspc.SALE_DATE (+)= tlca.SALE_DATE
          AND  tsspc.POS_NO (+)= tlca.POS_NO
          AND  tsspc.APPR_LOG_NO (+)= tlca.APPR_LOG_NO
          AND  tms.HQ_OFFICE_CD = tlca.HQ_OFFICE_CD
          AND  tms.HQ_BRAND_CD = tlca.HQ_BRAND_CD
          AND  tms.STORE_CD = tlca.STORE_CD
        <if test='orgnFg != null and orgnFg == "A"'>
            AND tms.AGENCY_CD = #{agencyCd}
        </if>
          AND  tlca.HQ_OFFICE_CD = #{hqOfficeCd}
          AND  tlca.STORE_CD = #{storeCd}
          AND  tlca.SALE_DATE BETWEEN #{startDate} AND #{endDate}
     ORDER BY  tlca.HQ_OFFICE_CD, tlca.HQ_BRAND_CD, tlca.STORE_CD, tlca.SALE_DATE, tlca.POS_NO, tlca.APPR_LOG_NO
    </select>

    <!-- 현금승인현황 -->
    <!--
        TABLE    : TB_LG_CASH_APPR, TB_SL_SALE_PAY_CASH
        PARAM    : storeStatusVO
        COMMENTS : 현금승인현황
    -->
    <select id="getCashAppr" parameterType="storeStatusVO" resultType="DefaultMap">
      /* USE : StoreStatusMapper.getCashAppr */
        SELECT
                tlca.HQ_OFFICE_CD,
                tms.AGENCY_CD,
                tlca.HQ_BRAND_CD,
                tlca.STORE_CD,
                tlca.SALE_DATE,
                tlca.POS_NO,
                tsspc.BILL_NO,
                tlca.APPR_FG,
                tlca.APPR_PROC_FG,
                tlca.REQ_AMT,
                tlca.TIP_AMT,
                tlca.VAT_AMT,
                tlca.APPR_DT,
                tlca.APPR_NO,
                tlca.APPR_AMT,
                'CASH' AS payApprType
        FROM   TB_LG_CASH_APPR tlca,
                TB_SL_SALE_PAY_CASH tsspc,
                TB_MS_STORE tms
        WHERE  1=1
          AND  tsspc.HQ_OFFICE_CD (+)= tlca.HQ_OFFICE_CD
          AND  tsspc.HQ_BRAND_CD (+)= tlca.HQ_BRAND_CD
          AND  tsspc.STORE_CD (+)= tlca.STORE_CD
          AND  tsspc.SALE_DATE (+)= tlca.SALE_DATE
          AND  tsspc.POS_NO (+)= tlca.POS_NO
          AND  tsspc.APPR_LOG_NO (+)= tlca.APPR_LOG_NO
          AND  tms.HQ_OFFICE_CD = tlca.HQ_OFFICE_CD
          AND  tms.HQ_BRAND_CD = tlca.HQ_BRAND_CD
          AND  tms.STORE_CD = tlca.STORE_CD
        <if test='orgnFg != null and orgnFg == "A"'>
            AND tms.AGENCY_CD = #{agencyCd}
        </if>
          AND  tlca.HQ_OFFICE_CD = #{hqOfficeCd}
          AND  tlca.STORE_CD = #{storeCd}
          AND  tlca.SALE_DATE BETWEEN #{startDate} AND #{endDate}
     ORDER BY  tlca.HQ_OFFICE_CD, tlca.HQ_BRAND_CD, tlca.STORE_CD, tlca.SALE_DATE, tlca.POS_NO, tlca.APPR_LOG_NO
    </select>

    <!-- 매출정보_매출상세내역 -->
    <!--
        TABLE    : TB_SL_SALE_HDR, TB_SL_SALE_HDR_PAY
        PARAM    : storeStatusVO
        COMMENTS : 매출정보_매출상세내역
    -->
    <select id="getSaleDtlInfo" parameterType="storeStatusVO" resultType="DefaultMap">
      /* USE : DayMapper.getStoreSalePayInfo */
        SELECT   tssh.STORE_CD,
                  (SELECT STORE_NM FROM TB_MS_STORE WHERE HQ_OFFICE_CD = tssh.HQ_OFFICE_CD AND STORE_CD = tssh.STORE_CD) AS STORE_NM,
                  TO_CHAR(TO_DATE(tssh.SALE_DATE, 'yyyymmdd'), 'yyyy-mm-dd') AS SALE_DATE,
                  tssh.POS_NO,
                  tssh.BILL_NO,
                  NVL(tssh.TOT_SALE_AMT, 0) AS TOT_SALE_AMT,
                  NVL(tssh.TOT_DC_AMT, 0) AS TOT_DC_AMT,
                  NVL(tssh.REAL_SALE_AMT, 0) AS REAL_SALE_AMT,
                  NVL(tssh.NET_SALE_AMT, 0) AS NET_SALE_AMT,
                  NVL(tssh.NO_TAX_SALE_AMT, 0) AS NO_TAX_SALE_AMT,
                  NVL(tssh.TAX_SALE_AMT, 0) AS TAX_SALE_AMT,
                  NVL(tssh.VAT_AMT, 0) AS VAT_AMT,
                  NVL(tssh.TOT_TIP_AMT, 0) AS TOT_TIP_AMT,
                <foreach collection="arrPayCol" item="item" separator=",">
                    NVL(tsshp.PAY${item}, 0) AS PAY${item}
                </foreach>
        FROM    (
                   SELECT  tssh.HQ_OFFICE_CD,
                   			tssh.HQ_BRAND_CD,
                   			tssh.STORE_CD,
                    	    tssh.SALE_DATE,
                    	    tssh.POS_NO,
                    		tssh.BILL_NO,
                    		tssh.TOT_SALE_AMT,
                    		tssh.TOT_DC_AMT,
							tssh.REAL_SALE_AMT,
							tssh.NET_SALE_AMT,
							tssh.NO_TAX_SALE_AMT,
							tssh.TAX_SALE_AMT,
							tssh.VAT_AMT,
							tssh.TOT_TIP_AMT
                    FROM    TB_SL_SALE_HDR tssh
                    WHERE   tssh.HQ_OFFICE_CD = #{hqOfficeCd}
                      AND   tssh.HQ_BRAND_CD = #{hqBrandCd}
                      AND   tssh.STORE_CD = #{storeCd}
                      AND   tssh.SALE_DATE = #{saleDate}
                      AND   tssh.POS_NO = #{posNo}
     				  AND   tssh.BILL_NO = #{billNo}

                ) tssh
        ,       (   SELECT  HQ_OFFICE_CD
        			, HQ_BRAND_CD
        			, STORE_CD
        			, SALE_DATE
        			, POS_NO
        			, BILL_NO,
                    <foreach collection="arrPayCol" item="item" separator=",">
                        PAY${item}
                    </foreach>
                    FROM    (  SELECT  tsshp.HQ_OFFICE_CD, tsshp.HQ_BRAND_CD, tsshp.STORE_CD,  tsshp.SALE_DATE, tsshp.POS_NO, tsshp.BILL_NO, tsshp.PAY_CD, tsshp.PAY_AMT
                                  FROM  TB_SL_SALE_HDR_PAY tsshp
                                 WHERE  tsshp.HQ_OFFICE_CD = #{hqOfficeCd}
                                   AND  tsshp.HQ_BRAND_CD = #{hqBrandCd}
                                   AND  tsshp.STORE_CD = #{storeCd}
                                   AND  tsshp.SALE_DATE = #{saleDate}
                                   AND  tsshp.POS_NO = #{posNo}
     							   AND  tsshp.BILL_NO = #{billNo}
                            )
                    PIVOT   (
                                SUM(PAY_AMT)
                                FOR PAY_CD
                                IN (${pivotPayCol})
                            )
                ) tsshp
        WHERE   1=1
        AND tsshp.HQ_OFFICE_CD = tssh.HQ_OFFICE_CD
        AND tsshp.HQ_BRAND_CD = tssh.HQ_BRAND_CD
        AND tsshp.STORE_CD = tssh.STORE_CD
        AND tsshp.SALE_DATE = tssh.SALE_DATE
        AND tsshp.POS_NO = tssh.POS_NO
        --AND tsshp.BILL_NO = tssh.BILL_NO
    </select>

    <!-- 매출정보_신용카드결제내역 -->
    <!--
        TABLE    : TB_LG_CARD_APPR, TB_SL_SALE_PAY_CARD
        PARAM    : storeStatusVO
        COMMENTS : 매출정보_신용카드결제내역
    -->
    <select id="getCardPayInfo" parameterType="storeStatusVO" resultType="DefaultMap">
       SELECT
				tsspc.CORNR_CD,
                tlca.APPR_FG,
                tlca.APPR_PROC_FG,
                SUBSTR(tlca.CARD_NO,0,4)||'-'||SUBSTR(tlca.CARD_NO,5,4)||'-'||SUBSTR(tlca.CARD_NO,9,4) ||'-'||SUBSTR(tlca.CARD_NO,13,4)AS CARD_NO,
                tlca.INST_CNT,
                tlca.APPR_NO,
                TO_CHAR(TO_DATE(tlca.APPR_DT, 'YYYYMMDDHH24MISS'), 'YYYY.MM.DD HH24:MI:SS') AS APPR_DT,
                tlca.APPR_AMT,
                tlca.VAN_CD,
                tcva.VAN_NM,
                tlca.ISSUE_NM,
                tlca.ACQUIRE_NM,
                tlca.ORG_APPR_DT,
                tlca.ORG_APPR_NO
        FROM   TB_LG_CARD_APPR tlca,
                TB_SL_SALE_PAY_CARD tsspc,
                TB_CM_VAN_CMPNY tcva
        WHERE  1=1
          AND  tsspc.HQ_OFFICE_CD (+)= tlca.HQ_OFFICE_CD
          AND  tsspc.HQ_BRAND_CD (+)= tlca.HQ_BRAND_CD
          AND  tsspc.STORE_CD (+)= tlca.STORE_CD
          AND  tsspc.SALE_DATE (+)= tlca.SALE_DATE
          AND  tsspc.POS_NO (+)= tlca.POS_NO
          AND  tsspc.APPR_LOG_NO (+)= tlca.APPR_LOG_NO
          AND  tcva.VAN_CD (+)= tlca.VAN_CD
          AND  tcva.VAN_FG = '01' -- 현금
          AND  tlca.HQ_OFFICE_CD = #{hqOfficeCd}
          AND  tlca.HQ_BRAND_CD = #{hqBrandCd}
          AND  tlca.STORE_CD = #{storeCd}
          AND  tlca.SALE_DATE = #{saleDate}
          AND  tlca.POS_NO = #{posNo}
     	  AND  tsspc.BILL_NO = #{billNo}
    </select>

    <!-- 매출정보_현금결제내역 -->
    <!--
        TABLE    : TB_LG_CASH_APPR, TB_SL_SALE_PAY_CASH
        PARAM    : storeStatusVO
        COMMENTS : 매출정보_현금결제내역
    -->
    <select id="getCashPayInfo" parameterType="storeStatusVO" resultType="DefaultMap">
       SELECT
				tsspc.CORNR_CD,
                tlca.APPR_FG,
                tlca.APPR_PROC_FG,
                -- 유효기간
                tlca.APPR_NO,
                TO_CHAR(TO_DATE(tlca.APPR_DT, 'YYYYMMDDHH24MISS'), 'YYYY.MM.DD HH24:MI:SS') AS APPR_DT,
                tlca.APPR_AMT,
                tlca.VAN_CD,
                tlca.ORG_APPR_DT,
                tlca.ORG_APPR_NO
        FROM   TB_LG_CASH_APPR tlca,
                TB_SL_SALE_PAY_CASH tsspc
        WHERE  1=1
          AND  tsspc.HQ_OFFICE_CD (+)= tlca.HQ_OFFICE_CD
          AND  tsspc.HQ_BRAND_CD (+)= tlca.HQ_BRAND_CD
          AND  tsspc.STORE_CD (+)= tlca.STORE_CD
          AND  tsspc.SALE_DATE (+)= tlca.SALE_DATE
          AND  tsspc.POS_NO (+)= tlca.POS_NO
          AND  tsspc.APPR_LOG_NO (+)= tlca.APPR_LOG_NO
          AND  tlca.HQ_OFFICE_CD = #{hqOfficeCd}
          AND  tlca.HQ_BRAND_CD = #{hqBrandCd}
          AND  tlca.STORE_CD = #{storeCd}
          AND  tlca.SALE_DATE = #{saleDate}
          AND  tlca.POS_NO = #{posNo}
     	  AND  tsspc.BILL_NO = #{billNo}
    </select>

    <!-- 매출정보_상품내역 -->
    <!--
        TABLE    : TB_SL_SALE_DTL, TB_MS_PRODUCT
        PARAM    : storeStatusVO
        COMMENTS : 매출정보_상품내역
    -->
    <select id="getSaleProductInfo" parameterType="storeStatusVO" resultType="DefaultMap">
        SELECT tssd.PROD_CD,
                 (SELECT PROD_NM FROM TB_MS_PRODUCT
                  WHERE 1=1
                    /*AND HQ_BRAND_CD = tssd.HQ_BRAND_CD */
                    AND STORE_CD = tssd.STORE_CD
                    AND PROD_CD = tssd.PROD_CD) AS PROD_NM,
                 tssd.SALE_QTY,
                 tssd.SALE_UPRC,
                 tssd.SALE_AMT,
                 tssd.DC_AMT,
                 tssd.REAL_SALE_AMT,
                 (tssd.REAL_SALE_AMT - tssd.VAT_AMT) AS TAX_SALE_AMT,
                 tssd.VAT_AMT
          FROM  TB_SL_SALE_DTL tssd
          WHERE 1=1
           AND   tssd.HQ_OFFICE_CD = #{hqOfficeCd}
           AND   tssd.HQ_BRAND_CD = #{hqBrandCd}
           AND   tssd.STORE_CD = #{storeCd}
           AND   tssd.SALE_DATE = #{saleDate}
           AND   tssd.POS_NO = #{posNo}
     	   AND   tssd.BILL_NO = #{billNo}
    </select>
</mapper>
