<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    TerminalManage.xml
    매장터미널관리 sql
    ======================================================
    No  ||  수정자 ||  수정일자    ||  수정내역
    ======================================================
    1       김지은     2018.10.07      최초작성
-->
<mapper namespace="kr.co.solbipos.store.manage.terminalManage.service.impl.TerminalManageMapper">

    <!-- 매장목록 조회 -->
    <!--
        TABLE    : TB_MS_STORE, TB_HQ_OFFICE
        PARAM    : storeManageVO
        COMMENTS : 매장목록을 조회한다.
    -->
    <select id="getStoreList" parameterType="DefaultMap" resultType="DefaultMap">
        /* USE : TerminalManageMapper.getStoreList */
        <!--<include refid="CmmSQL.PagingTemplateHeader"/>-->
        SELECT '[' || tho.HQ_OFFICE_CD || '] ' || tho.HQ_OFFICE_NM AS HQ_OFFICE_CD_NM,
               tho.HQ_OFFICE_CD,
               tho.HQ_OFFICE_NM,
               tms.STORE_CD,
               tms.STORE_NM,
               NVL(tms.CLS_FG, tho.CLS_FG) AS CLS_FG,
               NVL(tms.SYS_STAT_FG,  tho.SYS_STAT_FG) AS SYS_STAT_FG,
               tho.SYS_STAT_FG AS HQ_SYS_STAT_FG,
               tms.SYS_OPEN_DATE,
               TO_CHAR(TO_DATE(tms.SYS_OPEN_DATE, 'YYYYMMDD') , 'YYYY/MM/DD')
        <!--<include refid="CmmSQL.PagingTemplateCount"/>-->
        FROM TB_HQ_OFFICE tho,
             TB_MS_STORE tms
        WHERE tms.HQ_OFFICE_CD (+)= tho.HQ_OFFICE_CD
          AND tms.STORE_CD IS NOT NULL
        <if test='hqOfficeCd != null and hqOfficeCd != ""'>
          AND tho.HQ_OFFICE_CD LIKE '%'||#{hqOfficeCd}||'%'
        </if>
        <if test='hqOfficeNm != null and hqOfficeNm != ""'>
          AND tho.HQ_OFFICE_NM LIKE '%'||#{hqOfficeNm}||'%'
        </if>
        <if test='storeCd != null and storeCd != ""'>
          AND tms.STORE_CD LIKE '%'||#{storeCd}||'%'
        </if>
        <if test='storeNm != null and storeNm != ""'>
          AND tms.STORE_NM LIKE '%'||#{storeNm}||'%'
        </if>
        <if test='clsFg != null and clsFg.toString() != ""'>
          AND tms.CLS_FG = #{clsFg}
        </if>
        <if test='sysStatFg != null and sysStatFg.toString() != ""'>
          AND tms.SYS_STAT_FG = #{sysStatFg}
        </if>
        ORDER BY tho.HQ_OFFICE_CD, tms.STORE_CD, tms.SYS_OPEN_DATE ASC
        <!--<include refid="CmmSQL.PagingTemplateBottom"/>-->
    </select>

    <!-- 매장 환경변수 값 조회 -->
    <!--
        TABLE    : TB_MS_STORE_ENVST
        COMMENTS : 매장 환경변수 테이블에 등록된 값을 조회한다.
    -->
    <select id="getTerminalEnv" parameterType="storeEnvVO" resultType="String">
        /* TerminalManageMapper.getTerminalEnv */
        SELECT ENVST_VAL
          FROM TB_MS_STORE_ENVST
         WHERE STORE_CD = #{storeCd}
           AND ENVST_CD = #{envstCd}
           AND USE_YN = 'Y'
    </select>

    <!-- 매장 포스목록 조회 -->
    <!--
        TABLE    : TB_MS_POS
        COMMENTS : 매장에 등록된 포스를 조회한다.
    -->
    <select id="getPosList" parameterType="storePosVO" resultType="DefaultMap">
        /* TerminalManageMapper.getPosList */
        SELECT STORE_CD,
               POS_NO,
               POS_NM,
               HW_AUTH_KEY,
               POS_VER_NO,
               VAN_TERMNL_NO,
               VAN_CERT_YN,
               VAN_CD,
               VAN_SER_NO,
               USE_YN,
               REMARK
          FROM TB_MS_POS
         WHERE STORE_CD = #{storeCd}
    </select>

    <!-- 매장 환경변수 값 변경 -->
    <!--
        TABLE    : TB_MS_STORE_ENVST
        COMMENTS : 매장의 환경변수 값을 수정한다.
    -->
    <update id="updateTerminalEnvst" parameterType="storeEnvVO">
        /* TerminalManageMapper.updateTerminalEnvst */
        MERGE INTO TB_MS_STORE_ENVST tmse
        USING DUAL
           ON (
                   tmse.STORE_CD = #{storeCd}
               AND tmse.ENVST_CD = #{envstCd}
          )
          WHEN MATCHED THEN
               UPDATE
                  SET ENVST_VAL = #{envstVal},
                      MOD_DT = #{modDt},
                      MOD_ID = #{modId}
          WHEN NOT MATCHED THEN
               INSERT
               (
                   STORE_CD,
                   ENVST_CD,
                   ENVST_VAL,
                   DIRCT_IN_YN,
                   USE_YN,
                   REG_DT,
                   REG_ID,
                   MOD_DT,
                   MOD_ID
               ) VALUES (
                   #{storeCd},
                   #{envstCd},
                   #{envstVal},
                   'N',
                   'Y',
                   #{regDt},
                   #{regId},
                   #{modDt},
                   #{modId}
               )


    </update>

    <!-- 포스정보 등록 -->
    <!--
        TABLE    : TB_MS_POS
        COMMENTS : 포스의 정보를 등록한다.
    -->
    <insert id="insertPosInfo" parameterType="storePosVO">
        /* TerminalManageMapper.insertPosInfo */
        <selectKey keyProperty="posNo" resultType="String" order="BEFORE">
        SELECT LPAD( NVL(MAX(POS_NO), 0) + 1, 2, '0') AS POS_NO
          FROM TB_MS_POS tmp
         WHERE STORE_CD = #{storeCd}
        </selectKey>
        INSERT INTO TB_MS_POS
        (   STORE_CD,
            POS_NO,
            POS_NM,
            HW_AUTH_KEY,
            POS_VER_NO,
            VAN_TERMNL_NO,
            VAN_CERT_YN,
            VAN_CD,
            VAN_SER_NO,
            USE_YN,
            REMARK,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID
        )
        VALUES
        (
            #{storeCd},
            #{posNo},
            #{posNm},
            #{hwAuthKey},
            #{posVerNo},
            #{vanTermnlNo},
            #{vanCertYn,jdbcType=VARCHAR},
            #{vanCd},
            #{vanSerNo},
            #{useYn,jdbcType=VARCHAR},
            #{remark},
            #{regDt},
            #{regId},
            #{modDt},
            #{modId}
        )
    </insert>

    <!-- 포스정보 수정 -->
    <!--
        TABLE    : TB_MS_POS
        COMMENTS : 포스의 정보를 수정한다.
    -->
    <update id="updatePosInfo" parameterType="storePosVO">
        /* TerminalManageMapper.updatePosInfo */
        UPDATE TB_MS_POS
           SET POS_NM = #{posNm},
               HW_AUTH_KEY = #{hwAuthKey},
               POS_VER_NO = #{posVerNo},
               VAN_TERMNL_NO = #{vanTermnlNo},
               VAN_CERT_YN = #{vanCertYn},
               VAN_CD = #{vanCd},
               VAN_SER_NO = #{vanSerNo},
               USE_YN = #{useYn},
               REMARK = #{remark},
               MOD_DT = #{modDt},
               MOD_ID = #{modId}
         WHERE STORE_CD = #{storeCd}
           AND POS_NO = #{posNo}
    </update>

    <!-- 매장 코너 목록 조회 -->
    <!--
        TABLE    : TB_MS_CORNER
        COMMENTS : 매장에 등록된 코너를 조회한다.
    -->
    <select id="getCornerList" parameterType="storeCornerVO" resultType="DefaultMap">
        /* TerminalManageMapper.getPosList */
        SELECT STORE_CD,
               CORNR_CD,
               CORNR_NM,
               OWNER_NM,
               BIZ_NO,
               TEL_NO,
               VAN_CD,
               VAN_TERMNL_NO,
               VAN_SER_NO,
               USE_YN
          FROM TB_MS_CORNER
         WHERE STORE_CD = #{storeCd}
    </select>


    <!-- 코너 등록 -->
    <!--
        TABLE    : TB_MS_POS
        COMMENTS : 코너 정보를 등록한다.
    -->
    <insert id="insertCornerInfo" parameterType="storeCornerVO">
        /* TerminalManageMapper.insertCornerInfo */
        <selectKey keyProperty="cornrCd" resultType="String" order="BEFORE">
            SELECT LPAD( NVL(MAX(CORNR_CD), 0) + 1, 2, '0') AS CORNR_CD
              FROM TB_MS_CORNER tmc
             WHERE STORE_CD = #{storeCd}
        </selectKey>
        INSERT INTO TB_MS_CORNER
        (   STORE_CD,
            CORNR_CD,
            CORNR_NM,
            OWNER_NM,
            BIZ_NO,
            TEL_NO,
            VAN_CD,
            VAN_TERMNL_NO,
            VAN_SER_NO,
            USE_YN,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID
        )
        VALUES
        (
            #{storeCd},
            #{cornrCd},
            #{cornrNm},
            #{ownerNm},
            #{bizNo},
            #{telNo},
            #{vanCd},
            #{vanTermnlNo},
            #{vanSerNo},
            #{useYn,jdbcType=VARCHAR},
            #{regDt},
            #{regId},
            #{modDt},
            #{modId}
        )
    </insert>

    <!-- 포스정보 수정 -->
    <!--
        TABLE    : TB_MS_POS
        COMMENTS : 포스의 정보를 수정한다.
    -->
    <update id="updateCornerInfo" parameterType="storeCornerVO">
        /* TerminalManageMapper.updateCornerInfo */
        UPDATE TB_MS_CORNER
           SET CORNR_NM = #{cornrNm},
               OWNER_NM = #{ownerNm},
               BIZ_NO = #{bizNo},
               TEL_NO = #{telNo},
               VAN_CD = #{vanCd},
               VAN_TERMNL_NO = #{vanTermnlNo},
               VAN_SER_NO = #{verSerNo},
               USE_YN = #{useYn},
               MOD_DT =  #{modDt},
               MOD_ID = #{modId}
         WHERE STORE_CD = #{storeCd}
           AND CORNR_CD = #{cornrCd}
    </update>

</mapper>
