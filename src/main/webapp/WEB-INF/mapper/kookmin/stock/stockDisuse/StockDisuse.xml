<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    StockDisuse.xml
    재고폐기 sql
    ======================================================
    No  ||  수정자 ||  수정일자    ||  수정내역
    ======================================================
    1       김유승     2025.12.17
-->
<mapper namespace="kr.co.solbipos.kookmin.stock.stockDisuse.service.impl.StockDisuseMapper">
    <!-- 폐기사유 조회 -->
    <!--
        TABLE    :
        COMMENTS : 폐기사유를 조회한다.
    -->
    <select id="getDisuseReason" parameterType="sessionInfoVO" resultType="DefaultMap">
        /* StockDisuseMapper.getDisuseReason */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg.toString() == "HQ"'>
                SELECT  NMCODE_CD
                ,       NMCODE_NM
                FROM    TB_HQ_NMCODE
                WHERE   HQ_OFFICE_CD    = #{hqOfficeCd}
                AND     NMCODE_GRP_CD   = '136'
                AND     USE_YN          = 'Y'
            </when>
            <!-- 가맹점 -->
            <when test='orgnFg != null and orgnFg.toString() == "STORE"'>
                SELECT  NMCODE_CD
                ,       NMCODE_NM
                FROM    TB_MS_STORE_NMCODE
                WHERE   STORE_CD        = #{storeCd}
                AND     NMCODE_GRP_CD   = '136'
                AND     USE_YN          = 'Y'
            </when>
        </choose>
    </select>

    <!-- 재고폐기 - 재고폐기 리스트 조회(본사) -->
    <!--
        TABLE    : TB_ST_HQ_STOCK_CUR, TB_HQ_PRODUCT, TB_HQ_PRODUCT_BARCD
        PARAM    : stockDisuseVO
        COMMENTS : 재고폐기 - 재고폐기 리스트를 조회한다.
    -->
    <select id="getSearchStockDisuseList" parameterType="stockDisuseVO" resultType="DefaultMap">
        /* USE : StockDisuseMapper.getSearchStockDisuseList */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                SELECT  A.DISUSE_DATE
                ,       A.HQ_OFFICE_CD
                ,       A.SEQ_NO
                ,       A.DISUSE_TITLE
                ,       A.PROC_FG
                ,       A.DTL_CNT
                ,       A.CONFM_DATE
                ,       SUBSTR(A.REG_DT,0,8) AS REG_DATE
                ,		A.DISUSE_STORAGE_CD
                ,       A.REASON_CD AS DISUSE_REASON
                ,       SUBSTR(A.MOD_DT,0,8) AS MOD_DATE
                ,       A.REG_ID
                ,       A.MOD_ID
                ,       A.CONFM_ID
                FROM    TB_ST_HQ_DISUSE A
                WHERE   HQ_OFFICE_CD  = #{hqOfficeCd}
                AND     DISUSE_DATE  BETWEEN #{startDate} AND #{endDate}
                <if test='procFg != null and procFg != ""'>
                    AND A.PROC_FG = #{procFg}
                </if>
                <if test='disuseReason != null and disuseReason != ""'>
                    AND A.REASON_CD = #{disuseReason}
                </if>
                ORDER
                BY      A.DISUSE_DATE DESC
                ,       A.SEQ_NO DESC
            </when>
            <!-- 가맹점 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                SELECT  A.DISUSE_DATE
                ,       A.STORE_CD
                ,       A.SEQ_NO
                ,       A.DISUSE_TITLE
                ,       A.PROC_FG
                ,       A.DTL_CNT
                ,       A.CONFM_DATE
                ,       SUBSTR(A.REG_DT,0,8) AS REG_DATE
                ,		A.DISUSE_STORAGE_CD
                ,       A.REASON_CD AS DISUSE_REASON
                ,       SUBSTR(A.MOD_DT,0,8) AS MOD_DATE
                ,       A.REG_ID
                ,       A.MOD_ID
                ,       A.CONFM_ID
                FROM    TB_ST_STORE_DISUSE A
                WHERE   A.STORE_CD     = #{storeCd}
                AND     A.DISUSE_DATE  BETWEEN #{startDate} AND #{endDate}
                <if test='procFg != null and procFg != ""'>
                    AND A.PROC_FG = #{procFg}
                </if>
                <if test='disuseReason != null and disuseReason != ""'>
                    AND A.REASON_CD = #{disuseReason}
                </if>
                ORDER
                BY      A.DISUSE_DATE DESC
                ,       A.SEQ_NO DESC
            </when>
        </choose>
    </select>

    <!-- 재고폐기 - 폐기 DTL 전부 삭제(본사) -->
    <!--
        TABLE    : TB_ST_HQ_DISUSE_DTL
        PARAM    : stockDisuseVO
        COMMENTS : 재고폐기 - 폐기일자, SEQ_NO 에 해당하는 DTL을 전부 삭제한다.
    -->
    <delete id="deleteAllDisuseDtl" parameterType="stockDisuseVO">
        /* USE : StockDisuseMapper.deleteAllDisuseDtl */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                DELETE  TB_ST_HQ_DISUSE_DTL
                WHERE   HQ_OFFICE_CD  = #{hqOfficeCd}
                AND     DISUSE_DATE   = #{disuseDate}
                AND     SEQ_NO        = #{seqNo}
            </when>
            <!-- 가맹점 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                DELETE  TB_ST_STORE_DISUSE_DTL
                WHERE   STORE_CD      = #{storeCd}
                AND     DISUSE_DATE   = #{disuseDate}
                AND     SEQ_NO        = #{seqNo}
            </when>
        </choose>
    </delete>

    <!-- 재고폐기 - 폐기 HD 삭제(본사) -->
    <!--
        TABLE    : TB_ST_HQ_DISUSE
        PARAM    : stockDisuseVO
        COMMENTS : 재고폐기 - 폐기일자, SEQ_NO 에 해당하는 HD를 삭제한다.
    -->
    <delete id="deleteDisuseHd" parameterType="stockDisuseVO">
        /* USE : StockDisuseMapper.deleteDisuseHd */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                DELETE  TB_ST_HQ_DISUSE
                WHERE   HQ_OFFICE_CD  = #{hqOfficeCd}
                AND     DISUSE_DATE   = #{disuseDate}
                AND     SEQ_NO        = #{seqNo}
            </when>
            <!-- 가맹점 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                DELETE  TB_ST_STORE_DISUSE
                WHERE   STORE_CD      = #{storeCd}
                AND     DISUSE_DATE   = #{disuseDate}
                AND     SEQ_NO        = #{seqNo}
            </when>
        </choose>
    </delete>

    <!-- 재고폐기 - 폐기 진행구분 및 제목 조회(본사) -->
    <!--
        TABLE    : TB_ST_HQ_DISUSE
        PARAM    : stockDisuseVO
        COMMENTS : 재고폐기 - 폐기 진행구분 및 제목을 조회한다.
    -->
    <select id="getProcFgCheck" parameterType="stockDisuseVO" resultType="DefaultMap">
        /* USE : StockDisuseMapper.getProcFgCheck */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                SELECT  A.PROC_FG
                ,       A.DISUSE_TITLE
                ,       A.DISUSE_STORAGE_CD
                ,       B.STORAGE_NM
                ,       A.REASON_CD AS DISUSE_REASON
                ,       A.DISUSE_STORE_CD
                ,       A.DISUSE_VENDR_CD
                ,       C.STORE_NM
                ,       D.VENDR_NM
                FROM    TB_ST_HQ_DISUSE A
                ,       TB_HQ_STORAGE B
                ,		TB_MS_STORE C
                ,		TB_HQ_VENDOR D
                WHERE   C.STORE_CD 			    = A.DISUSE_STORE_CD
                AND		D.HQ_OFFICE_CD 		    = A.HQ_OFFICE_CD
                AND		D.VENDR_CD 			    = A.DISUSE_VENDR_CD
                AND		A.HQ_OFFICE_CD          = #{hqOfficeCd}
                AND     A.DISUSE_DATE           = #{disuseDate}
                AND     A.SEQ_NO                = #{seqNo}
                AND     A.HQ_OFFICE_CD          = B.HQ_OFFICE_CD
                AND     A.DISUSE_STORAGE_CD     = B.STORAGE_CD
            </when>
            <!-- 가맹점 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                SELECT  tssd.PROC_FG, tssd.DISUSE_TITLE, tssd.DISUSE_STORAGE_CD, tms.STORAGE_NM, tssd.REASON_CD AS DISUSE_REASON
                FROM    TB_ST_STORE_DISUSE tssd
                ,       TB_MS_STORAGE               tms
                WHERE   tssd.STORE_CD      = #{storeCd}
                AND     tssd.DISUSE_DATE   = #{disuseDate}
                AND     tssd.SEQ_NO        = #{seqNo}
                AND		tssd.STORE_CD		= tms.STORE_CD
                AND		tssd.DISUSE_STORAGE_CD = tms.STORAGE_CD
            </when>
        </choose>
    </select>

    <!-- 실사관리 - 실사 상세 리스트 조회(본사) -->
    <!--
        TABLE    : TB_HQ_PRODUCT, TB_ST_HQ_ACTUAL_INSPECTION_DTL, TB_ST_HQ_STOCK_CUR, TB_ST_HQ_STOCK_MONTHLY
                 , TB_HQ_PRODUCT_BARCD, TB_ST_HQ_STOCK_DAILY
        PARAM    : stockAcinsVO
        COMMENTS : 실사관리 - 실사 상세 리스트를 조회한다.
    -->
    <select id="getSearchDisuseRegistList" parameterType="stockDisuseVO" resultType="DefaultMap">
        /* USE : StockDisuseMapper.getSearchDisuseRegistList */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                <include refid="CmmSQL.PagingTemplateHeader"/>
                SELECT	E.BARCD_CD
                , 		A.PROD_CD
                , 		D.PROD_NM
                , 		D.PO_UNIT_QTY
                ,		NVL	(
                                (
                                    SELECT 	MAX(SALE_UPRC) KEEP(DENSE_RANK FIRST ORDER BY REG_DT DESC)
                                    FROM 	TB_HQ_PRODUCT_SALE_PRICE
                                    WHERE 	HQ_OFFICE_CD 	= A.HQ_OFFICE_CD
                                    AND 	PROD_CD 		= A.PROD_CD
                                    AND 	#{disuseDate} BETWEEN START_DATE AND END_DATE
                                ), 0
                            ) AS SALE_UPRC
                ,       NVL(F.AVG_COST_UPRC, D.COST_UPRC) AS COST_UPRC
                ,       NVL(NVL(C.CURR_QTY, F.CURR_QTY), 0) AS CURR_QTY
                ,       C.DISUSE_QTY
                ,       C.DISUSE_AMT
                ,       C.REMARK
                ,       DECODE(C.PROD_CD, NULL, 'I', 'U') AS DISUSE_PROD_STATUS
                ,       D.LAST_COST_UPRC
                ,       A.SEQ
                <include refid="CmmSQL.PagingTemplateCount"/>
                FROM	TB_HQ_PRODUCT_VENDOR_STORE_DTL A
                ,		TB_ST_HQ_DISUSE B
                ,		TB_ST_HQ_DISUSE_DTL C
                ,		TB_MS_PRODUCT D
                ,		TB_MS_PRODUCT_BARCD E
                ,       (
                            SELECT  A.PROD_CD
                            , 		A.CURR_QTY
                            , 		B.AVG_COST_UPRC
                            FROM    TB_ST_HQ_STOCK_CUR A
                            ,       TB_ST_HQ_STOCK_MONTHLY B
                            WHERE   A.HQ_OFFICE_CD    	=   #{hqOfficeCd}
                            AND		A.STORAGE_CD		=	'999'   -- 전체재고용 창고코드를 999 씀 / 창고코드 확인
                            AND     B.IOSTOCK_YM  (+) 	=   SUBSTR(#{disuseDate}, 0, 6)
                            AND     B.HQ_OFFICE_CD(+) 	=   A.HQ_OFFICE_CD
                            AND     B.PROD_CD     (+) 	=   A.PROD_CD
                        )   F
                WHERE	B.HQ_OFFICE_CD      =	A.HQ_OFFICE_CD
                AND		B.DISUSE_STORE_CD 	=	A.STORE_CD
                AND		B.DISUSE_VENDR_CD 	=	A.VENDR_CD
                AND		C.HQ_OFFICE_CD  (+)	= 	A.HQ_OFFICE_CD
                AND		C.PROD_CD 		(+)	=	A.PROD_CD
                AND		C.DISUSE_DATE 	(+)	=	B.DISUSE_DATE
                AND		C.SEQ_NO 		(+)	=	B.SEQ_NO
                AND		C.SEQ			(+)	=	A.SEQ
                AND		D.STORE_CD			=	A.STORE_CD
                AND		D.PROD_CD			=	A.PROD_CD
                AND		E.STORE_CD		(+)	=	A.STORE_CD
                AND		E.PROD_CD		(+)	=	A.PROD_CD
                AND		F.PROD_CD		(+)	=	A.PROD_CD
                AND     A.HQ_OFFICE_CD      =   #{hqOfficeCd}
                AND     B.DISUSE_DATE       =   #{disuseDate}
                AND     B.SEQ_NO            =   #{seqNo}
                <if test='prodCd != null and prodCd != ""'>
                    AND A.PROD_CD LIKE '%'||#{prodCd}||'%'
                </if>
                <if test='prodNm != null and prodNm != ""'>
                    AND D.PROD_NM LIKE '%'||#{prodNm}||'%'
                </if>
                <if test='barcdCd != null and barcdCd != ""'>
                    AND E.BARCD_CD = #{barcdCd}
                </if>
                <if test='prodClassCd != null and prodClassCd != ""'>
                    AND D.PROD_CLASS_CD IN  (
                                                SELECT  PROD_CLASS_CD
                                                FROM    TB_HQ_PRODUCT_CLASS
                                                WHERE   HQ_OFFICE_CD = #{hqOfficeCd}
                                                START WITH PROD_CLASS_CD = #{prodClassCd} AND HQ_OFFICE_CD = #{hqOfficeCd}
                                                CONNECT BY
                                                PRIOR   PROD_CLASS_CD    = P_PROD_CLASS_CD  AND HQ_OFFICE_CD = #{hqOfficeCd}
                                            )
                </if>
                <if test='vendrCd != null and vendrCd != ""'>
                    AND A.VENDR_CD = #{vendrCd}
                </if>
                <if test='storeCd != null and storeCd != ""'>
                    AND A.STORE_CD = #{storeCd}
                </if>
                <if test='prodBarcdCd != null and prodBarcdCd != ""'>
                    AND (D.PROD_CD = #{prodBarcdCd} OR E.BARCD_CD = #{prodBarcdCd})
                </if>
                <if test='disuseFg == "Y"'>
                    AND C.DISUSE_QTY IS NOT NULL
                </if>
                <if test='disuseFg == "N"'>
                    AND C.DISUSE_QTY IS NULL
                </if>
                ORDER
                BY		A.PROD_CD
                ,       A.SEQ
                <include refid="CmmSQL.PagingTemplateBottom"/>
            </when>
            <!-- 가맹점 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                <include refid="CmmSQL.PagingTemplateHeader"/>
                SELECT	E.BARCD_CD
                , 		A.PROD_CD
                , 		D.PROD_NM
                , 		D.PO_UNIT_QTY
                ,		NVL	(
                (
                SELECT 	MAX(SALE_UPRC) KEEP(DENSE_RANK FIRST ORDER BY REG_DT DESC)
                FROM 	TB_HQ_PRODUCT_SALE_PRICE
                WHERE 	HQ_OFFICE_CD 	= A.HQ_OFFICE_CD
                AND 	PROD_CD 		= A.PROD_CD
                AND 	#{disuseDate} BETWEEN START_DATE AND END_DATE
                ), 0
                ) AS SALE_UPRC
                ,       NVL(F.AVG_COST_UPRC, D.COST_UPRC) AS COST_UPRC
                ,       NVL(NVL(C.CURR_QTY, F.CURR_QTY), 0) AS CURR_QTY
                ,       C.DISUSE_QTY
                ,       C.DISUSE_AMT
                ,       C.REMARK
                ,       DECODE(C.PROD_CD, NULL, 'I', 'U') AS DISUSE_PROD_STATUS
                ,       D.LAST_COST_UPRC
                ,       A.DISUSE_VENDR_CD
                ,       A.DISUSE_STORE_CD
                ,       A.SEQ
                <include refid="CmmSQL.PagingTemplateCount"/>
                FROM	TB_HQ_PRODUCT_VENDOR_STORE_DTL A
                ,		TB_ST_HQ_DISUSE B
                ,		TB_ST_HQ_DISUSE_DTL C
                ,		TB_MS_PRODUCT D
                ,		TB_MS_PRODUCT_BARCD E
                ,       (
                SELECT  A.PROD_CD
                , 		A.CURR_QTY
                , 		B.AVG_COST_UPRC
                FROM    TB_ST_HQ_STOCK_CUR A
                ,       TB_ST_HQ_STOCK_MONTHLY B
                WHERE   A.HQ_OFFICE_CD    	=   #{hqOfficeCd}
                AND		A.STORAGE_CD		=	'999'   -- 전체재고용 창고코드를 999 씀 / 창고코드 확인
                AND     B.IOSTOCK_YM  (+) 	=   SUBSTR(#{disuseDate}, 0, 6)
                AND     B.HQ_OFFICE_CD(+) 	=   A.HQ_OFFICE_CD
                AND     B.PROD_CD     (+) 	=   A.PROD_CD
                )   F
                WHERE	B.HQ_OFFICE_CD      =	A.HQ_OFFICE_CD
                AND		B.DISUSE_STORE_CD 	=	A.STORE_CD
                AND		B.DISUSE_VENDR_CD 	=	A.VENDR_CD
                AND		C.HQ_OFFICE_CD  (+)	= 	A.HQ_OFFICE_CD
                AND		C.PROD_CD 		(+)	=	A.PROD_CD
                AND		C.DISUSE_DATE 	(+)	=	B.DISUSE_DATE
                AND		C.SEQ_NO 		(+)	=	B.SEQ_NO
                AND		C.SEQ			(+)	=	A.SEQ
                AND		D.STORE_CD			=	A.STORE_CD
                AND		D.PROD_CD			=	A.PROD_CD
                AND		E.STORE_CD		(+)	=	A.STORE_CD
                AND		E.PROD_CD		(+)	=	A.PROD_CD
                AND		F.PROD_CD		(+)	=	A.PROD_CD
                AND     A.HQ_OFFICE_CD      =   #{hqOfficeCd}
                AND     B.DISUSE_DATE       =   #{disuseDate}
                AND     B.SEQ_NO            =   #{seqNo}
                <if test='prodCd != null and prodCd != ""'>
                    AND A.PROD_CD LIKE '%'||#{prodCd}||'%'
                </if>
                <if test='prodNm != null and prodNm != ""'>
                    AND D.PROD_NM LIKE '%'||#{prodNm}||'%'
                </if>
                <if test='barcdCd != null and barcdCd != ""'>
                    AND E.BARCD_CD = #{barcdCd}
                </if>
                <if test='prodClassCd != null and prodClassCd != ""'>
                    AND D.PROD_CLASS_CD IN  (
                    SELECT  PROD_CLASS_CD
                    FROM    TB_HQ_PRODUCT_CLASS
                    WHERE   HQ_OFFICE_CD = #{hqOfficeCd}
                    START WITH PROD_CLASS_CD = #{prodClassCd} AND HQ_OFFICE_CD = #{hqOfficeCd}
                    CONNECT BY
                    PRIOR   PROD_CLASS_CD    = P_PROD_CLASS_CD  AND HQ_OFFICE_CD = #{hqOfficeCd}
                    )
                </if>
                <if test='vendrCd != null and vendrCd != ""'>
                    AND A.VENDR_CD = #{vendrCd}
                </if>
                <if test='storeCd != null and storeCd != ""'>
                    AND A.STORE_CD = #{storeCd}
                </if>
                <if test='prodBarcdCd != null and prodBarcdCd != ""'>
                    AND (D.PROD_CD = #{prodBarcdCd} OR E.BARCD_CD = #{prodBarcdCd})
                </if>
                <if test='disuseFg == "Y"'>
                    AND C.DISUSE_QTY IS NOT NULL
                </if>
                <if test='disuseFg == "N"'>
                    AND C.DISUSE_QTY IS NULL
                </if>
                ORDER
                BY		A.PROD_CD
                ,       A.SEQ
                <include refid="CmmSQL.PagingTemplateBottom"/>
            </when>
        </choose>
    </select>

    <!-- 재고폐기 - 폐기등록 신규 SEQ 조회(본사) -->
    <!--
        TABLE    : TB_ST_HQ_DISUSE
        PARAM    : stockDisuseVO
        COMMENTS : 재고폐기 - 폐기등록 신규 SEQ를 조회한다.
    -->
    <select id="getMaxSeqNo" parameterType="stockDisuseVO" resultType="String">
        /* USE : StockDisuseMapper.getMaxSeqNo */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                SELECT  NVL(MAX(tshd.SEQ_NO), 0)+1 AS SEQ_NO
                FROM    TB_ST_HQ_DISUSE tshd
                WHERE   tshd.HQ_OFFICE_CD  =  #{hqOfficeCd}
                AND     tshd.DISUSE_DATE   =  #{disuseDate}
            </when>
            <!-- 가맹점 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                SELECT  NVL(MAX(tssd.SEQ_NO), 0)+1 AS SEQ_NO
                FROM    TB_ST_STORE_DISUSE tssd
                WHERE   tssd.STORE_CD      =  #{storeCd}
                AND     tssd.DISUSE_DATE   =  #{disuseDate}
            </when>
        </choose>
    </select>

    <!-- 재고폐기 - 폐기 상품 DTL 삭제(본사) -->
    <!--
        TABLE    : TB_ST_HQ_DISUSE_DTL
        PARAM    : stockDisuseVO
        COMMENTS : 재고폐기 - 폐기 상품 DTL을 삭제한다.
    -->
    <delete id="deleteDisuseDtl" parameterType="stockDisuseVO">
        /* USE : StockDisuseMapper.deleteDisuseDtl */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                DELETE  TB_ST_HQ_DISUSE_DTL
                WHERE   HQ_OFFICE_CD    = #{hqOfficeCd}
                AND     DISUSE_DATE     = #{disuseDate}
                AND     SEQ_NO          = #{seqNo}
                AND     PROD_CD         = #{prodCd}
                AND     SEQ             = #{seq}
            </when>
            <!-- 가맹점 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                DELETE  TB_ST_STORE_DISUSE_DTL
                WHERE   STORE_CD      = #{storeCd}
                AND     DISUSE_DATE   = #{disuseDate}
                AND     SEQ_NO        = #{seqNo}
                AND     PROD_CD       = #{prodCd}
            </when>
        </choose>
    </delete>

    <!-- 재고폐기 - 폐기 상품 DTL 등록(본사) -->
    <!--
        TABLE    : TB_ST_HQ_DISUSE_DTL
        PARAM    : stockDisuseVO
        COMMENTS : 재고폐기 - 폐기 상품 DTL을 등록한다.
    -->
    <insert id="insertDisuseDtl" parameterType="stockDisuseVO">
        /* USE : StockDisuseMapper.insertDisuseDtl */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                INSERT INTO TB_ST_HQ_DISUSE_DTL
                (
                    HQ_OFFICE_CD
                ,   DISUSE_DATE
                ,   SEQ_NO
                ,   HQ_BRAND_CD
                ,   PROD_CD
                ,   COST_UPRC
                ,   PO_UNIT_QTY
                ,   CURR_QTY
                ,   DISUSE_QTY
                ,   DISUSE_AMT
                ,   REMARK
                ,   REG_DT
                ,   REG_ID
                ,   MOD_DT
                ,   MOD_ID
                ,   SEQ
                )
                VALUES
                (
                    #{hqOfficeCd}
                ,   #{disuseDate}
                ,   #{seqNo}
                ,   #{hqBrandCd}
                ,   #{prodCd}
                ,   #{costUprc}
                ,   #{poUnitQty}
                ,   #{currQty}
                ,   #{disuseQty}
                ,   #{disuseAmt}
                ,   #{remark}
                ,   #{regDt}
                ,   #{regId}
                ,   #{modDt}
                ,   #{modId}
                ,   #{seq}
                )
            </when>
            <!-- 가맹점 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                INSERT INTO TB_ST_STORE_DISUSE_DTL
                (
                    STORE_CD
                ,   DISUSE_DATE
                ,   SEQ_NO
                ,   HQ_BRAND_CD
                ,   PROD_CD
                ,   COST_UPRC
                ,   PO_UNIT_QTY
                ,   CURR_QTY
                ,   DISUSE_QTY
                ,   DISUSE_AMT
                ,   REMARK
                ,   REG_DT
                ,   REG_ID
                ,   MOD_DT
                ,   MOD_ID
                )
                VALUES
                (
                    #{storeCd}
                ,   #{disuseDate}
                ,   #{seqNo}
                ,   #{hqBrandCd}
                ,   #{prodCd}
                ,   #{costUprc}
                ,   #{poUnitQty}
                ,   #{currQty}
                ,   #{disuseQty}
                ,   #{disuseAmt}
                ,   #{remark}
                ,   #{regDt}
                ,   #{regId}
                ,   #{modDt}
                ,   #{modId}
                )
            </when>
        </choose>
    </insert>

    <!-- 재고폐기 - 폐기 상품 DTL 수정(본사) -->
    <!--
        TABLE    : TB_ST_HQ_DISUSE_DTL
        PARAM    : stockDisuseVO
        COMMENTS : 재고폐기 - 폐기 상품 DTL을 수정한다.
    -->
    <update id="updateDisuseDtl" parameterType="stockDisuseVO">
        /* USE : StockDisuseMapper.updateDisuseDtl */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                UPDATE  TB_ST_HQ_DISUSE_DTL
                SET     DISUSE_QTY  = #{disuseQty}
                ,       DISUSE_AMT  = #{disuseAmt}
                ,       REMARK      = #{remark}
                WHERE   HQ_OFFICE_CD    = #{hqOfficeCd}
                AND     DISUSE_DATE     = #{disuseDate}
                AND     SEQ_NO          = #{seqNo}
                AND     PROD_CD         = #{prodCd}
                AND     SEQ             = #{seq}
            </when>
            <!-- 가맹점 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                UPDATE  TB_ST_STORE_DISUSE_DTL
                SET     DISUSE_QTY = #{disuseQty}
                ,       DISUSE_AMT = #{disuseAmt}
                ,       REMARK     = #{remark}
                WHERE   STORE_CD      = #{storeCd}
                AND     DISUSE_DATE   = #{disuseDate}
                AND     SEQ_NO        = #{seqNo}
                AND     PROD_CD       = #{prodCd}
            </when>
        </choose>
    </update>

    <!-- 재고폐기 - 폐기 HD 등록(본사) -->
    <!--
        TABLE    : TB_ST_HQ_DISUSE, TB_ST_HQ_DISUSE_DTL
        PARAM    : stockDisuseVO
        COMMENTS : 재고폐기 - 폐기 HD을 등록한다.
    -->
    <insert id="insertDisuseHd" parameterType="stockDisuseVO">
        /* USE : StockDisuseMapper.insertDisuseHd */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                INSERT INTO TB_ST_HQ_DISUSE
                (
                HQ_OFFICE_CD
                ,   STORAGE_CD
                ,   DISUSE_DATE
                ,   SEQ_NO
                ,   DISUSE_TITLE
                ,   PROC_FG
                ,   DISUSE_STORAGE_CD
                ,   DTL_CNT
                ,   TOT_DISUSE_AMT
                ,   REG_DT
                ,   REG_ID
                ,   MOD_DT
                ,   MOD_ID
                ,   REASON_CD
                ,   DISUSE_VENDR_CD
                ,   DISUSE_STORE_CD
                )
                SELECT  #{hqOfficeCd}
                ,       #{storageCd}
                ,       #{disuseDate}
                ,       #{seqNo}
                ,       #{disuseTitle}
                ,       #{procFg}
                ,       #{disuseStorageCd}
                ,      tshdd.DTL_CNT
                ,       tshdd.TOT_DISUSE_AMT
                ,       #{regDt}
                ,       #{regId}
                ,       #{modDt}
                ,       #{modId}
                ,       #{disuseReason}
                ,       #{vendrCd}
                ,       #{storeCd}
                FROM    DUAL a
                ,       (
                            SELECT  SUM(DTL_CNT) AS DTL_CNT, SUM(TOT_DISUSE_AMT) AS TOT_DISUSE_AMT
                            FROM
                            (
                            SELECT  0 AS DTL_CNT
                            ,       0 AS TOT_DISUSE_AMT
                            FROM    dual
                            UNION ALL
                            SELECT  NVL(COUNT(tshdd.PROD_CD), 0) AS DTL_CNT
                            ,       NVL(SUM(tshdd.DISUSE_AMT), 0) AS TOT_DISUSE_AMT
                            FROM    TB_ST_HQ_DISUSE_DTL tshdd
                            WHERE   tshdd.HQ_OFFICE_CD  =   #{hqOfficeCd}
                            AND     tshdd.DISUSE_DATE   =   #{disuseDate}
                            AND     tshdd.SEQ_NO        =   #{seqNo}
                            GROUP
                            BY      tshdd.HQ_OFFICE_CD
                            ,       #{storageCd}
                            ,       tshdd.DISUSE_DATE
                            ,       tshdd.SEQ_NO
                            ,       #{disuseTitle}
                            ,       #{procFg}
                            ,       #{regDt}
                            ,       #{regId}
                            ,       #{modDt}
                            ,       #{modId}
                            )
                        ) tshdd
            </when>
            <!-- 가맹점 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                INSERT INTO TB_ST_STORE_DISUSE
                (
                    STORE_CD
                ,   STORAGE_CD
                ,   DISUSE_DATE
                ,   SEQ_NO
                ,   DISUSE_TITLE
                ,   PROC_FG
                ,   DISUSE_STORAGE_CD
                ,   DTL_CNT
                ,   TOT_DISUSE_AMT
                ,   REG_DT
                ,   REG_ID
                ,   MOD_DT
                ,   MOD_ID
                ,   REASON_CD
                )
                SELECT  #{storeCd}
                ,       #{storageCd}
                ,       #{disuseDate}
                ,       #{seqNo}
                ,       #{disuseTitle}
                ,       #{procFg}
                ,       #{disuseStorageCd}
                ,       tssdd.DTL_CNT
                ,       tssdd.TOT_DISUSE_AMT
                ,       #{regDt}
                ,       #{regId}
                ,       #{modDt}
                ,       #{modId}
                ,       #{disuseReason}
                FROM    DUAL a
                ,       (
                            SELECT  SUM(DTL_CNT) AS DTL_CNT
                            ,       SUM(TOT_DISUSE_AMT) AS TOT_DISUSE_AMT
                            FROM
                                    (
                                        SELECT  0 AS DTL_CNT
                                        ,       0 AS TOT_DISUSE_AMT
                                        FROM    dual
                                        UNION ALL
                                        SELECT  NVL(COUNT(tssdd.PROD_CD), 0) AS DTL_CNT
                                        ,       NVL(SUM(tssdd.DISUSE_AMT), 0) AS TOT_DISUSE_AMT
                                        FROM    TB_ST_STORE_DISUSE_DTL tssdd
                                        WHERE   tssdd.STORE_CD  =   #{storeCd}
                                        AND     tssdd.DISUSE_DATE   =   #{disuseDate}
                                        AND     tssdd.SEQ_NO        =   #{seqNo}
                                        GROUP
                                        BY      tssdd.STORE_CD
                                        ,       #{storageCd}
                                        ,       tssdd.DISUSE_DATE
                                        ,       tssdd.SEQ_NO
                                        ,       #{disuseTitle}
                                        ,       #{procFg}
                                        ,       #{regDt}
                                        ,       #{regId}
                                        ,       #{modDt}
                                        ,       #{modId}
                                    )
                        ) tssdd
            </when>
        </choose>
    </insert>

    <!-- 재고폐기 - 폐기 HD 수정(본사) -->
    <!--
        TABLE    : TB_ST_HQ_DISUSE
        PARAM    : stockDisuseVO
        COMMENTS : 재고폐기 - 폐기 HD을 수정한다.
    -->
    <update id="updateDisuseHd" parameterType="stockDisuseVO">
        /* USE : StockDisuseMapper.updateDisuseHd */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                UPDATE  TB_ST_HQ_DISUSE
                SET     (
                            DTL_CNT
                        ,   TOT_DISUSE_AMT
                        )
                        =
                        (
                            SELECT  NVL(COUNT(tshdd.PROD_CD), 0)
                            ,       NVL(SUM(tshdd.DISUSE_AMT), 0)
                            FROM    TB_ST_HQ_DISUSE_DTL tshdd
                            WHERE   tshdd.HQ_OFFICE_CD  =   #{hqOfficeCd}
                            AND     tshdd.DISUSE_DATE   =   #{disuseDate}
                            AND     tshdd.SEQ_NO        =   #{seqNo}
                        )
                ,       DISUSE_TITLE = #{disuseTitle}
                ,       REASON_CD = #{disuseReason}
                ,       DISUSE_STORAGE_CD = #{disuseStorageCd}
                ,       PROC_FG      = #{procFg}
                ,       CONFM_DATE   = DECODE(#{procFg}, '0', NULL, SUBSTR(#{modDt}, 0, 8))
                ,       CONFM_ID     = DECODE(#{procFg}, '0', NULL, #{modId})
                ,       MOD_DT       = #{modDt}
                ,       MOD_ID       = #{modId}
                WHERE   HQ_OFFICE_CD  = #{hqOfficeCd}
                AND     DISUSE_DATE   = #{disuseDate}
                AND     SEQ_NO        = #{seqNo}
            </when>
            <!-- 가맹점 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                UPDATE  TB_ST_STORE_DISUSE
                SET     (
                            DTL_CNT
                        ,   TOT_DISUSE_AMT
                        )
                        =
                        (
                            SELECT  NVL(COUNT(tssdd.PROD_CD), 0)
                            ,       NVL(SUM(tssdd.DISUSE_AMT), 0)
                            FROM    TB_ST_STORE_DISUSE_DTL tssdd
                            WHERE   tssdd.STORE_CD      =   #{storeCd}
                            AND     tssdd.DISUSE_DATE   =   #{disuseDate}
                            AND     tssdd.SEQ_NO        =   #{seqNo}
                        )
                ,       DISUSE_TITLE = #{disuseTitle}
                ,       REASON_CD = #{disuseReason}
                ,       DISUSE_STORAGE_CD = #{disuseStorageCd}
                ,       PROC_FG      = #{procFg}
                ,       CONFM_DATE   = DECODE(#{procFg}, '0', NULL, SUBSTR(#{modDt}, 0, 8))
                ,       CONFM_ID     = DECODE(#{procFg}, '0', NULL, #{modId})
                ,       MOD_DT       = #{modDt}
                ,       MOD_ID       = #{modId}
                WHERE   STORE_CD      = #{storeCd}
                AND     DISUSE_DATE   = #{disuseDate}
                AND     SEQ_NO        = #{seqNo}
            </when>
        </choose>
    </update>

    <!-- 재고폐기 - 폐기 상세 리스트 조회(본사) -->
    <!--
        TABLE    : TB_HQ_PRODUCT, TB_ST_HQ_DISUSE_DTL, TB_ST_HQ_STOCK_CUR, TB_ST_HQ_STOCK_MONTHLY
                 , TB_HQ_PRODUCT_BARCD, TB_ST_HQ_STOCK_DAILY
        PARAM    : stockDisuseVO
        COMMENTS : 재고폐기 - 폐기 상세 리스트를 조회한다.
    -->
    <select id="getSearchDisuseDtlList" parameterType="stockDisuseVO" resultType="DefaultMap">
        /* USE : StockDisuseMapper.getSearchDisuseDtlList */
        <include refid="CmmSQL.PagingTemplateHeader"/>
        SELECT  E.BARCD_CD
        ,       C.PROD_CD
        ,       C.PROD_NM
        ,       C.PO_UNIT_QTY
        ,       NVL (
                        (
                            SELECT  MAX(SALE_UPRC) KEEP(DENSE_RANK FIRST ORDER BY REG_DT DESC)
                            FROM    TB_HQ_PRODUCT_SALE_PRICE
                            WHERE   HQ_OFFICE_CD = C.HQ_OFFICE_CD
                            AND     PROD_CD = C.PROD_CD
                            AND     #{disuseDate} BETWEEN START_DATE AND END_DATE
                        ), 0
                    ) AS SALE_UPRC
        ,       NVL(D.AVG_COST_UPRC, C.COST_UPRC) AS COST_UPRC
        ,       B.CURR_QTY
        ,       B.DISUSE_QTY
        ,       B.DISUSE_AMT
        ,       B.REMARK
        ,       'U' AS DISUSE_PROD_STATUS
        ,		A.DISUSE_STORAGE_CD
        ,       A.DISUSE_STORE_CD
        ,       A.DISUSE_VENDR_CD
        ,       C.LAST_COST_UPRC
        ,       B.SEQ
        <include refid="CmmSQL.PagingTemplateCount"/>
        FROM    TB_ST_HQ_DISUSE A
        ,       TB_ST_HQ_DISUSE_DTL B
        ,       TB_HQ_PRODUCT C
        ,       (
                    SELECT  A.PROD_CD
                    ,       A.AVG_COST_UPRC
                    ,       (A.BASE_QTY + NVL(IOSTOCK_QTY, 0)) AS CMPT_DATE_QTY
                    FROM    (
                                SELECT  A.IOSTOCK_YM, A.HQ_OFFICE_CD
                                ,       A.PROD_CD, A.BASE_QTY, A.AVG_COST_UPRC
                                FROM    TB_ST_HQ_STOCK_MONTHLY A
                                WHERE   A.HQ_OFFICE_CD  =   #{hqOfficeCd}
                                AND     A.IOSTOCK_YM    =   SUBSTR(#{disuseDate}, 0, 6)
                            ) A
                    ,       (
                                SELECT  A.IOSTOCK_DATE, A.HQ_OFFICE_CD
                                ,       A.PROD_CD
                                ,       SUM(A.IOSTOCK_QTY) AS IOSTOCK_QTY
                                FROM    TB_ST_HQ_STOCK_DAILY A
                                WHERE   A.HQ_OFFICE_CD  =   #{hqOfficeCd}
                                AND     A.IOSTOCK_DATE  =   #{disuseDate}
                                GROUP
                                BY      A.IOSTOCK_DATE, A.HQ_OFFICE_CD
                                ,       A.PROD_CD
                            ) B
                    WHERE   B.PROD_CD(+)=   A.PROD_CD
                )   D
        ,       TB_HQ_PRODUCT_BARCD E
        WHERE   B.HQ_OFFICE_CD      =   #{hqOfficeCd}
        AND     B.DISUSE_DATE       =   #{disuseDate}
        AND     B.SEQ_NO            =   #{seqNo}
        AND		B.HQ_OFFICE_CD     	=   A.HQ_OFFICE_CD
        AND     B.DISUSE_DATE       =   A.DISUSE_DATE
        AND     B.SEQ_NO           	=   A.SEQ_NO
        AND     B.HQ_OFFICE_CD      =   C.HQ_OFFICE_CD
        AND     B.PROD_CD           =   C.PROD_CD
        AND     D.PROD_CD       (+) =   B.PROD_CD
        AND     E.HQ_OFFICE_CD   (+) =   B.HQ_OFFICE_CD
        AND     E.PROD_CD        (+) =   B.PROD_CD
        ORDER
        BY      B.PROD_CD
        ,       B.SEQ
        <include refid="CmmSQL.PagingTemplateBottom"/>
    </select>

    <!--  재고폐기 엑셀업로드 - 기존 데이터중 엑셀업로드 한 데이터와 같은 상품 삭제 -->
    <!--
        TABLE    : TB_ST_HQ_DISUSE_DTL, TB_ST_STORE_TEMP_EXCEL
        PARAM    : stockAcinsVO
        COMMENTS : 재고폐기 엑셀업로드 - 기존 데이터중 엑셀업로드 한 데이터와 같은 상품은 삭제한다.
    -->
    <delete id="deleteDisuseToExcelUploadData" parameterType="StockAcinsVO">
        /* USE : StockDisuseMapper.deleteDisuseToExcelUploadData */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                DELETE  TB_ST_HQ_DISUSE_DTL
                WHERE   HQ_OFFICE_CD    = #{hqOfficeCd}
                AND     DISUSE_DATE     = #{date}
                AND     SEQ_NO          = #{seqNo}
                AND     PROD_CD         IN  (
                                                SELECT  PROD_CD
                                                FROM    TB_ST_STORE_TEMP_EXCEL
                                                WHERE   SESSION_ID  = #{sessionId}
                                                AND     PROD_CD     IS NOT NULL
                                            )
                AND     SEQ             =   (
                                                SELECT  NVL(MAX(SEQ),0) AS SEQ
                                                FROM    TB_HQ_PRODUCT_VENDOR_STORE_DTL
                                                WHERE   HQ_OFFICE_CD    =   #{hqOfficeCd}
                                                AND     PROD_CD         IN  (
                                                                                SELECT  PROD_CD
                                                                                FROM    TB_ST_STORE_TEMP_EXCEL
                                                                                WHERE   SESSION_ID  = #{sessionId}
                                                                                AND     PROD_CD     IS NOT NULL
                                                                            )
                                                AND     (VENDR_CD, STORE_CD) IN (
                                                                                    SELECT  DISUSE_VENDR_CD
                                                                                    ,       DISUSE_STORE_CD
                                                                                    FROM    TB_ST_HQ_DISUSE
                                                                                    WHERE   HQ_OFFICE_CD    = #{hqOfficeCd}
                                                                                    AND     DISUSE_DATE     = #{date}
                                                                                    AND     SEQ_NO          = #{seqNo}
                                                                                )
                                            )
            </when>
            <!-- 가맹점 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                DELETE  TB_ST_STORE_DISUSE_DTL
                WHERE   STORE_CD      = #{storeCd}
                AND     DISUSE_DATE   = #{date}
                AND     SEQ_NO        = #{seqNo}
                AND     PROD_CD       IN  ( SELECT  PROD_CD
                FROM    TB_ST_STORE_TEMP_EXCEL
                WHERE   SESSION_ID  = #{sessionId}
                AND     PROD_CD     IS NOT NULL
                )
            </when>
        </choose>
    </delete>

    <!--  재고폐기 엑셀업로드 - 엑셀업로드 한 수량을 폐기수량으로 입력 -->
    <!--
        TABLE    : TB_ST_HQ_DISUSE_DTL, TB_ST_STORE_TEMP_EXCEL, TB_HQ_PRODUCT, TB_ST_HQ_STOCK_CUR, TB_ST_HQ_STOCK_MONTHLY
                   TB_ST_STORE_DISUSE_DTL, TB_ST_STORE_TEMP_EXCEL, TB_MS_PRODUCT, TB_ST_STORE_STOCK_CUR, TB_ST_STORE_STOCK_MONTHLY
        PARAM    : stockAcinsVO
        COMMENTS : 재고폐기 엑셀업로드 - 엑셀업로드 한 수량을 폐기수량으로 입력한다.
    -->
    <insert id="insertDisuseToExcelUploadData" parameterType="StockAcinsVO">
        /* USE : StockDisuseMapper.insertDisuseToExcelUploadData */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                MERGE INTO TB_ST_HQ_DISUSE_DTL A
                USING
                    (
                        SELECT  #{hqOfficeCd} AS HQ_OFFICE_CD
                        ,       #{date} AS DISUSE_DATE
                        ,       #{seqNo}  AS SEQ_NO
                        ,       '00' AS HQ_BRAND_CD
                        ,       tpte.PROD_CD
                        ,       tpte.COST_UPRC AS COST_UPRC
                        ,       tpte.PO_UNIT_QTY
                        ,       NVL(tsssc.CURR_QTY,0) AS CURR_QTY
                        ,       tpte.QTY AS DISUSE_QTY
                        ,       tpte.COST_UPRC * tpte.QTY AS DISUSE_AMT
                        ,       tpte.REMARK
                        ,       #{regDt} AS REG_DT
                        ,       #{regId} AS REG_ID
                        ,       #{modDt} AS MOD_DT
                        ,       #{modId} AS MOD_ID
                        ,       (
                                    SELECT  NVL(MAX(SEQ),0) AS SEQ
                                    FROM    TB_HQ_PRODUCT_VENDOR_STORE_DTL
                                    WHERE   HQ_OFFICE_CD    = #{hqOfficeCd}
                                    AND     PROD_CD         = tpte.PROD_CD
                                    AND     (VENDR_CD, STORE_CD) IN (
                                                                        SELECT  DISUSE_VENDR_CD
                                                                        ,       DISUSE_STORE_CD
                                                                        FROM    TB_ST_HQ_DISUSE
                                                                        WHERE   HQ_OFFICE_CD    = #{hqOfficeCd}
                                                                        AND     DISUSE_DATE     = #{date}
                                                                        AND     SEQ_NO          = #{seqNo}
                                                                    )
                                )   AS SEQ
                        FROM
                                (
                                    SELECT  tpte.HQ_OFFICE_CD
                                    ,       tpte.PROD_CD
                                    ,       thp.PO_UNIT_QTY
                                    ,       NVL(MAX(thp.COST_UPRC), 0) AS COST_UPRC
                                    ,       SUM(tpte.QTY)    AS QTY
                                    ,       MAX(tpte.REMARK) AS REMARK
                                    FROM    TB_ST_STORE_TEMP_EXCEL tpte
                                    ,       TB_HQ_PRODUCT thp
                                    WHERE   tpte.SESSION_ID     =   #{sessionId}
                                    AND     tpte.PROD_CD        IS NOT  NULL
                                    AND     thp.HQ_OFFICE_CD    =   #{hqOfficeCd}
                                    AND     thp.PROD_CD         =   tpte.PROD_CD
                                    AND     thp.STOCK_PROD_YN   =   'Y'
                                    AND     thp.USE_YN          =   'Y'
                                    GROUP
                                    BY      tpte.HQ_OFFICE_CD
                                    ,       tpte.PROD_CD
                                    ,       thp.PO_UNIT_QTY
                                ) tpte
                        ,       TB_ST_HQ_STOCK_CUR tsssc
                        WHERE   tsssc.HQ_OFFICE_CD  (+) =   tpte.HQ_OFFICE_CD
                        AND     tsssc.storage_cd    (+) =   '999'
                        AND     tsssc.PROD_CD       (+) =   tpte.PROD_CD
                    ) B
                ON  (
                            A.HQ_OFFICE_CD  = B.HQ_OFFICE_CD
                        AND A.DISUSE_DATE   = B.DISUSE_DATE
                        AND A.SEQ_NO        = B.SEQ_NO
                        AND A.PROD_CD       = B.PROD_CD
                        AND A.SEQ           = B.SEQ
                    )
                WHEN MATCHED THEN
                UPDATE
                SET
                    A.COST_UPRC     = B.COST_UPRC
                ,   A.PO_UNIT_QTY   = B.PO_UNIT_QTY
                ,   A.CURR_QTY      = B.CURR_QTY
                ,   A.DISUSE_QTY    = A.DISUSE_QTY + B.DISUSE_QTY
                ,   A.DISUSE_AMT    = A.DISUSE_AMT + B.DISUSE_AMT
                ,   A.REMARK        = B.REMARK
                ,   A.MOD_DT        = B.MOD_DT
                ,   A.MOD_ID        = B.MOD_ID
                WHEN NOT MATCHED THEN
                INSERT
                (
                    A.HQ_OFFICE_CD
                ,   A.DISUSE_DATE
                ,   A.SEQ_NO
                ,   A.HQ_BRAND_CD
                ,   A.PROD_CD
                ,   A.COST_UPRC
                ,   A.PO_UNIT_QTY
                ,   A.CURR_QTY
                ,   A.DISUSE_QTY
                ,   A.DISUSE_AMT
                ,   A.REMARK
                ,   A.REG_DT
                ,   A.REG_ID
                ,   A.MOD_DT
                ,   A.MOD_ID
                ,   A.SEQ
                )
                VALUES
                (
                    B.HQ_OFFICE_CD
                ,   B.DISUSE_DATE
                ,   B.SEQ_NO
                ,   B.HQ_BRAND_CD
                ,   B.PROD_CD
                ,   B.COST_UPRC
                ,   B.PO_UNIT_QTY
                ,   B.CURR_QTY
                ,   B.DISUSE_QTY
                ,   B.DISUSE_AMT
                ,   B.REMARK
                ,   B.REG_DT
                ,   B.REG_ID
                ,   B.MOD_DT
                ,   B.MOD_ID
                ,   B.SEQ
                )
            </when>
            <!-- 가맹점 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                MERGE INTO TB_ST_STORE_DISUSE_DTL A
                USING (
                SELECT #{storeCd} AS STORE_CD
                , #{date} AS DISUSE_DATE
                , #{seqNo} AS SEQ_NO
                , '00' AS HQ_BRAND_CD
                , tpte.PROD_CD
                , tpte.COST_UPRC AS COST_UPRC
                , tpte.PO_UNIT_QTY
                , NVL(tsssc.CURR_QTY,0) AS CURR_QTY
                , tpte.QTY AS DISUSE_QTY
                , tpte.COST_UPRC * tpte.QTY AS DISUSE_AMT
                , tpte.REMARK
                , #{regDt} AS REG_DT
                , #{regId} AS REG_ID
                , #{modDt} AS MOD_DT
                , #{modId} AS MOD_ID
                FROM ( SELECT tpte.STORE_CD
                , tpte.PROD_CD
                , tmp.PO_UNIT_QTY
                , NVL(MAX(tmp.COST_UPRC), 0) AS COST_UPRC
                , SUM(tpte.QTY) AS QTY
                , MAX(tpte.REMARK) AS REMARK
                FROM TB_ST_STORE_TEMP_EXCEL tpte
                , TB_MS_PRODUCT tmp
                WHERE tpte.SESSION_ID = #{sessionId}
                AND tpte.PROD_CD IS NOT NULL
                AND tmp.STORE_CD = #{storeCd}
                AND tmp.PROD_CD = tpte.PROD_CD
                AND tmp.STOCK_PROD_YN = 'Y'
                AND tmp.USE_YN = 'Y'
                GROUP
                BY tpte.STORE_CD
                , tpte.PROD_CD
                , tmp.PO_UNIT_QTY
                ) tpte
                ,       TB_ST_STORE_STOCK_CUR tsssc
                WHERE   tsssc.STORE_CD      (+) =   tpte.STORE_CD
                AND     tsssc.storage_cd    (+) =   '999'
                AND     tsssc.PROD_CD       (+) =   tpte.PROD_CD
                ) B
                ON (
                A.STORE_CD = B.STORE_CD
                AND A.DISUSE_DATE = B.DISUSE_DATE
                AND A.SEQ_NO = B.SEQ_NO
                AND A.PROD_CD = B.PROD_CD
                )
                WHEN MATCHED THEN
                UPDATE
                SET
                A.COST_UPRC = B.COST_UPRC,
                A.PO_UNIT_QTY = B.PO_UNIT_QTY,
                A.CURR_QTY = B.CURR_QTY,
                A.DISUSE_QTY = A.DISUSE_QTY + B.DISUSE_QTY,
                A.DISUSE_AMT = A.DISUSE_AMT + B.DISUSE_AMT,
                A.REMARK = B.REMARK,
                A.REG_DT = B.REG_DT,
                A.REG_ID = B.REG_ID,
                A.MOD_DT = B.MOD_DT,
                A.MOD_ID = B.MOD_ID
                WHEN NOT MATCHED THEN
                INSERT
                ( A.STORE_CD
                , A.DISUSE_DATE
                , A.SEQ_NO
                , A.HQ_BRAND_CD
                , A.PROD_CD
                , A.COST_UPRC
                , A.PO_UNIT_QTY
                , A.CURR_QTY
                , A.DISUSE_QTY
                , A.DISUSE_AMT
                , A.REMARK
                , A.REG_DT
                , A.REG_ID
                , A.MOD_DT
                , A.MOD_ID
                ) VALUES (
                B.STORE_CD
                , B.DISUSE_DATE
                , B.SEQ_NO
                , B.HQ_BRAND_CD
                , B.PROD_CD
                , B.COST_UPRC
                , B.PO_UNIT_QTY
                , B.CURR_QTY
                , B.DISUSE_QTY
                , B.DISUSE_AMT
                , B.REMARK
                , B.REG_DT
                , B.REG_ID
                , B.MOD_DT
                , B.MOD_ID
                )
            </when>
        </choose>
    </insert>

    <!--  재고폐기 엑셀업로드 - 정상 입력된 데이터 TEMP 테이블에서 삭제 -->
    <!--
        TABLE    : TB_ST_STORE_TEMP_EXCEL, TB_HQ_PRODUCT
                   TB_ST_STORE_TEMP_EXCEL, TB_MS_PRODUCT
        PARAM    : stockAcinsVO
        COMMENTS : 재고폐기 엑셀업로드 - 정상 입력된 데이터 TEMP 테이블에서 삭제한다.
    -->
    <delete id="deleteExcelUploadCompleteData" parameterType="stockAcinsVO">
        /* USE : StockDisuseMapper.deleteExcelUploadCompleteData */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                DELETE  TB_ST_STORE_TEMP_EXCEL
                WHERE   SESSION_ID  = #{sessionId}
                AND     PROD_CD     IS NOT NULL
                AND     PROD_CD     IN  (
                                            SELECT  PROD_CD
                                            FROM    TB_HQ_PRODUCT
                                            WHERE   HQ_OFFICE_CD  =   #{hqOfficeCd}
                                            AND     STOCK_PROD_YN =   'Y'
                                            AND     USE_YN        =   'Y'
                                        )
            </when>
            <!-- 가맹점 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                DELETE  TB_ST_STORE_TEMP_EXCEL
                WHERE   SESSION_ID  = #{sessionId}
                AND     PROD_CD     IS NOT NULL
                AND     PROD_CD     IN  (
                                            SELECT  PROD_CD
                                            FROM    TB_MS_PRODUCT
                                            WHERE   STORE_CD      =   #{storeCd}
                                            AND     STOCK_PROD_YN =   'Y'
                                            AND     USE_YN        =   'Y'
                                        )
            </when>
        </choose>
    </delete>
</mapper>