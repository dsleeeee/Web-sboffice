<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SalePrice.xml
    판매가 관리
    ======================================================
    No  ||  수정자 ||  수정일자    ||  수정내역
    ======================================================
    1       김지은     2018.12.24     최초작성
-->
<mapper namespace="kr.co.solbipos.base.price.salePrice.service.impl.SalePriceMapper">


    <!-- 매장 판매가관리 > 상품의 본사 가격정보 조회 -->
    <!--
        TABLE    : TB_HQ_PRODUCT, TB_HQ_PRODUCT_SALE_PRICE
        COMMENTS : 판매가 관리 대상의 본사 가격정보를 조회한다.
    -->
    <select id="getProdInfo"  parameterType="salePriceVO" resultType="DefaultMap">
        /* SalePriceMapper.getProdInfo */
      <![CDATA[
        SELECT thp.HQ_OFFICE_CD,
               thp.PROD_CD,
               thp.PROD_NM,
               thpsp.SALE_UPRC,     -- 본사 판매가
               thp.PO_UNIT_QTY,		-- 입수
               thp.COST_UPRC, 		-- 본사 원가
               thp.SPLY_UPRC   		-- 본사 공급가
          FROM TB_HQ_PRODUCT thp,
               TB_HQ_PRODUCT_SALE_PRICE thpsp
         WHERE thp.HQ_OFFICE_CD = #{hqOfficeCd}
           AND thp.PROD_CD = #{prodCd}
           AND thpsp.HQ_OFFICE_CD = thp.HQ_OFFICE_CD
           AND thpsp.PROD_CD = thp.PROD_CD
           AND thpsp.START_DATE <= SYSDATE
           AND thpsp.END_DATE >= SYSDATE
        ]]>
    </select>

    <!-- 매장 판매가관리 > 상품 기준 판매가 관리 대상 조회 -->
    <!--
        TABLE    : TB_MS_PRODUCT, TB_MS_STORE, TB_MS_PRODUCT_SALE_PRICE
        COMMENTS : 판매가 관리 대상 목록을 조회한다.
    -->
    <select id="getProdSalePriceList"  parameterType="salePriceVO" resultType="DefaultMap">
        /* SalePriceMapper.getProdSalePriceList */
      <include refid="CmmSQL.PagingTemplateHeader"/>
        SELECT tms.STORE_CD,
               tms.STORE_NM,
               tmp.PROD_CD,
               tmp.PROD_NM,
               tmp.COST_UPRC,                     -- 원가단가
               tmp.LAST_COST_UPRC,                -- 최종원가단가
               tmp.SPLY_UPRC,                     -- 공급가
               tmp.SPLY_UPRC AS STORE_SPLY_UPRC,  -- 매장공급가
               tmpsp.SALE_UPRC AS SALE_UPRC_P,    -- 변경전 판매금액
               tmpsp.SALE_UPRC,                   -- 판매금액(변경가능)
               tmpsp.START_DATE,                  -- 판매가 적용 시작일
               tmpsp.END_DATE,                    -- 판매가 적용 종료일
               tmp.PO_UNIT_QTY                    -- 주문(발주)단위수량
      <include refid="CmmSQL.PagingTemplateCount"/>
          FROM TB_MS_PRODUCT tmp,
               TB_MS_STORE tms,
               TB_MS_PRODUCT_SALE_PRICE tmpsp
         WHERE tmp.PROD_CD = #{prodCd}
           AND tmp.SALE_PROD_YN = 'Y'             -- 판매상품 여부
           AND tmp.PRC_CTRL_FG = '1'              -- 가격관리구분 : 본사
           AND tms.HQ_OFFICE_CD = #{hqOfficeCd}
           AND tms.STORE_CD = tmp.STORE_CD
           AND tmpsp.STORE_CD = tmp.STORE_CD
           AND tmpsp.PROD_CD = tmp.PROD_CD
           AND tmpsp.SALE_PRC_FG = '1'
      <![CDATA[
           AND tmpsp.START_DATE <= SYSDATE
           AND tmpsp.END_DATE >= SYSDATE
         ]]>
      <if test='arrStoreCd != null and arrStoreCd != ""'>
           AND tms.STORE_CD IN
        <foreach collection="arrStoreCd" item="item" open="(" close=")" separator=",">
          #{item}
        </foreach>
      </if>
         ORDER BY tms.STORE_CD, tmp.PROD_CD
      <include refid="CmmSQL.PagingTemplateBottom"/>
    </select>

</mapper>
