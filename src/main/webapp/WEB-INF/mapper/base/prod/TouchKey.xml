<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="kr.co.solbipos.base.prod.touchkey.service.impl.TouchKeyMapper">

    <select id="selectProdByStore" parameterType="touchVO" resultType="DefaultMap">
        /* TouchKeyMapper.selectProdByStore */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                SELECT
                    thp.PROD_CD,
                    thp.PROD_NM,
                    thpc.PROD_CLASS_NM,
                    NVL(thpsp.SALE_UPRC, 0) AS SALE_UPRC
                FROM
                    TB_HQ_PRODUCT thp
                LEFT OUTER JOIN TB_HQ_PRODUCT_CLASS thpc ON
                    thp.HQ_OFFICE_CD = thpc.HQ_OFFICE_CD
                    AND thp.PROD_CLASS_CD = thpc.PROD_CLASS_CD
                LEFT OUTER JOIN (
                    SELECT
                        PROD_CD,
                        MIN(SALE_UPRC) KEEP( DENSE_RANK FIRST
                        ORDER BY
                        START_DATE DESC ) AS SALE_UPRC
                    FROM
                        TB_HQ_PRODUCT_SALE_PRICE
                    WHERE
                        HQ_OFFICE_CD = #{hqOfficeCd}
                        <![CDATA[
                        AND START_DATE <= TO_CHAR(SYSDATE, 'yyyyMMdd')
                        AND END_DATE >= TO_CHAR(SYSDATE, 'yyyyMMdd')
                        ]]>
                    GROUP BY
                        PROD_CD ) thpsp ON
                    thp.PROD_CD = thpsp.PROD_CD
                WHERE
                    thp.HQ_OFFICE_CD = #{hqOfficeCd}
                ORDER BY thp.PROD_CD
            </when>
            <!-- 매장 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                SELECT
                    tmp.PROD_CD,
                    tmp.PROD_NM,
                    tmpc.PROD_CLASS_NM,
                    NVL(tmpsp.SALE_UPRC, 0) AS SALE_UPRC
                FROM
                    TB_MS_PRODUCT tmp
                LEFT OUTER JOIN TB_MS_PRODUCT_CLASS tmpc ON
                    tmp.STORE_CD = tmpc.STORE_CD
                    AND tmp.PROD_CLASS_CD = tmpc.PROD_CLASS_CD
                LEFT OUTER JOIN (
                    SELECT
                        PROD_CD,
                        MIN(SALE_UPRC) KEEP( DENSE_RANK FIRST
                        ORDER BY
                        START_DATE DESC ) AS SALE_UPRC
                    FROM
                        TB_MS_PRODUCT_SALE_PRICE
                    WHERE
                        STORE_CD = #{storeCd}
                    <![CDATA[
                        AND START_DATE <= TO_CHAR(SYSDATE, 'yyyyMMdd')
                        AND END_DATE >= TO_CHAR(SYSDATE, 'yyyyMMdd')
                    ]]>
                    GROUP BY
                        PROD_CD ) tmpsp ON
                    tmp.PROD_CD = tmpsp.PROD_CD
                WHERE
                    tmp.STORE_CD = #{storeCd}
                ORDER BY tmp.PROD_CD
            </when>
        </choose>
  </select>

    <delete id="deleteTouchClassByStore" parameterType="String">
    /* TouchKeyMapper.deleteTouchClassByStore */
    DELETE
      FROM TB_MS_TOUCH_CLASS
     WHERE STORE_CD = #{storeCd}
    </delete>

  <insert id="insertTouchClassByStore" parameterType="touchClassVO">
    /* TouchKeyMapper.mergeTableGroupByStore */
    INSERT INTO TB_MS_TOUCH_CLASS A
    (
        A.STORE_CD,
        A.TUKEY_GRP_CD,
        A.TUKEY_CLASS_CD,
        A.TUKEY_CLASS_NM,
        A.PAGE_NO,
        A.X,
        A.Y,
        A.WIDTH,
        A.HEIGHT,
        A.IN_FG,
        A.REG_DT,
        A.REG_ID,
        A.MOD_DT,
        A.MOD_ID
    )
    VALUES
    (
        #{storeCd},
        #{tukeyGrpCd},
        #{tukeyClassCd},
        #{tukeyClassNm},
        #{pageNo},
        #{x},
        #{y},
        #{width},
        #{height},
        #{inFg},
        #{regDt},
        #{regId},
        #{regDt},
        #{regId}
    )
  </insert>

    <update id="deleteTouchByStore" parameterType="String">
    /* TouchKeyMapper.deleteTouchByStore */
    DELETE
      FROM TB_MS_TOUCH
     WHERE STORE_CD = #{storeCd}
    </update>

  <insert id="insertTouchByStore" parameterType="touchVO">
    /* TouchKeyMapper.insertTouchByStore */
    INSERT INTO TB_MS_TOUCH A
    (
        A.STORE_CD,
        A.TUKEY_CLASS_CD,
        A.TUKEY_CD,
        A.PROD_CD,
        A.PAGE_NO,
        A.X,
        A.Y,
        A.WIDTH,
        A.HEIGHT,
        A.IN_FG,
        A.REG_DT,
        A.REG_ID,
        A.MOD_DT,
        A.MOD_ID
    )
    VALUES
    (
        #{storeCd},
        #{tukeyClassCd},
        #{tukeyCd},
        #{prodCd},
        #{pageNo},
        #{x},
        #{y},
        #{width},
        #{height},
        #{inFg},
        #{regDt},
        #{regId},
        #{regDt},
        #{regId}
    )
  </insert>

</mapper>



