<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    ProdInfoMapper.xml
    매출공통팝업
    ======================================================
    No  ||  수정자 ||  수정일자    ||  수정내역
    ======================================================
    1                                 최초작성
    2       김설아     2019.12.11     수정
-->
<mapper namespace="kr.co.solbipos.sale.cmmSalePopup.prodInfo.service.impl.ProdInfoMapper">

    <!-- 매출공통팝업 - 상품매출 상세내역 조회 -->
    <!--
        TABLE    : TB_SL_SALE_DTL, TB_MS_PRODUCT, TB_MS_PRODUCT_CLASS
        PARAM    : prodInfoVO
        COMMENTS : 매출공통팝업 - 상품매출 상세내역을 조회한다.
    -->
    <select id="getProdSaleDtlList" parameterType="ProdInfoVO" resultType="DefaultMap">
        /* ProdInfoMapper.ProdInfoMapper */
        SELECT
        STORE_CD,
        PROD_CLASS_NM,
        PROD_CD,
        PROD_NM,
        SUM(SALE_QTY) AS SALE_QTY,
        SUM(SALE_AMT) AS TOT_SALE_AMT,
        SUM(DC_AMT) AS TOT_DC_AMT,
        SUM(REAL_SALE_AMT) AS REAL_SALE_AMT,
        SUM(TAX_SALE_AMT) AS TAX_SALE_AMT,
        SUM(REAL_SALE_AMT) - SUM(VAT_AMT) AS GA_AMT,
        SUM(VAT_AMT) AS VAT_AMT,
        SUM(NO_TAX_SALE_AMT) AS NO_TAX_SALE_AMT,
        SUM(REAL_SALE_AMT) - SUM(VAT_AMT) AS NET_SALE_AMT
        FROM
        (
            SELECT
            tssd.STORE_CD,
            tmpc.PROD_CLASS_NM,
            tssd.PROD_CD,
            tmp.PROD_NM,
            tssd.SALE_QTY,
            tssd.SALE_AMT,
            tssd.DC_AMT,
            tssd.REAL_SALE_AMT,
            (CASE WHEN tssd.VAT_FG = '1' THEN REAL_SALE_AMT ELSE 0 END) AS TAX_SALE_AMT,
            tssd.VAT_AMT,
            (CASE WHEN tssd.VAT_FG = '2' THEN REAL_SALE_AMT ELSE 0 END) AS NO_TAX_SALE_AMT
            FROM TB_SL_SALE_DTL tssd,
            TB_MS_PRODUCT tmp,
            TB_MS_PRODUCT_CLASS tmpc
            WHERE 1=1
            AND tssd.HQ_OFFICE_CD = #{membrOrgnCd}
            <choose>
                <when test='gubun != null'>
                    <!-- 기간별매출 > 일자별 탭 > 과면세별,포스별 탭 -->
                    <if test='gubun == "day"'>
                        <![CDATA[
                            AND tssd.SALE_DATE = #{saleDate}
                        ]]>
                    </if>
                    <!-- 기간별매출 > 월별 탭 > 과면세별,포스별 탭 -->
                    <if test='gubun == "month"'>
                        <![CDATA[
                            AND tssd.SALE_DATE BETWEEN #{yearMonth}||'01' AND #{yearMonth} ||'31'
                        ]]>
                    </if>
                </when>
            </choose>
            <if test='storeCds != null and storeCds != ""'>
                AND tssd.STORE_CD IN
                <foreach collection="storeCdList" item="item" open="("  separator="," close=")" >
                    #{item}
                </foreach>
            </if>
            AND tmp.STORE_CD (+)= tssd.STORE_CD
            AND tmp.PROD_CD (+)= tssd.PROD_CD
            AND tmpc.STORE_CD (+)= tssd.STORE_CD
            AND tmpc.PROD_CLASS_CD (+)= tmp.PROD_CLASS_CD
        )
        GROUP BY STORE_CD, PROD_CLASS_NM, PROD_CD, PROD_NM
        ORDER BY STORE_CD, PROD_CD
    </select>

</mapper>