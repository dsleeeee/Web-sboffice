<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    HqManage.xml
    본사정보관리 sql
    ======================================================
    No  ||  수정자 ||  수정일자    ||  수정내역
    ======================================================
    1       김지은     2018.06.08      최초작성
-->
<mapper namespace="kr.co.solbipos.store.hq.hqmanage.service.impl.HqManageMapper">

    <!-- 본사 목록 조회 -->
    <!--
        TABLE    : TB_HQ_OFFICE, TB_MS_STORE, TB_HQ_ENVST, TB_CM_ENVST
        PARAM    : hqManageVO
        COMMENTS : 등록된 본사 목록을 조회한다.
    -->
    <select id="getHqOfficeList" parameterType="hqManageVO" resultType="DefaultMap">
        /* USE : HqManageMapper.getHqOfficeList */
        <include refid="CmmSQL.PagingTemplateHeader"/>
        <![CDATA[
        SELECT tho.HQ_OFFICE_CD,
               tho.HQ_OFFICE_NM,
               tho.OWNER_NM,
               tho.BIZ_NO,
               tho.BIZ_TYPE_CD,
               tho.BIZ_ITEM_CD,
               tho.BIZ_STORE_NM,
               tho.TEL_NO,
               tho.FAX_NO,
               tho.EMAIL_ADDR,
               tho.HMPG_ADDR,
               tho.POST_NO,
               tho.ADDR,
               tho.ADDR_DTL,
               tho.AREA_CD,
               tho.SYS_STAT_FG,
               tho.SYS_OPEN_DATE,
               tho.SYS_CLOSURE_DATE,
               tho.AGENCY_CD,
               tho.REMARK,
               tho.CLS_FG,
               tho.REG_DT,
               tho.REG_ID,
               tho.MOD_DT,
               tho.MOD_ID,
               NVL(tms.CNT, 0) AS CNT,
               the.POS_NM
        ]]>
        <include refid="CmmSQL.PagingTemplateCount"/>
        <![CDATA[
          FROM TB_HQ_OFFICE tho,
               (
          SELECT HQ_OFFICE_CD,
                 COUNT(HQ_OFFICE_CD) AS CNT
            FROM TB_MS_STORE
           GROUP BY HQ_OFFICE_CD
                ) tms,
                (
          SELECT the.HQ_OFFICE_CD,
                 tcm.ENVST_NM AS POS_NM
            FROM TB_HQ_ENVST the,
                 TB_CM_ENVST tcm
           WHERE the.ENVST_CD = '140'
             AND tcm.ENVST_CD = the.ENVST_CD
                ) the
         WHERE tho.HQ_OFFICE_CD != '00000'
           AND tms.HQ_OFFICE_CD (+) = tho.HQ_OFFICE_CD
           AND the.HQ_OFFICE_CD (+) = tho.HQ_OFFICE_CD
        ]]>
        <if test='hqOfficeCd != null and hqOfficeCd != ""'>
           AND tho.HQ_OFFICE_CD = #{hqOfficeCd}
        </if>
        <if test='hqOfficeNm != null and hqOfficeNm != ""'>
           AND tho.HQ_OFFICE_NM = #{hqOfficeNm}
        </if>
        <if test='bizNo != null and bizNo != ""'>
           AND tho.BIZ_NO = #{bizNo}
        </if>
        <if test='clsFg != null and clsFg != ""'>
           AND tho.CLS_FG = #{clsFg}
        </if>
        <if test='sysStatFg != null and sysStatFg != ""'>
           AND tho.SYS_STAT_FG = #{sysStatFg}
        </if>
         ORDER BY tho.HQ_OFFICE_CD ASC
        <include refid="CmmSQL.PagingTemplateBottom"/>
    </select>

    <!-- 본사 상세정보 조회  -->
    <!--
        TABLE    : TB_HQ_OFFICE, TB_CM_AGENCY, TB_CM_NMCODE
        PARAM    : hqManageVO
        COMMENTS : 등록된 본사 상세정보를 조회한다.
    -->
    <select id="dtlInfo" parameterType="hqManageVO" resultType="DefaultMap">
        /* USE : HqManageMapper.dtlInfo */
        <![CDATA[
        SELECT tho.HQ_OFFICE_CD,
               tho.HQ_OFFICE_NM,
               tho.OWNER_NM,
               tho.BIZ_NO,
               SUBSTR(tho.BIZ_NO,0,3) AS BIZ_NO1,
               SUBSTR(tho.BIZ_NO,4,2) AS BIZ_NO2,
               SUBSTR(tho.BIZ_NO,6,5) AS BIZ_NO3,
               tho.BIZ_TYPE_CD,
               tho.BIZ_ITEM_CD,
               tho.BIZ_STORE_NM,
               tho.TEL_NO,
               tho.FAX_NO,
               tho.EMAIL_ADDR,
               tho.HMPG_ADDR,
               tho.POST_NO,
               tho.ADDR,
               tho.ADDR_DTL,
               tho.AREA_CD,
               tcna.NMCODE_NM AS AREA_NM,
               tho.SYS_STAT_FG,
               tcnm.NMCODE_NM AS SYS_STAT_FG_NM,
               TO_CHAR(TO_DATE(tho.SYS_OPEN_DATE, 'YYYYMMDD'), 'YYYY.MM.DD') AS SYS_OPEN_DATE,
               TO_CHAR(TO_DATE(tho.SYS_CLOSURE_DATE, 'YYYYMMDD'), 'YYYY.MM.DD') AS SYS_CLOSURE_DATE,
               tho.AGENCY_CD,
               tca.AGENCY_NM,
               tho.REMARK,
               tho.CLS_FG,
               tcn.NMCODE_NM AS CLS_FG_NM,
               tho.REG_DT,
               tho.REG_ID,
               tho.MOD_DT,
               tho.MOD_ID
          FROM TB_HQ_OFFICE tho,
               TB_CM_AGENCY tca,
               TB_CM_NMCODE tcn,
               TB_CM_NMCODE tcnm,
               TB_CM_NMCODE tcna
         WHERE tho.HQ_OFFICE_CD = #{hqOfficeCd}
           AND tca.AGENCY_CD (+)= tho.AGENCY_CD
           AND tcn.NMCODE_GRP_CD = '001'
           AND tcn.NMCODE_CD = tho.CLS_FG
           AND tcnm.NMCODE_GRP_CD = '005'
           AND tcnm.NMCODE_CD = tho.SYS_STAT_FG
           AND tcna.NMCODE_GRP_CD = '061'
           AND tcna.NMCODE_CD = tho.AREA_CD
        ]]>
    </select>

    <!-- 사업자번호 중복체크  -->
    <!--
        TABLE    : TB_HQ_OFFICE, TB_MS_STORE
        PARAM    : hqManageVO
        COMMENTS : 사업자번호를 중복체크한다.
    -->
    <select id="chkBizNo" parameterType="hqManageVO" resultType="Integer">
        /* USE : HqManageMapper.chkBizNo */
        <![CDATA[
        SELECT COUNT(STORE_CD) AS CNT
          FROM (
          SELECT HQ_OFFICE_CD AS STORE_CD
            FROM TB_HQ_OFFICE
           WHERE BIZ_NO = #{bizNo}
           UNION ALL
          SELECT STORE_CD
            FROM TB_MS_STORE
           WHERE BIZ_NO = #{bizNo}
               )
        ]]>
    </select>

    <!-- 사업자번호 사용현황 목록  -->
    <!--
        TABLE    : TB_HQ_OFFICE, TB_MS_STORE, TB_CM_NMCODE
        PARAM    : hqManageVO
        COMMENTS : 해당 사업자번호가 등록된 현황을 조회한다.
    -->
    <select id="getBizUseList" parameterType="hqManageVO" resultType="DefaultMap">
        /* USE : HqManageMapper.getBizUseList */
        SELECT 'H' AS STORE_FG,
               tho.HQ_OFFICE_CD AS STORE_CD,
               tho.HQ_OFFICE_NM AS STORE_NM,
               tho.OWNER_NM,
               tho.BIZ_NO,
               (SELECT NMCODE_NM FROM TB_CM_NMCODE WHERE NMCODE_GRP_CD = '005' AND NMCODE_CD = tho.SYS_STAT_FG) AS SYS_STAT_FG_NM,
               (SELECT NMCODE_NM FROM TB_CM_NMCODE WHERE NMCODE_GRP_CD = '001' AND NMCODE_CD = tho.CLS_FG) AS CLS_FG_NM
          FROM TB_HQ_OFFICE tho
         WHERE tho.BIZ_NO = #{bizNo}
         UNION ALL
         SELECT 'S' AS STORE_FG,
                tms.STORE_CD,
                tms.STORE_NM,
                tms.OWNER_NM,
                tms.BIZ_NO,
                (SELECT NMCODE_NM FROM TB_CM_NMCODE WHERE NMCODE_GRP_CD = '005' AND NMCODE_CD = tms.SYS_STAT_FG) AS SYS_STAT_FG_NM,
                (SELECT NMCODE_NM FROM TB_CM_NMCODE WHERE NMCODE_GRP_CD = '001' AND NMCODE_CD = tms.CLS_FG) AS CLS_FG_NM
           FROM TB_MS_STORE tms
          WHERE tms.BIZ_NO = #{bizNo}
    </select>

    <!-- 사업자번호 사용현황 상세  -->
    <!--
        TABLE    : TB_HQ_OFFICE, TB_MS_STORE, TB_CM_NMCODE
        PARAM    : hqManageVO
        COMMENTS : 사업자번호 사용현황 상세내용을 조회한다.
    -->
    <select id="getBizInfoDtl" parameterType="hqManageVO" resultType="DefaultMap">
        /* USE : HqManageMapper.getBizInfoDtl */
        SELECT tho.OWNER_NM,
               tho.BIZ_NO,
               SUBSTR(tho.BIZ_NO,0,3) AS BIZ_NO1,
               SUBSTR(tho.BIZ_NO,4,2) AS BIZ_NO2,
               SUBSTR(tho.BIZ_NO,6,5) AS BIZ_NO3,
               tho.BIZ_STORE_NM,
               tho.TEL_NO,
               tho.FAX_NO,
               tho.POST_NO,
               tho.ADDR,
               tho.ADDR_DTL,
               tho.AREA_CD,
               (SELECT NMCODE_NM FROM TB_CM_NMCODE WHERE NMCODE_GRP_CD = '061' AND NMCODE_CD = tho.AREA_CD) AS AREA_NM,
               tho.SYS_STAT_FG,
               (SELECT NMCODE_NM FROM TB_CM_NMCODE WHERE NMCODE_GRP_CD = '005' AND NMCODE_CD = tho.SYS_STAT_FG) AS SYS_STAT_FG_NM,
               tho.SYS_OPEN_DATE,
               tho.AGENCY_CD,
               tca.AGENCY_NM,
               tho.CLS_FG,
               (SELECT NMCODE_NM FROM TB_CM_NMCODE WHERE NMCODE_GRP_CD = '001' AND NMCODE_CD = tho.CLS_FG) AS CLS_FG_NM,
        <if test='storeFg == "H"'>
               tho.HQ_OFFICE_CD AS STORE_CD,
               tho.HQ_OFFICE_NM AS STORE_NM
          FROM TB_HQ_OFFICE tho,
               TB_CM_AGENCY tca
         WHERE tho.HQ_OFFICE_CD = #{storeCd}
           AND tca.AGENCY_CD = tho.AGENCY_CD
        </if>
        <if test='storeFg != "H"'>
               tho.STORE_CD,
               tho.STORE_NM
          FROM TB_MS_STORE tho,
               TB_CM_AGENCY tca
         WHERE tho.STORE_CD = #{storeCd}
           AND tca.AGENCY_CD = tho.AGENCY_CD
        </if>
    </select>

    <!-- 본사 코드 조회  -->
    <!--
        TABLE    : TB_HQ_OFFICE
        PARAM    : hqManageVO
        COMMENTS : 본사 코드 조회를 조회한다.
    -->
    <select id="getHqOfficeCd" parameterType="DefaultMap" resultType="String">
        /* HqManageMapper.getHqOfficeCd */
        <if test='sysStatFg.toString() == "DEMO"'>
          SELECT 'DS'||LPAD(TO_CHAR(NVL(MAX(SUBSTR(HQ_OFFICE_CD, 3, 4)), 0) + 1), 3, '0') AS HQ_OFFICE_CD
            FROM TB_HQ_OFFICE
           WHERE SYS_STAT_FG = '9'
        </if>
        <if test='sysStatFg.toString() != "DEMO"'>
          SELECT 'H'||LPAD(TO_CHAR(NVL(MAX(SUBSTR(HQ_OFFICE_CD, 2, 4)), 0) + 1), 4, '0') AS HQ_OFFICE_CD
            FROM TB_HQ_OFFICE
           WHERE SYS_STAT_FG != '9'
        </if>
    </select>

    <!-- 본사 신규등록  -->
    <!--
        TABLE    : TB_HQ_OFFICE
        PARAM    : hqManageVO
        COMMENTS : 본사를 등록한다.
    -->
    <insert id="regist" parameterType="DefaultMap">
        /* USE : HqManageMapper.regist */
        <![CDATA[
        INSERT INTO TB_HQ_OFFICE
        (
            HQ_OFFICE_CD,
            HQ_OFFICE_NM,
            OWNER_NM,
            BIZ_NO,
            BIZ_TYPE_CD,
            BIZ_ITEM_CD,
            BIZ_STORE_NM,
            TEL_NO,
            FAX_NO,
            EMAIL_ADDR,
            HMPG_ADDR,
            POST_NO,
            ADDR,
            ADDR_DTL,
            AREA_CD,
            SYS_STAT_FG,
            SYS_OPEN_DATE,
            SYS_CLOSURE_DATE,
            AGENCY_CD,
            REMARK,
            CLS_FG,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID
        )
        VALUES (
            #{hqOfficeCd},
            #{hqOfficeNm},
            #{ownerNm},
            #{bizNo},
            #{bizTypeCd},
            #{bizItemCd},
            #{bizStoreNm},
            #{telNo},
            #{faxNo},
            #{emailAddr},
            #{hmpgAddr},
            #{postNo},
            #{addr},
            #{addrDtl},
            #{areaCd},
            #{sysStatFg},
            #{sysOpenDate},
            '99991231',
            #{agencyCd},
            #{remark},
            #{clsFg},
            #{regDt},
            #{regId},
            #{modDt},
            #{modId}
        )
        ]]>
    </insert>

    <!-- 본사 사원등록  -->
    <!--
        TABLE    : TB_HQ_EMPLOYEE
        PARAM    : hqManageVO
        COMMENTS : 본사 사원을 등록한다.
    -->
    <insert id="registEmployee" parameterType="DefaultMap">
        /* USE : HqManageMapper.registEmployee */
        <![CDATA[
        INSERT INTO TB_HQ_EMPLOYEE
        (
            HQ_OFFICE_CD,
            EMP_NO,
            EMP_NM,
            EMP_PWD,
            WEB_USE_YN,
            USER_ID,
            MP_NO,
            SERVICE_FG,
            SMS_RECV_YN,
            USE_YN,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID
        )
        VALUES
        (
            #{hqOfficeCd},
            #{posEmpNo},
            #{ownerNm},
            #{posUserPwd},
            'Y',
            #{userId},
            #{telNo},
            '1',
            'N',
            'Y',
            #{regDt},
            #{regId},
            #{modDt},
            #{modId}
        )
        ]]>
    </insert>

    <!-- 웹 사용자 등록  -->
    <!--
        TABLE    : TB_WB_USER_INFO
        PARAM    : hqManageVO
        COMMENTS : 웹 사용자를 등록한다.
    -->
    <insert id="registWebUser" parameterType="DefaultMap">
        /* USE : HqManageMapper.registWebUser */
        INSERT INTO TB_WB_USER_INFO
        (
            USER_ID,
            USER_PWD,
            AUTH_GRP_CD,
            LOGIN_FAIL_CNT,
            LAST_PWD_CHG_DT,
            USER_STAT_FG,
            USE_YN,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID
        )
        VALUES
        (
            #{userId},
            #{userPwd},
            '000007', -- TODO 보나비용 임시 권한(화면에서 사용자 권한 선택 추가 필요)
            0,
            #{regDt},
            '99',
            'Y',
            #{regDt},
            #{regId},
            #{modDt},
            #{modId}
        )
    </insert>

    <!-- 본사 공통코드 등록  -->
    <!--
        TABLE    : TB_HQ_NMCODE
        PARAM    : hqManageVO
        COMMENTS : 본사 공통코드를 등록한다.
    -->
    <insert id="cmmCodeReg" parameterType="DefaultMap">
        /* USE : HqManageMapper.cmmCodeReg */
        INSERT INTO TB_HQ_NMCODE
        (
            HQ_OFFICE_CD,
            NMCODE_GRP_CD,
            NMCODE_CD,
            PARENT_CD,
            NMCODE_NM,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID
        )
        VALUES
        (
            #{hqOfficeCd},
            #{nmcodeGrpCd},
            #{nmcodeCd},
            #{nmcodeCd},
            #{nmcodeNm},
            #{regDt},
            #{regId},
            #{modDt},
            #{modId}
        )
    </insert>

    <!-- 공통코드 복사   -->
    <!--
        TABLE    : TB_HQ_NMCODE
        PARAM    : hqNmcodeVO
        COMMENTS : 시스템 공통코드 테이블에서 본사용 공통코드를 복사함
    -->
    <!--
    <select id="copyCmmNameCode" statementType="CALLABLE"  parameterType="hqNmcodeVO" resultType="String">
        /* USE : HqManageMapper.copyCmmNameCode */
        {
            CALL PKG_CM_NMCODE.SP_HQ_NMCODE_I
            (
                #{hqOfficeCd},
                #{result, mode=OUT, jdbcType=VARCHAR}
            )
        }
    </select>
    -->

    <!-- TID 복사  -->
    <!--
        TABLE    : TB_HQ_NMCODE
        PARAM    : hqNmcodeVO
        COMMENTS : 공통코드 테이블에서 TID 복사하여 본사 공통코드 테이블에 넣음
    -->
    <!--
    <select id="copyTid" statementType="CALLABLE"  parameterType="hqNmcodeVO" resultType="String">
      /* USE : HqManageMapper.copyTid */
      {
        CALL PKG_CM_NMCODE_TID.SP_HQ_NMCODE_TID_I
        (
          #{hqOfficeCd},
          #{result, mode=OUT, jdbcType=VARCHAR}
        )
      }
    </select>
    -->

    <!-- 공통코드 복사  -->
    <!--
        TABLE    : TB_HQ_NMCODE
        PARAM    : hqManageVO
        COMMENTS : 공통코드 테이블에서 복사하여 본사 공통코드 테이블에 넣음
    -->
    <!--
    <insert id="copyCmmCode" parameterType="DefaultMap">
        /* USE : HqManageMapper.copyCmmCode */
        INSERT INTO TB_HQ_NMCODE
        SELECT #{hqOfficeCd},
               NMCODE_GRP_CD,
               NMCODE_CD,
               NMCODE_NM,
               NMCODE_ITEM_1,
               NMCODE_ITEM_2,
               'Y',
               #{regDt},
               #{regId},
               #{modDt},
               #{modId}
          FROM TB_CM_NMCODE
         WHERE NMCODE_GRP_CD = #{nmcodeGrpCd}
    </insert>
    -->

    <!-- 본사 수정 -->
    <!--
        TABLE    : TB_WB_USER_INFO
        PARAM    : hqManageVO
        COMMENTS : 본사 정보를 수정한다.
    -->
    <update id="modify" parameterType="hqManageVO">
        /* USE : HqManageMapper.modify */
        <![CDATA[
        UPDATE TB_HQ_OFFICE
           SET HQ_OFFICE_NM   = #{hqOfficeNm},
               OWNER_NM       = #{ownerNm},
               BIZ_NO         = #{bizNo},
               BIZ_TYPE_CD    = #{bizTypeCd},
               BIZ_ITEM_CD    = #{bizItemCd},
               BIZ_STORE_NM   = #{bizStoreNm},
               TEL_NO         = #{telNo},
               FAX_NO         = #{faxNo},
               EMAIL_ADDR     = #{emailAddr},
               HMPG_ADDR      = #{hmpgAddr},
               POST_NO        = #{postNo},
               ADDR           = #{addr},
               ADDR_DTL       = #{addrDtl},
               AREA_CD        = #{areaCd},
               SYS_STAT_FG    = #{sysStatFg.code},
               SYS_OPEN_DATE  = #{sysOpenDate},
               SYS_CLOSURE_DATE = #{sysClosureDate},
               AGENCY_CD      = #{agencyCd},
               REMARK         = #{remark},
               CLS_FG         = #{clsFg},
               MOD_DT         = #{modDt},
               MOD_ID         = #{modId}
         WHERE HQ_OFFICE_CD   = #{hqOfficeCd}
        ]]>
    </update>

    <!-- 권한그룹 목록조회 -->
    <!--
        TABLE    : TB_HQ_OFFICE
        PARAM    : hqManageVO
        COMMENTS : 권한그룹 목록을 조회한다.
    -->
    <select id="authHqList" parameterType="hqManageVO" resultType="DefaultMap">
        /* USE : HqManageMapper.authHqList */
        <![CDATA[
        SELECT HQ_OFFICE_CD AS VALUE,
               HQ_OFFICE_NM AS NAME
          FROM TB_HQ_OFFICE
         WHERE HQ_OFFICE_CD != #{hqOfficeCd}
           AND SYS_OPEN_DATE <> '2'
           AND SYS_CLOSURE_DATE > SYSDATE
           AND CLS_FG = #{clsFg}
        ]]>
    </select>

    <!-- 사용가능 메뉴 조회 -->
    <!--
        TABLE    : TB_WB_RESRCE_INFO, TB_HQ_EMPLOYEE, TB_WB_USER_INFO, TB_WB_AUTHOR_EXCEPT
        PARAM    : hqManageVO
        COMMENTS : 사용가능한 메뉴를 조회한다.
    -->
    <select id="avlblMenu" parameterType="hqManageVO" resultType="DefaultMap">
        /* USE : HqManageMapper.avlblMenu */
        SELECT twr.*
          FROM (
          SELECT twr.RESRCE_CD AS RESRCE_CD_LARGE,
                 twr.RESRCE_NM AS RESRCE_NM_LARGE,
                 twri.RESRCE_CD AS RESRCE_CD_MID,
                 twri.RESRCE_NM AS RESRCE_NM_MID,
                 twrif.RESRCE_CD AS RESRCE_CD_SMALL,
                 twrif.RESRCE_NM AS RESRCE_NM_SMALL
            FROM TB_WB_RESRCE_INFO twr,
                 TB_WB_RESRCE_INFO twri,
                 TB_WB_RESRCE_INFO twrif
           WHERE twr.USE_YN = 'Y'
             AND (twr.SPCL_AUTHOR IS NULL OR twr.SPCL_AUTHOR NOT IN ('A01'))
             AND twri.P_RESRCE = twr.RESRCE_CD
             AND twri.USE_YN = 'Y'
             AND twrif.P_RESRCE = twri.RESRCE_CD
             AND twrif.DISP_LEVEL = '2'
           ORDER BY twr.RESRCE_CD, twri.RESRCE_CD, twrif.RESRCE_CD
              ) twr,
              (
          SELECT RESRCE_CD
            FROM TB_WB_RESRCE_INFO
           MINUS
          SELECT twa.RESRCE_CD
            FROM TB_HQ_EMPLOYEE the,
                 TB_WB_USER_INFO twu,
                 TB_WB_AUTHOR_GRP_RESRCE twa
           WHERE the.HQ_OFFICE_CD = #{hqOfficeCd}
             AND the.EMP_NO = '0000'
             AND twu.USER_ID = the.USER_ID
             AND twa.AUTH_GRP_CD = twu.AUTH_GRP_CD
           MINUS
          SELECT twa.RESRCE_CD
            FROM TB_HQ_EMPLOYEE the,
                 TB_WB_USER_INFO twu,
                 TB_WB_AUTHOR_EXCEPT twa
           WHERE the.HQ_OFFICE_CD = #{hqOfficeCd}
             AND the.EMP_NO = '0000'
             AND twu.USER_ID = the.USER_ID
             AND twa.USER_ID = twu.USER_ID
             AND twa.INCLD_EXCLD_FG = 'I'
           UNION ALL
          SELECT twa.RESRCE_CD
          FROM TB_HQ_EMPLOYEE the,
               TB_WB_USER_INFO twu,
               TB_WB_AUTHOR_EXCEPT twa
         WHERE the.HQ_OFFICE_CD = #{hqOfficeCd}
           AND the.EMP_NO = '0000'
           AND twu.USER_ID = the.USER_ID
           AND twa.USER_ID = twu.USER_ID
           AND twa.INCLD_EXCLD_FG = 'E'
               ) the
       WHERE the.RESRCE_CD = twr.RESRCE_CD_SMALL
    </select>

    <!-- 사용중인 메뉴 조회 -->
    <!--
        TABLE    : TB_WB_RESRCE_INFO, TB_HQ_EMPLOYEE, TB_WB_USER_INFO, TB_WB_AUTHOR_EXCEPT
        PARAM    : hqManageVO
        COMMENTS : 사용가능한 메뉴를 조회한다.
    -->
    <select id="beUseMenu" parameterType="hqManageVO" resultType="DefaultMap">
        /* USE : HqManageMapper.beUseMenu */
        SELECT twr.*
          FROM (
          SELECT twr.RESRCE_CD AS RESRCE_CD_LARGE,
                 twr.RESRCE_NM AS RESRCE_NM_LARGE,
                 twri.RESRCE_CD AS RESRCE_CD_MID,
                 twri.RESRCE_NM AS RESRCE_NM_MID,
                 twrif.RESRCE_CD AS RESRCE_CD_SMALL,
                 twrif.RESRCE_NM AS RESRCE_NM_SMALL
            FROM TB_WB_RESRCE_INFO twr,
                 TB_WB_RESRCE_INFO twri,
                 TB_WB_RESRCE_INFO twrif
           WHERE twr.USE_YN = 'Y'
             AND (twr.SPCL_AUTHOR IS NULL OR twr.SPCL_AUTHOR NOT IN ('A01'))
             AND twri.P_RESRCE = twr.RESRCE_CD
             AND twri.USE_YN = 'Y'
             AND twrif.P_RESRCE = twri.RESRCE_CD
             AND twrif.DISP_LEVEL = '2'
           ORDER BY twr.RESRCE_CD, twri.RESRCE_CD, twrif.RESRCE_CD
               ) twr,
               (
          SELECT twa.RESRCE_CD
            FROM TB_HQ_EMPLOYEE the,
                 TB_WB_USER_INFO twu,
                 TB_WB_AUTHOR_GRP_RESRCE twa
           WHERE the.HQ_OFFICE_CD = #{hqOfficeCd}
             AND the.EMP_NO = '0000'
             AND twu.USER_ID = the.USER_ID
             AND twa.AUTH_GRP_CD = twu.AUTH_GRP_CD
           UNION ALL
          SELECT twa.RESRCE_CD
            FROM TB_HQ_EMPLOYEE the,
                 TB_WB_USER_INFO twu,
                 TB_WB_AUTHOR_EXCEPT twa
           WHERE the.HQ_OFFICE_CD = #{hqOfficeCd}
             AND the.EMP_NO = '0000'
             AND twu.USER_ID = the.USER_ID
             AND twa.USER_ID = twu.USER_ID
             AND twa.INCLD_EXCLD_FG = 'I'
             AND twa.USE_YN = 'Y'
           MINUS
          SELECT twa.RESRCE_CD
            FROM TB_HQ_EMPLOYEE the,
                 TB_WB_USER_INFO twu,
                 TB_WB_AUTHOR_EXCEPT twa
           WHERE the.HQ_OFFICE_CD = #{hqOfficeCd}
             AND the.EMP_NO = '0000'
             AND twu.USER_ID = the.USER_ID
             AND twa.USER_ID = twu.USER_ID
             AND twa.INCLD_EXCLD_FG = 'E'
             AND twa.USE_YN = 'Y'
               ) the
         WHERE the.RESRCE_CD = twr.RESRCE_CD_SMALL
    </select>

    <!-- 메뉴권한복사-->
    <!--
        TABLE    : TB_WB_USER_INFO, TB_HQ_EMPLOYEE
        PARAM    : hqManageVO
        COMMENTS : 메뉴권한을 복사한다.
    -->
    <update id="copyAuth" parameterType="hqMenuVO" >
        /* USE : HqManageMapper.copyAuth */
        UPDATE TB_WB_USER_INFO
           SET AUTH_GRP_CD = (SELECT twu.AUTH_GRP_CD
                                FROM TB_HQ_EMPLOYEE the,
                                     TB_WB_USER_INFO twu
                               WHERE the.HQ_OFFICE_CD = #{copyHqOfficeCd}
                                 AND the.EMP_NO = '0000'
                                 AND twu.USER_ID = the.USER_ID
                              )
         WHERE USER_ID = (SELECT the.USER_ID
                            FROM TB_HQ_EMPLOYEE the,
                                 TB_WB_USER_INFO twu
                           WHERE the.HQ_OFFICE_CD = #{hqOfficeCd}
                             AND the.EMP_NO = '0000'
                             AND twu.USER_ID = the.USER_ID
                          )
    </update>

    <!-- 권한예외 복사-->
    <!--
        TABLE    : TB_WB_AUTHOR_EXCEPT, TB_HQ_EMPLOYEE, TB_WB_USER_INFO
        PARAM    : hqManageVO
        COMMENTS : 예외 권한을 복사한다.
    -->
    <insert id="copyAuthExcp" parameterType="hqMenuVO" >
        /* USE : HqManageMapper.copyAuthExcp */
        <![CDATA[
        MERGE INTO TB_WB_AUTHOR_EXCEPT twa
        USING (
              SELECT USER_ID, RESRCE_CD, INCLD_EXCLD_FG, USE_YN
                FROM TB_WB_AUTHOR_EXCEPT
               WHERE USER_ID = (
                                SELECT twu.USER_ID
                                  FROM TB_HQ_EMPLOYEE the,
                                       TB_WB_USER_INFO twu
                                 WHERE the.HQ_OFFICE_CD = #{copyHqOfficeCd}
                                   AND the.EMP_NO = '0000'
                                   AND twu.USER_ID = the.USER_ID
                               )
              ) twae
         ON (twa.USER_ID = twae.USER_ID AND twa.RESRCE_CD = twae.RESRCE_CD)
         WHEN MATCHED THEN
         UPDATE
            SET twa.INCLD_EXCLD_FG = twae.INCLD_EXCLD_FG,
                twa.USE_YN = twae.USE_YN,
                twa.MOD_DT = #{modDt},
                twa.MOD_ID = #{modId}
         WHEN NOT MATCHED THEN
         INSERT (USER_ID, RESRCE_CD, INCLD_EXCLD_FG, USE_YN, REG_DT, REG_ID)
         VALUES (
                  (SELECT the.USER_ID FROM TB_HQ_EMPLOYEE the, TB_WB_USER_INFO twu WHERE the.HQ_OFFICE_CD = #{hqOfficeCd} AND the.EMP_NO = '0000' AND twu.USER_ID = the.USER_ID),
                  twae.RESRCE_CD,
                  twae.INCLD_EXCLD_FG,
                  twae.USE_YN,
                  #{regDt},
                  #{regId}
                )
        ]]>
    </insert>

    <!-- 메뉴권한 추가-->
    <!--
        TABLE    : TB_WB_AUTHOR_EXCEPT
        PARAM    : hqManageVO
        COMMENTS : 예외 권한을 복사한다.
    -->
    <insert id="addAuth" parameterType="DefaultMap">
        /* USE : HqManageMapper.addAuth */
        INSERT INTO TB_WB_AUTHOR_EXCEPT
        (
            USER_ID,
            RESRCE_CD,
            INCLD_EXCLD_FG,
            USE_YN,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID
        )
        VALUES
        (
            (SELECT twu.USER_ID FROM TB_HQ_EMPLOYEE the, TB_WB_USER_INFO twu WHERE the.HQ_OFFICE_CD = #{hqOfficeCd} AND the.EMP_NO = '0000' AND twu.USER_ID = the.USER_ID),
            #{resrceCd},
            #{incldExcldFg},
            'Y',
            #{regDt},
            #{regId},
            #{modDt},
            #{modId}
        )
    </insert>

    <!-- 메뉴권한 확인-->
    <!--
        TABLE    : TB_WB_AUTHOR_EXCEPT
        PARAM    : hqManageVO
        COMMENTS : 메뉴권한을 확인한다.
    -->
    <select id="isAuth" parameterType="DefaultMap" resultType="Integer">
        /* USE : HqManageMapper.isAuth */
        SELECT COUNT(RESRCE_CD) AS CNT
          FROM TB_WB_AUTHOR_EXCEPT
         WHERE USER_ID = (SELECT twu.USER_ID
                            FROM TB_HQ_EMPLOYEE the,
                                 TB_WB_USER_INFO twu
                           WHERE the.HQ_OFFICE_CD = #{hqOfficeCd}
                             AND the.EMP_NO = '0000'
                             AND twu.USER_ID = the.USER_ID)
           AND RESRCE_CD = #{resrceCd}
           AND USE_YN = 'Y'
    </select>

    <!-- 메뉴권한 삭제-->
    <!--
        TABLE    : TB_WB_AUTHOR_EXCEPT
        PARAM    : hqManageVO
        COMMENTS : 메뉴권한을 삭제한다.
    -->
    <delete id="removeAuth" parameterType="DefaultMap">
        /* HqManageMapper.removeAuth */
        DELETE TB_WB_AUTHOR_EXCEPT
         WHERE USER_ID = (SELECT twu.USER_ID
                            FROM TB_HQ_EMPLOYEE the,
                                 TB_WB_USER_INFO twu
                           WHERE the.HQ_OFFICE_CD = #{hqOfficeCd}
                             AND the.EMP_NO = '0000'
                             AND twu.USER_ID = the.USER_ID)
           AND RESRCE_CD = #{resrceCd}
    </delete>

    <!-- 본사 환경정보 조회 -->
    <!--
        TABLE    : TB_CM_ENVST, TB_CM_ENVST_DTL, TB_HQ_ENVST, TB_CM_NMCODE, TB_HQ_OFFICE
        COMMENTS : 브랜드의 환경정보를 조회한다.
    -->
    <select id="getConfigList" parameterType="hqManageVO" resultType="DefaultMap">
        /* USE : HqManageMapper.getConfigList */
        SELECT tcd.ENVST_GRP_CD,
               tcn.NMCODE_NM,
               tcd.ENVST_CD,
               tcd.ENVST_NM,
               tcd.DIRCT_IN_YN,
               tcd.REMARK,
               tcd.ENVST_VAL_CD,
               tcd.ENVST_VAL_NM,
               tcd.DEFLT_YN,
               tcd.TARGT_FG,
               DECODE(the.ENVST_CD, NULL, 'N', 'Y') AS EXIST_FG,
               the.ENVST_VAL AS SEL_ENVST_VAL,
               tce.ENVST_CD_CNT
          FROM (
          SELECT tce.ENVST_GRP_CD,
                 tce.ENVST_CD,
                 tce.ENVST_NM,
                 tce.ENVST_FG,
                 tce.TARGT_FG,
                 tce.DIRCT_IN_YN,
                 tce.REMARK,
                 tcd.ENVST_VAL_CD,
                 tcd.ENVST_VAL_NM,
                 tcd.DEFLT_YN
            FROM TB_CM_ENVST tce,
                 TB_CM_ENVST_DTL tcd
           WHERE tce.TARGT_FG IN ('H','X','C')
             AND tce.USE_YN = 'Y'
             AND tcd.ENVST_CD (+)= tce.ENVST_CD
                ) tcd,
                (
           SELECT tce.ENVST_GRP_CD,
                  COUNT(*) AS ENVST_CD_CNT
             FROM TB_CM_ENVST tce
            WHERE tce.TARGT_FG IN ('H','X','C')
              AND tce.USE_YN = 'Y'
            GROUP BY tce.ENVST_GRP_CD
                ) tce,
               TB_HQ_ENVST the,
               TB_CM_NMCODE tcn
         WHERE the.HQ_OFFICE_CD (+)= #{hqOfficeCd}
           AND the.ENVST_CD (+)= tcd.ENVST_CD
           AND tcn.NMCODE_GRP_CD = '004'
           AND tcn.NMCODE_CD = tcd.ENVST_GRP_CD
           AND tce.ENVST_GRP_CD = tcd.ENVST_GRP_CD
         ORDER BY tcd.ENVST_GRP_CD, tcd.ENVST_CD, tcd.ENVST_VAL_CD
    </select>

    <!-- 브랜드환경정보 등록 -->
    <!--
        TABLE    : TB_HQ_ENVST
        COMMENTS : 브랜드의 환경정보를 조회한다.
    -->
    <insert id="insertConfig" parameterType="DefaultMap">
        /* USE : HqManageMapper.insertConfig */
        INSERT INTO TB_HQ_ENVST
        (
            HQ_OFFICE_CD,
            ENVST_CD,
            ENVST_VAL,
            DIRCT_IN_YN,
            USE_YN,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID
        )
        VALUES
        (
            #{hqOfficeCd},
            #{envstCd},
            #{envstVal},
            #{dirctInYn},
            #{useYn},
            #{regDt},
            #{regId},
            #{modDt},
            #{modId}
        )
    </insert>

    <!-- 환경설정 수정 -->
    <!--
        TABLE    : TB_HQ_ENVST
        COMMENTS : 환경설정정보를 수정한다.
    -->
    <update id="updateConfig" parameterType="DefaultMap">
        /* USE : HqManageMapper.updateConfig */
        UPDATE TB_HQ_ENVST
           SET ENVST_VAL = #{envstVal},
               MOD_DT = #{modDt},
               MOD_ID = #{modId}
         WHERE HQ_OFFICE_CD = #{hqOfficeCd}
           AND ENVST_CD = #{envstCd}
    </update>

    <!-- 매장 환경설정 수정 -->
    <!--
        TABLE    : TB_MS_STORE_ENVST
        COMMENTS : 매장의환경설정정보를 수정한다.
    -->
    <update id="updateConfigStore" parameterType="DefaultMap">
        /* USE : HqManageMapper.updateConfigStore */
        UPDATE TB_MS_STORE_ENVST
           SET ENVST_VAL = #{envstVal}
         WHERE STORE_CD IN (SELECT STORE_CD FROM TB_MS_STORE WHERE HQ_OFFICE_CD = #{hqOfficeCd} )
           AND ENVST_CD = #{envstCd}
    </update>

</mapper>
