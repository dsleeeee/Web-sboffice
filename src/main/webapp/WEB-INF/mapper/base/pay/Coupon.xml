<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    Coupon.xml
    쿠폰등록
    ======================================================
    No  ||  수정자 ||  수정일자    ||  수정내역
    ======================================================
    1       김지은     2018.08.10     최초작성
-->

<mapper namespace="kr.co.solbipos.base.pay.coupon.service.impl.CouponMapper">

    <resultMap id="classListMap" type="DefaultMap">
        <result column="USE_YN" property="useYn" typeHandler="CustomBooleanTypeHandler"/>
        <result column="SER_NO_YN" property="serNoYn" typeHandler="CustomBooleanTypeHandler"/>
    </resultMap>

    <resultMap id="couponListMap" type="DefaultMap">
        <result column="USE_YN" property="useYn" typeHandler="CustomBooleanTypeHandler"/>
    </resultMap>


    <!-- 본사 쿠폰 분류 조회 -->
    <!--
        TABLE    : TB_HQ_PAY_METHOD_CLASS, TB_MS_PAY_METHOD_CLASS
        COMMENTS : 본사 또는 매장의 쿠폰 분류를 조회한다.
    -->
    <select id="getCouponClassList" parameterType="payMethodClassVO" resultType="DefaultMap">
        /* USE : CouponMapper.getCouponClassList */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg.toString() == "HQ"'>
                <include refid="CmmSQL.PagingTemplateHeader"/>
                SELECT
                    thpmc.HQ_OFFICE_CD,
                    thpmc.PAY_CLASS_CD,
                    thpmc.PAY_TYPE_FG,
                    thpmc.PAY_CLASS_NM,
                    thpmc.SER_NO_YN,
                    thpmc.USE_YN,
                    thpmc.REG_ID,
                    thpmc.MAPPING_CODE,
                    (
                        SELECT
                            COUNT(thc.COUPN_CD)
                        FROM
                            TB_HQ_COUPON thc
                        WHERE
                            thc.HQ_OFFICE_CD = thpmc.HQ_OFFICE_CD
                            AND thc.PAY_CLASS_CD = thpmc.PAY_CLASS_CD
                    ) AS COUPON_CNT
                    <include refid="CmmSQL.PagingTemplateCount"/>
                FROM
                    TB_HQ_PAY_METHOD_CLASS thpmc
                WHERE
                    thpmc.HQ_OFFICE_CD = #{hqOfficeCd}
                    AND thpmc.PAY_TYPE_FG = #{payTypeFg}
                    AND thpmc.PAY_CLASS_CD != '000'
                <include refid="CmmSQL.PagingTemplateBottom"/>
            </when>
            <!-- 가맹점 -->
            <when test='orgnFg != null and orgnFg.toString() == "STORE"'>
                <include refid="CmmSQL.PagingTemplateHeader"/>
                SELECT
                    tmpmc.STORE_CD,
                    tmpmc.PAY_TYPE_FG,
                    tmpmc.PAY_CLASS_CD,
                    tmpmc.PAY_CLASS_NM,
                    tmpmc.SER_NO_YN,
                    tmpmc.USE_YN,
                    tmpmc.REG_ID,
                    tmpmc.MAPPING_CODE,
                    (
                        SELECT
                            COUNT(tmc.COUPN_CD)
                        FROM
                            TB_MS_COUPON tmc
                        WHERE
                            tmc.STORE_CD = tmpmc.STORE_CD
                            AND tmc.PAY_CLASS_CD = tmpmc.PAY_CLASS_CD
                    ) AS COUPON_CNT
                    <include refid="CmmSQL.PagingTemplateCount"/>
                FROM
                    TB_MS_PAY_METHOD_CLASS tmpmc
                WHERE
                    tmpmc.STORE_CD = #{storeCd}
                    AND tmpmc.PAY_TYPE_FG = #{payTypeFg}
                    AND tmpmc.PAY_CLASS_CD != '000'
                <include refid="CmmSQL.PagingTemplateBottom"/>
            </when>
        </choose>
    </select>

    <!-- 쿠폰 분류 코드 조회 -->
    <!--
        TABLE    : TB_HQ_PAY_METHOD_CLASS, TB_MS_PAY_METHOD_CLASS
        COMMENTS : 쿠폰 분류 코드를 조회한다.
    -->
    <select id="getPayMethodClassCd" parameterType="DefaultMap" resultType="String">
        /* USE : CouponMapper.getPayMethodClassCd */
<!--        <if test="coupnEnvstVal != null and coupnEnvstVal.toString() == 'HQ'">-->
        <if test="orgnFg != null and orgnFg.toString() == 'HQ'">
            SELECT LPAD( NVL(MAX(PAY_CLASS_CD), 0) + 1, 3, '0')
            FROM TB_HQ_PAY_METHOD_CLASS
            WHERE HQ_OFFICE_CD = #{hqOfficeCd}
            AND PAY_TYPE_FG = #{payTypeFg}
        </if>
        <if test="orgnFg != null and orgnFg.toString() == 'STORE'">
            SELECT LPAD( NVL(MAX(PAY_CLASS_CD), 799) + 1, 3, '0')
            FROM TB_MS_PAY_METHOD_CLASS
            WHERE STORE_CD = #{storeCd}
            AND PAY_TYPE_FG = #{payTypeFg}
            AND PAY_CLASS_CD > 799
        </if>
    </select>

    <!-- 본사 쿠폰 분류 등록 -->
    <!--
        TABLE    : TB_HQ_PAY_METHOD_CLASS
        COMMENTS : 분류를 등록한다.
    -->
    <insert id="insertHqCouponClass" parameterType="DefaultMap">
        /* USE : CouponMapper.insertHqCouponClass */
        INSERT INTO TB_HQ_PAY_METHOD_CLASS
        (
            HQ_OFFICE_CD,
            PAY_CLASS_CD,
            PAY_TYPE_FG,
            PAY_CLASS_NM,
            SER_NO_YN,
            USE_YN,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID,
            MAPPING_CODE
        ) VALUES (
            #{hqOfficeCd},
            #{payClassCd},
            #{payTypeFg},
            #{payClassNm},
            #{serNoYn},
            #{useYn},
            #{regDt},
            #{regId},
            #{modDt},
            #{modId},
            #{mappingCode}
        )
    </insert>

    <!-- 본사 쿠폰 분류 수정 -->
    <!--
        TABLE    : TB_HQ_PAY_METHOD_CLASS
        COMMENTS : 분류를 수정한다.
    -->
    <update id="updateHqCouponClass" parameterType="DefaultMap">
        /* USE : CouponMapper.updateHqCouponClass */
        UPDATE
            TB_HQ_PAY_METHOD_CLASS
        SET
            PAY_CLASS_NM = #{payClassNm},
            SER_NO_YN = #{serNoYn},
            USE_YN = #{useYn},
            MOD_DT = #{modDt},
            MOD_ID = #{modId},
            MAPPING_CODE = #{mappingCode}
        WHERE
            HQ_OFFICE_CD = #{hqOfficeCd}
            AND PAY_CLASS_CD = #{payClassCd}
            AND PAY_TYPE_FG =  #{payTypeFg}
    </update>

    <!-- 본사 쿠폰 분류 삭제 -->
    <!--
        TABLE    : TB_HQ_PAY_METHOD_CLASS
        COMMENTS : 분류를 삭제한다.
    -->
    <update id="deleteHqCouponClass" parameterType="DefaultMap">
        /* USE : CouponMapper.deleteHqCouponClass */
        DELETE  TB_HQ_PAY_METHOD_CLASS
        WHERE   HQ_OFFICE_CD = #{hqOfficeCd}
        AND     PAY_CLASS_CD = #{payClassCd}
        AND     PAY_TYPE_FG =  #{payTypeFg}
    </update>

    <!-- 매장 쿠폰 분류 등록 -->
    <!--
        TABLE    : TB_HQ_PAY_METHOD_CLASS
        COMMENTS : 분류를 등록한다.
    -->
    <insert id="insertStoreCouponClass" parameterType="DefaultMap">
        /* USE : CouponMapper.insertStoreCouponClass */
        INSERT INTO TB_MS_PAY_METHOD_CLASS
        (
            STORE_CD,
            PAY_CLASS_CD,
            PAY_TYPE_FG,
            PAY_CLASS_NM,
            SER_NO_YN,
            USE_YN,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID,
            MAPPING_CODE
        ) VALUES (
            #{storeCd},
            #{payClassCd},
            #{payTypeFg},
            #{payClassNm},
            #{serNoYn},
            #{useYn},
            #{regDt},
            #{regId},
            #{modDt},
            #{modId},
            #{mappingCode}
        )
    </insert>

    <!-- 매장 쿠폰 분류 수정 -->
    <!--
        TABLE    : TB_HQ_PAY_METHOD_CLASS
        COMMENTS : 분류를 수정한다.
    -->
    <update id="updateStoreCouponClass" parameterType="DefaultMap">
        /* USE : CouponMapper.updateStoreCouponClass */
        UPDATE
            TB_MS_PAY_METHOD_CLASS
        SET
            PAY_CLASS_NM = #{payClassNm},
            SER_NO_YN = #{serNoYn},
            USE_YN = #{useYn},
            MOD_DT = #{modDt},
            MOD_ID = #{modId},
            MAPPING_CODE = #{mappingCode}
        WHERE
            STORE_CD = #{storeCd}
            AND PAY_CLASS_CD = #{payClassCd}
            AND PAY_TYPE_FG =  #{payTypeFg}
    </update>

    <!-- 매장 쿠폰 분류 삭제 -->
    <!--
        TABLE    : TB_HQ_PAY_METHOD_CLASS
        COMMENTS : 분류를 삭제한다.
    -->
    <update id="deleteStoreCouponClass" parameterType="DefaultMap">
        /* USE : CouponMapper.deleteStoreCouponClass */
        DELETE  TB_MS_PAY_METHOD_CLASS
        WHERE   STORE_CD = #{storeCd}
        AND     PAY_TYPE_FG = #{payTypeFg}
        AND     PAY_CLASS_CD = #{payClassCd}
    </update>

    <!-- 본사 쿠폰분류 등록시 프로시져 호출 -->
    <!--
        TABLE    : TB_HQ_PAY_METHOD_CLASS, TB_MS_PAY_METHOD_CLASS
        PARAM    :
        COMMENTS : 본사 쿠폰분류를 매장 쿠폰분류에 적용시킨다.
    -->
    <select id="insertHqCouponClassToStore" statementType="CALLABLE" parameterType="payMethodClassVO" resultType="String">
        /* USE : CouponMapper.insertHqCouponClassToStore */
        {
            CALL PKG_HQ_PAY_METHOD_CLASS.SP_HQ_PAY_METHOD_CLASS_I
            (
                #{hqOfficeCd},
                #{payTypeFg, jdbcType=VARCHAR},
                #{payClassCd},
                #{regDt},
                #{regId},
                #{result, mode=OUT, jdbcType=VARCHAR}
            )
        }
    </select>

    <!-- 본사 쿠폰분류 수정 프로시져 호출 -->
    <!--
        TABLE    : TB_HQ_PAY_METHOD_CLASS, TB_MS_PAY_METHOD_CLASS
        PARAM    :
        COMMENTS : 본사 쿠폰분류를 매장 쿠폰분류에 적용시킨다.
    -->
    <select id="updateHqCouponClassToStore" statementType="CALLABLE" parameterType="payMethodClassVO" resultType="String">
        /* USE : CouponMapper.updateHqCouponClassToStore */
        {
            CALL PKG_HQ_PAY_METHOD_CLASS.SP_HQ_PAY_METHOD_CLASS_U
            (
                #{hqOfficeCd},
                #{payTypeFg, jdbcType=VARCHAR},
                #{payClassCd},
                #{modDt},
                #{modId},
                #{result, mode=OUT, jdbcType=VARCHAR}
            )
        }
    </select>

    <!-- 본사 쿠폰분류 삭제 프로시져 호출 -->
    <!--
        TABLE    : TB_HQ_PAY_METHOD_CLASS, TB_MS_PAY_METHOD_CLASS
        PARAM    :
        COMMENTS : 본사 쿠폰분류를 매장 쿠폰분류에 적용시킨다.
    -->
    <select id="deleteHqCouponClassToStore" statementType="CALLABLE" parameterType="payMethodClassVO" resultType="String">
        /* USE : CouponMapper.deleteHqCouponClassToStore */
        {
            CALL PKG_HQ_PAY_METHOD_CLASS.SP_HQ_PAY_METHOD_CLASS_D
            (
                #{hqOfficeCd},
                #{payTypeFg, jdbcType=VARCHAR},
                #{payClassCd},
                #{modDt},
                #{modId},
                #{result, mode=OUT, jdbcType=VARCHAR}
            )
        }
    </select>

    <!-- 본사 쿠폰 조회 -->
    <!--
        TABLE    : TB_HQ_COUPON
        COMMENTS : 본사의 쿠폰을 조회한다.
    -->
    <select id="getHqCouponList" parameterType="DefaultMap" resultType="DefaultMap">
        /* USE : CouponMapper.getHqCouponList */
        SELECT
            thc.HQ_OFFICE_CD,
            thc.COUPN_CD,
            thc.COUPN_NM,
            thc.PAY_CLASS_CD,
            thc.COUPN_DC_FG,
            thc.COUPN_DC_RATE,
            thc.COUPN_DC_AMT,
            thc.COUPN_APPLY_FG,
            thc.USE_YN,
            thc.REG_ID,
            thc.COUPN_TARGET_FG,
            thc.COUPN_PROD_FG,
            (SELECT COUNT(thcp.PROD_CD) FROM TB_HQ_COUPON_PROD thcp WHERE thcp.HQ_OFFICE_CD = thc.HQ_OFFICE_CD AND thcp.PAY_CLASS_CD = thc.PAY_CLASS_CD AND thcp.COUPN_CD = thc.COUPN_CD ) AS PROD_CNT,
            (SELECT COUNT(thcs.STORE_CD) FROM TB_HQ_COUPON_STORE thcs WHERE thcs.HQ_OFFICE_CD = thc.HQ_OFFICE_CD AND thcs.PAY_CLASS_CD = thc.PAY_CLASS_CD AND thcs.COUPN_CD = thc.COUPN_CD ) AS STORE_CNT,
            thc.DISP_SEQ_NO AS DISP_SEQ
        FROM
            TB_HQ_COUPON thc
        WHERE
            thc.HQ_OFFICE_CD = #{hqOfficeCd}
            AND thc.PAY_CLASS_CD = #{payClassCd}
--             AND thc.USE_YN = 'Y'
        ORDER BY thc.DISP_SEQ_NO
    </select>

    <!-- 매장 쿠폰 조회 -->
    <!--
        TABLE    : TB_MS_PAY_METHOD_CLASS
        COMMENTS : 매장의 쿠폰을 조회한다.
    -->
    <select id="getStoreCouponList" parameterType="DefaultMap" resultType="DefaultMap">
        /* USE : CouponMapper.getStoreCouponList */
        SELECT
            tmc.STORE_CD,
            tmc.COUPN_CD,
            tmc.COUPN_NM,
            tmc.PAY_CLASS_CD,
            tmc.COUPN_DC_FG,
            tmc.COUPN_DC_RATE,
            tmc.COUPN_DC_AMT,
            tmc.COUPN_APPLY_FG,
            tmc.USE_YN,
            tmc.REG_ID,
            tmc.COUPN_TARGET_FG,
            tmc.COUPN_PROD_FG,
            (SELECT COUNT(tmcp.PROD_CD) FROM TB_MS_COUPON_PROD tmcp WHERE tmcp.STORE_CD = tmc.STORE_CD AND tmcp.PAY_CLASS_CD = tmc.PAY_CLASS_CD AND tmcp.COUPN_CD = tmc.COUPN_CD ) AS PROD_CNT,
            tmc.DISP_SEQ_NO
        FROM
            TB_MS_COUPON tmc
        WHERE
            tmc.STORE_CD = #{storeCd}
            AND tmc.PAY_CLASS_CD = #{payClassCd}
--             AND tmc.USE_YN = 'Y'
        ORDER BY tmc.DISP_SEQ_NO
    </select>

    <!-- 쿠폰 코드 조회 -->
    <!--
        TABLE    : TB_HQ_COUPON, TB_MS_COUPON
        COMMENTS : 쿠폰 분류 코드를 조회한다.
    -->
    <select id="getCouponCd" parameterType="DefaultMap" resultType="String">
        /* USE : CouponMapper.getCouponCd */
        <if test="orgnFg != null and orgnFg.toString() == 'HQ'">
            SELECT
                LPAD( NVL(MAX(COUPN_CD), 0) + 1, 4, '0') AS COUPN_CD
            FROM
                TB_HQ_COUPON
            WHERE
                HQ_OFFICE_CD = #{hqOfficeCd}
                AND PAY_CLASS_CD = #{payClassCd}
        </if>
        <if test="orgnFg != null and orgnFg.toString() == 'STORE'">
            SELECT
                LPAD( NVL(MAX(COUPN_CD), 0) + 1, 4, '0') AS COUPN_CD
            FROM
                TB_MS_COUPON
            WHERE
                STORE_CD = #{storeCd}
                AND PAY_CLASS_CD = #{payClassCd}
        </if>
    </select>

    <!-- 본사 쿠폰 등록 -->
    <!--
        TABLE    : TB_HQ_COUPON
        COMMENTS : 쿠폰을 등록한다.
    -->
    <insert id="insertHqCoupon" parameterType="DefaultMap">
        /* USE : CouponMapper.insertHqCoupon */
        INSERT INTO TB_HQ_COUPON
        (
            HQ_OFFICE_CD,
            COUPN_CD,
            COUPN_NM,
            PAY_CLASS_CD,
            COUPN_DC_FG,
            COUPN_DC_RATE,
            COUPN_DC_AMT,
            COUPN_APPLY_FG,
            COUPN_TARGET_FG,
            COUPN_PROD_FG,
            USE_YN,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID,
            DISP_SEQ_NO
        ) VALUES (
            #{hqOfficeCd},
            #{coupnCd},
            #{coupnNm},
            #{payClassCd},
            #{coupnDcFg},
            #{coupnDcRate},
            #{coupnDcAmt},
            #{coupnApplyFg},
            #{coupnTargetFg},
            #{coupnProdFg},
            #{useYn},
            #{regDt},
            #{regId},
            #{modDt},
            #{modId},
            #{dispSeq}
        )
    </insert>

    <!-- 본사 쿠폰 수정 -->
    <!--
        TABLE    : TB_HQ_COUPON
        COMMENTS : 쿠폰을 수정한다.
    -->
    <update id="updateHqCoupon" parameterType="DefaultMap">
        /* USE : CouponMapper.updateHqCoupon */
        UPDATE
            TB_HQ_COUPON
        SET
            COUPN_NM = #{coupnNm},
            COUPN_DC_FG = #{coupnDcFg},
            COUPN_DC_RATE = #{coupnDcRate},
            COUPN_DC_AMT = #{coupnDcAmt},
            COUPN_APPLY_FG = #{coupnApplyFg},
            COUPN_TARGET_FG = #{coupnTargetFg},
            COUPN_PROD_FG = #{coupnProdFg},
            USE_YN = #{useYn},
            MOD_DT = #{modDt},
            MOD_ID = #{modId},
            DISP_SEQ_NO = #{dispSeq}
        WHERE
            HQ_OFFICE_CD = #{hqOfficeCd}
            AND PAY_CLASS_CD =  #{payClassCd}
            AND COUPN_CD = #{coupnCd}
    </update>

    <!-- 본사 쿠폰 삭제 -->
    <!--
        TABLE    : TB_HQ_COUPON
        COMMENTS : 쿠폰을 삭제한다.
    -->
    <update id="deleteHqCoupon" parameterType="DefaultMap">
        /* USE : CouponMapper.deleteHqCoupon */
        DELETE  TB_HQ_COUPON
        WHERE   HQ_OFFICE_CD = #{hqOfficeCd}
        AND     PAY_CLASS_CD =  #{payClassCd}
        <if test="coupnCd != null and coupnCd != ''">
        AND     COUPN_CD = #{coupnCd}
        </if>
    </update>

    <!-- 본사 쿠폰 등록시 프로시져 호출 -->
    <!--
        TABLE    : TB_MS_COUPON
        PARAM    :
        COMMENTS : 본사 쿠폰을 매장에 등록시킨다.
    -->
    <select id="insertHqCouponToStore" statementType="CALLABLE" parameterType="couponStoreVO" resultType="String">
        /* USE : CouponMapper.insertHqCouponToStore */
        {
            CALL PKG_HQ_COUPON.SP_HQ_COUPON_I
            (
                #{hqOfficeCd},
                #{payClassCd},
                #{coupnCd},
                #{storeCd},
                #{regDt},
                #{regId},
                #{result, mode=OUT, jdbcType=VARCHAR}
            )
        }
    </select>

    <!-- 본사 쿠폰 수정시 프로시져 호출 -->
    <!--
        TABLE    : TB_MS_COUPON
        PARAM    :
        COMMENTS : 본사 쿠폰 수정정보를 매장 쿠폰에 적용한다.
    -->
    <select id="updateHqCouponToStore" statementType="CALLABLE" parameterType="couponVO" resultType="String">
        /* USE : CouponMapper.updateHqCouponToStore */
        {
            CALL PKG_HQ_COUPON.SP_HQ_COUPON_U
            (
                #{hqOfficeCd},
                #{payClassCd},
                #{coupnCd},
                #{modDt},
                #{modId},
                #{result, mode=OUT, jdbcType=VARCHAR}
            )
        }
    </select>

    <!-- 본사 쿠폰 삭제시 프로시져 호출 -->
    <!--
        TABLE    : TB_MS_COUPON
        PARAM    :
        COMMENTS : 본사 쿠폰을 매장 쿠폰에서 삭제한다.
    -->
    <select id="deleteHqCouponToStore01" statementType="CALLABLE" parameterType="couponVO" resultType="String">
        /* USE : CouponMapper.deleteHqCouponToStore01 */
        {
            CALL PKG_HQ_COUPON.SP_HQ_COUPON_D01
            (
                #{hqOfficeCd},
                #{payClassCd},
                #{coupnCd},
                #{modDt},
                #{modId},
                #{result, mode=OUT, jdbcType=VARCHAR}
            )
        }
    </select>

    <!-- 매장 쿠폰 등록 -->
    <!--
        TABLE    : TB_MS_COUPON
        COMMENTS : 매장에 쿠폰을 등록한다.
    -->
    <insert id="insertStoreCoupon" parameterType="DefaultMap">
        /* USE : CouponMapper.insertStoreCoupon */
        INSERT INTO TB_MS_COUPON
        (
            STORE_CD,
            COUPN_REG_FG,
            PAY_CLASS_CD,
            COUPN_CD,
            COUPN_NM,
            COUPN_DC_FG,
            COUPN_DC_RATE,
            COUPN_DC_AMT,
            COUPN_APPLY_FG,
            COUPN_PROD_FG,
            USE_YN,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID,
            DISP_SEQ_NO
        ) VALUES (
            #{storeCd},
            #{coupnRegFg},
            #{payClassCd},
            #{coupnCd},
            #{coupnNm},
            #{coupnDcFg},
            #{coupnDcRate},
            #{coupnDcAmt},
            #{coupnApplyFg},
            #{coupnProdFg},
            #{useYn, jdbcType=VARCHAR},
            #{regDt},
            #{regId},
            #{modDt},
            #{modId},
            #{dispSeq}
        )
    </insert>

    <!-- 매장 쿠폰 수정 -->
    <!--
        TABLE    : TB_MS_COUPON
        COMMENTS : 매장의 쿠폰을 수정한다.
    -->
    <update id="updateStoreCoupon" parameterType="DefaultMap">
        /* USE : CouponMapper.updateStoreCoupon */
        UPDATE
            TB_MS_COUPON
        SET
            COUPN_NM = #{coupnNm},
            COUPN_DC_FG = #{coupnDcFg},
            COUPN_DC_RATE = #{coupnDcRate},
            COUPN_DC_AMT = #{coupnDcAmt},
            COUPN_APPLY_FG = #{coupnApplyFg},
            COUPN_TARGET_FG = #{coupnTargetFg},
            COUPN_PROD_FG = #{coupnProdFg},
            USE_YN = #{useYn},
            MOD_DT = #{modDt},
            MOD_ID = #{modId},
            DISP_SEQ_NO = #{dispSeq}
        WHERE
            STORE_CD = #{storeCd}
            AND COUPN_REG_FG =  #{coupnRegFg}
            AND PAY_CLASS_CD =  #{payClassCd}
            AND COUPN_CD = #{coupnCd}
    </update>

    <!-- 매장 쿠폰 삭제 -->
    <!--
        TABLE    : TB_MS_COUPON
        COMMENTS : 쿠폰을 삭제한다.
    -->
    <update id="deleteStoreCoupon" parameterType="DefaultMap">
        /* USE : CouponMapper.deleteStoreCoupon */
        DELETE  TB_MS_COUPON
        WHERE   PAY_CLASS_CD = #{payClassCd}
        <if test="coupnRegFg != null and coupnRegFg != ''">
        AND     COUPN_REG_FG =  #{coupnRegFg}
        </if>
        <if test="coupnCd != null and coupnCd != ''">
            AND COUPN_CD = #{coupnCd}
        </if>
        <if test="storeCd != null and storeCd != ''">
            AND STORE_CD = #{storeCd}
        </if>
        <if test="storeCd == null or storeCd == ''">
            AND STORE_CD IN (SELECT STORE_CD FROM TB_MS_STORE WHERE HQ_OFFICE_CD = #{hqOfficeCd})
        </if>
    </update>

    <!-- 매장 쿠폰 삭제 시 하위 분류가 있는지 조회 -->
    <!--
        TABLE    : TB_MS_COUPON
        COMMENTS : 쿠폰을 삭제한다.
    -->
    <select id="getCouponCnt" parameterType="couponVO" resultType="Integer">
        /* USE : CouponMapper.getCouponCnt */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg.toString() == "HQ"'>
                SELECT  COUNT(*)
                FROM    TB_HQ_COUPON
                WHERE   HQ_OFFICE_CD = #{hqOfficeCd}
                AND     PAY_CLASS_CD = #{payClassCd}
                <if test="coupnCd != null and coupnCd != ''">
                    AND COUPN_CD = #{coupnCd}
                </if>
            </when>
            <!-- 매장 -->
            <when test='orgnFg != null and orgnFg.toString() == "STORE"'>
                SELECT  COUNT(*)
                FROM    TB_MS_COUPON
                WHERE   STORE_CD = #{storeCd}
                AND     PAY_CLASS_CD = #{payClassCd}
                <if test="coupnCd != null and coupnCd != ''">
                    AND COUPN_CD = #{coupnCd}
                </if>
            </when>
        </choose>
    </select>

    <!-- 매장 쿠폰 삭제 시 하위 분류가 있는지 조회 -->
    <!--
        TABLE    : TB_MS_COUPON
        COMMENTS : 쿠폰을 삭제한다.
    -->
    <select id="getCouponProdCnt" parameterType="couponProdVO" resultType="Integer">
        /* USE : CouponMapper.getCouponProdCnt */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg.toString() == "HQ"'>
                SELECT  COUNT(*)
                FROM    TB_HQ_COUPON_PROD
                WHERE   HQ_OFFICE_CD = #{hqOfficeCd}
                AND     PAY_CLASS_CD = #{payClassCd}
                <if test="coupnCd != null and coupnCd != ''">
                    AND COUPN_CD = #{coupnCd}
                </if>
            </when>
            <!-- 매장 -->
            <when test='orgnFg != null and orgnFg.toString() == "STORE"'>
                SELECT  COUNT(*)
                FROM    TB_MS_COUPON_PROD
                WHERE   STORE_CD = #{storeCd}
                AND     PAY_CLASS_CD = #{payClassCd}
                <if test="coupnCd != null and coupnCd != ''">
                    AND COUPN_CD = #{coupnCd}
                </if>
            </when>
        </choose>
    </select>

    <!-- 매장 쿠폰 삭제 시 하위 분류가 있는지 조회 -->
    <!--
        TABLE    : TB_MS_COUPON
        COMMENTS : 쿠폰을 삭제한다.
    -->
    <select id="getCouponStoreCnt" parameterType="payMethodClassVO" resultType="Integer">
        /* USE : CouponMapper.getCouponStoreCnt */
        SELECT  COUNT(*)
        FROM    TB_HQ_COUPON_STORE
        WHERE   HQ_OFFICE_CD = #{hqOfficeCd}
        AND     PAY_CLASS_CD = #{payClassCd}
        <if test='coupnCd != null and coupnCd != ""'>
            AND     COUPN_CD = #{coupnCd}
        </if>
    </select>

    <!-- 쿠폰 적용/미적용 본사 상품 조회 -->
    <!--
        TABLE    : TB_HQ_PRODUCT, TB_HQ_PRODUCT_CLASS, TB_HQ_COUPON_PROD
        COMMENTS : 본사의 상품을 조회한다.
    -->
    <select id="getHqProdList" parameterType="couponProdVO" resultType="DefaultMap">
        /* USE : CouponMapper.getHqProdList */
        <if test='prodRegFg != null and prodRegFg.toString() == "Y"'>
            SELECT p.HQ_OFFICE_CD,
                   p.PROD_CLASS_CD,
                   p.PROD_CLASS_NM,
                   thcp.PROD_CD,
                   NVL(p.PROD_NM,'삭제된 메뉴') AS PROD_NM,
                   p.COST_UPRC,
                   NVL2(thcp.PROD_CD, 'Y', 'N') AS REG_YN
              FROM TB_HQ_COUPON_PROD thcp LEFT OUTER JOIN
                   (SELECT thp.HQ_OFFICE_CD,
                           thp.PROD_CLASS_CD,
                           thpc.PROD_CLASS_NM,
                           thp.PROD_CD,
                           thp.PROD_NM,
                           thp.COST_UPRC
                      FROM TB_HQ_PRODUCT thp,
                           TB_HQ_PRODUCT_CLASS thpc
                     WHERE thp.HQ_OFFICE_CD = THPC.HQ_OFFICE_CD
                       AND thp.PROD_CLASS_CD = THPC.PROD_CLASS_CD
                       AND THP.HQ_OFFICE_CD = #{hqOfficeCd}
                       AND (
                             ( ((SELECT COUNT(HQ_BRAND_CD) FROM TB_WB_USER_BRAND WHERE USER_ID = #{userId}) != 0) AND (thp.HQ_BRAND_CD IN (SELECT HQ_BRAND_CD FROM TB_WB_USER_BRAND WHERE USER_ID = #{userId})) )
                             OR
                             ( ((SELECT COUNT(HQ_BRAND_CD) FROM TB_WB_USER_BRAND WHERE USER_ID = #{userId}) = 0) AND 1=1 )
                           )
                ) p
                ON thcp.HQ_OFFICE_CD = p.HQ_OFFICE_CD
               AND thcp.PROD_CD = p.prod_cd
             WHERE thcp.HQ_OFFICE_CD = #{hqOfficeCd}
               AND thcp.PAY_CLASS_CD = #{payClassCd}
               AND thcp.COUPN_CD = #{coupnCd}
            <if test='prodCd != null and prodCd != ""'>
                AND p.PROD_CD = #{prodCd}
            </if>
            <if test='prodNm != null and prodNm != ""'>
                AND p.PROD_NM LIKE '%'||#{prodNm}||'%'
            </if>
        </if>
        <if test='prodRegFg != null and prodRegFg.toString() == "N"'>
            SELECT thp.HQ_OFFICE_CD,
                   thp.PROD_CLASS_CD,
                   thpc.PROD_CLASS_NM,
                   thp.PROD_CD,
                   thp.PROD_NM,
                   thp.COST_UPRC,
                   NVL2(thcp.PROD_CD, 'Y', 'N') AS REG_YN
              FROM TB_HQ_PRODUCT thp,
                   TB_HQ_PRODUCT_CLASS thpc,
                   TB_HQ_COUPON_PROD thcp
             WHERE thp.USE_YN = 'Y'
               AND thp.HQ_OFFICE_CD = #{hqOfficeCd}
               AND thp.HQ_OFFICE_CD = thpc.HQ_OFFICE_CD
               AND thp.PROD_CLASS_CD = thpc.PROD_CLASS_CD
               AND thcp.HQ_OFFICE_CD (+)= thp.HQ_OFFICE_CD
               AND thcp.PAY_CLASS_CD (+)=  #{payClassCd}
               AND thcp.COUPN_CD (+)= #{coupnCd}
               AND thcp.PROD_CD (+)= thp.PROD_CD
            <if test='prodCd != null and prodCd != ""'>
                AND thp.PROD_CD = #{prodCd}
            </if>
            <if test='prodNm != null and prodNm != ""'>
                AND thp.PROD_NM LIKE '%'||#{prodNm}||'%'
            </if>
            AND thcp.PROD_CD IS NULL
            AND (
                    ( ((SELECT COUNT(HQ_BRAND_CD) FROM TB_WB_USER_BRAND WHERE USER_ID = #{userId}) != 0) AND (thp.HQ_BRAND_CD IN (SELECT HQ_BRAND_CD FROM TB_WB_USER_BRAND WHERE USER_ID = #{userId})) )
                    OR
                    ( ((SELECT COUNT(HQ_BRAND_CD) FROM TB_WB_USER_BRAND WHERE USER_ID = #{userId}) = 0) AND 1=1 )
                )
        </if>
    </select>

    <!-- 쿠폰 적용/미적용 매장 상품 조회 -->
    <!--
        TABLE    : TB_MS_PRODUCT, TB_MS_PRODUCT_CLASS, TB_MS_COUPON_PROD
        COMMENTS : 매장의 상품을 조회한다
    -->
    <select id="getStoreProdList" parameterType="couponProdVO" resultType="DefaultMap">
        /* USE : CouponMapper.getStoreProdList */
        <if test='prodRegFg != null and prodRegFg.toString() == "Y"'>
            SELECT p.STORE_CD,
                   p.PROD_CLASS_CD,
                   p.PROD_CLASS_NM,
                   tmcp.PROD_CD,
                   NVL(p.PROD_NM,'삭제된 메뉴') AS PROD_NM,
                   p.COST_UPRC,
                   NVL2(tmcp.PROD_CD, 'Y', 'N') AS REG_YN
              FROM TB_ms_COUPON_PROD tmcp LEFT OUTER JOIN
                    (SELECT tmp.STORE_CD,
                            tmp.PROD_CLASS_CD,
                            tmpc.PROD_CLASS_NM,
                            tmp.PROD_CD,
                            tmp.PROD_NM,
                            tmp.COST_UPRC
                       FROM TB_MS_PRODUCT tmp,
                            TB_MS_PRODUCT_CLASS tmpc
                      WHERE tmp.STORE_CD = tmpc.STORE_CD
                        AND tmp.PROD_CLASS_CD = tmpc.PROD_CLASS_CD
                        AND tmp.STORE_CD = #{storeCd}) p
                 ON tmcp.STORE_CD = p.STORE_CD
                AND tmcp.PROD_CD = p.prod_cd
              WHERE tmcp.STORE_CD = #{storeCd}
                AND tmcp.PAY_CLASS_CD = #{payClassCd}
                AND tmcp.COUPN_CD = #{coupnCd}
            <if test='prodCd != null and prodCd != ""'>
                AND p.PROD_CD = #{prodCd}
            </if>
            <if test='prodNm != null and prodNm != ""'>
                AND p.PROD_NM LIKE '%'||#{prodNm}||'%'
            </if>
        </if>
        <if test='prodRegFg != null and prodRegFg.toString() == "N"'>
            SELECT tmp.STORE_CD,
                   tmp.PROD_CLASS_CD,
                   tmpc.PROD_CLASS_NM,
                   tmp.PROD_CD,
                   tmp.PROD_NM,
                   tmp.COST_UPRC,
                   NVL2(tmcp.PROD_CD, 'Y', 'N') AS REG_YN
              FROM TB_MS_PRODUCT tmp,
                   TB_MS_PRODUCT_CLASS tmpc,
                   TB_MS_COUPON_PROD tmcp
             WHERE tmp.USE_YN = 'Y'
               AND tmp.STORE_CD = #{storeCd}
               AND tmp.STORE_CD = tmpc.STORE_CD
               AND tmp.PROD_CLASS_CD = tmpc.PROD_CLASS_CD
               AND tmcp.STORE_CD (+)= tmp.STORE_CD
               AND tmcp.PAY_CLASS_CD (+)= #{payClassCd}
               AND tmcp.COUPN_CD (+)= #{coupnCd}
               AND tmcp.PROD_CD (+)= tmp.PROD_CD
            <if test='prodCd != null and prodCd != ""'>
                AND thp.PROD_CD = #{prodCd}
            </if>
            <if test='prodNm != null and prodNm != ""'>
                AND thp.PROD_NM LIKE '%'||#{prodNm}||'%'
            </if>
               AND tmcp.PROD_CD IS NULL
        </if>
    </select>

    <!-- 본사 쿠폰적용상품 등록 -->
    <!--
        TABLE    : TB_HQ_COUPON_PROD
        COMMENTS : 본사 쿠폰을 적용할 상품을 등록한다.
    -->
    <insert id="insertHqCouponProd" parameterType="couponProdVO">
        /* USE : CouponMapper.insertHqCouponProd */
        INSERT INTO TB_HQ_COUPON_PROD
        (
            HQ_OFFICE_CD,
            PAY_CLASS_CD,
            COUPN_CD,
            PROD_CD,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID
        ) VALUES (
            #{hqOfficeCd},
            #{payClassCd},
            #{coupnCd},
            #{prodCd},
            #{regDt},
            #{regId},
            #{modDt},
            #{modId}
        )
    </insert>

    <!-- 매장 쿠폰적용상품 등록 -->
    <!--
        TABLE    : TB_MS_COUPON_PROD
        COMMENTS : 본사 쿠폰을 적용할 상품을 등록한다.
    -->
    <insert id="insertStoreCouponProd" parameterType="couponProdVO">
        /* USE : CouponMapper.insertStoreCouponProd */
        INSERT INTO TB_MS_COUPON_PROD
        (
            STORE_CD,
            PAY_CLASS_CD,
            COUPN_CD,
            PROD_CD,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID
        ) VALUES (
            #{storeCd},
            #{payClassCd},
            #{coupnCd},
            #{prodCd},
            #{regDt},
            #{regId},
            #{modDt},
            #{modId}
        )
  </insert>

    <!-- 본사 쿠폰적용상품 삭제 -->
    <!--
        TABLE    : TB_HQ_COUPON_PROD
        COMMENTS : 본사 쿠폰을 적용한 상품을 삭제한다.
    -->
    <delete id="deleteHqCouponProd" parameterType="couponProdVO">
        /* USE : CouponMapper.deleteHqCouponProd */
        DELETE
            TB_HQ_COUPON_PROD
        WHERE
            HQ_OFFICE_CD = #{hqOfficeCd}
            AND PAY_CLASS_CD = #{payClassCd}
        <if test='coupnCd != null and coupnCd != ""'>
            AND COUPN_CD = #{coupnCd}
        </if>
        <if test='prodCd != null and prodCd != ""'>
            AND PROD_CD = #{prodCd}
        </if>
    </delete>

    <!-- 매장 쿠폰적용상품 삭제 -->
    <!--
        TABLE    : TB_MS_COUPON_PROD
        COMMENTS : 본사 쿠폰을 적용한 상품을 삭제한다.
    -->
    <delete id="deleteStoreCouponProd" parameterType="couponProdVO">
        /* USE : CouponMapper.deleteStoreCouponProd */
        DELETE  TB_MS_COUPON_PROD
        WHERE   PAY_CLASS_CD = #{payClassCd}
        <if test='coupnCd != null and coupnCd != ""'>
            AND COUPN_CD = #{coupnCd}
        </if>
        <if test='prodCd != null and prodCd != ""'>
            AND PROD_CD = #{prodCd}
        </if>
        <if test='storeCd != null and storeCd != ""'>
            AND STORE_CD = #{storeCd}
        </if>
        <if test='storeCd == null or storeCd == ""'>
            AND STORE_CD IN (SELECT STORE_CD FROM TB_MS_STORE WHERE HQ_OFFICE_CD = #{hqOfficeCd})
        </if>
    </delete>

    <!-- 본사 쿠폰적용상품 등록시 프로시져 호출 -->
    <!--
        TABLE    : TB_HQ_COUPON_PROD, TB_MS_COUPON_PROD
        PARAM    :
        COMMENTS : 본사 쿠폰적용상품을 매장 쿠폰에 적용시킨다.
    -->
    <select id="insertHqCouponProdToStore01" statementType="CALLABLE" parameterType="couponProdVO" resultType="String">
        /* USE : CouponMapper.insertHqCouponProdToStore01 */
        {
            CALL PKG_HQ_COUPON_PROD.SP_HQ_COUPON_PROD_I01
            (
                #{hqOfficeCd},
                #{payClassCd},
                #{coupnCd},
                #{prodCd},
                #{regDt},
                #{regId},
                #{result, mode=OUT, jdbcType=VARCHAR}
            )
        }
    </select>

    <!-- 본사 쿠폰적용상품 삭제시 프로시져 호출 -->
    <!--
        TABLE    : TB_HQ_COUPON_PROD, TB_MS_COUPON_PROD
        PARAM    :
        COMMENTS : 본사 쿠폰적용상품을 매장 쿠폰에 적용시킨다.
    -->
    <select id="deleteHqCouponProdToStore01" statementType="CALLABLE" parameterType="couponProdVO" resultType="String">
        /* USE : CouponMapper.deleteHqCouponProdToStore01 */
        {
            CALL PKG_HQ_COUPON_PROD.SP_HQ_COUPON_PROD_D01
            (
                #{hqOfficeCd},
                #{payClassCd},
                #{coupnCd},
                #{prodCd},
                #{modDt},
                #{modId},
                #{result, mode=OUT, jdbcType=VARCHAR}
            )
        }
    </select>

    <!-- 쿠폰 적용/미적용 매장 조회 -->
    <!--
        TABLE    : TB_MS_STORE, TB_HQ_OFFICE, TB_HQ_COUPON_STORE
        COMMENTS : 쿠폰 적용 대상인 매장을 조회한다.
    -->
    <select id="getStoreList" parameterType="couponStoreVO" resultType="DefaultMap">
        /* USE : CouponMapper.getStoreList */
        SELECT
            tms.HQ_OFFICE_CD,
            tho.HQ_OFFICE_NM,
            tms.STORE_CD,
            tms.STORE_NM,
            NVL2(thcs.STORE_CD, 'Y', 'N') AS REG_YN
        FROM
            TB_MS_STORE tms,
            TB_HQ_OFFICE tho,
            TB_HQ_COUPON_STORE thcs
        WHERE
            tho.HQ_OFFICE_CD = tms.HQ_OFFICE_CD
            AND tms.HQ_OFFICE_CD = #{hqOfficeCd}
            AND thcs.HQ_OFFICE_CD (+)= tms.HQ_OFFICE_CD
            AND thcs.STORE_CD (+)= tms.STORE_CD
            AND thcs.PAY_CLASS_CD (+)= #{payClassCd}
            AND thcs.COUPN_CD (+)= #{coupnCd}
        <if test='srchStoreCd != null and srchStoreCd.toString() != ""'>
            AND tms.STORE_CD = #{srchStoreCd}
        </if>
        <if test='srchStoreNm != null and srchStoreNm.toString() != ""'>
            AND tms.STORE_NM LIKE '%'||#{srchStoreNm}||'%'
        </if>
        <if test='storeRegFg != null and storeRegFg.toString() == "Y"'>
            AND thcs.STORE_CD IS NOT NULL
        </if>
        <if test='storeRegFg != null and storeRegFg.toString() == "N"'>
            AND thcs.STORE_CD IS NULL
        </if>
        ORDER BY tms.HQ_OFFICE_CD, tms.STORE_CD
    </select>

    <!-- 쿠폰적용매장 등록 -->
    <!--
        TABLE    : TB_HQ_COUPON_STORE
        COMMENTS : 본사 쿠폰을 적용할 매장을 등록한다.
    -->
    <insert id="insertCouponStore" parameterType="couponStoreVO">
        /* USE : CouponMapper.insertCouponStore */
        INSERT INTO TB_HQ_COUPON_STORE
        (
            HQ_OFFICE_CD,
            PAY_CLASS_CD,
            COUPN_CD,
            STORE_CD,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID
        ) VALUES (
            #{hqOfficeCd},
            #{payClassCd},
            #{coupnCd},
            #{storeCd},
            #{regDt},
            #{regId},
            #{regDt},
            #{regId}
        )
    </insert>

    <!-- 본사 쿠폰적용매장 등록시, 해당 매장의 쿠폰별 적용상품 등록 프로시져 -->
    <!--
        TABLE    : TB_HQ_COUPON_PROD, TB_MS_COUPON_PROD
        PARAM    :
        COMMENTS : 본사 쿠폰적용매장 등록시, 해당 매장의 쿠폰별 적용상품 등록
    -->
    <select id="insertHqCouponProdToStore02" statementType="CALLABLE" parameterType="couponStoreVO" resultType="String">
        /* USE : CouponMapper.insertHqCouponProdToStore02 */
        {
            CALL PKG_HQ_COUPON_PROD.SP_HQ_COUPON_PROD_I02
            (
                #{hqOfficeCd},
                #{payClassCd},
                #{coupnCd},
                #{storeCd},
                #{regDt},
                #{regId},
                #{result, mode=OUT, jdbcType=VARCHAR}
            )
        }
    </select>

    <!-- 쿠폰적용매장 삭제 -->
    <!--
        TABLE    : TB_HQ_COUPON_STORE
        COMMENTS : 본사 쿠폰을 적용한 매장을 삭제한다.
    -->
    <delete id="deleteCouponStore" parameterType="couponStoreVO">
        /* USE : CouponMapper.deleteCouponStore */
        DELETE
            TB_HQ_COUPON_STORE
        WHERE
            HQ_OFFICE_CD = #{hqOfficeCd}
            AND PAY_CLASS_CD = #{payClassCd}
            <if test="coupnCd != null and coupnCd != ''">
                AND COUPN_CD = #{coupnCd}
            </if>
            <if test="storeCd != null and storeCd != ''">
                AND STORE_CD = #{storeCd}
            </if>
    </delete>

    <!-- 본사 쿠폰적용상품 삭제시, 해당 매장의 적용상품 삭제 프로시져 -->
    <!--
        TABLE    : TB_HQ_COUPON_PROD, TB_MS_COUPON_PROD
        PARAM    :
        COMMENTS : 본사 쿠폰적용상품 삭제시, 해당 매장의 적용상품 삭제
    -->
    <select id="deleteHqCouponProdToStore02" statementType="CALLABLE" parameterType="couponVO" resultType="String">
        /* USE : CouponMapper.deleteHqCouponProdToStore02 */
        {
            CALL PKG_HQ_COUPON_PROD.SP_HQ_COUPON_PROD_D02
            (
                #{hqOfficeCd},
                #{payClassCd},
                #{coupnCd},
                #{storeCd},
                #{result, mode=OUT, jdbcType=VARCHAR}
            )
        }
    </select>

    <!-- 본사 쿠폰적용상품 삭제시 프로시져 호출 -->
    <!--
        TABLE    : TB_MS_COUPON
        PARAM    :
        COMMENTS : 본사 쿠폰적용상품 삭제시, 해당 매장의 쿠폰 같이 삭제.
    -->
    <select id="deleteHqCouponToStore02" statementType="CALLABLE" parameterType="couponVO" resultType="String">
        /* USE : CouponMapper.deleteHqCouponToStore02 */
        {
            CALL PKG_HQ_COUPON.SP_HQ_COUPON_D02
            (
                #{hqOfficeCd},
                #{payClassCd},
                #{coupnCd},
                #{storeCd},
                #{modDt},
                #{modId},
                #{result, mode=OUT, jdbcType=VARCHAR}
            )
        }
    </select>

    <!-- 쿠폰 순서저장 update -->
    <!--
        TABLE    :
        COMMENTS :
    -->
    <update id="getCouponSeqChgSaveUpdate" parameterType="CouponVO">
        /* CouponMapper.getCouponSeqChgSaveUpdate */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg.toString() == "HQ"'>
                UPDATE
                TB_HQ_COUPON
                SET
                DISP_SEQ_NO = #{dispSeq},
                MOD_DT = #{modDt},
                MOD_ID = #{modId}
                WHERE 1=1
                AND HQ_OFFICE_CD = #{hqOfficeCd}
                AND PAY_CLASS_CD = #{payClassCd}
                AND COUPN_CD = #{coupnCd}
            </when>
            <!-- 매장 -->
            <when test='orgnFg != null and orgnFg.toString() == "STORE"'>
                UPDATE
                TB_MS_COUPON
                SET
                DISP_SEQ_NO = #{dispSeq},
                MOD_DT = #{modDt},
                MOD_ID = #{modId}
                WHERE 1=1
                AND STORE_CD = #{storeCd}
                AND PAY_CLASS_CD = #{payClassCd}
                AND COUPN_CD = #{coupnCd}
            </when>
        </choose>
    </update>

    <!-- 쿠폰순서 매장적용 팝업 - 조회 -->
    <!--
        TABLE    :
        COMMENTS :
    -->
    <select id="getCouponSeqChgStoreRegistList" parameterType="CouponVO" resultType="DefaultMap">
        /* CouponMapper.getCouponSeqChgStoreRegistList */
        SELECT
        tms.HQ_OFFICE_CD,
        tms.STORE_CD,
        tms.STORE_NM,
        tms.SYS_STAT_FG
        FROM TB_MS_STORE tms
        WHERE tms.HQ_OFFICE_CD = #{hqOfficeCd}
        <if test="storeCd != null and storeCd != ''">
            AND tms.STORE_CD LIKE '%'||#{storeCd}||'%'
        </if>
        <if test="storeNm != null and storeNm != ''">
            AND tms.STORE_NM LIKE '%'||#{storeNm}||'%'
        </if>
        <if test="sysStatFg != null and sysStatFg != ''">
            AND tms.SYS_STAT_FG = #{sysStatFg}
        </if>
        ORDER BY tms.STORE_CD ASC
    </select>

    <!-- 쿠폰순서 매장적용 팝업 - 저장 merge -->
    <!--
        TABLE    :
        COMMENTS :
    -->
    <update id="getCouponSeqChgStoreRegistSaveMerge" parameterType="CouponVO">
        /* CouponMapper.getCouponSeqChgStoreRegistSaveMerge */
        MERGE INTO TB_MS_COUPON A
        USING
        (
            SELECT
            #{storeCd} AS STORE_CD,
            PAY_CLASS_CD,
            COUPN_CD,
            DISP_SEQ_NO,
            #{modDt} AS MOD_DT,
            #{modId} AS MOD_ID
            FROM TB_HQ_COUPON
            WHERE 1=1
            AND HQ_OFFICE_CD = #{hqOfficeCd}
            AND PAY_CLASS_CD = #{payClassCd}
        ) B
        ON  (
                A.STORE_CD = B.STORE_CD
                AND A.PAY_CLASS_CD = B.PAY_CLASS_CD
                AND A.COUPN_CD = B.COUPN_CD
            )
        WHEN MATCHED THEN
            UPDATE
            SET
            A.DISP_SEQ_NO = B.DISP_SEQ_NO,
            A.MOD_DT = B.MOD_DT,
            A.MOD_ID = B.MOD_ID
    </update>

</mapper>