<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    RecpOrigin.xml
    원산지관리
    ======================================================
    No  ||  수정자 ||  수정일자    ||  수정내역
    ======================================================
    1       김설아     2020.07.10     최초작성
-->
<mapper namespace="kr.co.solbipos.base.prod.recpOrigin.service.impl.RecpOriginMapper">

    <!-- 원산지관리 조회 -->
    <!--
        TABLE    : TB_MS_PRODUCT_RECP_ORIGIN
        COMMENTS : [매장]재료-원산지정보
    -->
    <select id="getRecpOriginList"  parameterType="RecpOriginVO" resultType="DefaultMap">
        /* RecpOriginMapper.getRecpOriginList */
        SELECT
        tmpro.RECIPES_CD,
        tmpro.RECIPES_NM,
        tmpro.ORGPLCE_NM
        FROM TB_MS_PRODUCT_RECP_ORIGIN tmpro
        WHERE 1=1
        AND tmpro.STORE_CD = #{storeCd}
        ORDER BY tmpro.RECIPES_CD
    </select>

    <!-- 재료코드(자동채번) -->
    <!--
        TABLE    : TB_MS_PRODUCT_RECP_ORIGIN
        COMMENTS : [매장]재료-원산지정보
    -->
    <select id="getRecpOriginRecipesCd" parameterType="RecpOriginVO" resultType="String">
        /* RecpOriginMapper.getRecpOriginRecipesCd */
        SELECT
        LPAD(NVL(MAX(tmpro.RECIPES_CD), 0) + 1, 4, '0')
        FROM TB_MS_PRODUCT_RECP_ORIGIN tmpro
        WHERE 1=1
        AND tmpro.STORE_CD = #{storeCd}
    </select>

    <!-- 원산지관리 저장 insert -->
    <!--
        TABLE    : TB_MS_PRODUCT_RECP_ORIGIN
        COMMENTS : [매장]재료-원산지정보
    -->
    <insert id="getRecpOriginSaveInsert" parameterType="RecpOriginVO">
        /* RecpOriginMapper.getRecpOriginSaveInsert */
        INSERT INTO TB_MS_PRODUCT_RECP_ORIGIN
        (
            STORE_CD,
            RECIPES_CD,
            RECIPES_NM,
            ORGPLCE_NM,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID
        ) VALUES (
            #{storeCd},
            #{recipesCd},
            #{recipesNm},
            #{orgplceNm},
            #{regDt},
            #{regId},
            #{modDt},
            #{modId}
        )
    </insert>

    <!-- 원산지관리 저장 update -->
    <!--
        TABLE    : TB_MS_PRODUCT_RECP_ORIGIN
        COMMENTS : [매장]재료-원산지정보
    -->
    <update id="getRecpOriginSaveUpdate" parameterType="RecpOriginVO">
        /* RecpOriginMapper.getRecpOriginSaveUpdate */
        UPDATE
        TB_MS_PRODUCT_RECP_ORIGIN
        SET
        RECIPES_NM = #{recipesNm},
        ORGPLCE_NM = #{orgplceNm},
        MOD_DT = #{modDt},
        MOD_ID = #{modId}
        WHERE 1=1
        AND STORE_CD = #{storeCd}
        AND RECIPES_CD = #{recipesCd}
    </update>

    <!-- 원산지관리 저장 delete -->
    <!--
        TABLE    : TB_MS_PRODUCT_RECP_ORIGIN
        COMMENTS : [매장]재료-원산지정보
    -->
    <delete id="getRecpOriginSaveDelete" parameterType="RecpOriginVO">
        /* RecpOriginMapper.getRecpOriginSaveDelete */
        DELETE
        TB_MS_PRODUCT_RECP_ORIGIN
        WHERE 1=1
        AND STORE_CD = #{storeCd}
        AND RECIPES_CD = #{recipesCd}
    </delete>

    <!-- 원산지관리 저장 delete 시, 재료-상품 저장 delete -->
    <!--
        TABLE    : TB_MS_PRODUCT_RECP_PROD
        COMMENTS : [매장]재료-원산지정보
    -->
    <delete id="getRecpProdSaveDeleteAll" parameterType="RecpOriginVO">
        /* RecpOriginMapper.getRecpProdSaveDeleteAll */
        DELETE
        TB_MS_PRODUCT_RECP_PROD
        WHERE 1=1
        AND STORE_CD = #{storeCd}
        AND RECIPES_CD = #{recipesCd}
    </delete>

    <!-- 재료-상품 조회 -->
    <!--
        TABLE    : TB_MS_PRODUCT_RECP_PROD, TB_MS_PRODUCT, TB_MS_PRODUCT_CLASS
        COMMENTS : [매장]재료-원산지정보, [매장]상품, [매장]상품_분류
    -->
    <select id="getRecpOriginDetailList"  parameterType="RecpOriginVO" resultType="DefaultMap">
        /* RecpOriginMapper.getRecpOriginDetailList */
        SELECT
        REPLACE(SUBSTR(tmpc_p.PATH, 0, 6) ,'/','') AS LEVEL1,
        (SELECT PROD_CLASS_NM FROM TB_MS_PRODUCT_CLASS WHERE STORE_CD = #{storeCd} AND PROD_CLASS_CD=(REPLACE(SUBSTR(tmpc_p.PATH, 0, 6) ,'/',''))) AS LEVEL1_NM,
        REPLACE(SUBSTR(tmpc_p.PATH, 7, 6) ,'/','') AS LEVEL2,
        (SELECT PROD_CLASS_NM FROM TB_MS_PRODUCT_CLASS WHERE STORE_CD = #{storeCd} AND PROD_CLASS_CD=(REPLACE(SUBSTR(tmpc_p.PATH, 7, 6) ,'/',''))) AS LEVEL2_NM,
        REPLACE(SUBSTR(tmpc_p.PATH, 13, 6) ,'/','') AS LEVEL3,
        (SELECT PROD_CLASS_NM FROM TB_MS_PRODUCT_CLASS WHERE STORE_CD = #{storeCd} AND PROD_CLASS_CD=(REPLACE(SUBSTR(tmpc_p.PATH, 13, 6) ,'/',''))) AS LEVEL3_NM,
        tmprp.PROD_CD,
        tmp.PROD_NM,
        tmp.LAST_COST_UPRC
        FROM TB_MS_PRODUCT_RECP_PROD tmprp,
        TB_MS_PRODUCT tmp,
        (
            SELECT
            STORE_CD,
            PROD_CLASS_CD,
            SYS_CONNECT_BY_PATH (PROD_CLASS_CD, '/') PATH
            FROM (SELECT * FROM TB_MS_PRODUCT_CLASS WHERE STORE_CD = #{storeCd})
            WHERE 1=1
            START WITH P_PROD_CLASS_CD = '00000'
            CONNECT BY P_PROD_CLASS_CD = PRIOR PROD_CLASS_CD
        ) tmpc_p
        WHERE 1=1
        AND tmprp.STORE_CD = tmp.STORE_CD
        AND tmprp.PROD_CD = tmp.PROD_CD
        AND tmp.STORE_CD = tmpc_p.STORE_CD
        AND tmp.PROD_CLASS_CD = tmpc_p.PROD_CLASS_CD
        AND tmprp.STORE_CD = #{storeCd}
        AND tmprp.RECIPES_CD = #{recipesCd}
        ORDER BY tmprp.PROD_CD
    </select>

    <!-- 재료-상품 조회 -->
    <!--
        TABLE    : TB_MS_PRODUCT, TB_MS_PRODUCT_CLASS
        COMMENTS : [매장]상품, [매장]상품_분류
    -->
    <select id="getRecpProdList"  parameterType="RecpOriginVO" resultType="DefaultMap">
        /* RecpOriginMapper.getRecpProdList */
        SELECT *
        FROM
        (
            SELECT
            REPLACE(SUBSTR(tmpc_p.PATH, 0, 6) ,'/','') AS LEVEL1,
            (SELECT PROD_CLASS_NM FROM TB_MS_PRODUCT_CLASS WHERE STORE_CD = #{storeCd} AND PROD_CLASS_CD=(REPLACE(SUBSTR(tmpc_p.PATH, 0, 6) ,'/',''))) AS LEVEL1_NM,
            REPLACE(SUBSTR(tmpc_p.PATH, 7, 6) ,'/','') AS LEVEL2,
            (SELECT PROD_CLASS_NM FROM TB_MS_PRODUCT_CLASS WHERE STORE_CD = #{storeCd} AND PROD_CLASS_CD=(REPLACE(SUBSTR(tmpc_p.PATH, 7, 6) ,'/',''))) AS LEVEL2_NM,
            REPLACE(SUBSTR(tmpc_p.PATH, 13, 6) ,'/','') AS LEVEL3,
            (SELECT PROD_CLASS_NM FROM TB_MS_PRODUCT_CLASS WHERE STORE_CD = #{storeCd} AND PROD_CLASS_CD=(REPLACE(SUBSTR(tmpc_p.PATH, 13, 6) ,'/',''))) AS LEVEL3_NM,
            tmp.PROD_CD,
            tmp.PROD_NM,
            tmp.LAST_COST_UPRC
            FROM TB_MS_PRODUCT tmp,
            (
                SELECT
                STORE_CD,
                PROD_CLASS_CD,
                SYS_CONNECT_BY_PATH (PROD_CLASS_CD, '/') PATH
                FROM (SELECT * FROM TB_MS_PRODUCT_CLASS WHERE STORE_CD = #{storeCd})
                WHERE 1=1
                START WITH P_PROD_CLASS_CD = '00000'
                CONNECT BY P_PROD_CLASS_CD = PRIOR PROD_CLASS_CD
            ) tmpc_p
            WHERE 1=1
            AND tmp.STORE_CD = tmpc_p.STORE_CD
            AND tmp.PROD_CLASS_CD = tmpc_p.PROD_CLASS_CD
            AND tmp.STORE_CD = #{storeCd}
            <if test="prodCd != null and prodCd != ''">
                AND tmp.PROD_CD LIKE '%'|| #{prodCd} ||'%'
            </if>
            <if test="prodNm != null and prodNm != ''">
                AND tmp.PROD_NM LIKE '%'|| #{prodNm} ||'%'
            </if>
            AND NOT EXISTS
            (
                SELECT 1
                FROM TB_MS_PRODUCT_RECP_PROD tmprp
                WHERE 1=1
                AND tmprp.STORE_CD = tmp.STORE_CD
                AND tmprp.PROD_CD = tmp.PROD_CD
                AND tmprp.RECIPES_CD = #{recipesCd}
            )
        )
        WHERE 1=1
        <if test="prodClassCd != null and prodClassCd != ''">
            AND (      LEVEL1 = #{prodClassCd}
                    OR LEVEL2 = #{prodClassCd}
                    OR LEVEL3 = #{prodClassCd}
                )
        </if>
        ORDER BY PROD_CD
    </select>

    <!-- 재료-상품 저장 insert -->
    <!--
        TABLE    : TB_MS_PRODUCT_RECP_PROD
        COMMENTS : [매장]재료-원산지정보
    -->
    <insert id="getRecpProdSaveInsert" parameterType="RecpOriginVO">
        /* RecpOriginMapper.getRecpProdSaveInsert */
        INSERT INTO TB_MS_PRODUCT_RECP_PROD
        (
            STORE_CD,
            RECIPES_CD,
            PROD_CD,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID
        ) VALUES (
            #{storeCd},
            #{recipesCd},
            #{prodCd},
            #{regDt},
            #{regId},
            #{modDt},
            #{modId}
        )
    </insert>

    <!-- 재료-상품 저장 delete -->
    <!--
        TABLE    : TB_MS_PRODUCT_RECP_PROD
        COMMENTS : [매장]재료-원산지정보
    -->
    <delete id="getRecpProdSaveDelete" parameterType="RecpOriginVO">
        /* RecpOriginMapper.getRecpProdSaveDelete */
        DELETE
        TB_MS_PRODUCT_RECP_PROD
        WHERE 1=1
        AND STORE_CD = #{storeCd}
        AND RECIPES_CD = #{recipesCd}
        AND PROD_CD = #{prodCd}
    </delete>

</mapper>