<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    View.xml
    매장정보 조회 sql
    ======================================================
    No  ||  수정자 ||  수정일자    ||  수정내역
    ======================================================
    1       김영근     2018.08.13      최초작성
-->
<mapper namespace="kr.co.solbipos.base.store.view.service.impl.ViewMapper">

    <!-- 매장정보조회  -->
    <!--
        TABLE    : TB_MS_STORE
        COMMENTS : 매장정보조회한다.
    -->
    <select id="getViewList" parameterType="viewVO" resultType="DefaultMap">
        /* USE : ViewMapper.getViewList */
      <include refid="CmmSQL.PagingTemplateHeader"/>
        SELECT tms.STORE_CD,
               tms.STORE_NM,
               tms.CLS_FG,
               tms.BIZ_NO ,
               tms.OWNER_NM,
               tms.TEL_NO,
               tms.POST_NO || ') ' || tms.ADDR || tms.ADDR_DTL  AS ADDRESS,
               tmp.POS_VER_NO,
               tms.SYS_STAT_FG,
               TO_CHAR(TO_DATE(tms.SYS_OPEN_DATE, 'yyyyMMdd'), 'YYYY/MM/DD') AS SYS_OPEN_DATE,
               TO_CHAR(TO_DATE(tms.SYS_CLOSURE_DATE, 'yyyyMMdd'), 'YYYY/MM/DD') AS SYS_CLOSURE_DATE
      <include refid="CmmSQL.PagingTemplateCount"/>
          FROM TB_MS_STORE tms,
               TB_MS_POS tmp
         WHERE tms.HQ_OFFICE_CD =  #{hqOfficeCd}
           AND tmp.STORE_CD (+)= tms.STORE_CD
           AND tmp.POS_NO (+)= '01' -- 기본포스(포스 최신버전 가져오기 위함)
           AND tmp.USE_YN (+)= 'Y'
        <if test='storeCd != null and storeCd != ""'>
           AND tms.STORE_CD = #{storeCd}
        </if>
        <if test='storeNm != null and storeNm != ""'>
           AND tms.STORE_NM  LIKE '%'||#{storeNm}||'%'
        </if>
        <if test='clsFg != null and clsFg != ""'>
           AND tms.CLS_FG = #{clsFg}
        </if>
        <if test='sysStatFg != null and sysStatFg != ""'>
           AND tms.SYS_STAT_FG = #{sysStatFg}
        </if>
         ORDER BY tms.STORE_CD ASC
      <include refid="CmmSQL.PagingTemplateBottom"/>
    </select>


    <!-- 매장정보상세조회  -->
    <!--
        TABLE    : TB_MS_STORE, TB_MS_STORE_ENVST
        COMMENTS : 매장정보상세조회한다.
    -->
    <select id="getViewDetail" parameterType="viewVO" resultType="DefaultMap">
        /* USE : ViewMapper.getViewDetail */
        SELECT  X.*,
                (SELECT TCED.ENVST_VAL_NM FROM TB_CM_ENVST_DTL TCED WHERE TCED.ENVST_CD = '1028' AND TCED.ENVST_VAL_CD = X.CORNER_USE_YN ) CORNER_USE_YN_NM,
                (SELECT TCED.ENVST_VAL_NM FROM TB_CM_ENVST_DTL TCED WHERE TCED.ENVST_CD = '0007' AND TCED.ENVST_VAL_CD = X.CASH_BILL_YN ) CASH_BILL_YN_NM
          FROM
          (
            SELECT  TMS.STORE_CD,
                    TMS.STORE_NM,
                    DECODE(TMS.HQ_OFFICE_CD, '00000', '단독', '가맹') AS STORE_TYPE_NM,
                    TMS.CLS_FG,
                    (SELECT TCN.NMCODE_NM FROM TB_CM_NMCODE TCN  WHERE TCN.NMCODE_GRP_CD='001' AND TCN.NMCODE_CD = TMS.CLS_FG) AS CLS_FG_NM,
                    TMS.SYS_STAT_FG,
                    (SELECT TCN.NMCODE_NM FROM TB_CM_NMCODE TCN  WHERE TCN.NMCODE_GRP_CD='005' AND TCN.NMCODE_CD = TMS.SYS_STAT_FG) AS SYS_STAT_FG_NM,
                    (SELECT COUNT(TMP.STORE_CD) FROM TB_MS_POS TMP WHERE TMP.STORE_CD = TMS.STORE_CD AND TMP.USE_YN = 'Y') AS POS_CNT,
                    TMS.SYS_OPEN_DATE,
                    TMS.SYS_CLOSURE_DATE,
                    TMS.BIZ_STORE_NM,
                    TMS.OWNER_NM,
                    TMS.BIZ_NO,
                    TMS.TEL_NO,
                    TMS.MP_NO,
                    TMS.FAX_NO,
                    TMS.EMAIL_ADDR,
                    TMS.HMPG_ADDR,
                    TMS.POST_NO || ') ' || TMS.ADDR || TMS.ADDR_DTL AS ADDRESS,
                    TMS.AREA_CD,
                    (SELECT TCN.NMCODE_NM FROM TB_CM_NMCODE TCN  WHERE TCN.NMCODE_GRP_CD='061' AND TCN.NMCODE_CD = TMS.AREA_CD) AS AREA_NM,
                    TMS.VAN_CD,
                    (SELECT TCVC.VAN_NM FROM TB_CM_VAN_CMPNY TCVC  WHERE TCVC.VAN_CD = TMS.VAN_CD AND TCVC.VAN_FG = '01') AS VAN_NM,
                    TMS.AGENCY_CD,
                    (SELECT AGENCY_NM FROM TB_CM_AGENCY TMA WHERE TMA.AGENCY_CD = TMS.AGENCY_CD) AGENCY_NM,
                    TMS.SYS_REMARK,
                    TMS.HD_REMARK,
                    TMS.REMARK,
                    NVL((SELECT TMSE.ENVST_VAL FROM TB_MS_STORE_ENVST TMSE WHERE TMSE.STORE_CD   = TMS.STORE_CD AND TMSE.ENVST_CD = '1028' ), 0 ) CORNER_USE_YN,
                    NVL((SELECT TMSE.ENVST_VAL FROM TB_MS_STORE_ENVST TMSE WHERE TMSE.STORE_CD   = TMS.STORE_CD AND TMSE.ENVST_CD = '0007' ), 0 ) CASH_BILL_YN
              FROM  TB_MS_STORE TMS
             WHERE  TMS.STORE_CD = #{storeCd}
           ) X
    </select>

    <!-- 매장의 코너 사용여부 조회 -->
    <!--
        TABLE    : TB_MS_STORE_ENVST
        COMMENTS : 매장의 코너 사용여부를 조회한다.
    -->
    <select id="getCornerUseYnVal" parameterType="storeEnvVO" resultType="String">
        /* getCornerUseYnVal.getTerminalEnv */
        SELECT NVL(ENVST_VAL, '0') AS ENVST_VAL
          FROM TB_MS_STORE_ENVST
         WHERE STORE_CD = #{storeCd}
           AND ENVST_CD = #{envstCd}
           AND USE_YN = 'Y'
    </select>

     <!-- 코너별 터미널 목록 조회 -->
    <select id="getCornerTerminalList" parameterType="DefaultMap" resultType="DefaultMap">
        /* USE : StoreManageMapper.getCornerTerminalList */
        <![CDATA[
        SELECT tmct.STORE_CD,
               tmct.CORNR_CD,
               tmct.VENDOR_FG,
               (SELECT NMCODE_NM FROM TB_CM_NMCODE WHERE NMCODE_GRP_CD = '078' AND NMCODE_CD = tmct.VENDOR_FG ) AS VENDOR_FG_NM,
               tmct.VENDOR_CD,
               tmct.VENDOR_NM,
               tmct.VENDOR_TERMNL_NO,
               tmct.VENDOR_SER_NO
          FROM TB_MS_CORNER_TERMNL tmct
         WHERE tmct.STORE_CD = #{storeCd}
         ORDER BY tmct.CORNR_CD, tmct.VENDOR_FG, tmct.VENDOR_CD
        ]]>
    </select>

    <!-- 포스별 터미널목록 조회 -->
    <select id="getPosTerminalList" parameterType="DefaultMap" resultType="DefaultMap">
        /* USE : StoreManageMapper.getPosTerminalList */
        <![CDATA[
         SELECT tmpt.STORE_CD,
                tmpt.POS_NO,
                tmpt.VENDOR_FG,
                (SELECT NMCODE_NM FROM TB_CM_NMCODE WHERE NMCODE_GRP_CD = '078' AND NMCODE_CD = tmpt.VENDOR_FG ) AS VENDOR_FG_NM,
                tmpt.VENDOR_CD,
                tmpt.VENDOR_NM,
                tmpt.VENDOR_TERMNL_NO,
                tmpt.VENDOR_SER_NO
           FROM TB_MS_POS_TERMNL tmpt
          WHERE tmpt.STORE_CD = #{storeCd}
          ORDER BY tmpt.POS_NO, tmpt.VENDOR_FG, tmpt.VENDOR_CD
        ]]>
    </select>
</mapper>
