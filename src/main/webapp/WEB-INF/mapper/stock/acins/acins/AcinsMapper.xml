<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.solbipos.stock.acins.acins.service.impl.AcinsMapper">

    <!-- 실사관리 - 실사관리 리스트 조회(본사) -->
    <!--
        TABLE    : TB_ST_HQ_ACTUAL_INSPECTION
        PARAM    : acinsVO
        COMMENTS : 실사관리 - 실사관리 리스트를 조회한다.
    -->
    <select id="getHqAcinsList" parameterType="acinsVO" resultType="DefaultMap">
        /* USE : AcinsMapper.getHqAcinsList */
        <![CDATA[
        SELECT  tshai.ACINS_DATE, tshai.HQ_OFFICE_CD, tshai.SEQ_NO
        ,       tshai.ACINS_TITLE, tshai.PROC_FG, tshai.DTL_CNT
        ,       tshai.ADJ_CNT, tshai.CONFM_DATE
        ,       SUBSTR(tshai.REG_DT,0,8) AS REG_DATE
        ,		tshai.ADJ_STORAGE_CD, tshai.REASON_CD AS ACINS_REASON, SUBSTR(tshai.MOD_DT,0,8) AS MOD_DATE, tshai.REG_ID, tshai.MOD_ID, tshai.CONFM_ID
        FROM    TB_ST_HQ_ACTUAL_INSPECTION tshai
        WHERE   HQ_OFFICE_CD  = #{hqOfficeCd}
        AND     ACINS_DATE  BETWEEN #{startDate} AND #{endDate}
        ]]>
        <if test='procFg != null and procFg != ""'>
            AND tshai.PROC_FG = #{procFg}
        </if>
        <if test='acinsReason != null and acinsReason != ""'>
            AND tshai.REASON_CD = #{acinsReason}
        </if>
        <![CDATA[
        ORDER BY tshai.ACINS_DATE DESC, tshai.SEQ_NO DESC
        ]]>
    </select>


    <!-- 실사관리 - 실사관리 리스트 조회(매장) -->
    <!--
        TABLE    : TB_ST_STORE_ACTUAL_INSPECTION
        PARAM    : acinsVO
        COMMENTS : 실사관리 - 실사관리 리스트를 조회한다.
    -->
    <select id="getStAcinsList" parameterType="acinsVO" resultType="DefaultMap">
        /* USE : AcinsMapper.getStAcinsList */
        <![CDATA[
        SELECT  tssai.ACINS_DATE, tssai.STORE_CD, tssai.SEQ_NO
        ,       tssai.ACINS_TITLE, tssai.PROC_FG, tssai.DTL_CNT
        ,       tssai.ADJ_CNT, tssai.CONFM_DATE
        ,       SUBSTR(tssai.REG_DT,0,8) AS REG_DATE
        ,		tssai.ADJ_STORAGE_CD, tssai.REASON_CD AS ACINS_REASON, SUBSTR(tssai.MOD_DT,0,8) AS MOD_DATE, tssai.REG_ID, tssai.MOD_ID, tssai.CONFM_ID
        FROM    TB_ST_STORE_ACTUAL_INSPECTION tssai
        WHERE   tssai.STORE_CD    = #{storeCd}
        AND     tssai.ACINS_DATE  BETWEEN #{startDate} AND #{endDate}
        ]]>
        <if test='procFg != null and procFg != ""'>
            AND tssai.PROC_FG = #{procFg}
        </if>
        <if test='acinsReason != null and acinsReason != ""'>
            AND tssai.REASON_CD = #{acinsReason}
        </if>
        <![CDATA[
        ORDER BY tssai.ACINS_DATE DESC, tssai.SEQ_NO DESC
        ]]>
    </select>


    <!-- 실사관리 - 실사 진행구분 및 제목 조회(본사) -->
    <!--
        TABLE    : TB_ST_HQ_ACTUAL_INSPECTION
        PARAM    : acinsVO
        COMMENTS : 실사관리 - 실사 진행구분 및 제목을 조회한다.
    -->
    <select id="getHqProcFgCheck" parameterType="acinsVO" resultType="DefaultMap">
        /* USE : AcinsMapper.getHqProcFgCheck */
        <![CDATA[
        SELECT  tshai.PROC_FG, tshai.ACINS_TITLE, tshai.ADJ_STORAGE_CD, ths.STORAGE_NM, tshai.REASON_CD AS ACINS_REASON
        FROM    TB_ST_HQ_ACTUAL_INSPECTION tshai
		,       TB_HQ_STORAGE               ths
        WHERE   tshai.HQ_OFFICE_CD  = #{hqOfficeCd}
        AND     tshai.ACINS_DATE    = #{acinsDate}
        AND     tshai.SEQ_NO        = #{seqNo}
		AND     tshai.HQ_OFFICE_CD      = ths.HQ_OFFICE_CD
		AND     tshai.ADJ_STORAGE_CD    = ths.STORAGE_CD
        ]]>
    </select>


    <!-- 실사관리 - 실사 진행구분 및 제목 조회(매장) -->
    <!--
        TABLE    : TB_ST_STORE_ACTUAL_INSPECTION
        PARAM    : acinsVO
        COMMENTS : 실사관리 - 실사 진행구분 및 제목을 조회한다.
    -->
    <select id="getStProcFgCheck" parameterType="acinsVO" resultType="DefaultMap">
        /* USE : AcinsMapper.getStProcFgCheck */
        <![CDATA[
        SELECT  tssai.PROC_FG, tssai.ACINS_TITLE, tssai.ADJ_STORAGE_CD, tms.STORAGE_NM, tssai.REASON_CD AS ACINS_REASON
        FROM    TB_ST_STORE_ACTUAL_INSPECTION tssai
        ,       TB_MS_STORAGE               tms
        WHERE   tssai.STORE_CD      = #{storeCd}
        AND     tssai.ACINS_DATE    = #{acinsDate}
        AND     tssai.SEQ_NO        = #{seqNo}
        AND		tssai.STORE_CD		= tms.STORE_CD
        AND		tssai.ADJ_STORAGE_CD = tms.STORAGE_CD
        ]]>
    </select>


    <!-- 실사관리 - 실사등록 상품 리스트 조회(본사) -->
    <!--
        TABLE    : TB_HQ_PRODUCT, TB_ST_HQ_ACTUAL_INSPECTION_DTL, TB_ST_HQ_STOCK_CUR, TB_ST_HQ_STOCK_MONTHLY, TB_HQ_PRODUCT_BARCD
        PARAM    : acinsVO
        COMMENTS : 실사관리 - 실사등록 리스트를 조회한다.
    -->
    <select id="getHqAcinsRegistList" parameterType="acinsVO" resultType="DefaultMap">
        /* USE : AcinsMapper.getHqAcinsRegistList */
        <include refid="CmmSQL.PagingTemplateHeader"/>
        <![CDATA[
        SELECT  thpb.BARCD_CD, thp.PROD_CD, thp.PROD_NM, thp.PO_UNIT_QTY
        ,		NVL((SELECT MAX(SALE_UPRC) KEEP(DENSE_RANK FIRST ORDER BY REG_DT DESC)
                       FROM TB_HQ_PRODUCT_SALE_PRICE
                      WHERE HQ_OFFICE_CD = thp.HQ_OFFICE_CD
                        AND PROD_CD = thp.PROD_CD
                        AND #{acinsDate} BETWEEN START_DATE AND END_DATE
                     ), 0) AS SALE_UPRC
        ,       NVL(tshsc.AVG_COST_UPRC, thp.COST_UPRC) AS COST_UPRC
        ,       NVL(NVL(tshaid.CMPT_CURR_QTY, tshsc.CURR_QTY), 0) AS CMPT_CURR_QTY
        ,       tshaid.ACINS_QTY
        ,       tshaid.ACINS_AMT
        ,       tshaid.ADJ_QTY
        ,       tshaid.ADJ_AMT
        ,       tshaid.REMARK
        ,       DECODE(tshaid.PROD_CD, NULL, 'I', 'U') AS ACINS_PROD_STATUS
        ]]>
        <include refid="CmmSQL.PagingTemplateCount"/>
        <![CDATA[
        FROM    TB_HQ_PRODUCT thp
        ,       TB_ST_HQ_ACTUAL_INSPECTION_DTL tshaid
        ,       (	SELECT  tshsc.PROD_CD, tshsc.CURR_QTY, tshsm.AVG_COST_UPRC
                    FROM    TB_ST_HQ_STOCK_CUR tshsc
                    ,       TB_ST_HQ_STOCK_MONTHLY tshsm
                    WHERE   tshsc.HQ_OFFICE_CD    	=   #{hqOfficeCd}
                     AND		tshsc.STORAGE_CD	=	#{storageCd}
                    AND		tshsc.STORAGE_CD IN (SELECT X.STORAGE_CD FROM TB_HQ_STORAGE X WHERE X.HQ_OFFICE_CD  =   #{hqOfficeCd} AND X.AREA_FG    =   #{areaFg})
                    AND     tshsm.IOSTOCK_YM  (+) 	=   SUBSTR(#{acinsDate}, 0, 6)
                    AND     tshsm.HQ_OFFICE_CD(+) 	=   tshsc.HQ_OFFICE_CD
                    AND     tshsm.PROD_CD     (+) 	=   tshsc.PROD_CD
                )   tshsc
        ,       TB_HQ_PRODUCT_BARCD thpb
        WHERE   thp.HQ_OFFICE_CD        =   #{hqOfficeCd}
        AND     thp.STOCK_PROD_YN       =   'Y'
        AND     thp.USE_YN              =   'Y'
        AND     tshaid.PROD_CD      (+) =   thp.PROD_CD
        AND     tshaid.HQ_OFFICE_CD (+) =   #{hqOfficeCd}
        AND     tshaid.ACINS_DATE   (+) =   #{acinsDate}
        AND     tshaid.SEQ_NO       (+) =   #{seqNo}
        AND     tshsc.PROD_CD       (+) =   thp.PROD_CD
        AND     thpb.HQ_OFFICE_CD   (+) =   thp.HQ_OFFICE_CD
        AND     thpb.PROD_CD        (+) =   thp.PROD_CD
        ]]>
        <if test='prodCd != null and prodCd != ""'>
            AND thp.PROD_CD = #{prodCd}
        </if>
        <if test='prodNm != null and prodNm != ""'>
            AND thp.PROD_NM LIKE '%'||#{prodNm}||'%'
        </if>
        <if test='barcdCd != null and barcdCd != ""'>
            AND thpb.BARCD_CD = #{barcdCd}
        </if>
        <if test='prodClassCd != null and prodClassCd != ""'>
            AND thp.PROD_CLASS_CD IN  ( SELECT  #{prodClassCd} AS PROD_CLASS_CD
            FROM    DUAL
            UNION
            SELECT  thpc.PROD_CLASS_CD
            FROM    TB_HQ_PRODUCT_CLASS thpc
            WHERE   thpc.HQ_OFFICE_CD = #{hqOfficeCd}
            START WITH  thpc.P_PROD_CLASS_CD = #{prodClassCd}
            AND     thpc.HQ_OFFICE_CD = #{hqOfficeCd}
            CONNECT BY  thpc.P_PROD_CLASS_CD = PRIOR thpc.PROD_CLASS_CD
            AND     thpc.HQ_OFFICE_CD = #{hqOfficeCd}
            )
        </if>
        <if test='arrVendrCd != null and arrVendrCd != ""'>
            AND thp.PROD_CD IN  ( SELECT  PROD_CD
            FROM    TB_HQ_VENDOR_PROD
            WHERE   HQ_OFFICE_CD = #{hqOfficeCd}
            AND     VENDR_CD IN
            <foreach collection="arrVendrCd" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
            )
        </if>
        <if test='prodBarcdCd != null and prodBarcdCd != ""'>
            AND (thp.PROD_CD = #{prodBarcdCd} OR thpb.BARCD_CD = #{prodBarcdCd})
        </if>
        <if test='acinsFg == "Y"'>
            AND tshaid.ACINS_QTY IS NOT NULL
        </if>
        <if test='acinsFg == "N"'>
            AND tshaid.ACINS_QTY IS NULL
        </if>
        <![CDATA[
        ORDER
        BY		thp.PROD_CD
        ]]>
        <include refid="CmmSQL.PagingTemplateBottom"/>
    </select>


    <!-- 실사관리 - 실사등록 상품 리스트 조회(매장) -->
    <!--
        TABLE    : TB_MS_PRODUCT, TB_ST_STORE_ACTUAL_INSPECTION_DTL, TB_ST_STORE_STOCK_CUR, TB_ST_STORE_STOCK_MONTHLY, TB_MS_PRODUCT_BARCD
        PARAM    : acinsVO
        COMMENTS : 실사관리 - 실사등록 리스트를 조회한다.
    -->
    <select id="getStAcinsRegistList" parameterType="acinsVO" resultType="DefaultMap">
        /* USE : AcinsMapper.getStAcinsRegistList */
        <include refid="CmmSQL.PagingTemplateHeader"/>
        <![CDATA[
        SELECT  tmpb.BARCD_CD, tmp.PROD_CD, tmp.PROD_NM, tmp.PO_UNIT_QTY
        ,		NVL((SELECT MAX(SALE_UPRC) KEEP(DENSE_RANK FIRST ORDER BY REG_DT DESC)
                       FROM TB_MS_PRODUCT_SALE_PRICE
                      WHERE STORE_CD = tmp.STORE_CD
                        AND PROD_CD = tmp.PROD_CD
                        AND #{acinsDate} BETWEEN START_DATE AND END_DATE
                     ), 0) AS SALE_UPRC
        ,       tmp.COST_UPRC
        ,       NVL(NVL(tssaid.CMPT_CURR_QTY, tsssc.CURR_QTY), 0) AS CMPT_CURR_QTY
        ,       tssaid.ACINS_QTY
        ,       tssaid.ACINS_AMT
        ,       tssaid.ADJ_QTY
        ,       tssaid.ADJ_AMT
        ,       tssaid.REMARK
        ,       DECODE(tssaid.PROD_CD, NULL, 'I', 'U') AS ACINS_PROD_STATUS
        ]]>
        <include refid="CmmSQL.PagingTemplateCount"/>
        <![CDATA[
        FROM    TB_MS_PRODUCT tmp
        ,       TB_ST_STORE_ACTUAL_INSPECTION_DTL tssaid
        ,       TB_ST_STORE_STOCK_CUR tsssc
        ,       TB_MS_PRODUCT_BARCD tmpb
        WHERE   tmp.STORE_CD            =   #{storeCd}
        AND     tmp.STOCK_PROD_YN       =   'Y'
        AND     tmp.USE_YN              =   'Y'
        AND     tssaid.PROD_CD      (+) =   tmp.PROD_CD
        AND     tssaid.STORE_CD     (+) =   #{storeCd}
        AND     tssaid.ACINS_DATE   (+) =   #{acinsDate}
        AND     tssaid.SEQ_NO       (+) =   #{seqNo}
        AND     tsssc.STORE_CD      (+) =   tmp.STORE_CD
        AND     tsssc.STORAGE_CD    (+) =   '999'
        AND     tsssc.PROD_CD       (+) =   tmp.PROD_CD
        AND     tmpb.STORE_CD       (+) =   tmp.STORE_CD
        AND     tmpb.PROD_CD        (+) =   tmp.PROD_CD
        ]]>
        <if test='prodCd != null and prodCd != ""'>
            AND tmp.PROD_CD = #{prodCd}
        </if>
        <if test='prodNm != null and prodNm != ""'>
            AND tmp.PROD_NM LIKE '%'||#{prodNm}||'%'
        </if>
        <if test='barcdCd != null and barcdCd != ""'>
            AND tmpb.BARCD_CD = #{barcdCd}
        </if>
        <if test='prodClassCd != null and prodClassCd != ""'>
            AND tmp.PROD_CLASS_CD IN  ( SELECT  #{prodClassCd} AS PROD_CLASS_CD
            FROM    DUAL
            UNION
            SELECT  tmpc.PROD_CLASS_CD
            FROM    TB_MS_PRODUCT_CLASS tmpc
            WHERE   tmpc.STORE_CD = #{storeCd}
            START WITH  tmpc.P_PROD_CLASS_CD = #{prodClassCd}
            AND     tmpc.STORE_CD = #{storeCd}
            CONNECT BY  tmpc.P_PROD_CLASS_CD = PRIOR tmpc.PROD_CLASS_CD
            AND     tmpc.STORE_CD = #{storeCd}
            )
        </if>
        <if test='arrVendrCd != null and arrVendrCd != ""'>
            AND tmp.PROD_CD IN  ( SELECT  PROD_CD
            FROM    TB_MS_VENDOR_PROD
            WHERE   STORE_CD  = #{storeCd}
            AND     VENDR_CD IN
            <foreach collection="arrVendrCd" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
            )
        </if>
        <if test='prodBarcdCd != null and prodBarcdCd != ""'>
            AND (tmp.PROD_CD = #{prodBarcdCd} OR tmpb.BARCD_CD = #{prodBarcdCd})
        </if>
        <if test='acinsFg == "Y"'>
            AND tssaid.ACINS_QTY IS NOT NULL
        </if>
        <if test='acinsFg == "N"'>
            AND tssaid.ACINS_QTY IS NULL
        </if>
        <![CDATA[
        ORDER
        BY		tmp.PROD_CD
        ]]>
        <include refid="CmmSQL.PagingTemplateBottom"/>
    </select>


    <!-- 실사관리 - 실사등록 신규 SEQ 조회(본사) -->
    <!--
        TABLE    : TB_ST_HQ_ACTUAL_INSPECTION
        PARAM    : acinsVO
        COMMENTS : 실사관리 - 실사등록 신규 SEQ를 조회한다.
    -->
    <select id="getHqNewSeqNo" parameterType="acinsVO" resultType="String">
        /* USE : AcinsMapper.getHqNewSeqNo */
        <![CDATA[
        SELECT  NVL(MAX(tshai.SEQ_NO), 0)+1 AS SEQ_NO
        FROM    TB_ST_HQ_ACTUAL_INSPECTION tshai
        WHERE   tshai.HQ_OFFICE_CD  =  #{hqOfficeCd}
        AND     tshai.ACINS_DATE    =  #{acinsDate}
        ]]>
    </select>


    <!-- 실사관리 - 실사등록 신규 SEQ 조회(매장) -->
    <!--
        TABLE    : TB_ST_STORE_ACTUAL_INSPECTION
        PARAM    : acinsVO
        COMMENTS : 실사관리 - 실사등록 신규 SEQ를 조회한다.
    -->
    <select id="getStNewSeqNo" parameterType="acinsVO" resultType="String">
        /* USE : AcinsMapper.getStNewSeqNo */
        <![CDATA[
        SELECT  NVL(MAX(tssai.SEQ_NO), 0)+1 AS SEQ_NO
        FROM    TB_ST_STORE_ACTUAL_INSPECTION tssai
        WHERE   tssai.STORE_CD      =  #{storeCd}
        AND     tssai.ACINS_DATE    =  #{acinsDate}
        ]]>
    </select>


    <!-- 실사관리 - 실사 상세 리스트 조회(본사) -->
    <!--
        TABLE    : TB_HQ_PRODUCT, TB_ST_HQ_ACTUAL_INSPECTION_DTL, TB_ST_HQ_STOCK_CUR, TB_ST_HQ_STOCK_MONTHLY
                 , TB_HQ_PRODUCT_BARCD, TB_ST_HQ_STOCK_DAILY
        PARAM    : acinsVO
        COMMENTS : 실사관리 - 실사 상세 리스트를 조회한다.
    -->
    <select id="getHqAcinsDtlList" parameterType="acinsVO" resultType="DefaultMap">
        /* USE : AcinsMapper.getHqAcinsDtlList */
        <include refid="CmmSQL.PagingTemplateHeader"/>
        <![CDATA[
        SELECT  thpb.BARCD_CD, thp.PROD_CD, thp.PROD_NM, thp.PO_UNIT_QTY
        ,		NVL((SELECT MAX(SALE_UPRC) KEEP(DENSE_RANK FIRST ORDER BY REG_DT DESC)
                       FROM TB_HQ_PRODUCT_SALE_PRICE
                      WHERE HQ_OFFICE_CD = thp.HQ_OFFICE_CD
                        AND PROD_CD = thp.PROD_CD
                        AND #{acinsDate} BETWEEN START_DATE AND END_DATE
                     ), 0) AS SALE_UPRC
        ,       NVL(tshsm.AVG_COST_UPRC, thp.COST_UPRC) AS COST_UPRC
        ,       tshaid.CMPT_CURR_QTY
        ,       tshaid.ACINS_QTY
        ,       tshaid.ACINS_AMT
        ,       tshaid.ADJ_QTY
        ,       tshaid.ADJ_AMT
        ,       tshaid.REMARK
        ,       'U' AS ACINS_PROD_STATUS
        ,		tshai.ADJ_STORAGE_CD
        ]]>
        <include refid="CmmSQL.PagingTemplateCount"/>
        <![CDATA[
        FROM    TB_ST_HQ_ACTUAL_INSPECTION		tshai
        ,		TB_ST_HQ_ACTUAL_INSPECTION_DTL 	tshaid
        ,       TB_HQ_PRODUCT thp
        ,       (	SELECT	tshsm.PROD_CD
                    ,		tshsm.AVG_COST_UPRC
                    , 		(tshsm.BASE_QTY + NVL(IOSTOCK_QTY, 0)) AS CMPT_DATE_QTY
                    FROM	(	SELECT	tshsm.IOSTOCK_YM, tshsm.HQ_OFFICE_CD
                                ,		tshsm.PROD_CD, tshsm.BASE_QTY, tshsm.AVG_COST_UPRC
                                FROM	TB_ST_HQ_STOCK_MONTHLY tshsm
                                WHERE	tshsm.HQ_OFFICE_CD	=	#{hqOfficeCd}
                                AND		tshsm.IOSTOCK_YM	=	SUBSTR(#{acinsDate}, 0, 6)
                            ) tshsm
                    ,		(	SELECT	tshsd.IOSTOCK_DATE, tshsd.HQ_OFFICE_CD
                                ,		tshsd.PROD_CD
                                , 		SUM(tshsd.IOSTOCK_QTY) AS IOSTOCK_QTY
                                FROM	TB_ST_HQ_STOCK_DAILY tshsd
                                WHERE	tshsd.HQ_OFFICE_CD	=	#{hqOfficeCd}
                                AND		tshsd.IOSTOCK_DATE	=	#{acinsDate}
                                GROUP
                                BY		tshsd.IOSTOCK_DATE, tshsd.HQ_OFFICE_CD
                                ,		tshsd.PROD_CD
                            ) tshsd
                    WHERE	tshsd.PROD_CD(+)=	tshsm.PROD_CD
                )   tshsm
        ,       TB_HQ_PRODUCT_BARCD thpb
        WHERE   tshaid.HQ_OFFICE_CD     =   #{hqOfficeCd}
        AND     tshaid.ACINS_DATE       =   #{acinsDate}
        AND     tshaid.SEQ_NO           =   #{seqNo}
        AND		tshaid.HQ_OFFICE_CD     =   tshai.HQ_OFFICE_CD
        AND     tshaid.ACINS_DATE       =   tshai.ACINS_DATE
        AND     tshaid.SEQ_NO           =   tshai.SEQ_NO
        AND     tshaid.HQ_OFFICE_CD     =   thp.HQ_OFFICE_CD
        AND     tshaid.PROD_CD          =   thp.PROD_CD
        AND     tshsm.PROD_CD       (+) =   tshaid.PROD_CD
        AND     thpb.HQ_OFFICE_CD   (+) =   tshaid.HQ_OFFICE_CD
        AND     thpb.PROD_CD        (+) =   tshaid.PROD_CD
        ORDER
        BY		tshaid.PROD_CD
        ]]>
        <include refid="CmmSQL.PagingTemplateBottom"/>
    </select>


    <!-- 실사관리 - 실사 상세 리스트 조회(매장) -->
    <!--
        TABLE    : TB_MS_PRODUCT, TB_ST_STORE_ACTUAL_INSPECTION_DTL, TB_ST_HQ_STOCK_CUR, TB_ST_STORE_STOCK_MONTHLY
                 , TB_MS_PRODUCT_BARCD, TB_ST_STORE_STOCK_DAILY
        PARAM    : acinsVO
        COMMENTS : 실사관리 - 실사 상세 리스트를 조회한다.
    -->
    <select id="getStAcinsDtlList" parameterType="acinsVO" resultType="DefaultMap">
        /* USE : AcinsMapper.getStAcinsDtlList */
        <include refid="CmmSQL.PagingTemplateHeader"/>
        <![CDATA[
        SELECT  tmpb.BARCD_CD, tmp.PROD_CD, tmp.PROD_NM, tmp.PO_UNIT_QTY
        ,       NVL((SELECT MAX(SALE_UPRC) KEEP(DENSE_RANK FIRST ORDER BY REG_DT DESC)
                       FROM TB_MS_PRODUCT_SALE_PRICE
                      WHERE STORE_CD = tmp.STORE_CD
                        AND PROD_CD = tmp.PROD_CD
                        AND #{acinsDate} BETWEEN START_DATE AND END_DATE
                     ), 0) AS SALE_UPRC
        ,       tmp.COST_UPRC
        ,       tssaid.CMPT_CURR_QTY
        ,       tssaid.ACINS_QTY
        ,       tssaid.ACINS_AMT
        ,       tssaid.ADJ_QTY
        ,       tssaid.ADJ_AMT
        ,       tssaid.REMARK
        ,       'U' AS ACINS_PROD_STATUS
        ,		tssai.ADJ_STORAGE_CD
        ]]>
        <include refid="CmmSQL.PagingTemplateCount"/>
        <![CDATA[
        FROM    TB_ST_STORE_ACTUAL_INSPECTION		tssai
        ,		TB_ST_STORE_ACTUAL_INSPECTION_DTL 	tssaid
        ,       TB_MS_PRODUCT tmp
        ,       TB_MS_PRODUCT_BARCD tmpb
        WHERE   tssaid.STORE_CD         =   #{storeCd}
        AND     tssaid.ACINS_DATE       =   #{acinsDate}
        AND     tssaid.SEQ_NO           =   #{seqNo}
        AND		tssaid.STORE_CD     	=   tssai.STORE_CD
        AND     tssaid.ACINS_DATE       =   tssai.ACINS_DATE
        AND     tssaid.SEQ_NO           =   tssai.SEQ_NO
        AND     tssaid.STORE_CD         =   tmp.STORE_CD
        AND     tssaid.PROD_CD          =   tmp.PROD_CD
        AND     tmpb.STORE_CD       (+) =   tssaid.STORE_CD
        AND     tmpb.PROD_CD        (+) =   tssaid.PROD_CD
        ORDER
        BY      tssaid.PROD_CD
        ]]>
        <include refid="CmmSQL.PagingTemplateBottom"/>
    </select>


    <!-- 실사관리 - 실사 DTL 전부 삭제(본사) -->
    <!--
        TABLE    : TB_ST_HQ_ACTUAL_INSPECTION_DTL
        PARAM    : acinsVO
        COMMENTS : 실사관리 - 실사일자, SEQ_NO 에 해당하는 DTL을 전부 삭제한다.
    -->
    <delete id="deleteHqAllAcinsDtl" parameterType="acinsVO">
        /* USE : AcinsMapper.deleteHqAllAcinsDtl */
        DELETE  TB_ST_HQ_ACTUAL_INSPECTION_DTL
        WHERE   HQ_OFFICE_CD  = #{hqOfficeCd}
        AND     ACINS_DATE    = #{acinsDate}
        AND     SEQ_NO        = #{seqNo}
    </delete>


    <!-- 실사관리 - 실사 DTL 전부 삭제(매장) -->
    <!--
        TABLE    : TB_ST_STORE_ACTUAL_INSPECTION_DTL
        PARAM    : acinsVO
        COMMENTS : 실사관리 - 실사일자, SEQ_NO 에 해당하는 DTL을 전부 삭제한다.
    -->
    <delete id="deleteStAllAcinsDtl" parameterType="acinsVO">
        /* USE : AcinsMapper.deleteStAllAcinsDtl */
        DELETE  TB_ST_STORE_ACTUAL_INSPECTION_DTL
        WHERE   STORE_CD      = #{storeCd}
        AND     ACINS_DATE    = #{acinsDate}
        AND     SEQ_NO        = #{seqNo}
    </delete>


    <!-- 실사관리 - 실사 HD 삭제(본사) -->
    <!--
        TABLE    : TB_ST_HQ_ACTUAL_INSPECTION
        PARAM    : acinsVO
        COMMENTS : 실사관리 - 실사일자, SEQ_NO 에 해당하는 HD를 삭제한다.
    -->
    <delete id="deleteHqAcinsHd" parameterType="acinsVO">
        /* USE : AcinsMapper.deleteHqAcinsHd */
        DELETE  TB_ST_HQ_ACTUAL_INSPECTION
        WHERE   HQ_OFFICE_CD  = #{hqOfficeCd}
        AND     ACINS_DATE    = #{acinsDate}
        AND     SEQ_NO        = #{seqNo}
    </delete>


    <!-- 실사관리 - 실사 HD 삭제(매장) -->
    <!--
        TABLE    : TB_ST_STORE_ACTUAL_INSPECTION
        PARAM    : acinsVO
        COMMENTS : 실사관리 - 실사일자, SEQ_NO 에 해당하는 HD를 삭제한다.
    -->
    <delete id="deleteStAcinsHd" parameterType="acinsVO">
        /* USE : AcinsMapper.deleteStAcinsHd */
        DELETE  TB_ST_STORE_ACTUAL_INSPECTION
        WHERE   STORE_CD      = #{storeCd}
        AND     ACINS_DATE    = #{acinsDate}
        AND     SEQ_NO        = #{seqNo}
    </delete>


    <!-- 실사관리 - 실사 상품 DTL 등록(본사) -->
    <!--
        TABLE    : TB_ST_HQ_ACTUAL_INSPECTION_DTL
        PARAM    : acinsVO
        COMMENTS : 실사관리 - 실사 상품 DTL을 등록한다.
    -->
    <insert id="insertHqAcinsDtl" parameterType="acinsVO">
        /* USE : AcinsMapper.insertHqAcinsDtl */
        INSERT INTO TB_ST_HQ_ACTUAL_INSPECTION_DTL
        (
            HQ_OFFICE_CD,
            ACINS_DATE,
            SEQ_NO,
            HQ_BRAND_CD,
            PROD_CD,
            COST_UPRC,
            ADJ_AMT,
            CMPT_CURR_QTY,
            ACINS_QTY,
            ADJ_QTY,
            ACINS_AMT,
            PO_UNIT_QTY,
            REMARK,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID
        )
        VALUES
        (
            #{hqOfficeCd},
            #{acinsDate},
            #{seqNo},
            #{hqBrandCd},
            #{prodCd},
            #{costUprc},
            #{adjAmt},
            #{cmptCurrQty},
            #{acinsQty},
            #{adjQty},
            #{acinsAmt},
            #{poUnitQty},
            #{remark},
            #{regDt},
            #{regId},
            #{modDt},
            #{modId}
        )
    </insert>


    <!-- 실사관리 - 실사 상품 DTL 등록(매장) -->
    <!--
        TABLE    : TB_ST_STORE_ACTUAL_INSPECTION_DTL
        PARAM    : acinsVO
        COMMENTS : 실사관리 - 실사 상품 DTL을 등록한다.
    -->
    <insert id="insertStAcinsDtl" parameterType="acinsVO">
        /* USE : AcinsMapper.insertStAcinsDtl */
        INSERT INTO TB_ST_STORE_ACTUAL_INSPECTION_DTL
        (
            STORE_CD,
            ACINS_DATE,
            SEQ_NO,
            HQ_BRAND_CD,
            PROD_CD,
            COST_UPRC,
            ADJ_AMT,
            CMPT_CURR_QTY,
            ACINS_QTY,
            ADJ_QTY,
            ACINS_AMT,
            PO_UNIT_QTY,
            REMARK,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID
        )
        VALUES
        (
            #{storeCd},
            #{acinsDate},
            #{seqNo},
            #{hqBrandCd},
            #{prodCd},
            #{costUprc},
            #{adjAmt},
            #{cmptCurrQty},
            #{acinsQty},
            #{adjQty},
            #{acinsAmt},
            #{poUnitQty},
            #{remark},
            #{regDt},
            #{regId},
            #{modDt},
            #{modId}
        )
    </insert>


    <!-- 실사관리 - 실사 상품 DTL 수정(본사) -->
    <!--
        TABLE    : TB_ST_HQ_ACTUAL_INSPECTION_DTL
        PARAM    : acinsVO
        COMMENTS : 실사관리 - 실사 상품 DTL을 수정한다.
    -->
    <update id="updateHqAcinsDtl" parameterType="acinsVO">
        /* USE : AcinsMapper.updateHqAcinsDtl */
        UPDATE  TB_ST_HQ_ACTUAL_INSPECTION_DTL
        SET     ACINS_QTY = #{acinsQty}
        ,       ACINS_AMT = #{acinsAmt}
        ,       ADJ_QTY   = #{adjQty}
        ,       ADJ_AMT   = #{adjAmt}
        ,       REMARK    = #{remark}
        WHERE   HQ_OFFICE_CD  = #{hqOfficeCd}
        AND     ACINS_DATE    = #{acinsDate}
        AND     SEQ_NO        = #{seqNo}
        AND     PROD_CD       = #{prodCd}
    </update>


    <!-- 실사관리 - 실사 상품 DTL 수정(매장) -->
    <!--
        TABLE    : TB_ST_STORE_ACTUAL_INSPECTION_DTL
        PARAM    : acinsVO
        COMMENTS : 실사관리 - 실사 상품 DTL을 수정한다.
    -->
    <update id="updateStAcinsDtl" parameterType="acinsVO">
        /* USE : AcinsMapper.updateStAcinsDtl */
        UPDATE  TB_ST_STORE_ACTUAL_INSPECTION_DTL
        SET     ACINS_QTY = #{acinsQty}
        ,       ACINS_AMT = #{acinsAmt}
        ,       ADJ_QTY   = #{adjQty}
        ,       ADJ_AMT   = #{adjAmt}
        ,       REMARK    = #{remark}
        WHERE   STORE_CD  = #{storeCd}
        AND     ACINS_DATE    = #{acinsDate}
        AND     SEQ_NO        = #{seqNo}
        AND     PROD_CD       = #{prodCd}
    </update>


    <!-- 실사관리 - 실사 상품 DTL 삭제(본사) -->
    <!--
        TABLE    : TB_ST_HQ_ACTUAL_INSPECTION_DTL
        PARAM    : acinsVO
        COMMENTS : 실사관리 - 실사 상품 DTL을 삭제한다.
    -->
    <delete id="deleteHqAcinsDtl" parameterType="acinsVO">
        /* USE : AcinsMapper.deleteHqAcinsDtl */
        DELETE  TB_ST_HQ_ACTUAL_INSPECTION_DTL
        WHERE   HQ_OFFICE_CD  = #{hqOfficeCd}
        AND     ACINS_DATE    = #{acinsDate}
        AND     SEQ_NO        = #{seqNo}
        AND     PROD_CD       = #{prodCd}
    </delete>


    <!-- 실사관리 - 실사 상품 DTL 삭제(본사) -->
    <!--
        TABLE    : TB_ST_STORE_ACTUAL_INSPECTION_DTL
        PARAM    : acinsVO
        COMMENTS : 실사관리 - 실사 상품 DTL을 삭제한다.
    -->
    <delete id="deleteStAcinsDtl" parameterType="acinsVO">
        /* USE : AcinsMapper.deleteStAcinsDtl */
        DELETE  TB_ST_STORE_ACTUAL_INSPECTION_DTL
        WHERE   STORE_CD      = #{storeCd}
        AND     ACINS_DATE    = #{acinsDate}
        AND     SEQ_NO        = #{seqNo}
        AND     PROD_CD       = #{prodCd}
    </delete>


    <!-- 실사관리 - 실사 HD 등록(본사) -->
    <!--
        TABLE    : TB_ST_HQ_ACTUAL_INSPECTION, TB_ST_HQ_ACTUAL_INSPECTION_DTL
        PARAM    : acinsVO
        COMMENTS : 실사관리 - 실사 HD을 등록한다.
    -->
    <insert id="insertHqAcinsHd" parameterType="acinsVO">
        /* USE : AcinsMapper.insertHqAcinsHd */
        INSERT INTO TB_ST_HQ_ACTUAL_INSPECTION
        (
            HQ_OFFICE_CD,
            STORAGE_CD,
            ACINS_DATE,
            SEQ_NO,
            ACINS_TITLE,
            PROC_FG,
            ADJ_STORAGE_CD,
            DTL_CNT,
            ADJ_CNT,
            TOT_ACINS_AMT,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID,
            REASON_CD
        )
        SELECT	#{hqOfficeCd}
             ,		#{storageCd}
             ,		#{acinsDate}
             ,		#{seqNo}
             ,		#{acinsTitle}
             ,		#{procFg}
             ,       #{adjStorageCd}
             ,       tshaid.DTL_CNT
             ,       tshaid.ADJ_CNT
             ,       tshaid.TOT_ACINS_AMT
             ,       #{regDt}
             ,       #{regId}
             ,       #{modDt}
             ,       #{modId}
             ,       #{acinsReason}
        FROM DUAL a,
        (
            SELECT SUM(DTL_CNT) AS DTL_CNT, SUM(ADJ_CNT) AS ADJ_CNT, SUM(TOT_ACINS_AMT) AS TOT_ACINS_AMT
            FROM
            (
                SELECT 0 AS DTL_CNT, 0 AS ADJ_CNT, 0 AS TOT_ACINS_AMT
                FROM dual
                UNION ALL
                SELECT  NVL(COUNT(tshaid.PROD_CD), 0) AS DTL_CNT
                ,       NVL(SUM(DECODE(tshaid.ADJ_QTY, 0, 0, 1)), 0) AS ADJ_CNT
                ,       NVL(SUM(tshaid.ACINS_AMT), 0) AS TOT_ACINS_AMT
                FROM	TB_ST_HQ_ACTUAL_INSPECTION_DTL tshaid
                WHERE	tshaid.HQ_OFFICE_CD	=	#{hqOfficeCd}
                AND     tshaid.ACINS_DATE	=	#{acinsDate}
                AND     tshaid.SEQ_NO	    =	#{seqNo}
                GROUP
                    BY		tshaid.HQ_OFFICE_CD
                     ,		#{storageCd}
                     ,		tshaid.ACINS_DATE
                     ,		tshaid.SEQ_NO
                     ,		#{acinsTitle}
                     ,		#{procFg}
                     ,       #{regDt}
                     ,       #{regId}
                     ,       #{modDt}
                     ,       #{modId}
                     ,       #{acinsReason}
             )
        ) tshaid
    </insert>


    <!-- 실사관리 - 실사 HD 등록(매장) -->
    <!--
        TABLE    : TB_ST_STORE_ACTUAL_INSPECTION, TB_ST_STORE_ACTUAL_INSPECTION_DTL
        PARAM    : acinsVO
        COMMENTS : 실사관리 - 실사 HD을 등록한다.
    -->
    <insert id="insertStAcinsHd" parameterType="acinsVO">
        /* USE : AcinsMapper.insertStAcinsHd */
        INSERT INTO TB_ST_STORE_ACTUAL_INSPECTION
        (
            STORE_CD,
            STORAGE_CD,
            ACINS_DATE,
            SEQ_NO,
            ACINS_TITLE,
            PROC_FG,
            ADJ_STORAGE_CD,
            DTL_CNT,
            ADJ_CNT,
            TOT_ACINS_AMT,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID,
            REASON_CD
        )
        SELECT  #{storeCd}
             ,       #{storageCd}
             ,       #{acinsDate}
             ,       #{seqNo}
             ,       #{acinsTitle}
             ,       #{procFg}
             ,       #{adjStorageCd}
             ,       tshaid.DTL_CNT
             ,       tshaid.ADJ_CNT
             ,       tshaid.TOT_ACINS_AMT
             ,       #{regDt}
             ,       #{regId}
             ,       #{modDt}
             ,       #{modId}
             ,       #{acinsReason}
        FROM DUAL a,
        (
            SELECT SUM(DTL_CNT) AS DTL_CNT, SUM(ADJ_CNT) AS ADJ_CNT, SUM(TOT_ACINS_AMT) AS TOT_ACINS_AMT
            FROM
            (
                SELECT 0 AS DTL_CNT, 0 AS ADJ_CNT, 0 AS TOT_ACINS_AMT
                FROM dual
                UNION ALL
                SELECT  NVL(COUNT(tshaid.PROD_CD), 0) AS DTL_CNT
                ,       NVL(SUM(DECODE(tshaid.ADJ_QTY, 0, 0, 1)), 0) AS ADJ_CNT
                ,       NVL(SUM(tshaid.ACINS_AMT), 0) AS TOT_ACINS_AMT
                FROM    TB_ST_STORE_ACTUAL_INSPECTION_DTL tshaid
                WHERE   tshaid.STORE_CD     =   #{storeCd}
                AND     tshaid.ACINS_DATE   =   #{acinsDate}
                AND     tshaid.SEQ_NO       =   #{seqNo}
                GROUP
                    BY      tshaid.STORE_CD
                     ,       #{storageCd}
                     ,       tshaid.ACINS_DATE
                     ,       tshaid.SEQ_NO
                     ,       #{acinsTitle}
                     ,       #{procFg}
                     ,       #{regDt}
                     ,       #{regId}
                     ,       #{modDt}
                     ,       #{modId}
                     ,       #{acinsReason}
            )
        ) tshaid
    </insert>


    <!-- 실사관리 - 실사 HD 수정(본사) -->
    <!--
        TABLE    : TB_ST_HQ_ACTUAL_INSPECTION
        PARAM    : acinsVO
        COMMENTS : 실사관리 - 실사 HD을 수정한다.
    -->
    <update id="updateHqAcinsHd" parameterType="acinsVO">
        /* USE : AcinsMapper.updateHqAcinsHd */
        UPDATE  TB_ST_HQ_ACTUAL_INSPECTION
        SET     (DTL_CNT, ADJ_CNT, TOT_ACINS_AMT)
              = (   SELECT  NVL(COUNT(tshaid.PROD_CD), 0)
                    ,       NVL(SUM(DECODE(tshaid.ADJ_QTY, 0, 0, 1)), 0)
                    ,       NVL(SUM(tshaid.ACINS_AMT), 0)
                    FROM    TB_ST_HQ_ACTUAL_INSPECTION_DTL tshaid
                    WHERE   tshaid.HQ_OFFICE_CD =   #{hqOfficeCd}
                    AND     tshaid.ACINS_DATE   =   #{acinsDate}
                    AND     tshaid.SEQ_NO       =   #{seqNo}
                )
        ,       ACINS_TITLE = #{acinsTitle}
        ,       REASON_CD = #{acinsReason}
        ,       ADJ_STORAGE_CD = #{adjStorageCd}
        ,       PROC_FG     = #{procFg}
        ,       CONFM_DATE  = DECODE(#{procFg}, '0', NULL, SUBSTR(#{modDt}, 0, 8))
        ,       CONFM_ID    = DECODE(#{procFg}, '0', NULL, #{modId})
        ,       MOD_DT      = #{modDt}
        ,       MOD_ID      = #{modId}
        WHERE   HQ_OFFICE_CD  = #{hqOfficeCd}
        AND     ACINS_DATE    = #{acinsDate}
        AND     SEQ_NO        = #{seqNo}
    </update>

    <!-- 실사관리 - 실사 HD 수정(매장) -->
    <!--
        TABLE    : TB_ST_STORE_ACTUAL_INSPECTION
        PARAM    : acinsVO
        COMMENTS : 실사관리 - 실사 HD을 수정한다.
    -->
    <update id="updateStAcinsHd" parameterType="acinsVO">
        /* USE : AcinsMapper.updateStAcinsHd */
        UPDATE  TB_ST_STORE_ACTUAL_INSPECTION
        SET     (DTL_CNT, ADJ_CNT, TOT_ACINS_AMT)
                                 = (   SELECT  NVL(COUNT(tshaid.PROD_CD), 0)
                                            ,       NVL(SUM(DECODE(tshaid.ADJ_QTY, 0, 0, 1)), 0)
                                            ,       NVL(SUM(tshaid.ACINS_AMT), 0)
                                       FROM    TB_ST_STORE_ACTUAL_INSPECTION_DTL tshaid
                                       WHERE   tshaid.STORE_CD =   #{storeCd}
                                         AND     tshaid.ACINS_DATE   =   #{acinsDate}
                                         AND     tshaid.SEQ_NO       =   #{seqNo}
            )
          ,       ACINS_TITLE = #{acinsTitle}
          ,       REASON_CD = #{acinsReason}
          ,       ADJ_STORAGE_CD = #{adjStorageCd}
          ,       PROC_FG     = #{procFg}
          ,       CONFM_DATE  = DECODE(#{procFg}, '0', NULL, SUBSTR(#{modDt}, 0, 8))
          ,       CONFM_ID    = DECODE(#{procFg}, '0', NULL, #{modId})
          ,       MOD_DT      = #{modDt}
          ,       MOD_ID      = #{modId}
        WHERE   STORE_CD      = #{storeCd}
        AND     ACINS_DATE    = #{acinsDate}
        AND     SEQ_NO        = #{seqNo}
    </update>


    <!--                엑셀업로드 시작                 -->
    <!--  실사관리 엑셀업로드 - 엑셀업로드 수량추가 -->
    <!--
        TABLE    : TB_ST_STORE_TEMP_EXCEL, TB_ST_STORE_ACTUAL_INSPECTION_DTL
        PARAM    : excelUploadStoreVO
        COMMENTS : 실사관리 엑셀업로드 - 엑셀업로드 수량추가인 경우 기존에 등록된 내역을 TEMP 테이블에 입력한다.
    -->
    <insert id="insertExcelUploadAddQty" parameterType="excelUploadStoreVO">
        /* USE : AcinsMapper.insertExcelUploadAddQty */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                INSERT INTO TB_ST_STORE_TEMP_EXCEL
                (   SESSION_ID
                ,   HQ_OFFICE_CD
                ,   PROD_CD
                ,   QTY
                ,   REG_DT
                ,   REG_ID
                ,   MOD_DT
                ,   MOD_ID
                )
                SELECT  #{sessionId}
                ,       #{hqOfficeCd}
                ,       PROD_CD
                ,       ACINS_QTY
                ,       #{regDt}
                ,       #{regId}
                ,       #{modDt}
                ,       #{modId}
                FROM    TB_ST_HQ_ACTUAL_INSPECTION_DTL
                WHERE   HQ_OFFICE_CD=  #{hqOfficeCd}
                AND     ACINS_DATE  =  #{date}
                AND     SEQ_NO      =  #{seqNo}
                AND     PROD_CD     IN (  SELECT  PROD_CD
                FROM    TB_ST_STORE_TEMP_EXCEL
                WHERE   SESSION_ID  = #{sessionId}
                AND     PROD_CD     IS NOT  NULL
                AND     PROD_CD     IN (  SELECT  PROD_CD
                FROM    TB_HQ_PRODUCT
                WHERE   HQ_OFFICE_CD  =  #{hqOfficeCd}
                AND     STOCK_PROD_YN = 'Y'
                AND     USE_YN        = 'Y'
                )
                )
            </when>
            <!-- 가맹점 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                INSERT INTO TB_ST_STORE_TEMP_EXCEL
                (   SESSION_ID
                ,   STORE_CD
                ,   PROD_CD
                ,   QTY
                ,   REG_DT
                ,   REG_ID
                ,   MOD_DT
                ,   MOD_ID
                )
                SELECT  #{sessionId}
                ,       #{hqOfficeCd}
                ,       PROD_CD
                ,       ACINS_QTY
                ,       #{regDt}
                ,       #{regId}
                ,       #{modDt}
                ,       #{modId}
                FROM    TB_ST_STORE_ACTUAL_INSPECTION_DTL
                WHERE   STORE_CD    =  #{storeCd}
                AND     ACINS_DATE  =  #{date}
                AND     SEQ_NO      =  #{seqNo}
                AND     PROD_CD     IN (  SELECT  PROD_CD
                FROM    TB_ST_STORE_TEMP_EXCEL
                WHERE   SESSION_ID  = #{sessionId}
                AND     PROD_CD     IS NOT  NULL
                AND     PROD_CD     IN (  SELECT  PROD_CD
                FROM    TB_MS_PRODUCT
                WHERE   STORE_CD  =  #{storeCd}
                AND     STOCK_PROD_YN = 'Y'
                AND     USE_YN        = 'Y'
                )
                )
            </when>
        </choose>
    </insert>


    <!--  실사관리 엑셀업로드 - 기존 데이터중 엑셀업로드 한 데이터와 같은 상품 삭제 -->
    <!--
        TABLE    : TB_ST_HQ_ACTUAL_INSPECTION_DTL, TB_ST_STORE_TEMP_EXCEL
        PARAM    : excelUploadStoreVO
        COMMENTS : 실사관리 엑셀업로드 - 기존 데이터중 엑셀업로드 한 데이터와 같은 상품은 삭제한다.
    -->
    <delete id="deleteAcinsToExcelUploadData" parameterType="excelUploadStoreVO">
        /* USE : AcinsMapper.deleteAcinsToExcelUploadData */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                DELETE  TB_ST_HQ_ACTUAL_INSPECTION_DTL
                WHERE   HQ_OFFICE_CD  = #{hqOfficeCd}
                AND     ACINS_DATE    = #{date}
                AND     SEQ_NO        = #{seqNo}
                AND     PROD_CD       IN  ( SELECT  PROD_CD
                FROM    TB_ST_STORE_TEMP_EXCEL
                WHERE   SESSION_ID  = #{sessionId}
                AND     PROD_CD     IS NOT NULL
                )
            </when>
            <!-- 가맹점 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                DELETE  TB_ST_STORE_ACTUAL_INSPECTION_DTL
                WHERE   STORE_CD      = #{storeCd}
                AND     ACINS_DATE    = #{date}
                AND     SEQ_NO        = #{seqNo}
                AND     PROD_CD       IN  ( SELECT  PROD_CD
                FROM    TB_ST_STORE_TEMP_EXCEL
                WHERE   SESSION_ID  = #{sessionId}
                AND     PROD_CD     IS NOT NULL
                )
            </when>
        </choose>
    </delete>


    <!--  실사관리 엑셀업로드 - 엑셀업로드 한 수량을 실사수량으로 입력 -->
    <!--
        TABLE    : TB_ST_HQ_ACTUAL_INSPECTION_DTL, TB_ST_STORE_TEMP_EXCEL, TB_HQ_PRODUCT, TB_ST_HQ_STOCK_CUR, TB_ST_HQ_STOCK_MONTHLY
                   TB_ST_STORE_ACTUAL_INSPECTION_DTL, TB_ST_STORE_TEMP_EXCEL, TB_MS_PRODUCT, TB_ST_STORE_STOCK_CUR, TB_ST_STORE_STOCK_MONTHLY
        PARAM    : excelUploadStoreVO
        COMMENTS : 실사관리 엑셀업로드 - 엑셀업로드 한 수량을 실사수량으로 입력한다.
    -->
    <insert id="insertAcinsToExcelUploadData" parameterType="excelUploadStoreVO">
        /* USE : AcinsMapper.insertAcinsToExcelUploadData */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                MERGE INTO TB_ST_HQ_ACTUAL_INSPECTION_DTL A
                USING
                (
                SELECT  #{hqOfficeCd} AS HQ_OFFICE_CD
                , #{date} AS ACINS_DATE
                , #{seqNo} AS SEQ_NO
                , '00' AS HQ_BRAND_CD
                , tpte.PROD_CD AS PROD_CD
                , tpte.COST_UPRC AS COST_UPRC
                , tpte.COST_UPRC * (tpte.QTY - NVL(tsssc.CURR_QTY,0)) AS ADJ_AMT
                , NVL(tsssc.CURR_QTY,0) AS CMPT_CURR_QTY
                , tpte.QTY AS ACINS_QTY
                , tpte.QTY - NVL(tsssc.CURR_QTY,0) AS ADJ_QTY
                , tpte.COST_UPRC * tpte.QTY AS ACINS_AMT
                , tpte.PO_UNIT_QTY AS PO_UNIT_QTY
                , tpte.REMARK AS REMARK
                , #{regDt} AS REG_DT
                , #{regId} AS REG_ID
                , #{modDt} AS MOD_DT
                , #{modId} AS MOD_ID
                FROM ( SELECT tpte.HQ_OFFICE_CD
                , tpte.PROD_CD
                , thp.PO_UNIT_QTY
                , NVL(MAX(thp.COST_UPRC), 0) AS COST_UPRC
                , SUM(tpte.QTY) AS QTY
                , MAX(tpte.REMARK) AS REMARK
                FROM TB_ST_STORE_TEMP_EXCEL tpte
                , TB_HQ_PRODUCT thp
                WHERE tpte.SESSION_ID = #{sessionId}
                AND tpte.PROD_CD IS NOT NULL
                AND thp.HQ_OFFICE_CD = #{hqOfficeCd}
                AND thp.PROD_CD = tpte.PROD_CD
                AND thp.STOCK_PROD_YN = 'Y'
                AND thp.USE_YN = 'Y'
                GROUP
                BY tpte.HQ_OFFICE_CD
                , tpte.PROD_CD
                , thp.PO_UNIT_QTY
                ) tpte
                ,       TB_ST_HQ_STOCK_CUR tsssc
                WHERE   tsssc.HQ_OFFICE_CD  (+) =   tpte.HQ_OFFICE_CD
                AND     tsssc.storage_cd    (+) =   '999'
                AND     tsssc.PROD_CD       (+) =   tpte.PROD_CD
                ) B
                ON (
                A.HQ_OFFICE_CD = B.HQ_OFFICE_CD
                AND A.ACINS_DATE = B.ACINS_DATE
                AND A.SEQ_NO = B.SEQ_NO
                AND A.PROD_CD = B.PROD_CD
                )
                WHEN MATCHED THEN
                UPDATE
                SET
                A.COST_UPRC     = B.COST_UPRC,
                A.ADJ_AMT       = B.ADJ_AMT,
                A.CMPT_CURR_QTY = B.CMPT_CURR_QTY,
                A.ACINS_QTY     = A.ACINS_QTY + B.ACINS_QTY,
                A.ADJ_QTY       = B.ADJ_QTY,
                A.ACINS_AMT     = A.ACINS_AMT + B.ACINS_AMT,
                A.PO_UNIT_QTY   = B.PO_UNIT_QTY,
                A.REMARK        = B.REMARK,
                A.MOD_DT        = B.MOD_DT,
                A.MOD_ID        = B.MOD_ID
                WHEN NOT MATCHED THEN
                INSERT  (
                A.HQ_OFFICE_CD
                , A.ACINS_DATE
                , A.SEQ_NO
                , A.HQ_BRAND_CD
                , A.PROD_CD
                , A.COST_UPRC
                , A.ADJ_AMT
                , A.CMPT_CURR_QTY
                , A.ACINS_QTY
                , A.ADJ_QTY
                , A.ACINS_AMT
                , A.PO_UNIT_QTY
                , A.REMARK
                , A.REG_DT
                , A.REG_ID
                , A.MOD_DT
                , A.MOD_ID
                ) VALUES (
                B.HQ_OFFICE_CD
                , B.ACINS_DATE
                , B.SEQ_NO
                , B.HQ_BRAND_CD
                , B.PROD_CD
                , B.COST_UPRC
                , B.ADJ_AMT
                , B.CMPT_CURR_QTY
                , B.ACINS_QTY
                , B.ADJ_QTY
                , B.ACINS_AMT
                , B.PO_UNIT_QTY
                , B.REMARK
                , B.REG_DT
                , B.REG_ID
                , B.MOD_DT
                , B.MOD_ID
                )
            </when>
            <!-- 가맹점 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                MERGE INTO TB_ST_STORE_ACTUAL_INSPECTION_DTL A
                USING (
                SELECT  #{storeCd} AS STORE_CD
                ,       #{date} AS ACINS_DATE
                ,       #{seqNo} AS SEQ_NO
                ,       '00' AS HQ_BRAND_CD
                ,       tpte.PROD_CD AS PROD_CD
                ,       tpte.COST_UPRC AS COST_UPRC
                ,       tpte.COST_UPRC * (tpte.QTY - NVL(tsssc.CURR_QTY,0)) AS ADJ_AMT
                ,       NVL(tsssc.CURR_QTY,0) AS CMPT_CURR_QTY
                ,       tpte.QTY AS ACINS_QTY
                ,       tpte.QTY - NVL(tsssc.CURR_QTY,0) AS ADJ_QTY
                ,       tpte.COST_UPRC * tpte.QTY AS ACINS_AMT
                ,       tpte.PO_UNIT_QTY AS PO_UNIT_QTY
                ,       tpte.REMARK AS REMARK
                ,       #{regDt} AS REG_DT
                ,       #{regId} AS REG_ID
                ,       #{modDt} AS MOD_DT
                ,       #{modId} AS MOD_ID
                FROM    (
                SELECT  tpte.STORE_CD
                ,       tpte.PROD_CD
                ,       tmp.PO_UNIT_QTY
                ,       NVL(MAX(tmp.COST_UPRC), 0) AS COST_UPRC
                ,       SUM(tpte.QTY)    AS QTY
                ,       MAX(tpte.REMARK) AS REMARK
                FROM    TB_ST_STORE_TEMP_EXCEL tpte
                ,       TB_MS_PRODUCT tmp
                WHERE   tpte.SESSION_ID     =   #{sessionId}
                AND     tpte.PROD_CD        IS NOT  NULL
                AND     tmp.STORE_CD        =   #{storeCd}
                AND     tmp.PROD_CD         =   tpte.PROD_CD
                AND     tmp.STOCK_PROD_YN   =   'Y'
                AND     tmp.USE_YN          =   'Y'
                GROUP
                BY      tpte.STORE_CD
                ,       tpte.PROD_CD
                ,       tmp.PO_UNIT_QTY
                ) tpte
                ,       TB_ST_STORE_STOCK_CUR tsssc
                WHERE   tsssc.STORE_CD      (+) =   tpte.STORE_CD
                AND     tsssc.storage_cd    (+) =   '999'
                AND     tsssc.PROD_CD       (+) =   tpte.PROD_CD
                ) B
                ON (
                A.STORE_CD = B.STORE_CD
                AND A.ACINS_DATE = B.ACINS_DATE
                AND A.SEQ_NO = B.SEQ_NO
                AND A.PROD_CD = B.PROD_CD
                )
                WHEN MATCHED THEN
                UPDATE
                SET
                A.COST_UPRC     =  B.COST_UPRC,
                A.ADJ_AMT       =  B.ADJ_AMT,
                A.CMPT_CURR_QTY =  B.CMPT_CURR_QTY,
                A.ACINS_QTY     =  A.ACINS_QTY + B.ACINS_QTY,
                A.ADJ_QTY       =  B.ADJ_QTY,
                A.ACINS_AMT     =  A.ACINS_AMT + B.ACINS_AMT,
                A.PO_UNIT_QTY   =  B.PO_UNIT_QTY,
                A.REMARK        =  B.REMARK,
                A.MOD_DT        =  B.MOD_DT,
                A.MOD_ID        =  B.MOD_ID
                WHEN NOT MATCHED THEN
                INSERT
                (   A.STORE_CD
                ,   A.ACINS_DATE
                ,   A.SEQ_NO
                ,   A.HQ_BRAND_CD
                ,   A.PROD_CD
                ,   A.COST_UPRC
                ,   A.ADJ_AMT
                ,   A.CMPT_CURR_QTY
                ,   A.ACINS_QTY
                ,   A.ADJ_QTY
                ,   A.ACINS_AMT
                ,   A.PO_UNIT_QTY
                ,   A.REMARK
                ,   A.REG_DT
                ,   A.REG_ID
                ,   A.MOD_DT
                ,   A.MOD_ID
                ) VALUES (
                B.STORE_CD
                ,   B.ACINS_DATE
                ,   B.SEQ_NO
                ,   B.HQ_BRAND_CD
                ,   B.PROD_CD
                ,   B.COST_UPRC
                ,   B.ADJ_AMT
                ,   B.CMPT_CURR_QTY
                ,   B.ACINS_QTY
                ,   B.ADJ_QTY
                ,   B.ACINS_AMT
                ,   B.PO_UNIT_QTY
                ,   B.REMARK
                ,   B.REG_DT
                ,   B.REG_ID
                ,   B.MOD_DT
                ,   B.MOD_ID
                )
            </when>
        </choose>
    </insert>


    <!--  실사관리 엑셀업로드 - 정상 입력된 데이터 TEMP 테이블에서 삭제 -->
    <!--
        TABLE    : TB_ST_STORE_TEMP_EXCEL, TB_HQ_PRODUCT
                   TB_ST_STORE_TEMP_EXCEL, TB_MS_PRODUCT
        PARAM    : excelUploadStoreVO
        COMMENTS : 실사관리 엑셀업로드 - 정상 입력된 데이터 TEMP 테이블에서 삭제한다.
    -->
    <delete id="deleteExcelUploadCompleteData" parameterType="excelUploadStoreVO">
        /* USE : AcinsMapper.deleteExcelUploadCompleteData */
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg == "H"'>
                DELETE  TB_ST_STORE_TEMP_EXCEL
                WHERE   SESSION_ID  = #{sessionId}
                AND     PROD_CD     IS NOT NULL
                AND     PROD_CD     IN  ( SELECT  PROD_CD
                FROM    TB_HQ_PRODUCT
                WHERE   HQ_OFFICE_CD  =   #{hqOfficeCd}
                AND     STOCK_PROD_YN =   'Y'
                AND     USE_YN        =   'Y'
                )
            </when>
            <!-- 가맹점 -->
            <when test='orgnFg != null and orgnFg == "S"'>
                DELETE  TB_ST_STORE_TEMP_EXCEL
                WHERE   SESSION_ID  = #{sessionId}
                AND     PROD_CD     IS NOT NULL
                AND     PROD_CD     IN  ( SELECT  PROD_CD
                FROM    TB_MS_PRODUCT
                WHERE   STORE_CD      =   #{storeCd}
                AND     STOCK_PROD_YN =   'Y'
                AND     USE_YN        =   'Y'
                )
            </when>
        </choose>
    </delete>
    <!--                엑셀업로드 끝                 -->


    <select id="getAcinsReason" parameterType="sessionInfoVO" resultType="DefaultMap">
        <choose>
            <!-- 본사 -->
            <when test='orgnFg != null and orgnFg.toString() == "HQ"'>
                SELECT  NMCODE_CD,
                NMCODE_NM
                FROM    TB_HQ_NMCODE
                WHERE   HQ_OFFICE_CD = #{hqOfficeCd}
                AND     NMCODE_GRP_CD = '134'
                AND     USE_YN = 'Y'
            </when>
            <!-- 가맹점 -->
            <when test='orgnFg != null and orgnFg.toString() == "STORE"'>
                SELECT  NMCODE_CD,
                NMCODE_NM
                FROM    TB_MS_STORE_NMCODE
                WHERE   STORE_CD = #{storeCd}
                AND     NMCODE_GRP_CD = '134'
                AND     USE_YN = 'Y'
            </when>
        </choose>
    </select>
</mapper>
