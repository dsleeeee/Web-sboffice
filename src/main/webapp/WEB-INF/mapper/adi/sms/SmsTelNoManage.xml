<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SmsTelNoManage.xml
    발신번호관리
    ======================================================
    No  ||  수정자 ||  수정일자    ||  수정내역
    ======================================================
    1       김설아     2021.09.15     최초작성
-->
<mapper namespace="kr.co.solbipos.adi.sms.smsTelNoManage.service.impl.SmsTelNoManageMapper">

    <!-- 발신번호관리 - 조회 -->
    <!--
        TABLE    : HCS_SENDM_T
        COMMENTS : [본사매장]발신번호인증||
    -->
    <select id="getSmsTelNoManageList"  parameterType="SmsTelNoManageVO" resultType="DefaultMap">
        /* SmsTelNoManageMapper.getSmsTelNoManageList */
        SELECT
        SBPENC.D(hst.TEL_NO) AS TEL_NO,
        hst.USE_YN,
        hst.USE_SEQ
        FROM HCS_SENDM_T hst
        WHERE 1=1
        AND hst.OGN_CD = #{orgnCd}
        ORDER BY hst.USE_SEQ
    </select>

    <!-- 발신번호관리 - 발신번호 등록 요청 저장 -->
    <!--
        TABLE    :
        COMMENTS :
    -->
    <insert id="getSmsTelNoManageSave" parameterType="SmsTelNoManageVO">
        /* SmsTelNoManageMapper.getSmsTelNoManageSave */
        INSERT INTO HCS_CRTLG_T
        (
            CERT_ID,
            OGN_CD,
            PROC_FG,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID
        )
        VALUES
        (
            #{certId},
            #{orgnCd},
            '0',
            #{modDt},
            #{modId},
            #{modDt},
            #{modId}
        )
    </insert>

    <!-- 발신번호관리 - 기존에 등록된 번호인지 확인 -->
    <!--
        TABLE    : HCS_SENDM_T
        COMMENTS : [본사매장]발신번호인증||
    -->
    <select id="getSmsTelNoManageChk"  parameterType="SmsTelNoManageVO" resultType="Integer">
        /* SmsTelNoManageMapper.getSmsTelNoManageChk */
        SELECT  COUNT(*)
        FROM    HCS_SENDM_T
        WHERE   SBPENC.D(TEL_NO) = #{telNo}
        AND     OGN_CD = #{orgnCd}
        AND     USE_YN = 'Y'
    </select>

    <!-- 발신번호관리 수정 -->
    <!--
        TABLE    :
        COMMENTS :
    -->
    <update id="getSmsTelNoManageUpdate" parameterType="SmsTelNoManageVO">
        /* SmsTelNoManageMapper.getSmsTelNoManageUpdate */
        UPDATE
            HCS_CRTLG_T
        SET
            PROC_FG = '1',
            RES_RECV_NUMBER = SBPENC.E(#{telNo}),
            RES_RESULT_CD = #{resCd},
            MOD_DT = #{modDt},
            MOD_ID = #{modId}
        WHERE 1=1
        AND CERT_ID = #{certId}
        AND OGN_CD = #{orgnCd}
    </update>

    <!-- 발신번호관리 - 저장 -->
    <!--
        TABLE    :
        COMMENTS :
    -->
    <update id="getSmsTelNoManageSaveUpdate" parameterType="SmsTelNoManageVO">
        /* SmsTelNoManageMapper.getSmsTelNoManageSaveUpdate */
        UPDATE
            HCS_SENDM_T
        SET
            USE_SEQ = #{useSeq},
            MOD_DT = #{modDt},
            MOD_ID = #{modId}
        WHERE 1=1
          AND OGN_CD = #{orgnCd}
          AND TEL_NO = SBPENC.E(#{telNo})
    </update>

    <!-- HCS_CRTLG_T.OGN_CD 값 가져옴 -->
    <!--
        TABLE    : HCS_CRTLG_T
        COMMENTS :
    -->
    <select id="getOrdrIdxx"  parameterType="SmsTelNoManageVO" resultType="String">
        /* SmsTelNoManageMapper.getOrdrIdxx */
        SELECT  OGN_CD
        FROM    HCS_CRTLG_T
        WHERE   CERT_ID = #{certId}
    </select>

    <!-- 발신번호차단 탭 - 조회 -->
    <!--
        TABLE    :
        COMMENTS :
    -->
    <select id="getSmsTelNoStopList"  parameterType="SmsTelNoManageVO" resultType="DefaultMap">
        /* SmsTelNoManageMapper.getSmsTelNoStopList */
        SELECT
        hst.OGN_CD AS ORGN_CD,
        twuidv01.ORGN_NM,
        SBPENC.D(hst.TEL_NO) AS TEL_NO,
        hst.USE_YN
        FROM HCS_SENDM_T hst,
        (
            SELECT
            twuidv01.ORGN_FG,
            twuidv01.ORGN_CD,
            twuidv01.ORGN_NM,
            twuidv01.HQ_OFFICE_CD,
            twuidv01.STORE_CD,
            (CASE WHEN twuidv01.ORGN_FG = 'H' THEN (SELECT AGENCY_CD FROM TB_HQ_OFFICE WHERE HQ_OFFICE_CD = twuidv01.HQ_OFFICE_CD)
                   WHEN twuidv01.ORGN_FG = 'S' THEN (SELECT AGENCY_CD FROM TB_MS_STORE WHERE STORE_CD = twuidv01.STORE_CD)
                   ELSE null END
            ) AS AGENCY_CD
            FROM
            (
                SELECT
                DECODE(twuidv01.ORGN_FG, 'A', 'M', twuidv01.ORGN_FG) AS ORGN_FG,
                twuidv01.ORGN_CD,
                twuidv01.ORGN_NM,
                twuidv01.HQ_OFFICE_CD,
                twuidv01.STORE_CD
                FROM TB_WB_USER_INFO_DTL_V01 twuidv01
                GROUP BY twuidv01.ORGN_FG, twuidv01.ORGN_CD, twuidv01.ORGN_NM, twuidv01.HQ_OFFICE_CD, twuidv01.STORE_CD
            ) twuidv01
            WHERE 1=1
            GROUP BY twuidv01.ORGN_FG, twuidv01.ORGN_CD, twuidv01.ORGN_NM, twuidv01.HQ_OFFICE_CD, twuidv01.STORE_CD
        ) twuidv01
        WHERE 1=1
        <!-- 검색조건 소속구분 -->
        <if test='srchOrgnFg != null and srchOrgnFg != ""'>
            <![CDATA[
                AND twuidv01.ORGN_FG = #{srchOrgnFg}
            ]]>
        </if>
        AND twuidv01.ORGN_CD = hst.OGN_CD
        ORDER BY hst.OGN_CD, hst.USE_SEQ
    </select>

    <!-- 발신번호차단 탭 - 저장 -->
    <!--
        TABLE    :
        COMMENTS :
    -->
    <update id="getSmsTelNoStopSaveUpdate" parameterType="SmsTelNoManageVO">
        /* SmsTelNoManageMapper.getSmsTelNoStopSaveUpdate */
        UPDATE
        HCS_SENDM_T
        SET
        USE_YN = #{useYn},
        MOD_DT = #{modDt},
        MOD_ID = #{modId}
        WHERE 1=1
        AND OGN_CD = #{orgnCd}
        AND TEL_NO = SBPENC.E(#{telNo})
    </update>

</mapper>